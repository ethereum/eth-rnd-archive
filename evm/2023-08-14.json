[
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hi all, I want to get back into EOF development - what is the current status of https://notes.ethereum.org/@ipsilon/mega-eof-specification ?",
        "created_at": "2023-08-14T10:01:09.979000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It seems in the preface that there are 3 EIPs not yet defined, but they are defined in the spec, so I assume I should use the spec to update EOF?",
        "created_at": "2023-08-14T10:03:03.448000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes, mega-spec is the best source of truth right now",
        "created_at": "2023-08-14T10:19:51.545000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Great thanks üòÑ",
        "created_at": "2023-08-14T10:20:37.444000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok, I read the new spec and I understand most of it, except `CREATE3`.\n\nSo if I enter the `CREATE3` initcode-mode frame, I will use the code container (hardcoded and not a stack item) as the init code and enter the frame. But I am now not allowed to RETURN/STOP... so how should I exit the `CREATE3` frame? A \"succesful execution\" should return a `container_index` (ok, so assuming this is a `container_index` which is provided in the initcode container..? This could lead to recursive CREATE3 factories which would make the initial contract gigantic..? ü§î ). It should also return `aux_data`... I have no idea what this is. A data container? And the `data_offset`, `data_size` from the stack, where is this taken from? The data container or memory?",
        "created_at": "2023-08-14T11:27:48.573000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Also regarding the changes to EIP4844, is this possible..? I would assume this would need a new transaction type especially cross-forks for mempool reasons (so introducing this `initcodes` field)",
        "created_at": "2023-08-14T11:28:25.092000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok, am I getting this right? `RETURN` and `STOP` are disallowed in the new `CREATE` opcodes because we are not allowed to init state..?",
        "created_at": "2023-08-14T13:39:46.027000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If I read it right RETURNCONTRACT is the only state-changing exit from an EOF initcode section. REVERT will halt execution but not consume all gas, whereas RETURN, STOP, or any other exceptional halt will halt execution and also consume all gas.",
        "created_at": "2023-08-14T14:14:51.169000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm confused by this comment: which seems to imply `RETURNCONTRACT` is not used ü§î So I have no idea how to actually return from CREATE3?",
        "created_at": "2023-08-14T14:16:14.162000+00:00",
        "attachments": [
            {
                "type": "image/png",
                "origin_name": "image.png",
                "content": "c1cae370d76546d778f0667f975ec58cf68cbfd8e703893d7ec31b4033ee23be"
            }
        ]
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think that part of the spec needs to be cleaned up.  It should return the address on success and the code at that addess would have the code + new aux data.",
        "created_at": "2023-08-14T14:17:06.316000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Or it is is at significant variance with the other CREATEs",
        "created_at": "2023-08-14T14:17:51.767000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hmm ok and this aux_data where do I get it from? From memory?",
        "created_at": "2023-08-14T14:18:55.378000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "returncontract",
        "created_at": "2023-08-14T14:19:13.858000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "and yes, from memory",
        "created_at": "2023-08-14T14:19:20.805000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok yes I see",
        "created_at": "2023-08-14T14:19:27.872000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right it now makes more sense, I got confused by that comment",
        "created_at": "2023-08-14T14:19:54.855000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I am worried about the following pattern though:\n\n-\u003e Deploy a contract which is able to deploy new child contracts\n\nFor this, you need to deploy an EOF containers which has `container_index`. So if I get this right, this loads a new EOF frame if I CREATE3 and this is thus containers itself. So if my initcode would just be very simple `PUSH0 PUSH0 RETURNCONTRACT\u003c0\u003e` this would still add 4 bytes as initcode. So this bounds the CREATE3 depths of EOF contracts I can ever create, since I now have to recursively deploy these containers at the initial contract (right?)..? But I am not sure if this is a practical problem, though ü§î  (Or, thinking about it, I might be able to solve this with `DELEGATECALL` ?)",
        "created_at": "2023-08-14T14:42:21.870000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Perhaps Three nested EOF containers?  (a) the factory (b) the initcode container and (c) the actual deployed container. b is in a and c is in b (which is in a).",
        "created_at": "2023-08-14T14:44:00.302000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but size wise it imposes a limit.",
        "created_at": "2023-08-14T14:44:30.510000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we should have a test case for this.",
        "created_at": "2023-08-14T14:44:44.442000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Exactly, but as you can see this imposes a recursive problem:\n\nCall A to deploy B (which deploys C as code). This creates contract Z\nI now want to create some other contract (can be C with B as initcode, it does not really matter). However this means that in C I need to have this initcode and code as well - but this implies that this is inside A as well (since B is in A, and C is in B)\n\nThis assumes that the deployed code C is also EOF (but this is highly implied in the spec)",
        "created_at": "2023-08-14T14:47:50.656000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Has to be an EOF, I'm fairly certain there is a line prohibiting it womswhare that EOF cannot produce legacy",
        "created_at": "2023-08-14T14:48:25.324000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah yes you are right",
        "created_at": "2023-08-14T14:48:32.854000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We need some way to say \"This is our base code\" without initcode.  The need to initialize storage as part of it makes it difficult.   I think that was the motivation behind lightclients uber-create opcode.",
        "created_at": "2023-08-14T14:50:13.353000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think this depth problem can be solved using DELEGATECALL but the pattern is rather complex",
        "created_at": "2023-08-14T14:50:13.877000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hmm I'm not super up to date regarding the EOF discussion, where do I find info about this uber-create opcode?",
        "created_at": "2023-08-14T14:50:52.216000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think it may have been just a tweet from \u003c@543900561460822016\u003e .  and I mis-remembered.  It was a new transaciton type.  adds a block for key/value storage init as well as a block for auxdata.",
        "created_at": "2023-08-14T14:52:30.836000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "7377",
        "created_at": "2023-08-14T14:52:49.723000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "could be an opcode if it handles memory parsing of a key/value list",
        "created_at": "2023-08-14T14:52:52.077000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh yea, a fill EIP even.  I must have really disconnected on vacation for once.",
        "created_at": "2023-08-14T14:53:28.810000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ohh right ok I see the idea now... so to extend 7377s idea: the initcode is removed and instead we provide init storage values and whatever container we want to deploy there?",
        "created_at": "2023-08-14T14:54:21.885000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "well, that was EOA migration, not the copy tx or copy opcode I was thinking of",
        "created_at": "2023-08-14T14:54:23.993000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Another Q: it seems that I am allowed to use the CALL equivalents to CALL into non-EOF from EOF, right?",
        "created_at": "2023-08-14T14:55:05.323000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Just CALL and STATICCALL, not DELEGATECALL because you could delegate into a legacy contract that does EOF invalid operations, like self-destruct.",
        "created_at": "2023-08-14T14:55:44.766000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sure but this now allows me to inspect gas",
        "created_at": "2023-08-14T14:55:57.821000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "true.  That's how I see 4337 working until it is enshrined into the protocol as a precompile or some other such operation.",
        "created_at": "2023-08-14T14:57:01.876000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "entry points must be legacy code for now and you could still call into a bundler form EOF.  But not delegate call into.",
        "created_at": "2023-08-14T14:57:50.867000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How would DELEGATECALL work if I call from legacy -\u003e EOF? And then start to use EOF opcodes?",
        "created_at": "2023-08-14T14:58:54.621000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Does it now \"magically\" transform my call frame into EOF call frame?",
        "created_at": "2023-08-14T14:59:09.605000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I guess that could work ü§î",
        "created_at": "2023-08-14T14:59:17.361000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There's no real call frame changes.  So it should \"seamlessly\" work",
        "created_at": "2023-08-14T14:59:48.273000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Well this is slightly confusing and it makes it rather complex in my head... If I `DELEGATECALL` from a legacy contract into EOF and now `DATACOPY`... how should that work?",
        "created_at": "2023-08-14T15:02:10.994000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh wait I think I'm confusing how `DELEGATECALL` works ü§¶‚Äç‚ôÇÔ∏è",
        "created_at": "2023-08-14T15:04:04.342000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I guess that should work without a problem",
        "created_at": "2023-08-14T15:04:08.824000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think if we want to ban GAS introspection then we should disallow EOF -\u003e legacy CALLs and friends",
        "created_at": "2023-08-14T15:21:59.642000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm more interested in banning gas limiting than gas introspection.  That's what's broken gas schedule changes in the past, where compilers limit the gas to the next call.  Thus the solution to any gas schedule changes can always be \"send more gas to the top level tx\" if all gas is always passed.\n\n4337 kind of breaks it, and kind of doesn't.  Gas is a function of the UserOperation, and for typical cases UOs come from outside the EVM call stack.  I could see some wallets accepting unsigned UOs for some operations and the EVM creating them, but there should be a big \"make gas configurable\" warning label on such operations.",
        "created_at": "2023-08-14T15:26:19.357000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The places I see gas introspection useful for look suspiciously like EntryPoints.  The current \"break\" for introspection is easy to undo: restore the GAS opcode and the old CALL opcodes.  So it's more of a reversable break that we can walk back if it doesn't work.",
        "created_at": "2023-08-14T15:27:30.755000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have no strong opinion here but I also thought there were strong arguments against gas introspection as well? I do not remember the arguments though ü§î",
        "created_at": "2023-08-14T16:06:32.635000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The absence of gas introspection makes transpiling modulo gas easier, that way traps cannot be set up where contracts behave differently with different gas consumption.  Also not having to report on gas at possibly any point mid-exeution simplifies sone interpreters.",
        "created_at": "2023-08-14T17:18:40.233000+00:00",
        "attachments": null
    }
]