[
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Here's a weird one: `CREATE4` could actually be enabled in legacy too, to allow creating EOF code. The reason we wanted avoiding the creation of EOF code from legacy is a) unknown unknowns; b) code inspection.\n\n`CREATE4` at least removes b)",
        "created_at": "2023-03-29T16:38:18.974000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How does create 4 work in the context of a eip-4337 bundler, will it be limited to one create4 per bundle as the index becomes part of the signed user operation?  or could we let create 4 refer to these by hash instead of or in addition to index?",
        "created_at": "2023-03-29T16:40:36.379000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right, that's a good point, perhaps we need a unique identifier and not a linear one.",
        "created_at": "2023-03-29T16:41:05.154000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "since there is value in hashing the seed container for create 3, would that be better than a tx assigned tag?",
        "created_at": "2023-03-29T16:42:01.969000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There are a few distinct problems:\n1) how to properly identify an initcode in the tx?\n2) if that's a hash, should that be related to some other hash we have?",
        "created_at": "2023-03-29T16:46:22.477000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For 1) it seems the easiest is the initcode list is just a hashmap where the key is the hash of the value.",
        "created_at": "2023-03-29T16:46:46.551000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "As then we can be sure no matter the order of initcodes, create4 always gets the correct inputs.",
        "created_at": "2023-03-29T16:47:07.937000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "About 2) I'm not sure yet.",
        "created_at": "2023-03-29T16:47:20.493000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This likely also gives us an upper bound before it can become an attack vector?",
        "created_at": "2023-03-29T16:48:56.354000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Your proposal of index + hash could avoid the hashmap case, but makes block building hard, or in practice really just limits a single create4 transaction in a block.",
        "created_at": "2023-03-29T16:51:15.065000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So each entry in the initcode list in the new proposed TX would be hashed as an opaque object, unrelated to anything else in the transaction.  Create4 would use that hash to refer to it's object, or index if n \u003c 256?  The odds of a 31 zero prefix hash are astronomically low (as we learned from PoW).  Or just always by hash.",
        "created_at": "2023-03-29T17:03:23.500000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Having the opaque bytes hashed does open up some re-use, both within the transaction (3 txes could deploy the same ERC-721 with different auxdata) and clients could conceivably keep a cache outside in memory or on disk if they do fancy analysis, or they can always do everything the hard way.",
        "created_at": "2023-03-29T17:04:54.725000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'd tend to only do hashes for simplicity?",
        "created_at": "2023-03-29T17:05:33.975000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "in-tx reuse is still possible with the index only mechanism, that's not unique to the hashing mechanism.  It makes mev's jobs easier however.",
        "created_at": "2023-03-29T17:05:36.030000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "hashes only is fine by me.",
        "created_at": "2023-03-29T17:05:42.385000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If we limit the number of entries then even linear lookup should be non-dosable.",
        "created_at": "2023-03-29T17:05:51.649000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes.  2,4,8, 16?",
        "created_at": "2023-03-29T17:06:19.074000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And perceivably we want to have some limit",
        "created_at": "2023-03-29T17:06:19.180000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I was hoping for larger, in the order of 64-128.",
        "created_at": "2023-03-29T17:06:38.810000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Looking at 4337 transactions on mainnet could be a good data set for decisions",
        "created_at": "2023-03-29T17:06:48.507000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes.  256 max for sure.  64 or 128 are fine too.",
        "created_at": "2023-03-29T17:07:14.347000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hm, there's no \"hashmap\" style type in SSZ?",
        "created_at": "2023-03-29T17:12:40.923000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We need to make up a composite type and put it into a list?",
        "created_at": "2023-03-29T17:12:58.057000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It would just be values, not key/value.  Keys would need to be calculated as the tx is read.",
        "created_at": "2023-03-29T17:13:08.263000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right, we could calculate it there.",
        "created_at": "2023-03-29T17:13:18.782000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "and SSZ has some hash magic with it's types too we should leverage.",
        "created_at": "2023-03-29T17:13:29.750000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So then there's no change to the tx spec we have, just the way create4 works.",
        "created_at": "2023-03-29T17:13:32.177000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right.",
        "created_at": "2023-03-29T17:13:39.816000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "One thought, if we had create3 also use hashes, and we looked at the hashes in the TX body, in theory we could merge CREATE3 and CREATE4.  The hash of the opaque bytes makes it so we don't care where it comes from, it's always what we expect.",
        "created_at": "2023-03-29T17:14:20.708000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The downside that comes with is the index becomes 32-bytes instead of 1 and that's an additional 31-byte bloat for each create3 in a contract.",
        "created_at": "2023-03-29T17:15:20.878000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But interesting idea",
        "created_at": "2023-03-29T17:15:31.587000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It kind of becomes an access-list style situation with the merged create3/create4",
        "created_at": "2023-03-29T17:16:43.790000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "When contracts are 1k-24K and already cost 32K gas as a starting point 32 byte bloat for consistency seems reasonable.",
        "created_at": "2023-03-29T17:16:45.378000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "SSZ libs could add support for contrent-addressable arrays in their list of arrays impls.",
        "created_at": "2023-03-29T17:17:24.698000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "1. Have an initcode list\n2. Pre-populate that list with the tx.initcode_list\n3. When loading a contract, append the initcodes found in the contract to the list",
        "created_at": "2023-03-29T17:17:27.146000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For a contract create tx, yes. Also, we should explicitly state we don't dive into subcontainers to find hashes.  top level hashes only.",
        "created_at": "2023-03-29T17:18:29.969000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the only reason to keep create3 in that case if we can load-time validation, because that's the only reason to have it as an immediate argument",
        "created_at": "2023-03-29T17:19:51.464000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "load time validation of subcontainers could be a ddos vector",
        "created_at": "2023-03-29T17:20:27.584000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if it becomes recursive",
        "created_at": "2023-03-29T17:20:41.509000+00:00",
        "attachments": null
    },
    {
        "author": "zcstarr",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "anyone have any pro tips on validating the new EOFv1 format in EIP-3540 ? I launch data contracts so having a harness somewhere would be useful or if someone can point me to commits in go-ethereum, I could probably work out how I should validate that they meet the upcoming reqs for that.",
        "created_at": "2023-03-29T17:22:44.328000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There're also some local validator tools in https://github.com/ipsilon/eof which may be easier to use.",
        "created_at": "2023-03-29T17:28:47.223000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "To be clear, you just want to check if the code you generate is valid EOF, and you'll really only just want to fill out the data section. Is that correct?",
        "created_at": "2023-03-29T17:29:20.709000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Is  EXTDATACOPY in the current mega spec?",
        "created_at": "2023-03-29T17:31:12.350000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Nope. Data contracts are pretty much doomed in EOF.",
        "created_at": "2023-03-29T18:00:41.816000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm not worried so much about recursive validation because code size limit still applies.",
        "created_at": "2023-03-29T18:04:29.328000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That's still thousands of one op embedded contracts in an attack scenario.",
        "created_at": "2023-03-29T18:09:17.197000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@403707149043105803\u003e wdyt about this?",
        "created_at": "2023-03-29T18:45:53.690000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That depends on the transaction format additions.  It would work.  Would it create only EOF code?",
        "created_at": "2023-03-29T18:46:45.529000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Assuming create4 only allows EOF code",
        "created_at": "2023-03-29T18:47:08.317000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that would be fine.  It's not like the \"escape hatch\" situation that EOF delegatecall into legacy presented.",
        "created_at": "2023-03-29T18:47:41.309000+00:00",
        "attachments": null
    }
]