[
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So here's a question I had about EIP 2315",
        "created_at": "2021-03-04T20:10:53.585000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What would happen if we restricted it further, and instead of JUMPSUB taking a variable, we forced it to take an immediate?",
        "created_at": "2021-03-04T20:11:13.834000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The reason I'm interested in this is that it would be nice if we could make PCs _completely_ inobservable to the EVM, because that would allow EVM code to be transformed",
        "created_at": "2021-03-04T20:12:00.745000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "eg. one usecase of this is search-and-replacing all uses of some opcode with some contract call",
        "created_at": "2021-03-04T20:12:17.658000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If all PCs had to be read straight from the EVM, then you could (i) search-and-replace the code and build a PC translation table, and (ii) apply that translation table to all immediates",
        "created_at": "2021-03-04T20:12:48.094000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Can be done, but would either be jumpsub01 or jumpsub02 or even larger...",
        "created_at": "2021-03-04T20:12:58.332000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Making it static, or having a static version, was requested on the magicians post, but never followed up.",
        "created_at": "2021-03-04T20:12:58.861000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I know for a fact that Optimism would benefit greatly from this",
        "created_at": "2021-03-04T20:13:00.103000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Would also add branches to jumpdest analysis",
        "created_at": "2021-03-04T20:13:18.241000+00:00",
        "attachments": null
    },
    {
        "author": "wjmelements",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!273808422753796097\u003e the word you want is PIC, \"Position-Independent Code\"",
        "created_at": "2021-03-04T20:13:28.716000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think like this train of thought better for getting rid of PC: https://github.com/ethereum/pm/issues/250#issuecomment-782094832",
        "created_at": "2021-03-04T20:13:34.764000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e Can be done, but would either be jumpsub01 or jumpsub02 or even larger...\n\nSorry what do you mean by this?",
        "created_at": "2021-03-04T20:13:40.929000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Jumpsub [0-2400] or even larger jumps?",
        "created_at": "2021-03-04T20:14:09.439000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That is less powerful than what I suggest; it allows copying/pasting/shifting of code, but it would not allow search-and-replace",
        "created_at": "2021-03-04T20:14:26.203000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Like we have push1, push2 etc",
        "created_at": "2021-03-04T20:14:28.053000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Just jumpsub2 should be fine, no? Because code size is already limited to far less than 64 kB",
        "created_at": "2021-03-04T20:14:48.434000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(not initcode, yet)",
        "created_at": "2021-03-04T20:15:06.906000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Why would it not allow search and replace? In both cases one must be able to fit the code into what is being replaced (and padding it with STOP or INVALID) or moving it around and adding another intermediate jump.",
        "created_at": "2021-03-04T20:15:15.627000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e Why would it not allow search and replace\n\nBecause a search and replace would change the distance between a jump source and a jump destination",
        "created_at": "2021-03-04T20:15:36.939000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm definitely assuming at least some use cases where a single byte gets replaced with a string of 10+ bytes",
        "created_at": "2021-03-04T20:16:08.112000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm not entirely sure why beginsub with absolute offsets is easier?",
        "created_at": "2021-03-04T20:17:17.337000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Because if you know that all the offsets are right in the EVM code, you can adjust them after you do your search-and-replacing",
        "created_at": "2021-03-04T20:17:56.791000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Only with immediates. But not sure you actually need this, as you can just add the longer code at the end, and insert a jump and padding in the original location.",
        "created_at": "2021-03-04T20:18:46.254000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Btw the optimism case itself is being worked on within the Solidity compiler, so while it is a good example, it may not depend on this feature.",
        "created_at": "2021-03-04T20:19:27.926000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ethereum/solidity/issues/10869 (we just discussed some aspects of it today)",
        "created_at": "2021-03-04T20:20:15.439000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I thought someone said that taking an immediate would be a backward incompatible change for some reason?",
        "created_at": "2021-03-04T20:20:49.432000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right, but Optimism being solidity-only really sucks ðŸ˜¢",
        "created_at": "2021-03-04T20:21:13.785000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e insert a jump and padding in the original location.\n\nStill longer than 1 byte, no?",
        "created_at": "2021-03-04T20:21:46.510000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The feature will be on the Yul level, so Fe could use it too. And I am sure Vyper would be able to implement something similar.",
        "created_at": "2021-03-04T20:22:00.257000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It has been asked several times \"why are dynamic jumpsubs allowed\" and I *think* the answer has always been \"because static jumpsubs would require a backward incompatible change\".  However, I'm exhausted (4:30 here) and may be mis-remembering something.",
        "created_at": "2021-03-04T20:22:08.013000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "right, but still, having something EVM-level is better",
        "created_at": "2021-03-04T20:22:11.530000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, one needs at least 3 bytes. So it would not be possible to replace a single byte without reordering code.",
        "created_at": "2021-03-04T20:22:29.181000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Maybe the idea is that the validity rules for EVM code would change if the rules for what constitutes \"pushdata\" are changed, and this is bad?",
        "created_at": "2021-03-04T20:23:05.185000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ie. the argument for why EVM384 has that PUSH6 dummy byte",
        "created_at": "2021-03-04T20:23:25.724000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I never followed up when people answered with that, I just assumed they knew what they were talking about and had good reasons since everyone seemed to agree on the topic.",
        "created_at": "2021-03-04T20:24:09.512000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I always wondered why are we mixing executable code and formatting. Every reasonable system has code encapsulated in a format, such as ELF, and relocatable code has relocation tables for easy modifications.\n\nThere have been proposals to have such encapsulation, but never seriously considered.",
        "created_at": "2021-03-04T20:25:11.444000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I guess the point I'm making is that regardless of what other awesome things we could be doing, moving toward PCs being unobservable somehow feels like a step in the right direction that could open the door to all sorts of good things",
        "created_at": "2021-03-04T20:26:23.572000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "A note on PC: two kinds of contracts on main net are using it already, gas tokens and optimism. If we want to completely remove PC (which I agree with), that likely means we need some kind of account/evm versioning or a decision to make those deployed contracts broken. Or someone to come up with some nice solution where PC can work in some cases while discouraged in others.",
        "created_at": "2021-03-04T20:28:20.903000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah, I guess in this case the idea would be some form of versioning, and optimism would only support the new version",
        "created_at": "2021-03-04T20:28:43.296000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And if there is versioning, we can just introduce real immediates, or encapsulation, or any clear and nice solution.",
        "created_at": "2021-03-04T20:29:18.845000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I mean, any change is backwards incompatible. The particular way that _this_ is incompatible is that it breaks on-chain purity validators, for one thing. Dunno how 'bad' that is",
        "created_at": "2021-03-04T20:29:33.909000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What is an on-chain purity validator?",
        "created_at": "2021-03-04T20:29:54.014000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "A contract that verifies that another contract does not modify state or read state",
        "created_at": "2021-03-04T20:30:09.348000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Make the v1 marker `PUSH1 0 DUP1 SLOAD SSTORE`? ðŸ¤£",
        "created_at": "2021-03-04T20:30:30.110000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I wonder if now with 2929 it would cheaper for purity valdiators to just staticcall the code to see if it modifies state, and if we would have purecall (which was discussed for long) they could use that to check read-purity ðŸ™‚",
        "created_at": "2021-03-04T20:31:07.033000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Although, it will only ever make a validity checker error in the \"safe\" direction , since any new opcode must be considered \"not safe\" anyway...",
        "created_at": "2021-03-04T20:31:56.282000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Immediates also adds overhead to jumpdest analysis, but I think we have some margin there",
        "created_at": "2021-03-04T20:33:12.760000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Particularly if we limit initcode-size to prevent DoS attacks on 2-Mb \"contracts\"",
        "created_at": "2021-03-04T20:34:08.975000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If we would have encapsulation (with a jumpdest list), we wouldn't need jumpdest analysis. I know this is wishful thinking, but since we are talking about some crazy future, it may as well be possible.",
        "created_at": "2021-03-04T20:34:21.052000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Want to write up a doc for a simple proposal for how encapsulation could work?",
        "created_at": "2021-03-04T20:34:37.020000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(also keep in mind that because we are doing code merklization, we want to minimize the extent to which code execution needs to jump around to look for data)",
        "created_at": "2021-03-04T20:35:04.292000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think we first need a formal proposal for how EVM versioning would work?  This is the `n`th time we have had a desire/want/need for some kind of EVM versioning I believe.",
        "created_at": "2021-03-04T20:35:26.694000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Heh, this will be fun for the Solidity optimizer.  A new dimension to optimize on.  ðŸ˜„",
        "created_at": "2021-03-04T20:35:56.530000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I can try, I think there were some prior brief discussions about it 2 years ago. Basically it would be something on the order of:\n\u003e magic / version\n\u003e code offset\n\u003e jumplist offset\n\u003e metadata offset\n\u003e \u003ccode here\u003e\n\u003e \u003cjumptable here\u003e\n\u003e \u003cmetadata here\u003e",
        "created_at": "2021-03-04T20:36:03.390000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Could further split this into having functions, etc. But maybe that is not very useful, albeit possible as a future extension.",
        "created_at": "2021-03-04T20:36:25.583000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "well if we have functions then we don't need jumps to PCs at all!",
        "created_at": "2021-03-04T20:36:45.201000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Still needs jump within functions for control flow.",
        "created_at": "2021-03-04T20:37:04.932000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What about just having code structured as a list of segments, and you can only jump between segments?",
        "created_at": "2021-03-04T20:37:23.203000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But we would need to think about how to make this witness-efficient",
        "created_at": "2021-03-04T20:37:43.466000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Can we reasonably put a hard constraint on that so jumps can *only* be local?",
        "created_at": "2021-03-04T20:37:43.868000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If we have functions, jumps must be local.",
        "created_at": "2021-03-04T20:38:10.512000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And do we need *dynamic* jumps to achieve that, or can we still have immediate jumps?",
        "created_at": "2021-03-04T20:38:15.041000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Otherwise what benefit are we adding with functions. It would be very similar to the current jump-jumpsub case ðŸ˜•",
        "created_at": "2021-03-04T20:38:40.880000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In my experience with bytecode manipulation and rewriting, the higher level the bytecode language is, the easier it is to manipulate.  If bytecode manipulation is a desirable feature, then introducing higher level constructions is generally a \"good thing\" IMO.",
        "created_at": "2021-03-04T20:39:02.821000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah I agree",
        "created_at": "2021-03-04T20:39:15.122000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I find myself regretting more and more that the EVM is low-level",
        "created_at": "2021-03-04T20:39:23.380000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ASM *sucks* to rewrite, while the CLR and JVM are not too terrible to rewrite.",
        "created_at": "2021-03-04T20:39:43.957000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the EVM should have been LLL ðŸ¤£",
        "created_at": "2021-03-04T20:39:45.765000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "*LLL with gas accounting.  ðŸ˜‰",
        "created_at": "2021-03-04T20:39:56.397000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's trickier to have arbitrary size arguments in immediates. But if jumps are local, then one byte could suffice, and compilers could to N sequential jumps to go further :)",
        "created_at": "2021-03-04T20:40:16.679000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I while back I was considering this encapsulation format could be much more verbose, including a lot more metadata. However the client would only care about 1-2 mandatory sections. Users could deploy the entire code with all the metadata at their own expense though, but there would be no incentive to do so.",
        "created_at": "2021-03-04T20:41:33.493000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think (with the benefit of the hindsight, of course) EVM should've had a combination of two instruction sets. First, low-level, with fixed sized opcodes (but not fixed at 1 byte, of course), with dynamic jumps if need be, but so that you don't need to do any code verification, just run it. but no I/O. The main goal there is to be able to have good upper bound estimate on gas usage without actually counting gas. This instruction set is used to service the code of another instruction set, which has variable opcode size, does not allow dynamic jumps, has functions etc. That means it requires code verification before it can be used. That code verification is one of the functions of the lower-level instruction set. Also, lower level instruction set may do stuff like merkelisation and checking the merkle proofs - you keep these things programmable, but on a very efficient and simple instruction set ðŸ™‚",
        "created_at": "2021-03-04T20:51:44.372000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You are basically talking about x86 CISC vs. x86 microcode? ðŸ™‚",
        "created_at": "2021-03-04T20:55:19.751000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(Let me read it first though, it was just quick response.)",
        "created_at": "2021-03-04T20:55:46.190000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't know, maybe this is total nonsense in the end, sorry for diverting the discussion",
        "created_at": "2021-03-04T21:16:45.189000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "My personal opinion is to avoid underscores, as none of them use it currently. Out of this `CALLAS` seems to be the most clear if the person knows it means \"call as\" (though is it easy to mistake with `CALLER`?), but `CALLFROM` may be the easiest to read everything considered.",
        "created_at": "2021-03-04T21:52:38.069000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I agree with this",
        "created_at": "2021-03-04T23:06:01.553000+00:00",
        "attachments": null
    }
]