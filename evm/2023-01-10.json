[
    {
        "author": "hritzdorf",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hi everyone,\n\nI would like to submit an EOF-related proposal. I hope this is the right place. I have read the EIPs and have hopefully not missed anything.\n\n**EOF1 contracts can only `DELEGATECALL` EOF1 contracts**\n\n*Motivation*:\nCurrently contracts can selfdestruct in three different ways (directly through `SELFDESTRUCT`, indirectly through `CALLCODE` and indirectly through `DELEGATECALL`). EIP 3670 disables the first two possibilities, however the third possibility remains. Allowing EOF1 contracts to only `DELEGATECALL` other EOF1 contracts allows the following strong statement: *EOF1 contract can never be destructed.*\n\n*Specification*:\nWhen an EOF1 contract performs a `DELEGATECALL` the target contract has to be EOF1. If it is not EOF1 (e.g. it is EOF0 or EOF2), the `DELEGATECALL` exceptionally halts. Hence, (among other things) all the gas passed along is consumed and 0 is pushed onto the stack. `DELEGATECALL` to an empty code also fails.\n\n*Security Implications*:\nAttacks based on `SELFDESTRUCT` simply **disappear** for EOF1 contracts. These include:\n- Lost library contract, e.g. Parity Multisig (https://www.parity.io/blog/a-postmortem-on-the-parity-multi-sig-library-self-destruct/) and more recently Aave v2 with multiple audits (https://blog.trailofbits.com/2020/12/16/breaking-aave-upgradeability/)\n- Other unprotected selfdestructs (https://swcregistry.io/docs/SWC-106)\n- Replacing code with new code using `CREATE2` , `SELFDESTRUCT` and `CREATE2`  (legitimate use cases exist, but are rare)\n\n*Backwards Compatibility*:\nNo backwards compatibility is broken as EOF is newly introduced. In theory EOF1 contracts could use EOF0 libraries using `DELEGATECALL` but that seems relatively far fetched.\n\n*Complexity:*\nThe check is relatively simple. Hence, no changes to the gas cost of `DELEGATECALL` would be needed and the implementation overhead should not be prohibitive. \n\nPlease let me know if I should provide more clarifications, expand, write a PR or move this elsewhere.",
        "created_at": "2023-01-10T16:36:31.454000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "hey \u003c@736164446833213450\u003e thanks for this proposal, I think the best place to post this would actually be https://ethereum-magicians.org/t/evm-object-format-eof/5727",
        "created_at": "2023-01-10T17:07:14.116000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I converted the tests from the fuzzing corpus into the reference test format in case people want to start trying to add support to their tooling for the format: https://gist.github.com/lightclient/3442c744e03c58435c7b50013733481d",
        "created_at": "2023-01-10T18:56:51.105000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "and again, this was the reference test format proposal: https://notes.ethereum.org/@lightclient/HyWJKV7qi",
        "created_at": "2023-01-10T18:58:06.576000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "still open to suggestions - the \"ErrUnexpectedEOF\" (end of file) error is probably leaned on too much - open to modifying that behavior",
        "created_at": "2023-01-10T18:58:44.162000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "curious to know if standardizing errors will be worth it in the end - may be difficult considering it implies clients have the exact same order of operation when it comes to validation",
        "created_at": "2023-01-10T18:59:42.078000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Looks like good catch and reasonable thing to do.",
        "created_at": "2023-01-10T19:36:58.192000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Another thing is it would help us ensure that each test fails on one and only one way.  Besu had a AltBN128 bug because the tests case for point won't pair also was invaid for another reason, that we checked first.",
        "created_at": "2023-01-10T21:05:50.543000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We could also have an array of failure cases and the CUT only needs to return one of the reasons.",
        "created_at": "2023-01-10T21:06:15.960000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is the Filler format, not the filled tests?",
        "created_at": "2023-01-10T21:07:24.007000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that is a proposal for the filled test format",
        "created_at": "2023-01-10T21:07:39.857000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "happy with whatever filler format the retesteth team decides and separately will work on a format for the python test filler",
        "created_at": "2023-01-10T21:08:16.862000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Might not be the case for every implementation, but at least the implementation can decide how it will test itself.",
        "created_at": "2023-01-10T21:09:27.475000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "@winsvega's is different - https://github.com/ethereum/tests/issues/1130#issue-1517704002 - with indexes, array usage, etc.",
        "created_at": "2023-01-10T21:09:36.973000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but I do like bringing in the label into the test",
        "created_at": "2023-01-10T21:10:46.899000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think the only difference is the name -\u003e single test vs. name -\u003e array of tests (index sort of follows from that i think) and I feel relatively strongly that tests should have a single name and multiple results only for different fork configurations",
        "created_at": "2023-01-10T21:11:48.802000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "easy to change later if people disagree, but i don't know the status of retesteth support for that format so i'm starting with the name -\u003e single test",
        "created_at": "2023-01-10T21:12:37.219000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I see value in the name being the category and each indexed test being one instance, for example int boundary checking.  But a label propagated into each test.",
        "created_at": "2023-01-10T21:13:10.958000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But at a certain level it's what the testing team wants to support and what's the best format for retesteth to support.",
        "created_at": "2023-01-10T21:14:35.102000+00:00",
        "attachments": null
    }
]