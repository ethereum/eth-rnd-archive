[
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The early stages of the codegen would create balanced branches with a ton of pops on the Yul level. Later optimisations on the EVM level could in theory remove some of those.",
        "created_at": "2022-11-16T00:56:33.847000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "When we discussed with \u003c@425274498732916736\u003e in the afternoon I was leaning towards more of the `max_stack_height \u003e= num_outputs` and doing a stack move on `RETF`. The requirement to pop everything seem to be too excessive, and a `popn` instruction would really just serve this purpose and nothing else. If we let `retf` to do this task, different evm implementations may do different strategies.",
        "created_at": "2022-11-16T00:58:19.442000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Happy to be convinced otherwise ðŸ™‚",
        "created_at": "2022-11-16T00:58:41.623000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't have a strong  opinion, and you know what the compiler outputs.",
        "created_at": "2022-11-16T01:01:24.606000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Solidity will likely still just do balancing itself.",
        "created_at": "2022-11-16T01:02:42.535000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How much of difference does it make to the performance of RETF in that case?",
        "created_at": "2022-11-16T01:03:49.992000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If `retf` allows stray stack items, then\n- if there are stray items it would need to \"memmove\" the stack (ie. move n outputs to the frame pointer)\n- if there are no stray items then do nothing\n\nSo I think in the case of balanced input it would do nothing.",
        "created_at": "2022-11-16T01:05:41.413000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I guess I'd rather it not be \"automagically\" moving the stack, especially if it will rarely be necessary.  I also suspect it will be more difficult to specify the move than to specify an error condition.",
        "created_at": "2022-11-16T01:09:38.824000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That's fair. I'll ask more feedback about the current state of the optimizer.",
        "created_at": "2022-11-16T01:13:10.932000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thoughts on _requiring_ the type section? Seems like with everything going in together, there won't be many contracts with a single code section",
        "created_at": "2022-11-16T01:19:20.025000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So actually there's one argument against the explicit cleanup. That still kind of restricts how many items can be returned by a functions, because unless the stack kept clean, it wont be possible to return 16 items due to swap rules. That is unless EIP-663 is introduced.",
        "created_at": "2022-11-16T01:20:03.838000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I've created a spec for a fuzzing-target: https://github.com/holiman/txparse#eof-parser-eofparse .  Basically it takes input, and does eof validation on it. We did this previously with transactions, and it's very usefu to fuzz several implementations against eachother. So far, there's only geth, but I hope to see it in besu, nethermind and ethereumjs too, and perhaps someone is willing to do an implementation based on the python reference algo from the eip?",
        "created_at": "2022-11-16T08:17:24.080000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Here is python fuzzer: https://github.com/ipsilon/eof/blob/stack_validation/eips_code/fuzzing.py\nIt is libfuzzer based (path coverage fuzzing). I wasn't checking the coverage yet, but it seems it is not able to find the `max_stack_height \u003e 1024` case in stack validation. This maybe be because the code section size must much the EOF header and most of the fuzzing inputs fail here. I was considering adding custom mutator.",
        "created_at": "2022-11-16T09:12:31.873000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I was considering this. Added issue to the list for now.",
        "created_at": "2022-11-16T09:13:56.688000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Can you make it conform to the same input/output-spec as `eofparse`?",
        "created_at": "2022-11-16T09:17:25.839000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I will work on this next two days. This was done to check if JVM algo matches EOF.",
        "created_at": "2022-11-16T09:19:49.596000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I will try to deliver `eofparse` soon, but we are still debating some spec details.",
        "created_at": "2022-11-16T09:21:40.025000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@425279588009246720\u003e \u003c@275684146658148352\u003e \u003c@683653554631868440\u003e I have two more arguments _against _ automatic stack cleanup:\n1. If usage of `RETF` will turn out to be annoying because of the required stack cleanup we can enable automatic cleanup later without breaking existing code.\n2. During execution we don't need access to the type section so we can forget it after validation.",
        "created_at": "2022-11-16T09:24:27.013000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "2) is an interesting point, but assumes validation goes live.",
        "created_at": "2022-11-16T10:26:29.087000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes",
        "created_at": "2022-11-16T10:45:38.223000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Are we doing it this way then?",
        "created_at": "2022-11-16T10:46:15.485000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think you're much more important to have there than me - will set the call up and have it auto-record for you all - Friday 15:00 UTC it is ðŸ™‚",
        "created_at": "2022-11-16T14:26:36.614000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Agenda for the call, with the zoom info: https://github.com/ethereum/pm/issues/666\n\nY'all got the lucky issue number ðŸ‘¹ Make good use of it!",
        "created_at": "2022-11-16T14:29:55.029000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's good that cleanup is backwards compatible.\n\n\u003e 2) is an interesting point, but assumes validation goes live.\nI've been saying for  years that validation is essential, including for the EOF proposals -- I think they are much less useful without it.",
        "created_at": "2022-11-16T14:30:01.361000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Actually, the EIP-4750 has a gap in the spec. It requires the below at runtime.\n\n\u003e If data stack has less than `caller_stack_height + types[code_section_index].outputs`, execution results in exceptional halt.\n\nBut do not specify what to do in \"greater than\" case.",
        "created_at": "2022-11-16T14:33:15.690000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I originally posted this in the geth-channel, then _thought_ I had posted it to fellowship, but couldn't find it. Reposting it here for visibility:\n\nI think https://eips.ethereum.org/EIPS/eip-5450 is severely underspecified. \n\n1. At no point does it say exactly when and how the new verifications are checked (e.g. during CALLF, the current stack height plus the ... ).\n2. It never explicitly mentions the special-case which necessitates the up-front check to be performed (particularly: the new semantic that a stack overflow happens even if the actual overflow would not happen without the check, due to differing depth in different potential execution paths)\n\nThe EIP needs to define _where_ the stack hwm/lwm is stored. If it's _not_ in the state, then clients needs to generate it on the fly during block execution after a sync. And that is IMO definitely _not_ ideal. If it is in state, then it needs to be ironed out pretty ASAP.",
        "created_at": "2022-11-16T15:20:04.534000+00:00",
        "attachments": null
    }
]