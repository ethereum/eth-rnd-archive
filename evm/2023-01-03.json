[
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right.  EIP-2315 and EIP-4750  make the same promises on underflow, overflow and stack height and such, and support most of the same optimizations.  EIP-4750 (like EIP-615) also requires explicit interfaces for functions. These catch more errors and support some more optimizations, but prevent some inter-procedural and whole-program optimizations that EIP-2315 allows .  So there are tradeoffs.\n\nI prefer EIP-2315's tradeoffs, but am happily supporting the consensus on EIP-4750.  I'll decide later whether to pursue something like https://github.com/ethereum/EIPs/pull/4919",
        "created_at": "2023-01-03T02:58:11.110000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Nethermind has some issues still (crash + something else). For the others, \n```\n422: proc 0: OK b000015000,60ffb1\n422: proc 1: err: Section max height does not correspond to actual max height, expected error: undefined\n422: proc 2: OK b000015000,60ffb1\n422 input 0xef000101000802000200050003030001000000000100010001b00001500060ffb1ff\n```\nJS is the odd one out there^",
        "created_at": "2023-01-03T07:34:47.966000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Aside from the crash, \u003c@1011612262743679036\u003e , there's something else wonky. For `422`, nethermind outputs: \n```\n422: proc 3: OK 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00, ...\n```",
        "created_at": "2023-01-03T07:36:27.096000+00:00",
        "attachments": null
    },
    {
        "author": "smartprogrammer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Have a problem with the tests still. EIP-3540 states:\n```\nAt block.number == HF_BLOCK new contract creation is modified:\n\n    if initcode or code starts with the MAGIC, it is considered to be EOF formatted and will undergo validation specified in the following sections,\n    else if code starts with 0xEF, creation continues to result in an exceptional abort (the rule introduced in EIP-3541),\n    otherwise code is considered legacy code and the following rules do not apply to it.\n\nFor a create transaction, if initcode or code is invalid, the contract creation results in an exceptional abort. Such a transaction is valid and may be included in a block.\n\nFor the CREATE and CREATE2 instructions, if initcode or code is invalid, instructionsâ€™ execution ends with the result 0 pushed on stack.\n\nIn case initcode is invalid, gas for its execution is not deducted. In case code is invalid, all creation gas is deducted, similar to exceptional abort during initcode execution.\n```\nWhen i enable the checks on `initcode` and `code` that start with `MAGIC` I start failing more tests.\nrunning tests on https://github.com/ethereum/tests/pull/1127",
        "created_at": "2023-01-03T07:44:30.285000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hmm yeah our stack height is again wrong",
        "created_at": "2023-01-03T08:35:53.096000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We should also do these stack height checks for each opcode. I'm thinking of a sufficient format for this",
        "created_at": "2023-01-03T08:36:40.309000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Fixed this one",
        "created_at": "2023-01-03T08:49:07.075000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Fixed it",
        "created_at": "2023-01-03T08:50:33.491000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@425274498732916736\u003e for evmone\n```\n417: proc 3: err: too_many_code_sections\n```\nOthers are\n```\n417: proc 1: OK 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,...\n```\nThis input: https://github.com/holiman/txparse/blob/main/eofparse/all.input#L418",
        "created_at": "2023-01-03T08:52:42.182000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Can confirm that the only \"open\" case is `417` where evmone is the odd one out. Good job folks!",
        "created_at": "2023-01-03T08:55:54.830000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@450651770243252225\u003e",
        "created_at": "2023-01-03T08:57:38.375000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How many sections are here?",
        "created_at": "2023-01-03T08:59:05.509000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You can check the output: https://github.com/holiman/txparse/blob/main/eofparse/all.output#L418",
        "created_at": "2023-01-03T09:02:19.832000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Current status (with some new corpus): https://gist.github.com/holiman/f58f5831381981b0c9394bc127358c4f?permalink_comment_id=4422132#gistcomment-4422132",
        "created_at": "2023-01-03T09:11:37.576000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sigh, I find it so sad to see that I made so many mistakes on opcode stack deltas ðŸ˜¦",
        "created_at": "2023-01-03T09:18:10.613000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I will fix",
        "created_at": "2023-01-03T09:18:12.116000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I fixed the 3 JS divergences. On the nethermind/JS divergence, JS is now also OK with the code (so nethermind likely also has a stack delta error somewhere)",
        "created_at": "2023-01-03T09:26:13.221000+00:00",
        "attachments": null
    },
    {
        "author": "rodiazet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There are 1023 code sections so it should work fine. Limit is 1024. I will fix it today.",
        "created_at": "2023-01-03T09:27:13.066000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "No it is 1024 inclusive, right?",
        "created_at": "2023-01-03T09:28:58.576000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Confirmed. Only issue is`427` on Nethermind  (I'm not counting evmone since it also has known issues)",
        "created_at": "2023-01-03T09:30:44.470000+00:00",
        "attachments": null
    },
    {
        "author": "rodiazet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes \"Exactly one code section header MUST be present immediately following the type section. A maxmimum of 1024 individual code sections are allowed.\" https://eips.ethereum.org/EIPS/eip-3540",
        "created_at": "2023-01-03T09:32:59.139000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Two new ones for \u003c@403707149043105803\u003e : https://gist.github.com/holiman/f58f5831381981b0c9394bc127358c4f?permalink_comment_id=4422153#gistcomment-4422153",
        "created_at": "2023-01-03T09:37:10.275000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "at this point wouldn't it make more sense if that table is shared somewhere ?",
        "created_at": "2023-01-03T09:37:28.795000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I can generate it",
        "created_at": "2023-01-03T09:38:43.006000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That would be appreciated ðŸ˜„",
        "created_at": "2023-01-03T09:40:31.981000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://gist.github.com/holiman/598490eb62d318ac814a7232514a2860 lmk if you want it in a different format",
        "created_at": "2023-01-03T09:50:51.372000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I should also have done this \"trick\" with swap, swap16 = 16 inputs and 16 outputs",
        "created_at": "2023-01-03T09:53:16.965000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah it's an oldie but goldie",
        "created_at": "2023-01-03T09:53:28.233000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I like it ðŸ™‚",
        "created_at": "2023-01-03T09:53:32.143000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I now have a min stack height which is the same as the amount of inputs except for swap/dup",
        "created_at": "2023-01-03T09:53:45.744000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is The Right thing to do, just not intuitive",
        "created_at": "2023-01-03T09:53:47.361000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I should definitely update",
        "created_at": "2023-01-03T09:54:03.182000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Will add it as a todo to the pr",
        "created_at": "2023-01-03T09:54:08.836000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "this is cool, thanks",
        "created_at": "2023-01-03T14:13:23.623000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "After some battle, I managed to hook in the comparer with the golang native fuzzing, which has coverage guidance. So I let golang fuzzer generate inputs, and  - unbeknown to the fuzzer - I also ship those inputs to the other binaries, and compare outputs. With this strategy, running `geth`,`ethereumjs` and `evmone` (`proc 2`), found another flaw \n```\n--- FAIL: Fuzz (180.13s)\n    --- FAIL: Fuzz (0.00s)\n        comparer_test.go:55: Doing test\n        comparer_test.go:60: 81328: proc 0: err: expected kind data 0x03: have 0\n            81328: proc 1: err: pos: 11: data section marker (3) expected, expected error: undefined\n            81328: proc 2: OK 603060305d000230203000\n            81328 input 0xef0001010004020001000b0000000002603060305d000230203000\n            \n            \n            \n    \n    Failing input written to testdata/fuzz/Fuzz/f7f6a86e1edb920dd6ea6e31958c7ec3fddca7a7d353bf5835c917de325deb79\n    To re-run:\n    go test -run=Fuzz/f7f6a86e1edb920dd6ea6e31958c7ec3fddca7a7d353bf5835c917de325deb79\n```",
        "created_at": "2023-01-03T14:29:07.233000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Nethermind reports the same as proc 1 and proc 0 in this case : ``err: EIP-3540 : Eof1, Code header is not well formatted``",
        "created_at": "2023-01-03T14:50:23.325000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "confirmed.",
        "created_at": "2023-01-03T14:52:26.621000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "fixed",
        "created_at": "2023-01-03T15:26:30.534000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\n  0: /home/user/workspace/txparse/eofparse/eofparse\n  1: /usr/local/bin/ts-node /home/user/workspace/txparse-js/eofparse.ts --stdin\n  2: /home/user/workspace/EOF-Header-Parser/bin/release/net6.0/linux-x64/EofParser\n--- FAIL: Fuzz (32.56s)\n    --- FAIL: Fuzz (0.00s)\n        comparer_test.go:55: Doing test\n        comparer_test.go:60: 19919 input 0xef0001010004020001009f03000000003000156330303030603060306030376030603060300860306030603078303030303030303030303030303030303030303030303030306030603060307930303030303030303030303030303030303030303030303030306030653030303030302031f12031603065303030303030603060306030f4603030603064303030303060306030603060306030603060306030603060306130306230303061303037303000\n            19919: proc 0: err: invalid type annotation at index 0: input and output must be 0: have (0, 48)\n            19919: proc 1: err: type section body: first code section should have 0 outputs, expected error: undefined\n            19919: proc 2: OK 6330303030603060306030376030603060300860306030603078303030303030303030303030303030303030303030303030306030603060307930303030303030303030303030303030303030303030303030306030653030303030302031f12031603065303030303030603060306030f4603030603064303030303060306030603060306030603060306030603060306130306230303061303037303000\n```\nnethermind error ^",
        "created_at": "2023-01-03T15:28:02.467000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ethereum/EIPs/pull/6253",
        "created_at": "2023-01-03T15:50:03.806000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "fixed",
        "created_at": "2023-01-03T16:27:35.308000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Updated comment: https://gist.github.com/holiman/f58f5831381981b0c9394bc127358c4f?permalink_comment_id=4422810#gistcomment-4422810 . Errors for  js, nethermind and evmone",
        "created_at": "2023-01-03T18:18:50.809000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "updated with a geth-error, cc \u003c@543900561460822016\u003e . And with that, there are no two engines that can be fuzzed against eachother. Besu won the round this time",
        "created_at": "2023-01-03T18:26:18.824000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Here's my attempt to put a stake through the opcode table's heart - https://gist.github.com/shemnon/d64ec5468cf3928fa680231f414bf505 - one test per opcode so it's easier to debug\nThis is just the EOF1 valid opcodes at the moment, I'll fill in pushes and pops for the deprecated ones and TSTORE/TLOAD after lunch.",
        "created_at": "2023-01-03T18:38:13.524000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Also, where are the build instructions for nethermind's and js's eofparse?",
        "created_at": "2023-01-03T18:38:59.534000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Great. I'll nick those inputs and add to the existing corpus",
        "created_at": "2023-01-03T18:46:09.712000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "They were generated from Besu, so if besu is bugged in the opcode table still we will want to update it.",
        "created_at": "2023-01-03T18:46:41.833000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\ncd /home/user/workspace/EOF-Header-Parser \u0026\u0026 git pull\ndotnet publish -c release -r linux-x64\n```\nnethermind^",
        "created_at": "2023-01-03T18:46:50.929000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "As for ethereum-js, there's not a lot of building happening, but  executed via `ts-node /home/user/workspace/txparse-js/eofparse.ts --stdin`. Some npm i magic needs to happen at one point to get the dependencies",
        "created_at": "2023-01-03T18:48:11.919000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah I pull into `all.input`, and generate `all.output` , and push to the eofparse repo. Been doing that the entire time, not sure people have noticed",
        "created_at": "2023-01-03T18:49:06.880000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "here: https://github.com/holiman/txparse/tree/main/eofparse",
        "created_at": "2023-01-03T18:49:21.297000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "removed jumpf, that code correctly fails now",
        "created_at": "2023-01-03T18:49:57.096000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I expect the fuzzer would eventually get 100% opcode coverage, but a suite like this puts a spotlight on the failing entry.",
        "created_at": "2023-01-03T18:49:58.061000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh, btw, can everyone fix so their clients handle the format `0xef0001 010008 020002-0004-0001 030000 00 00000000-00000000 b00001-b1 ff` -- that is, strip ` ` and `-` before decoding",
        "created_at": "2023-01-03T18:50:05.506000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Lots of diffs between geth and besu... Example:\n```\n2 input 0xef0001 010008 020002-0007-0002 030000 00 00000002-02010002 59-59-b00001-50-b1 01-b1\n2: proc 0: err: wrong number of outputs (want: 0, got: 2)\n2: proc 1: OK 5959b0000150b1,01b1\n```",
        "created_at": "2023-01-03T18:57:28.372000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@211091239112671234\u003e the new All.input starting from line 502 contain spaces and dashes is that by design ?",
        "created_at": "2023-01-03T19:04:46.822000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@1011612262743679036\u003e yes ^^",
        "created_at": "2023-01-03T19:05:14.643000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(bonus point if you totally ignore lines beginning with `#` too. might be useful)",
        "created_at": "2023-01-03T19:06:21.750000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think Nethermind considers them all invalid",
        "created_at": "2023-01-03T19:09:07.066000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "this was a geth bug, i've just fixed it now",
        "created_at": "2023-01-03T19:09:24.610000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "is there a reason why we should add this ?",
        "created_at": "2023-01-03T19:10:10.409000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "These were all resolved by the latest code!",
        "created_at": "2023-01-03T19:11:44.984000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'll let \u003c@403707149043105803\u003e answer ... I suppose it's for human readability, making it easier to manage / copy / paste snippets... I don't see any downside really",
        "created_at": "2023-01-03T19:12:28.846000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Human readability.  All one string makes it hard to reason about small code runs.",
        "created_at": "2023-01-03T19:13:10.081000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "okey makes sense",
        "created_at": "2023-01-03T19:14:07.271000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "what is the set of special characters is being used ? just # ' ' and '-' ?",
        "created_at": "2023-01-03T19:14:58.167000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "space and `-` for now. I think it makes sense to skip lines starting with `#`, so we can add comments to the corpus, but that's not \"live\" anyway",
        "created_at": "2023-01-03T19:17:07.426000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right now spaces and dashes.  Besu strips out all alphanumerics.",
        "created_at": "2023-01-03T19:17:08.878000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Another nethermind err: https://gist.github.com/holiman/f58f5831381981b0c9394bc127358c4f?permalink_comment_id=4422939#gistcomment-4422939",
        "created_at": "2023-01-03T19:19:59.635000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "can sections end in non-terminating opcodes ?",
        "created_at": "2023-01-03T19:35:15.115000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\nef00 // prefix\n01 // version\n01 000c // typesection header\n02 0003 0003 000b 0001 // codesection header\n03 0000 // datasection header\n00 // terminator\n00000001 30300030 30300030 // typesection\n60 30 00 // code section 0\n5e 03 0000 0000 0000 5c fffd // code section 1 \n00 code section 2\n```\ndoesnt code section 1 end with JUMPI here ? or am I getting something wrong ?",
        "created_at": "2023-01-03T19:37:11.260000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sections terminators are 00, FD and 00.",
        "created_at": "2023-01-03T19:38:55.088000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "FD is not jumpi, it's revert",
        "created_at": "2023-01-03T19:39:39.664000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but 5c is right ?",
        "created_at": "2023-01-03T19:40:25.607000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have to double check this",
        "created_at": "2023-01-03T19:40:33.452000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But 5c isn't the last one",
        "created_at": "2023-01-03T19:40:58.846000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the code section 1 iig is :\n```\nRJUMPV 03 [0000 00000 0000]\nRJUMP fffd\n``` \nor does RJUMP take 1  byte as immediate ? or do we literally check last byte if it's a terminating opcode",
        "created_at": "2023-01-03T19:42:18.871000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "idk I am a bit confused here lol",
        "created_at": "2023-01-03T19:42:25+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hm. Yeah me tooo",
        "created_at": "2023-01-03T19:45:06.816000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e or does RJUMP take 1  byte as immediate ?\nIt takes two. \n\u003e do we literally check last byte if it's a terminating opcode \nThat can _not_ be correct",
        "created_at": "2023-01-03T19:47:39.685000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah",
        "created_at": "2023-01-03T19:48:42.370000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The answer is: `RJUMP` is a terminal opcode",
        "created_at": "2023-01-03T19:48:50.563000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "okey ? but in the spec it says this",
        "created_at": "2023-01-03T19:49:36.575000+00:00",
        "attachments": [
            {
                "type": "image/png",
                "origin_name": "image.png",
                "content": "7db23437c250adceb084c85b8643c9262655b7cbef8aebf9e8e5196143591443"
            }
        ]
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://eips.ethereum.org/EIPS/eip-4200 says differently too\n```\n# STOP, RETURN, REVERT, INVALID, SELFDESTRUCT\nterminating_opcodes = [ 0x00, 0xf3, 0xfd, 0xfe, 0xff ]\n```\nBut \u003c@543900561460822016\u003e has defined this in geth:\n```golang\n    jt[RJUMP] = \u0026operation{\n        execute:     opRjump,\n        constantGas: GasQuickStep,\n        minStack:    minStack(0, 0),\n        maxStack:    maxStack(0, 0),\n        terminal:    true,\n    }\n```",
        "created_at": "2023-01-03T19:51:17.004000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the thinking around \"terminal\" opcodes had to change when dead code became invalid.  So RJUMP, RETF, and any operation that closes the frame needed to be the last instruction or anything after it would evaluate out of the section.",
        "created_at": "2023-01-03T19:58:19.797000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I read terminal as \"terminates the code section\" not \"terminates execution of the message frame\"",
        "created_at": "2023-01-03T19:58:41.751000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "To be explicit: these and only these are terminal in geth:`INVALID,RETURN,STOP,REVERT,RETF,RJUMP`",
        "created_at": "2023-01-03T20:01:43.840000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "EIP-4200 calls for selfdestruct to be included, but I guess that's an academic point",
        "created_at": "2023-01-03T20:02:06.163000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "To me it's a question of do we enumerate them in the spec or set a code validation rule like \"the PC cannot advance outside the code section\" - that wasy when/if JUMPF gets added it is automatically added to the list of final instructions.",
        "created_at": "2023-01-03T20:03:35.298000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah. Something like \"If the code segment ends with an instruction which (even potentially) allows the PC to continue forward: traversing outside the code segment, is invalid\".",
        "created_at": "2023-01-03T20:06:18.063000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right, RJUMPI and RJUMPV are not valid terminal instructions, even if it's PUSH1 1 RJUMPI -20 - the code validation does not consider what is on the stack.",
        "created_at": "2023-01-03T20:07:30.896000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\nfuzz: elapsed: 48m27s, execs: 30049945 (11852/sec), new interesting: 1 (total: 511)\n```\nThat's 30M cases, geth/besu, with golang coverage guidance. Starting to look pretty good!",
        "created_at": "2023-01-03T20:09:47.636000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Of course I'll leave it on overnight. If anyone else wants to play, ping me when fixes are pushed",
        "created_at": "2023-01-03T20:10:46.550000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Updated my opcodes gist to include stacks for former/future codes (JUMP, JUMPI, PC, JUMPF, TSTORE, TLOAD, CALLCODE, SELFDESTRUCT)",
        "created_at": "2023-01-03T20:30:33.281000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You can pull evmone",
        "created_at": "2023-01-03T21:12:06.979000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@211091239112671234\u003e \u003c@1011612262743679036\u003e Sorry about this confusion. We don't check if the last instruction in a code section is terminating. We don't need this check because 5450 give similar property out of the control-flow analysis: the execution will not go out of code buffer. The realization of this property is that a code section will end with a terminating instruction or a `RJUMP`.\n\nThe reference implementation is outdated unfortunately. I'm not sure what is the fade of this python code. It was really hard to keep it updated and in many places it is removed. We can bring it back but I'm not sure what value it has if split across 5 different EIPs.",
        "created_at": "2023-01-03T22:19:57.553000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So, are you saying that the \"isTerminating\" check is not even needed?",
        "created_at": "2023-01-03T22:36:22.882000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is a part of \"operand stack validation\" https://eips.ethereum.org/EIPS/eip-5450#operand-stack-validation",
        "created_at": "2023-01-03T22:38:16.446000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i.e. a terminating instruction is one of the conditions to stop the control-flow analysis.",
        "created_at": "2023-01-03T22:39:04.496000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, if I remove the explicit check (https://github.com/ethereum/go-ethereum/pull/26133/files#diff-e6bcc86b41b8db93525b2cf969bffec96cb6c30524fc45c53fe8cd4c032f10caR93), the only effect is that the err text changes, but nothing else",
        "created_at": "2023-01-03T22:41:32.839000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "e.g \n```\n\u003c err: code section ends with non-terminal instruction\n---\n\u003e err: computed max stack height for code section 1 does not match expected (want: 48, got: 120)\n```",
        "created_at": "2023-01-03T22:41:55.273000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You didn't fix the strip though\n```\n504 input 0xef0001 010008 020002-0004-0001 030000 00 00000000-00000000 b00001-b1 00\n504: proc 0: OK b00001b1,00\n504: proc 1: OK b00001b1,00\n504: proc 2: err: invalid hex\n```\nBut I can still fuzz it, that will use more proper hex",
        "created_at": "2023-01-03T22:43:59.502000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i think the check is necessary though, otherwise `PUSH0 POP` would be considered a valid code section",
        "created_at": "2023-01-03T22:47:28.256000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There needs to be some checking that the code doesn't advance out of the container, much like rjump targets.  Terminal opcodes is the easiest way to grok.",
        "created_at": "2023-01-03T22:48:26.938000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I didn't know this is expected.",
        "created_at": "2023-01-03T22:48:36.007000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is check 3.1 in 5450.",
        "created_at": "2023-01-03T22:49:40.517000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Nah it's new, but we talked about it a bit further up ^",
        "created_at": "2023-01-03T22:52:36.389000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What is the meaning of `-`?",
        "created_at": "2023-01-03T22:53:28.546000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's to separate instructions and parts.  arbitrary punctuation",
        "created_at": "2023-01-03T22:54:11.463000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "To distinguish a multi-byte instruction from a single byte.  5f-6001-610002-...",
        "created_at": "2023-01-03T22:54:52.785000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And to separate the type decleration and code lengths.",
        "created_at": "2023-01-03T22:55:09.319000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Do you strip all whitespace?",
        "created_at": "2023-01-03T22:55:17.517000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes.  Besu strips all non-alpha-numerics",
        "created_at": "2023-01-03T22:55:30.744000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I agree that stripping non-alpha-numerics is even better, _iff_ it's done after checking whether it starts with `#`(and, if so, ignore the line)",
        "created_at": "2023-01-03T22:57:35.787000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But for all input in the samples, stripping `-` and ` ` is sufficient for now",
        "created_at": "2023-01-03T22:58:30.970000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "will add the # and trim to newline.",
        "created_at": "2023-01-03T22:58:35.981000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I expect that this code will be re-used for reference tests and I see value in embedded comments.  Likely a two pass - strip comment lines then strip non-alpha-nums (including newlines)",
        "created_at": "2023-01-03T22:59:37.030000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "and don't process zero length code",
        "created_at": "2023-01-03T22:59:49.194000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`geth`, `besu` and `evmone`, 20 minutes, 4M cases so far all good. I'll let it work while I sleep \n```\nfuzz: elapsed: 20m24s, execs: 4299756 (3321/sec), new interesting: 0 (total: 772)\n```",
        "created_at": "2023-01-03T23:06:30.270000+00:00",
        "attachments": null
    }
]