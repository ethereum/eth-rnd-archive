[
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If I understand you, my main concern is that this adds yet more overhead to the EVM. \n The per-operation overhead looks to be higher than gas counting, and I already joke (exaggerating) that the EVM is a gas-counting machine that does computation as a side effect.  Add in the per-chunk set operations and the performance impact could be large.  I'm not sure whether \u003c@!425274498732916736\u003e's optimization of consolidating static gas counting to the beginning of each basic block of control flow can be applied here.",
        "created_at": "2021-05-05T14:28:58.267000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Shower thought: A precompile that takes in a range of EVM code and will calculate the gas cost required for that code and cache (permanently) the results in state.  The code cannot have any conditional operations or storage reads/writes.",
        "created_at": "2021-05-05T14:31:43.842000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The idea here is that a contract that gets executed a lot can pay some gas to force all nodes to pre-calculate and store the gas cost for a series of operations, so the EVM can then optimize that particular codepath.",
        "created_at": "2021-05-05T14:32:55+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Doing this would yield a small gas cost reduction on future executions of that particular set of instructions, because we don't have to do gas accounting for them.",
        "created_at": "2021-05-05T14:33:36.784000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Particularly useful if you are doing a bunch of math or memory management.",
        "created_at": "2021-05-05T14:34:01.755000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Why a precompile?",
        "created_at": "2021-05-05T14:34:41.933000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The mechanism for allowing users to trigger this optimization I am ambivalent about.  ðŸ™‚",
        "created_at": "2021-05-05T14:38:48.291000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It operates under the assumption that not everyone wants to spend the money required to get these optimizations, so we shouldn't turn them on generally.",
        "created_at": "2021-05-05T14:39:16.443000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Though, maybe we should and users can just eat the cost at contract deployment time.",
        "created_at": "2021-05-05T14:39:29.162000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "OK.  Code that does no storage ops might be common enough, but stretches of code with no jumps are basic blocks, and they tend to be short.",
        "created_at": "2021-05-05T14:39:58.122000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Is that just due to choices made by Solidity, or is that the nature of *all* code?",
        "created_at": "2021-05-05T14:40:36.523000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The definition of basic blocks.",
        "created_at": "2021-05-05T14:40:55.101000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I mean are basic blocks short due to the nature of *all* code, or just due to how Solidity chooses to lay things out?",
        "created_at": "2021-05-05T14:41:20.368000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Or how developers tend to author code.",
        "created_at": "2021-05-05T14:41:24.852000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If it is a choice people can make, then if we make it cheaper to run non-jumping contiguous blocks people may change the choice they make so they benefit from gas cost reductions.",
        "created_at": "2021-05-05T14:41:46.255000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If it is just the nature of code that it has lots of branches (I have never looked into this), then it is less useful.",
        "created_at": "2021-05-05T14:42:12.813000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Developers.  I'll be back after I find a histogram of ops I made, but the number jumps is I think pretty intrinsic to the algorithms use.",
        "created_at": "2021-05-05T14:42:59.882000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "",
        "created_at": "2021-05-05T14:46:39.776000+00:00",
        "attachments": [
            {
                "type": "text/plain; charset=utf-8",
                "origin_name": "opcode_counts.txt",
                "content": "c90e4154f00b6151fbab6a9d1d6e34b4688c5ebc31975d0683f6ce5231eb1cce"
            }
        ]
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e I think this answers the question.",
        "created_at": "2021-05-05T14:47:52.722000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oof.  Yeah.",
        "created_at": "2021-05-05T14:48:01.636000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That is the top of the list I assume?",
        "created_at": "2021-05-05T14:48:09.224000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sorry, didn't realize I could expand that.",
        "created_at": "2021-05-05T14:48:52.626000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "OK, I'm convinced that jumps are common.  ðŸ˜„",
        "created_at": "2021-05-05T14:49:16.454000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Conditional jumps especially.",
        "created_at": "2021-05-05T14:50:13.275000+00:00",
        "attachments": null
    }
]