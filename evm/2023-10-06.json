[
    {
        "author": "gumb00",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "My idea so far is not to revalidate anything, just validate once against future expected data section size, which would be present somewhere in the header.\n\nThen at RETURNCONTRACT just do one runtime check that expected data section size == actual appended size",
        "created_at": "2023-10-06T10:15:55.818000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "One use that not validating subcontainers would enable is deploying a factory that will be invalid before a fork but deploy valid contrats after a fork.  For example, if an opcode like TSTORE were added and the new factory would be deployed when the network is low costed, then it could deploy newly featured contracts once the fork enables.  Not sure if that is a plus or a minus.",
        "created_at": "2023-10-06T16:54:58.805000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "this sounds like a bug to me, not a feature ðŸ™‚",
        "created_at": "2023-10-06T18:08:22.776000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "btw i realized that SWAP_N_M with 1-byte immediate can actually address 22 stack items, not just 16",
        "created_at": "2023-10-06T18:08:49.425000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Some magic about the higher number being +1 from the lower number?",
        "created_at": "2023-10-06T18:10:12.788000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "right, it's like a triangular number thing. like SWAP_1_1 doesn't mean anything, so you can encode it to do something else",
        "created_at": "2023-10-06T18:10:42.930000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "same with SWAP_2_3 being equivalent to SWAP_3_2",
        "created_at": "2023-10-06T18:10:53.281000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What if M was the closest to the top and N was distance from M?",
        "created_at": "2023-10-06T18:11:29.936000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "so i think it's like the solution to `256 == n * (n+1) / 2` (which is roughly 22)",
        "created_at": "2023-10-06T18:11:33.368000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ah yea, this might be the right encoding",
        "created_at": "2023-10-06T18:11:45.551000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Makes 32 the highest number, but only if you want to bring it to 16. Need a swapagami chart of possible swap pairs.",
        "created_at": "2023-10-06T18:12:33.463000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "hm so it can actually address 32 items deep?",
        "created_at": "2023-10-06T18:16:00.142000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "M - 1-16 (nybble + 1) N - 2*-32 (nybble + M + 2)",
        "created_at": "2023-10-06T18:36:43.174000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "one based stack counting.  index 31, or 32nd item on the stack",
        "created_at": "2023-10-06T18:37:39.082000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "so it seems",
        "created_at": "2023-10-06T18:39:06.260000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "how did we get 2x addressable stack space ðŸ¤¯",
        "created_at": "2023-10-06T18:39:35.712000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "order matters  Dup is still 256 with a single immediate arg",
        "created_at": "2023-10-06T18:39:55.257000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i'm not convinced exchange past 32 items is that useful",
        "created_at": "2023-10-06T18:41:14.290000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "will just add one-byte immediate for now",
        "created_at": "2023-10-06T18:41:27.770000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "33 if we start from 2- (1 is covered by existing swap instructions)",
        "created_at": "2023-10-06T18:42:19.425000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "My instinct is 8 would have us covered.  CALL has 7 args, first dup from deep in the stack, then swap for position.  So 16-32 should be enough.",
        "created_at": "2023-10-06T18:42:55.866000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "sometimes you want to swap things from deeper in the stack ðŸ™‚",
        "created_at": "2023-10-06T18:44:20.217000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "for instance, one of the arguments to CALL is like the 20th item in the stack",
        "created_at": "2023-10-06T18:44:37.816000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But if you swap it you consume it.  Hence dup then swap into final position.  Maybe you do want to consume it.",
        "created_at": "2023-10-06T18:45:25.040000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yea, i should have clarified that you also want to consume it",
        "created_at": "2023-10-06T18:45:51.558000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "btw, this is why swap_n_m is important, because the swap might be the final operation on a stack item before it is consumed. you don't need to do the extra dup and pop operations.",
        "created_at": "2023-10-06T18:47:38.522000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "a couple more observations about EOF:\n- PUSH1-32 instructions can all come down by 1 gas to be the same as PUSH0 because there is no more jumpdest analysis\n- all gas costs could probably come down by an additional 1 gas, because the event loop (theoretically) has less overhead\n- actually why are DUP* and SWAP* one more gas than PUSH0? at least, DUP* does the same amount of work as PUSH0",
        "created_at": "2023-10-06T19:11:21.561000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm hesitant to introduce different gas schedules between EOF and legacy.  PUSH0 was cheaper I beleive because there was no extraction of the immediate from the code, not because push operations pay for legacy validation (I don't think they do)",
        "created_at": "2023-10-06T19:13:27.985000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ethereum/EIPs/pull/7819",
        "created_at": "2023-10-06T19:14:42.730000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yea hm, more opcode space can be freed up btw by deprecating PUSH* instructions in favor of some variant of DATALOADN (which also specifies the number of bytes to copy from data)",
        "created_at": "2023-10-06T19:21:04.857000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ethereum/EIPs/pull/7820",
        "created_at": "2023-10-06T19:26:04.507000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't think we will run out of opcodes in 5-10 years.  Once we are out of 0x4x I think we should push new chain data opcodes to precompiles. We still have all of B, C, and D block.  \n\nOpcode exhaustion could be an impetuous for EOF2, where we transform old EOF1 code with SWAP and DUP and PUSH into immediate forms and then what other breaking changes are needed then, possibly transforming to legacy for some cases .",
        "created_at": "2023-10-06T19:26:07.983000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "most of the 2 and A blocks as well.",
        "created_at": "2023-10-06T19:26:44.894000+00:00",
        "attachments": null
    },
    {
        "author": "big_tech_sux",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(i wrote both of these PRs a bit quickly, happy to polish according to feedback)",
        "created_at": "2023-10-06T19:27:16.540000+00:00",
        "attachments": null
    }
]