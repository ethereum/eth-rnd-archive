[
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@1011612262743679036\u003e can you check this? Seems this is opposite to what you said that CIL didn't require stack height being the same in every point.",
        "created_at": "2023-05-18T10:20:08.023000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "no I said that the max stack height directive is not strict, it requires the bytecode to not exceed it, but it is not required that the actual max stack height reach it",
        "created_at": "2023-05-18T14:20:01.244000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but sure I will look into it and see",
        "created_at": "2023-05-18T14:20:36.180000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "also I have a question regarding Eof, do we do the instruction/stack validation for every codesection ? or for every reacheable codesection ?",
        "created_at": "2023-05-18T14:21:06.971000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is correct, I've found this part in the spec. Sorry I misunderstood your original statement.",
        "created_at": "2023-05-18T14:43:41.039000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We do it for every code section.",
        "created_at": "2023-05-18T14:44:25.630000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How does allowing the max stack height to be higher than consumed help with the de-duplication optimizations?",
        "created_at": "2023-05-18T14:46:41.545000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The code validation prohibits dead code, so every code section must be reachable.",
        "created_at": "2023-05-18T14:47:12.839000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It doesn't. This is an usability feature. E.g. when you write bytecode by hand you can just put max stack height 500 without need of computing precise value.",
        "created_at": "2023-05-18T14:51:34.936000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But it still impacts runtime, right?  If you set your stack requirement to 1023 and you have 10 items on stack at the call site it will still fail validation.",
        "created_at": "2023-05-18T14:53:03.604000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Not useful in the core compiler, but can help with features like solidity verbatim: https://docs.soliditylang.org/en/latest/yul.html#verbatim",
        "created_at": "2023-05-18T14:53:10.336000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, sure.",
        "created_at": "2023-05-18T14:53:41.371000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yul is still going to run code validation, it would be bad ux to allow verbatim to produce invalid code.  Also, they prohibit verbatim in actual solidity, it's yul only.",
        "created_at": "2023-05-18T14:54:25.217000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "having a not very strict maxStackHeight directive in dotnet allowed for some interesting IL manual/auto manipulation post build phase, which was interesting, but I am not sure if relaxing it in EOF will be any useful, unless we expect ppl to be writing evm bytecode manually",
        "created_at": "2023-05-18T14:55:00.686000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you can keep the stack consistent, I would expect a EOF assembler or \"fixer\" to be produced if by hand EOF catches on.  A Fixer would just do stuff like calculate stack heights and inputs/outputs and code section lengths, maybe remove dead code too.",
        "created_at": "2023-05-18T14:56:31.139000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah like inverted validator, instead of extracting the data to check it, it extracts it to set it",
        "created_at": "2023-05-18T14:57:26.877000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But how often is raw IL or java class file work done?  Wherever I've seen it they've always had a hand written packager than calculates all the pre-validation values like stack height.  The user just writes the method bodies and signatures.",
        "created_at": "2023-05-18T14:58:01.032000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We should ask, but solidity verbatim was dome for modified EVMs for some unknown opcodes.",
        "created_at": "2023-05-18T14:58:19.876000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I dont get this question tbh",
        "created_at": "2023-05-18T14:59:02.809000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Swing and a miss with PUSH0 then... https://github.com/hashgraph/hedera-services/blob/a9477c7f3d12027d9909e624049df684bcbd0288/hedera-node/test-clients/src/main/resource/contract/contracts/OpcodesContract/recompile.sh#L1",
        "created_at": "2023-05-18T14:59:28.411000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yul only is quite the restriction.",
        "created_at": "2023-05-18T14:59:59.801000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "some projects that manipulate IL/Bytecode, I think project Lombok in the java ecosystem does some heavy bytecode rewrites and manipulations, and Fody/IL weaving from dotnet's side also does some IL manipulations",
        "created_at": "2023-05-18T15:02:24.457000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Lombok works on the AST, not the bytecode.",
        "created_at": "2023-05-18T15:02:40.618000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "nice, then that leaves IL weaving that works on IL",
        "created_at": "2023-05-18T15:04:00.465000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Groovy used to do runtime bytecode generation for it's call sites before the JVM got a dynamic dispatch opcode.",
        "created_at": "2023-05-18T15:04:25.046000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "interesting stuff tbh, I thought working on bytecode would be easier than working on java's AST, time to delve deeper : D",
        "created_at": "2023-05-18T15:04:35.068000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It allows for a \"de-lombok\" mode where the AST is then outputted.  Some java devs don't like the compiler magic. And some of them are _very_ influential in Java's design.",
        "created_at": "2023-05-18T15:05:36.327000+00:00",
        "attachments": null
    },
    {
        "author": "demiurgos_23",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "makes sense, from the dotnet side I experimented with IL weaving a while ago, and the fact that maxStackHeight being relaxed allowed me to be able to add some instance calls and some extra stuff without worrying about matching the exact value, I had to just make sure I dont exceed it which was simpler",
        "created_at": "2023-05-18T15:08:08.564000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "From the EVM implementation perspective the difference is just `==` vs `\u003c=` in the EOF validation code.",
        "created_at": "2023-05-18T15:59:38.993000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Here's my EVM opcode homework assignment - https://hackmd.io/@shemnon/CancunOpcodeAllocation\nNow is an _excellent_ time to bikeshed opcode ordering.",
        "created_at": "2023-05-18T20:22:05.832000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'll share it into the ACD agenda on monday.",
        "created_at": "2023-05-18T20:22:32.845000+00:00",
        "attachments": null
    }
]