[
    {
        "author": "pdobacz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hey Frangio! There have been some ideas on how to do that, like for example the constrained immediates you mention. Another one which seemed cleanest to me (still not super clean) was to postfix the new opcode with a PUSH1 or PUSH2. This leaves the jumpdest analysis intact, doesn't change behavior of existing contracts and is rather straightforward to implement. OTOH it's quite hacky and a bit wasteful on bytecode. There's a spike PR in evmone and eest trying it out for SWAPN https://github.com/ipsilon/evmone/pull/1251",
        "created_at": "2025-09-08T06:33:28.473000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i've proposed an update to EIP-663 using constrained immediates\n\nhttps://github.com/ethereum/EIPs/pull/10298",
        "created_at": "2025-09-08T12:53:17.711000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "there's also EIP-7912 by \u003c@543900561460822016\u003e which uses a PUSH1 prefix. i agree with \u003c@907931206081990666\u003e that postfix push seems better (it's just \"lookahead\"), and is simpler than what i proposed. the only benefit of what i proposed is shorter bytecode\n\nhttps://eips.ethereum.org/EIPS/eip-7912",
        "created_at": "2025-09-08T12:56:32.206000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "in either case, it seems like SWAPN/DUPN is completely implementable without EOF and i think we should have it in Glamsterdam",
        "created_at": "2025-09-08T13:01:42.765000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "one of the main concerns with the post fix form is that it affects the execution of existing contracts and changes the jumpdest analysis. you would need to look into contracts on chain and verify it is safe to do",
        "created_at": "2025-09-08T13:14:41.521000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the prefix is totally safe because it just uses normal instruction operation",
        "created_at": "2025-09-08T13:14:59.478000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "how does it affect existing contracts or jumpdest analysis? you'd just go from `e6 60 00` meaning `invalid push1 0` to meaning `dupn 0` (rather `dupn 17`)",
        "created_at": "2025-09-08T14:26:44.166000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "postfix push is cleaner because it doesn't require an additional bit of state in the vm to mark the stack item as 'statically pushed', nor to lookahead after a push1 instruction to see if the next one is swapn/dupn. with postfix push you see e6, assert the next byte is 60, read the immediate after it, increment pc by 3",
        "created_at": "2025-09-08T14:32:09.966000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ah, i should clarify, any 'postfix' approach be it with push postfix or with constrained immediates (my 663 pr) must not mask a jumpdest or push opcode that follows the opcode, `e6 5b` has to continue to parse and behave as `invalid jumpdest`",
        "created_at": "2025-09-08T14:58:24.729000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "because you could have jumpdests inside push data that either are valid jumpdests right now or they could become invalid after this change",
        "created_at": "2025-09-08T15:03:53.715000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "there can be no jumpdests inside push data though. push1/0x60 masks the subsequent byte for jumpdest analysis today and it would continue to do so",
        "created_at": "2025-09-08T15:09:12.007000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "oh interesting, sorry i didn't understand the formula at first",
        "created_at": "2025-09-08T15:23:54.993000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "this is pretty neat",
        "created_at": "2025-09-08T15:27:43.623000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i can't come up with any backwards compatibility issues off the top of my head",
        "created_at": "2025-09-08T15:28:02.242000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "are you talking about my EIP-663 PR here? or piotr's postfix-push approach? they're different but both backwards compatible",
        "created_at": "2025-09-08T15:35:47.951000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i'm just looking at your PR",
        "created_at": "2025-09-08T15:42:06.261000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "or more generally the idea of reinterpretting the immediate data to avoid backward compat issues",
        "created_at": "2025-09-08T15:42:35.860000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah this is a general recipe for immediates, just avoid those values and reinterpret",
        "created_at": "2025-09-08T15:46:56.579000+00:00",
        "attachments": null
    },
    {
        "author": "frangio_",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@425279588009246720\u003e \u003c@408154589494247424\u003e can you review the PR and see if you accept these changes to EIP-663? https://github.com/ethereum/EIPs/pull/10298",
        "created_at": "2025-09-08T15:51:40.512000+00:00",
        "attachments": null
    }
]