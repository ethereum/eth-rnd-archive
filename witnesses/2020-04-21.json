[
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I added numbering to the chapters and merged 2 chapters together: https://github.com/ethereum/stateless-ethereum-specs/pull/28",
        "created_at": "2020-04-21T11:07:47.443000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "btw, re: big endian vs little endian, I don't have a strong opinion there (we do use big-endian encoded as CBOR does it), I can merge the outstanding PR",
        "created_at": "2020-04-21T11:10:00.287000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\n  Major type 0:  an unsigned integer.  The 5-bit additional information\n      is either the integer itself (for additional information values 0\n      through 23) or the length of additional data.  Additional\n      information 24 means the value is represented in an additional\n      uint8_t, 25 means a uint16_t, 26 means a uint32_t, and 27 means a\n      uint64_t.  For example, the integer 10 is denoted as the one byte\n      0b000_01010 (major type 0, additional information 10).  The\n      integer 500 would be 0b000_11001 (major type 0, additional\n      information 25) followed by the two bytes 0x01f4, which is 500 in\n      decimal.\n```",
        "created_at": "2020-04-21T11:10:03.680000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "cbor encoding of uints",
        "created_at": "2020-04-21T11:10:10.074000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "My 2 cents: I wouldn't mix in parts of CBOR if CBOR is not used in general for fields. Some variable lenght encoding scheme seems more appropriate.",
        "created_at": "2020-04-21T11:10:55.789000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We use it for all variable-length fields in our turbo-geth implementation at the moment (everything fixed length is just big-endian bytes).",
        "created_at": "2020-04-21T11:17:26.517000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "namely, opcodes, masks and hashes are fixed-length fields and keys, nonces, balances and values are usually variable lengths",
        "created_at": "2020-04-21T11:18:16.236000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "so in turbo-geth we just CBOR all the variable-length numbers and byte arrays. it provides quite compact representation and there are multiple implementations of encoder/decoder for many languages",
        "created_at": "2020-04-21T11:20:12.009000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I like CBOR for encoding complex structures, but it seems overly complex (compared to LEB128 or its ilk) for just number encoding.",
        "created_at": "2020-04-21T11:42:58.905000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(Obviously personal opinion ^^)",
        "created_at": "2020-04-21T11:43:18.021000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I think it is an overkill, I just want something that also have good implementations in multiple languages. what would you suggest here?",
        "created_at": "2020-04-21T11:57:31.942000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Probably LEB128 because it is used widely.",
        "created_at": "2020-04-21T11:57:57.122000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I will read up and probably replace little endian with it (cc \u003c@682078300234973185\u003e)",
        "created_at": "2020-04-21T12:01:10.065000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thanks!",
        "created_at": "2020-04-21T12:01:31.426000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have some other suggestions and created changes locally, planning to push a PR. Is that a good approach or would you guys prefer an issue instead?",
        "created_at": "2020-04-21T12:01:58.668000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I would prefer PRs (more illustrative) but I donâ€™t have a strong opinion.",
        "created_at": "2020-04-21T12:05:01.571000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Also, if you or anyone else knows a good spec that we should borrow ideas from, I would love to read it ðŸ™‚",
        "created_at": "2020-04-21T12:05:38.036000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ideas as in doc structure, etc",
        "created_at": "2020-04-21T12:05:56.511000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The closest in aim I would say is the webassembly spec: https://webassembly.github.io/spec/core/_download/WebAssembly.pdf",
        "created_at": "2020-04-21T12:12:33.506000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!520564582196969472\u003e Good point about also using variable-length integers for balances and nonces. This is a non-negligible size optimization.",
        "created_at": "2020-04-21T12:19:31.894000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e namely, opcodes, masks and hashes are fixed-length fields and keys, nonces, balances and values are usually variable lengths\n\nOh, actually that was one of my PRs. Won't submit it then.",
        "created_at": "2020-04-21T12:20:01.755000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thought I would argue it is not as useful for balances as those are usually in the ether range, which is too many bytes for LEB128 to be efficient.\n\nFor nonces it makes sense.",
        "created_at": "2020-04-21T12:20:38.458000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "A problem with LEB128 is that there are multiple ways to encode numbers, and it would be better for us to have a unique encoding for each number. Another variable-length integer encoding, VLQ, has ways to avoid this problem. I will look into this.",
        "created_at": "2020-04-21T12:23:02.926000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What do you mean by multiple ways? That one can pad it with zeroes? Or that signed numbers requires special consideration? I think we don't need signed numbers though.",
        "created_at": "2020-04-21T12:23:42.703000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The padding in particular. I don't know if there is anything else.",
        "created_at": "2020-04-21T12:24:23.971000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "VLQ as used in ASN.1 has the same problem as well. That's why there is a strict version of ASN.1 saying padding is disallowed.\n\nCannot we just do the same with LEB128?",
        "created_at": "2020-04-21T12:25:02.427000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, I hope that we can do the same with LEB128.",
        "created_at": "2020-04-21T12:26:27.158000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For balances, I agree that there may be something better than LEB128. Maybe we should start with LEB128, then we can measure improvements with alternatives, relative to test data.",
        "created_at": "2020-04-21T12:28:40.649000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\"Doing it\" in my mind is as much as stating \"LEB128 encoding must use the shortest encoding possible. Padding is strictly disallowed.\"\n\nBut probably you guys want to come up with some strict formal description of LEB128 without padding.",
        "created_at": "2020-04-21T12:28:46.682000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes. And making it strict may be simpler with VLQ than with LEB128. I don't know yet.",
        "created_at": "2020-04-21T12:30:47.985000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "IIRC VLQ starts with most-significant bits of the input, while LEB128 with the least-significant.\n\nIf that is the case, why do you think it is simpler to \"restrict\"?",
        "created_at": "2020-04-21T12:32:17.365000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(At least the VLQ used in ASN.1 PER/BER)",
        "created_at": "2020-04-21T12:34:36.397000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I was thinking that it is simpler to restrict the most significant bits when they are at the beginning. But I don't know yet.",
        "created_at": "2020-04-21T12:35:20.811000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Fair point",
        "created_at": "2020-04-21T12:38:51.491000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "so, I'm looking at the wasm spec, and my \"substitution rules\" that I used to have is basically the same as \"reduction rules\" in \"4.1.2 Formal Notation\"",
        "created_at": "2020-04-21T12:58:07.769000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I wonder if we can add an \"Execution\" section to our spec as well",
        "created_at": "2020-04-21T13:00:44.958000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The Wasm reduction rules are over an \"abstract syntax\", which we don't have.",
        "created_at": "2020-04-21T13:09:38.468000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Wasm doesn't use reduction rules for parsing.",
        "created_at": "2020-04-21T13:12:03.540000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think that reduction rules could be useful.",
        "created_at": "2020-04-21T13:12:26.230000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I drafted how the intro section might look like if we take wasm spec as a goal: https://github.com/ethereum/stateless-ethereum-specs/blob/change-goals-structure/witness.md",
        "created_at": "2020-04-21T13:26:35.045000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!520564582196969472\u003e This overhauled introduction section is much better.",
        "created_at": "2020-04-21T13:35:01.789000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Cool! Iâ€™ll spend some time on it tomorrow and submit a PR",
        "created_at": "2020-04-21T13:49:56.639000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Crazy idea for balance: encode `balance - 0.1eth` as a signed value. This is based on the hunch that most balances are close to the 0.1eth value. Whether most values are close 0.1eth can be verified via checking the blockchain state. The main problem with this attempt at compression is that average balance can shift over time as ether/fiat price increase/decreases significantly.",
        "created_at": "2020-04-21T14:50:57.530000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If `balance\u003c0.1eth`, then `balance - 0.1eth` has many leading 1's in two's complement, which cost many bytes.\n\nIf `balance\u003e=0.1eth`, then `balance - 0.1eth` may save some bits.\n\nNot sure whether the savings outweigh the cost for the average block (which, as you say, may change with time). Still an interesting idea.",
        "created_at": "2020-04-21T15:31:00.546000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I didn't mean two's complement specifically, but that there is a single sign bit and the rest is encoded as a positive number, e.g. not many leading ones.",
        "created_at": "2020-04-21T15:44:40.649000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Aha, yes, then you are right, this is a good idea to try.",
        "created_at": "2020-04-21T15:46:19.443000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is a random idea, probably premature optimisation and likely it is much easier to verify any of these ideas if we have some (standardised) test data to play with.",
        "created_at": "2020-04-21T15:47:03.947000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I am working on standardized test data. Yes, one of the motivations is to measure optimizations like this.",
        "created_at": "2020-04-21T15:49:18.846000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "well, as we saw in the charts, the keys and values at the leaves currently represent not very significant proportion of the witness size. So optimisations like that would indeed seem premature",
        "created_at": "2020-04-21T15:59:14.875000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://eips.ethereum.org/EIPS/eip-1985 could also help with setting new, lower limits",
        "created_at": "2020-04-21T16:00:31.017000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!425279588009246720\u003e I really like that EIP.  It would allow us to do some C-level optimizations in our python code that currently aren't trivial to do since things *can* be bigger that 64 bit.",
        "created_at": "2020-04-21T18:05:42.239000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "God job. You tricked me into necroing that discussion.  :P",
        "created_at": "2020-04-21T18:46:25.349000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!520564582196969472\u003e \u003c@!682078300234973185\u003e what is the metadata used for?",
        "created_at": "2020-04-21T19:00:57.969000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`\u003cTree\u003e := 0xbb m:\u003cMetadata\u003e n:\u003cTree_Node(0)\u003e` this one?",
        "created_at": "2020-04-21T19:02:46.607000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes",
        "created_at": "2020-04-21T19:02:53.526000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I see it is a key-value storage, but not sure what it is used for",
        "created_at": "2020-04-21T19:03:24.325000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't remember having it in my version of the spec...",
        "created_at": "2020-04-21T19:03:30.514000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!682078300234973185\u003e did you have something specific in mind or was it here just in case?",
        "created_at": "2020-04-21T19:03:49.274000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(I'm also half asleep already so I might just not remembering something)",
        "created_at": "2020-04-21T19:08:19.389000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!520564582196969472\u003e shouldn't feel compelled to respond late (it is like 10pm over there?)",
        "created_at": "2020-04-21T19:08:50.729000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes. Metadata makes it easier to specify and implement new features and versions. For example, (i) witness chunking could use Metadata to give the prefix or nibble-depth of each chunk, (ii) sync protocols may use Metadata to give details, and (iii) the Metadata section can be used to encode the tree if we abandon the Tree_Node encoding.",
        "created_at": "2020-04-21T19:10:16.339000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Metadata can be dropped. But it adds only one byte of overhead per tree, so I propose we leave it for now.",
        "created_at": "2020-04-21T19:11:09.257000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "One more nitpick: while a lot of the notation is explained in 3.1, two symbols are not: //, %.",
        "created_at": "2020-04-21T19:11:41.724000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Maybe we can add a short note about metadata so it isn't confusing.",
        "created_at": "2020-04-21T19:12:19.553000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, it's 2212 at my time, but I just was nearby my computer with Discord open ðŸ˜„",
        "created_at": "2020-04-21T19:12:56.291000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And I am a bit confused about what is the meaning of parenthesis here: `\u003cAccount_Storage_Tree_Node(d\u003c65)\u003e`\n\nParenthesis are explained for tuples in 3.1.\n\nLet me know if these questions have been covered before, this is not the place to ask them, or I am becoming annoying ðŸ˜‰",
        "created_at": "2020-04-21T19:14:08.193000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, floor division `//` and modulo `%` are not defined, I will add it to my todo list, but maybe someone will get to this before me. But `^` is defined in the context of `^n`, `^+`, and `^*`.",
        "created_at": "2020-04-21T19:14:47.102000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, found `^` afterwards. Also found `(d\u003c65)` now.",
        "created_at": "2020-04-21T19:15:08.217000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Maybe one comment, 3.1. consistently uses `n` while the spec consistently uses `d`. Using the same symbol could be useful.",
        "created_at": "2020-04-21T19:16:23.145000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, parentheses are used for two things -- abuse of notation. But we already use the various brackets, `\u003c\u003e(){}[]`. I will add it to my todo list, but maybe someone will get to it before me.",
        "created_at": "2020-04-21T19:18:19.888000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, we use arbitrary variable names `n` and `d` . I am actually considering merging the account tree and storage trees, which will add new notation but reduce the number of syntax rules. So this problem may go away. But I made a note of this.",
        "created_at": "2020-04-21T19:20:29.664000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Another nitpick: `\u003cByte_Nonzero\u003e`, `\u003cByte_More_Than_One_Bit_Set\u003e`, `\u003cByte_Lower_Nibble_Zero\u003e` are listed under \"non-terminal types\", but they seem to be terminal to me.",
        "created_at": "2020-04-21T19:21:22.902000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The only terminals are `0x00`, `0x01`, ..., `0xff`.",
        "created_at": "2020-04-21T19:22:10.828000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Right, I think I was confused by the headings under 3.2, where you start with `\u003cByte\u003e`. Btw, should \"represented in hexary notation\" not say hexadecimal?\n\nThese questions may be dumb I apologise.",
        "created_at": "2020-04-21T19:26:49.516000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, I suppose that hexadecimal is more standard. Added to my todo list, but I hope that you will get to this before me.",
        "created_at": "2020-04-21T19:31:11.182000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Fun fact: it takes ~90194 ether to exhaust a 32-bit nonce counter, if nonces start at 0.\n\n(The morden (?) testnet used 10000 (?) as a starting point to distinguish between mainnet accounts, before replay protection was introduced much later.)\n\nAssuming the cheapest transaction is 21000 gas and 1 gwei gas price: `(((2^32 - 1) * 21000) * 1000000000 [gwei]) / 1000000000000000000 [eth]`",
        "created_at": "2020-04-21T19:38:15.839000+00:00",
        "attachments": null
    }
]