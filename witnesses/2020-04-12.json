[
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It looks like we can parse the prefix witness by the existing code with minimal changes, if we just traverse it backwards. I implemented the code here:  https://github.com/ledgerwatch/turbo-geth/compare/prefix-witness-parse-backwards\n\nIt will lose streamability of course.\nBut I don't think it is a big problem because we want to split it to chunks and propagate chunks around.\nThat way it doesn't matter if we can stream a single chunk or not.",
        "created_at": "2020-04-12T10:44:53.392000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This code is PoC, it creates prefix witnesses for the mainnet, and runs blocks using them. It is the same way we tested all our algorithms.\nI tested it successfully on first 900.000 first blocks, it works (the test is still running in background).",
        "created_at": "2020-04-12T10:51:08.537000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!682078300234973185\u003e \u003c@!689635476826619924\u003e \u003c@!364458974906548225\u003e and \u003c@456226577798135808\u003e \nI tried to come up with the goals of the specification document itself, so we can be on the same page about it. \n\nI keep the PR open to get your feedback and align these goals. If you feel like they are okay, please leave `+` as a comment to this PR.\nOtherwise, I'm open to any feedback.\n\nhttps://github.com/ethereum/stateless-ethereum-specs/pull/19",
        "created_at": "2020-04-12T12:52:58.058000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!520564582196969472\u003e I have added a comment to your PR on goals with 2 additional goals of formal analysis and reference tests.",
        "created_at": "2020-04-12T14:01:38.285000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!520564582196969472\u003e I always thought that the Merkle proofs do not contain the Trie root. A candidate Merkle root is computed using the data provided and its Merkle proof, which is then matched against an expected root. But I see in the high-level algorithm that len(witness) is checked with 1, and also correspondingly defined in the section on â€œSuccess criteria: a single trie\". If my understanding is correct, even when there is one trie to be constructed, the proofs can end up with multiple nodes in the top. In fact, there should be 15 nodes.",
        "created_at": "2020-04-12T15:23:26.510000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "our block witness always builds a trie with a single root, the root branch node (or an extension if there is only one child) is always included",
        "created_at": "2020-04-12T15:26:22.613000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "it is basically a subset of  the state/account trie that is used for normal block execution",
        "created_at": "2020-04-12T15:27:19.496000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "with some paths replaced by hashes",
        "created_at": "2020-04-12T15:27:25.921000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "at least we need to know which children are non-nil in subtrie roots if we want to be able to do subtrie-based witness chunking",
        "created_at": "2020-04-12T15:35:36.155000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I see that the API eth_getProof does return the root along with other data.",
        "created_at": "2020-04-12T15:36:10.528000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e \u003c@!520564582196969472\u003e I have added a comment to your PR on goals with 2 additional goals of formal analysis and reference tests.\n\n\u003c@!689635476826619924\u003e hmm, I don't see that comment ðŸ˜¦ can you double-check? maybe it is github being annoying...",
        "created_at": "2020-04-12T15:39:05.514000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e at least we need to know which children are non-nil in subtrie roots if we want to be able to do subtrie-based witness chunking\n\u003c@!520564582196969472\u003e Yes, that merits a BranchNode with a bitmask at the top, that too with a special way to treat that the data is sitting in a special place. For example, BRANCH {0b 0000000000000001, 4} shows that there is one subtrie as the last child, and the data being checked should be placed at 4.",
        "created_at": "2020-04-12T15:39:59.169000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have now updated my comment to your PR by tagging you. Hopefully you should see it now.",
        "created_at": "2020-04-12T15:41:21.751000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I can see for sure",
        "created_at": "2020-04-12T15:41:29.084000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ðŸ˜¦",
        "created_at": "2020-04-12T15:43:15.983000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "unknown.png",
                "content": "ab4a7428a08f0cae62ca93edc452703303065f8dba707095b3c4eb6c109fd138"
            }
        ]
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have left a comment inside the files. Please click on \"files changed\"",
        "created_at": "2020-04-12T15:43:47.552000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "nope, empty",
        "created_at": "2020-04-12T15:45:39.038000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "unknown.png",
                "content": "a07d66b6418645f2bff566ae5cfb16f3f009d940247e18d1d844441e0bab56cb"
            }
        ]
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "maybe github is having some sharding issues...",
        "created_at": "2020-04-12T15:46:40.159000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ah, now I see it",
        "created_at": "2020-04-12T15:47:06.834000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah, those are good ones, I'll add them",
        "created_at": "2020-04-12T15:47:37.046000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Can GUARD be anything other than NBITSET(mask) == k OR has_code == bool has_storage == bool?",
        "created_at": "2020-04-12T15:49:21.317000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Q2. Is it possible to get a dump of eth_getProof of a specific address, and some storage locations? This will help us see real Merkle proofs and crosscheck the witness spec.",
        "created_at": "2020-04-12T15:56:15.107000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Nope. Keep in mind that these GUARD statements are not part of the witness format, they are parts of the witness parsing algorithm.",
        "created_at": "2020-04-12T15:58:46.963000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, I get it. It is part of the fixed substitution rules, that help interpret the witness instructions.",
        "created_at": "2020-04-12T15:59:24.559000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "A2: Probably. I didnâ€™t use that api that much.",
        "created_at": "2020-04-12T16:00:24.124000+00:00",
        "attachments": null
    },
    {
        "author": "mandrigin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "you need a block number and storage/account addresses",
        "created_at": "2020-04-12T16:00:52.676000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, any block number / storage / account address should do, as long as we can verify that proof. I don't see any api for verifying a proof!",
        "created_at": "2020-04-12T16:02:28.058000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!689635476826619924\u003e you would need to write quite a lot of code to try to verify the correspondence between multiple eth_getProof calls and one witness. Not sure it is worth the effort",
        "created_at": "2020-04-12T16:04:06.849000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But, how has \u003c@!520564582196969472\u003e tested them on Eth1 blocks?",
        "created_at": "2020-04-12T16:06:40.676000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I thought it involved querying using eth_getProof API.",
        "created_at": "2020-04-12T16:09:18.656000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "no, the witness are not related to eth_getProof API",
        "created_at": "2020-04-12T16:10:09.221000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we have re-executed all historical transactions based on the generated witnesses",
        "created_at": "2020-04-12T16:10:24.613000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "to make sure that the root hash matches the header state root, and that all operations succeed and produce expected result",
        "created_at": "2020-04-12T16:10:49.221000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that's why performance is important, otherwise it would be impractical to do such backtesting",
        "created_at": "2020-04-12T16:11:51.141000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What exactly is the definition of witness? I was assuming that witnesses correspond to Merkle proofs",
        "created_at": "2020-04-12T16:14:29.583000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "From this post: https://ethresear.ch/t/the-stateless-client-concept/172",
        "created_at": "2020-04-12T16:15:08.656000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e we have re-executed all historical transactions based on the generated witnesses\n\u003c@456226577798135808\u003e How was witnesses generated?",
        "created_at": "2020-04-12T16:19:37.496000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we have code in turbo-geth that can generates witnesses as we process the blocks",
        "created_at": "2020-04-12T16:20:16.918000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "this was first implemented, and then specified ðŸ™‚",
        "created_at": "2020-04-12T16:21:09.044000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You mean for the part of the data that the block accessed. Do you have separate read-witness and write-witness?",
        "created_at": "2020-04-12T16:21:37.714000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes. no.",
        "created_at": "2020-04-12T16:22:05.304000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Please point me to the specific function inside turbo-geth that generates witnesses. Is it not a multi-Merkle proof for the data that the block accesses?",
        "created_at": "2020-04-12T16:23:33.366000+00:00",
        "attachments": null
    },
    {
        "author": "80raghavendra",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "From this definition from Vitalik https://ethereum-magicians.org/t/protocol-changes-to-bound-witness-size/3885, it should be.",
        "created_at": "2020-04-12T16:24:08.646000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ledgerwatch/turbo-geth/blob/master/trie/witness_builder.go#L38",
        "created_at": "2020-04-12T16:25:30.225000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes, it is a multi-merkle proof for the data that the block accessed",
        "created_at": "2020-04-12T16:25:51.333000+00:00",
        "attachments": null
    }
]