[
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "Hi all, we published a retrospective on the eth2 mainnet incident this past weekend https://medium.com/prysmatic-labs/eth2-mainnet-incident-retrospective-f0338814340c?source=social.tw\u0026_branch_match_id=871038082114616044",
        "created_at": "2021-04-29T01:12:09.299000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "happy to answer any questions",
        "created_at": "2021-04-29T01:12:18.100000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "Am I understanding correctly that the affected prysm clients were voting for the invalid blocks, but rest of the network wasn‚Äôt? Do you know what % of validators were on avg voting for the invalid blocks?",
        "created_at": "2021-04-29T02:34:33.270000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "Over 2/3rds \u003c@!543900561460822016\u003e",
        "created_at": "2021-04-29T03:56:14.267000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "actually scratch that, i think it was 65%",
        "created_at": "2021-04-29T03:56:29.086000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "They were voting on an invalid deposit tree root for the validator deposit contrac",
        "created_at": "2021-04-29T03:57:01.447000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "contract*",
        "created_at": "2021-04-29T03:57:03.201000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "so 1% from finalizing an invalid deposit root?",
        "created_at": "2021-04-29T03:58:01.258000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "No because the block proposals were failing",
        "created_at": "2021-04-29T03:58:44.685000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "prysm validators could not propose blocks because deposit proofs were failing",
        "created_at": "2021-04-29T03:58:54.599000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "oh because the root was already voted in correctly, but the validators weren't getting activated because the prysm proofs were invalid?",
        "created_at": "2021-04-29T03:59:36.650000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "so thankfully, the invalid root never became a canonical one in the beacon chain state",
        "created_at": "2021-04-29T03:59:57.610000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "validators were trying to vote on that deposit tree root, but their block proposals were failing",
        "created_at": "2021-04-29T04:00:12.761000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "haha i'm sorry, i still don't understand why it didn't canonicalize? if the other prysm nodes were voting for the invalid blocks, what do you mean the block proposals failed?",
        "created_at": "2021-04-29T04:03:26.900000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "apologies, it's getting a bit late here so might be miscommunicating this...lemme rewind a bit",
        "created_at": "2021-04-29T04:04:22.536000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "so the first thing that happened was we noticed a lot of block proposals were failing on mainnet",
        "created_at": "2021-04-29T04:05:17.796000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "no no, i'm quite confident the misunderstanding is just on my end not looking into eth2  as much recently üôÇ",
        "created_at": "2021-04-29T04:05:33.878000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "throughout the duration of the incident, a huge amount of blocks were not be proposed",
        "created_at": "2021-04-29T04:05:36.114000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "and the error was something like \"deposit proof for deposit in block failed to verify\"",
        "created_at": "2021-04-29T04:05:50.867000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "upon deeper inspection, it turns out somebody voted for an invalid, corrupt deposit tree root, and Prysm nodes which saw that also voted on that deposit tree root",
        "created_at": "2021-04-29T04:06:33.420000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "Blocks produced by such prysm nodes were failing to verify by the rest of the network because they had deposits with invalid deposit proofs",
        "created_at": "2021-04-29T04:09:32.720000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "I think during the incident, you had almost half of all block proposals missing",
        "created_at": "2021-04-29T04:09:56.525000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "if we didn't have those missing block proposals, the invalid root could have canonicalized",
        "created_at": "2021-04-29T04:10:24.433000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "i think this is were i am slightly lost as to why if the majority (2f+1?) of nodes were proposing something (invalid or not) did it not canonicalize?",
        "created_at": "2021-04-29T04:10:48.341000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "Ah I see what you mean",
        "created_at": "2021-04-29T04:12:04.038000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "we can also pick this up tomorrow, don't let me keep you up",
        "created_at": "2021-04-29T04:12:32.560000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "sounds good, we'll get someone from our team to answer here",
        "created_at": "2021-04-29T04:12:51.033000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "nice work sorting it out so quickly regardless",
        "created_at": "2021-04-29T04:13:18.580000+00:00",
        "attachments": null
    },
    {
        "author": "raulj",
        "category": "general",
        "parent": "",
        "content": "thank you! was indeed a rough time getting to the main cause",
        "created_at": "2021-04-29T04:14:16.572000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "So we did not canoncalize because at the boundary it failed to propose a block. Basically at the boundary, in order for the vote to become the majority, \n-\u003e we need to add that proposer's vote ( which makes it the majority)\n-\u003e Now that the vote is a majority, you need to pack in deposits specified by that eth1 tuple( blockhash, deposit root, deposit count)\n\nGiven that the deposit root voted in is invalid, any proof that is created for that deposit will also be invalid. So you end up with block proposals failing",
        "created_at": "2021-04-29T04:18:34.634000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "so if the boundary proposer would have been prysm, it would have canonicalized?",
        "created_at": "2021-04-29T04:19:32.021000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "No it cant be canoncalized",
        "created_at": "2021-04-29T04:19:42.865000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "because the moment you vote in a new eth1data, you have to include the specified deposits. And for each \ndeposit you have an attached proof",
        "created_at": "2021-04-29T04:20:15.217000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "If the proof is bad, the block becomes bad",
        "created_at": "2021-04-29T04:20:27.276000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "To confirm my understanding - other clients continued to produce blocks because they only voted for a valid eth1 vote so never cast the vote that ticked over to 50%.",
        "created_at": "2021-04-29T04:20:28.315000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "^ +1",
        "created_at": "2021-04-29T04:20:34.307000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "but prysm nodes were thought the bad proofs were good, or do i misunderstand?",
        "created_at": "2021-04-29T04:21:11.249000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "The proof is generated at the time of block proposal, when deposit logs are emitted, no proofs are attached",
        "created_at": "2021-04-29T04:22:04.846000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "So during proof generation with a bad deposit root it fails",
        "created_at": "2021-04-29T04:22:37.032000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "That's an interesting point.  If the proposer casting the last required eth1 vote also had a corrupted eth1 cache (same as the first proposer who created the invalid vote), then shouldn't they get a deposit root that matches after including the deposit and thus be able to produce the block?",
        "created_at": "2021-04-29T04:23:06.896000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "So how we pack in deposits, is determined by the last added deposit into the state",
        "created_at": "2021-04-29T04:23:57.868000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "since the bad trie (had an off by 1). The way that it includes deposits would have been for the wrong deposit index. And the proof fails for that during deposit verification",
        "created_at": "2021-04-29T04:25:01.699000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "I'm wrong about this btw. üôÇ You don't verify the deposit in blocks against the merkle trie you built, just verify the proof lines up with the eth1 data deposit root.",
        "created_at": "2021-04-29T04:25:27.362000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Yeap, that is correct ^ , otherwise state transitions would have to have a persistent knowledge of the deposit trie",
        "created_at": "2021-04-29T04:26:41.854000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "ah ok, that makes sense. Also slightly lucky, theoretically a node that has a deposit missing from it's merkle trie should be able to produce a valid proof back to the root it has, even if that root doesn't match what the actual deposit contract has.",
        "created_at": "2021-04-29T04:26:56.949000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Yeah, its all the off by ones here üôÇ",
        "created_at": "2021-04-29T04:28:00.340000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Although maybe having a bit more stringent deposit root verification would be useful , but the tradeoff would be a bigger state",
        "created_at": "2021-04-29T04:29:37.705000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Probably easiest solution is to just merge eth1 and eth2 and be done with it all. üôÇ",
        "created_at": "2021-04-29T04:30:52.728000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "+1 , I am pretty much done with all eth1 voting now lol",
        "created_at": "2021-04-29T04:31:19.034000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Although, won't be done with it in the initial merge but eventually.",
        "created_at": "2021-04-29T04:31:22.438000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Yeah eth1 was not a fun little endeavour for us.  Though our problems were mostly around the interaction with eth1 nodes just to get the deposits reliably.",
        "created_at": "2021-04-29T04:32:24.369000+00:00",
        "attachments": null
    },
    {
        "author": ".paulharris",
        "category": "general",
        "parent": "",
        "content": "'little endeavour' LOL",
        "created_at": "2021-04-29T04:33:27.159000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "okay so say a prysm client produced a block at slot `N`, a nimbus client produced a block at `N+1`, and  a then another prysm client produced a block at `N+2`, the `N+2` block the parent block would be `N`?",
        "created_at": "2021-04-29T04:34:59.773000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "We didnt even produce the block in the incident",
        "created_at": "2021-04-29T04:35:29.828000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "before we broadcast a block, you have to verify that it is a valid state transition",
        "created_at": "2021-04-29T04:35:46.398000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "and there is where it fails",
        "created_at": "2021-04-29T04:35:52.333000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "oh okay, so then there was no way an invalid root could've canonicalized?",
        "created_at": "2021-04-29T04:36:04.292000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Yeap correct, wouldnt say no way, but all block proposals pretty much failed. So \n`N` Teku/Lighthouse/Nimbus , `N+1` Prysm ( but failed) , so `N+2` will have `N` as its parent",
        "created_at": "2021-04-29T04:37:31.424000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "thanks for explaining üôÇ",
        "created_at": "2021-04-29T04:37:54.503000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "No prob, anytime üëç",
        "created_at": "2021-04-29T04:38:42.022000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "general",
        "parent": "",
        "content": "\u003c@!476250636548308992\u003e this makes me curious - would it make sense to create a \"standard\" list of deposit tests that should lead to certain outcomes with eth1 votes, that could be added to the common test suite? or was this more of a prysm-specific quirk?",
        "created_at": "2021-04-29T19:41:02.036000+00:00",
        "attachments": null
    },
    {
        "author": "shrederz",
        "category": "general",
        "parent": "",
        "content": "why is it that prysm has majority of client share",
        "created_at": "2021-04-29T19:47:47.680000+00:00",
        "attachments": null
    },
    {
        "author": "mohamed.mansour",
        "category": "general",
        "parent": "",
        "content": "Whales with hundreds validators, shares same language with geth, easy to install and manage, users enjoyed the documentation,  staking pools, dappnode, who knows  ‚Ä¶ maybe color scheme was cool üôÇ \n\nWhen people decide to stake  ETH2, you get presented with a set of ETH1 Nodes and ETH2 nodes to choose,  there is no banner saying which is the minority. Then economically speaking, why would you choose a node which is 1% popular over 60%?\n\nIf there was incentives to switch, like you get better rewards with clients that are less popular, that could be one avenue that would be interesting to explore.",
        "created_at": "2021-04-29T21:54:13.782000+00:00",
        "attachments": null
    },
    {
        "author": "chris2_2_2",
        "category": "general",
        "parent": "",
        "content": "Thats an issue with ETH1 that I think people were hoping ETH2 would fix. Without diversity across all 4 clients you have some clients falling behind others (as there is no focus on them) while the whole network relies on 1 client being absolutely perfect",
        "created_at": "2021-04-29T22:40:13.610000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Teku actually does consistently generate better attestation rewards, though the difference is small.  Client diversity is definitely better in eth2 than eth1 but we need people to actually evaluate clients and not just go with what everyone's using. I've seen people chose clients based on the number of github stars so these things kind of snowball...  Prysm did an excellent job of being in early and engaging the community early (and continue to engage the community well, though all clients have stepped that up now).",
        "created_at": "2021-04-29T22:45:15.163000+00:00",
        "attachments": null
    },
    {
        "author": "chris2_2_2",
        "category": "general",
        "parent": "",
        "content": "If the goal is to maintain a diversity among all 4 could there be a small bonus reward distributed equally among all 4 clients to incentivize people to use the minority? Post 1.0 there is a large decrease in issuance anyway so adding a little more is still a big drop.",
        "created_at": "2021-04-29T22:48:14.607000+00:00",
        "attachments": null
    },
    {
        "author": "ssh4098",
        "category": "general",
        "parent": "",
        "content": "there's really no good way to enforce this",
        "created_at": "2021-04-29T22:52:45.694000+00:00",
        "attachments": null
    },
    {
        "author": "ssh4098",
        "category": "general",
        "parent": "",
        "content": "(unless maybe you want to rely on SGX and similar things)",
        "created_at": "2021-04-29T22:53:50.975000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "That sounds like a good idea to me, having a standard set of voting tests would be useful here. Given a set of deposits and its relevant eth1block/time , you could test around the majority vote function. \n\nFor us this would have caught our voting bug, although not the initial one that triggered it.",
        "created_at": "2021-04-29T23:02:33.675000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Oh \u003c@476250636548308992\u003e woke up! We need you on \u003c#826479341784662056\u003e üòÜ",
        "created_at": "2021-04-29T23:03:25.409000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Haha, yeap talking with terence now on it",
        "created_at": "2021-04-29T23:04:09.814000+00:00",
        "attachments": null
    }
]