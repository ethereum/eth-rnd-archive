[
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "All clients have whitelisting. If you have a change in your pool you won't take others",
        "created_at": "2022-12-23T02:31:36.886000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "\u003c@340345049063882753\u003e I think the issue of when to start gossiping is a subtle one. I'd like to get your input on this again. I want to allow prysm to take these messages before Capella. The reason being that I think it's important to give users the option to favor whatever message they want to send first (of course large pools and hacked accounts are the main consumers of this). Gossiping has nothing to do with this so far. We will allow the local endpoint to take these changes before Capella. The issue comes now with broadcasting. The easiest to allow the above from an engineering perspective is to simply check signatures all the time as if the head state is capella. But then if you're subscribed (say an epoch before the fork) you'll get these messages and you'll import them. This puts us in a tight spot: if we broadcast our messages we may doom them to not be included at all by other clients and if we don't we risk taking the hackers messages (they won't care broadcasting earlier) in every prysm instance. So I believe it'll be better if we coordinate on not taking any message before the fork or taking them all as long as they are signed as Capella. I like the second better to spread the initial burst",
        "created_at": "2022-12-23T02:38:54.070000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Iâ€™m not overly fussed what the solution is to be honest. I think the current state of gossip validation is pretty ridiculous and we should always use the fork the gossip topic is for when validating. BLS changes are a bit special in that they donâ€™t specify a slot or epoch so become invalid when the next fork kicks in but that just affects the policy of what to keep vs prune in the pool, not what to accept on gossip.",
        "created_at": "2022-12-23T02:42:21.517000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "If we can get agreement on it Iâ€™d say it makes sense to either validate bls change gossip based on the topic itâ€™s received on (ideal case) or ensure the fork used to verify is at least Capella (or if head state is bellatrix, use Capella, otherwise use head state). \nThen for pruning the operation pool youâ€™d discard any change thatâ€™s from a fork prior to the one being activated (and hence wouldnâ€™t drop anything when Capella activates because they were all validated against Capella).",
        "created_at": "2022-12-23T02:44:45.843000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I'm fine with the first option in this message. The second is exactly what's already implemented in prysm",
        "created_at": "2022-12-23T02:45:42.424000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Both will be good for me",
        "created_at": "2022-12-23T02:45:49.163000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "If youâ€™re accepting changes on rpc early you may need to add code to broadcast to gossip when you subscribe to that topic but itâ€™s probably ok to only start accepting when you have subscribed which is still going to be an epoch or two before it actually activates",
        "created_at": "2022-12-23T02:45:49.266000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Should be easy to implement either in teku as well. In fact we used to always use the fork for the gossip topic and had to change to avoid other clients scoring us down because they didnâ€™t.",
        "created_at": "2022-12-23T02:46:52.274000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Not that the down scoring lasts long and it would probably be fine but it wasnâ€™t something we wanted to risk being different on and suddenly having all our nodes banned.",
        "created_at": "2022-12-23T02:47:31.717000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Yeah I don't think this is an engineering problem but rather agreeing on something, anything, would be good as far as I can see",
        "created_at": "2022-12-23T02:47:39.459000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "More than the banning I'm worried about a big burst of messages all of them deemed invalid by say all Teku nodes.",
        "created_at": "2022-12-23T02:48:57.067000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "So that it takes another's client block to include them",
        "created_at": "2022-12-23T02:49:12.714000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Yeah I think broadcasting early if we donâ€™t have agreement will be a bad policy and likely mean you canâ€™t get your change included for quite a while.",
        "created_at": "2022-12-23T02:49:36.621000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "With current policy of verifying against chain head state, the best policy is probably to broadcast just after you get the first Capella block. Thatâ€™s not terrible but itâ€™s not exactly intuitive.",
        "created_at": "2022-12-23T02:50:36.199000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Right.. I think that with the current spec it's even dangerous to broadcast at the fork. I'm weighing doing it when syncing the first Capella block",
        "created_at": "2022-12-23T02:51:04.708000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Ah haha we were saying the same ðŸ™‚",
        "created_at": "2022-12-23T02:51:19.745000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Alright I feel better that I'm not the only one uncomfortable with this. I think if the spec issue about gossip topic is reopened it will get traction (or at least approval from prysm) if we go with taking messages as soon as you're subscribed and check signatures against Capella that will be even easier cause we already do this. But the only option I want to avoid is clients being subscribed and deeming messages invalid because of being early",
        "created_at": "2022-12-23T02:54:52.406000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "It would be preferrable to broadcast after the fork rather than start validating execution change messages before it. We would simply ignore messages before the fork currently in Prysm",
        "created_at": "2022-12-23T06:24:47.371000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "If the spec clearly states that messages before the fork have to be ignored and not penalize peers and not declare them invalid (so as to prevent inclusion in the future) then that's an improvement (cc \u003c@425572898787426305\u003e we talked about this before). However, I believe that this still is not optimal since there's a race condition at the fork. Sending the message too early and your peer may not have a Capella head, send it too late and your message is not included early. I believe either option talked above: either allow messages as early as subscription and validate them against the Capella fork version, or validate always with the gossip topic fork version, are both better options",
        "created_at": "2022-12-23T08:16:03.380000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Maybe gossip at the first justification with an epoch \u003e= CAPELLA_FORK_EPOCH?",
        "created_at": "2022-12-23T08:52:54.961000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "I agree with \u003c@340345049063882753\u003e and \u003c@755590043632140352\u003e that we should use the fork version from a gossip topic for message validation in all topics. I just don't know how big engineering effort is required to make this into implementations. If not big and all CL clients agree to make this change in Capella then let's spec it out, if there is a pushback let's file an issue and fix this after the fork.",
        "created_at": "2022-12-23T08:56:57.497000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "While looking at this PR https://github.com/ethereum/consensus-specs/pull/3173 I have realised that `get_beacon_block_proposer` can return an index of slashed validator, while a block from slashed validator will be rejected. I feel like we should fix this contradiction and don't allow slashed validator to become a proposer.",
        "created_at": "2022-12-23T09:14:56.108000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "If there's an engineering problem with the gossip topic based validation. We can simply choose to validate any early message with Capella. Prysm already does this and at least I know this is a trivial change.",
        "created_at": "2022-12-23T09:18:41.263000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "By *any* you mean BLSToExecution?",
        "created_at": "2022-12-23T09:29:15.987000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Opened a PR https://github.com/ethereum/consensus-specs/pull/3175",
        "created_at": "2022-12-23T09:34:19.534000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "do we know if any slashed validator has ever been selected as a proposer ? if it has this would be a consensus breaking change",
        "created_at": "2022-12-23T09:35:32.706000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Apparently it was not because a block that would have been proposed by a slashed validator must have been rejected",
        "created_at": "2022-12-23T09:37:17.932000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Yes, I'm only focusing on bls changes pre Capella fork",
        "created_at": "2022-12-23T09:37:22.210000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "yeah but the assignments are still different with this change, correct ? You would have a completely different proposer at that slot",
        "created_at": "2022-12-23T09:39:39.117000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "So, it is something like `If pre-Capella then verify BLSToExecution with Capella.fork_version else _ with relevant fork_version` ?",
        "created_at": "2022-12-23T09:40:50.394000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Right, that's what we're doing now",
        "created_at": "2022-12-23T09:43:32.775000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Yes, you're right. But it doesn't matter much as proposed block wouldn't be a part of canonical chain. If rolling out this change without coordination then we might end up in a network split if some validators are following this change, some are not and a validator next to a slashed one proposes a block.",
        "created_at": "2022-12-23T09:44:55.161000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "What do you mean without coordination? This change is a hard fork in itself",
        "created_at": "2022-12-23T09:48:44.385000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Yeah, this would need to be in a HF, as its consensus breaking. Otherwise you could have different assignments in an epoch for different validators and an unresolvable split",
        "created_at": "2022-12-23T09:53:56.179000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "The probability of this to happen (if not purposefully) is trivial hence we might do this without coordination. Of course, doing this with coordination would be much safer.",
        "created_at": "2022-12-23T10:01:57.379000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "I have added a note about HF to the PR.",
        "created_at": "2022-12-23T10:04:52.613000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Is there any reason _not_ to do this at a hard fork boundary?  I don't see the rationale behind doing this in an uncoordinated fashion.",
        "created_at": "2022-12-23T10:05:03.941000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "There is no reason I can think of as historical blocks aren't affected by this change",
        "created_at": "2022-12-23T10:05:55.071000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "\u003c@755590043632140352\u003e https://github.com/ethereum/consensus-specs/pull/3176",
        "created_at": "2022-12-23T10:23:56.246000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Nice! Thanks for it. Will track what the outcome of that is. Cc \u003c@476250636548308992\u003e",
        "created_at": "2022-12-23T10:25:42.953000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I don't see how this can be done without coordination: if some clients take this and some don't then they will have different proposers for the same slot. No chain will ever take the other as valid",
        "created_at": "2022-12-23T10:29:51.266000+00:00",
        "attachments": null
    }
]