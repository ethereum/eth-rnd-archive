[
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Exploit in the deposit contract: https://ethresear.ch/t/deposit-contract-exploit/6528",
        "created_at": "2019-11-29T12:36:49.528000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "\u003c@144468805697929216\u003e the withdrawal credentials are signed by the validator key, so at least we know the owner of the key put in the withdrawal creds. If you're giving your key to a staking service you should wait for your withdrawal creds to be confirmed first. This can be done by making a minimal deposit yourself first.",
        "created_at": "2019-11-29T12:47:59.517000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Funny that you have this approach, I jus expressed and discussed concerns about front-running by non-keyholderd who could copy the pubkey and signature, but change the withdrawal creds. In the current design it's not possible, but if we were to follow IETF by only signing the pubkey, it becomes an issue",
        "created_at": "2019-11-29T12:50:07.573000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "\u003c@203220829473996800\u003e minimal depost is at least 1 Ether, and results in a far more complicated process for those attempting to build staking services.  Surely a better option would be for the deposit contract to keep a mapping of `pubkey=\u003ewithdrawal credentials` and only accept deposits where this matches (or is absent, of course)",
        "created_at": "2019-11-29T12:54:10.263000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "I'm also a little unsure what you mean by \"giving your key to a staking service\"; the staking service doesn't need the withdrawal key for this attack",
        "created_at": "2019-11-29T12:55:17.308000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "The signing key I meant",
        "created_at": "2019-11-29T12:55:35.761000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "But agree that making a deposit yourself first, before handing it over to the staking service, is kind of inconvenient",
        "created_at": "2019-11-29T12:56:19.024000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "I can't believe a staking service would accept a validator private key from a random user, either.  Too much risk of the funds being slashed and the staking service being blamed.",
        "created_at": "2019-11-29T12:57:01.319000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Will forward your suggestion to the right people. The deposit contract has more small things we are discussing to improve, but formal verification of the existing code also plays a role.",
        "created_at": "2019-11-29T12:57:30.019000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Good point there",
        "created_at": "2019-11-29T12:58:09.847000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**CarlBeek**\nBroken proposal, please ignore.\n\nCould this not be prevented by having a coordinator contract do the deposit for you where you must approve before a Tx gets sent.\n\nSomething like:\n\n0. FFS sends a Tx to the coordinatorcontract with a Signing key.\n1. User sends 32 ETH to coordinator contract with withdrawal creds.\n2. FFS sends signature of DepositData container to coordinator contract.\n3. User sends \"lock\" Tx to the coordinator contract\n4. Iff user approves, they send the \"go\" Tx to the coordinator contract which then calls the deposit contract in turn.",
        "created_at": "2019-11-29T13:04:36.575000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**CarlBeek**\nDuring this process users can withdraw at any time if things go bad, etc, etc.",
        "created_at": "2019-11-29T13:06:06.506000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "That looks a tad more complex than having a single mapping in the deposit contract (and the latter cannot be bypassed)",
        "created_at": "2019-11-29T13:06:36.717000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "(It is also prone to the same front-running issue, where FFS can front-run the \"lock\" tx with their own deposit)",
        "created_at": "2019-11-29T13:09:13.060000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Yep, can still frontrun if you've the key there",
        "created_at": "2019-11-29T13:10:34.491000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**CarlBeek**\nSure, but it keeps calls to the deposit contract cheap for the average user and prevents the need to re-do formal verification on the deposit contract.\n\nAlso, the mapping produces a censorship attack vector whereby someone prevents deposits by frontrunning new FFS validators.",
        "created_at": "2019-11-29T13:10:44.797000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "*signing key",
        "created_at": "2019-11-29T13:10:47.435000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**CarlBeek** (in reply to **\u003c@144468805697929216\u003e**)",
        "created_at": "2019-11-29T13:11:24.377000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "Agreed.",
        "created_at": "2019-11-29T13:11:24.592000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "I would say front-running gets even easier with the user being stuck to a proxy lock contract when the FSS can just read it and frontrun with the key.",
        "created_at": "2019-11-29T13:13:05.262000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**CarlBeek** (in reply to **\u003c@203220829473996800\u003e**)",
        "created_at": "2019-11-29T13:14:31.656000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "Agreed. My proposal doesn't fix the problem.",
        "created_at": "2019-11-29T13:14:31.801000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "\u003e That looks a tad more complex than having a single mapping in the deposit contract (and the latter cannot be bypassed)\n\nWe could add this check to `process_deposit` function as a part of block processing. But here then could be the case when user burns 32 ETH as FSS made a front-run with 1 ETH. Non-profit for FSS but still possible.",
        "created_at": "2019-11-29T13:16:57.372000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "I considered that but it is, as you say, too late at that point.  The honest user has lost their funds regardless.",
        "created_at": "2019-11-29T13:18:00.469000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "(BTW the current deposit call takes about ~350K gas so another 20K or so doesn't seem like a massive addition)",
        "created_at": "2019-11-29T13:18:52.704000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Contract seems to be the only place for that check bc Tx reject is required.",
        "created_at": "2019-11-29T13:20:20.264000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Yep",
        "created_at": "2019-11-29T13:20:26.142000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "good finding \u003c@144468805697929216\u003e",
        "created_at": "2019-11-29T13:20:56.915000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Alternatively you stake (bond) on eth1 to commit to give a user certain withdrawal creds. And then get the bond back if you do things right",
        "created_at": "2019-11-29T13:21:41.267000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Not pretty, but solves the problem and enables you to push all responsibility to the FSS. (if you're that kind of person who likes that)",
        "created_at": "2019-11-29T13:22:48.529000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "I don't see what that gains over the `validator pubkey=\u003ewithdrawal credentials` check in `deposit()`, to be honest",
        "created_at": "2019-11-29T13:23:51.383000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "One less thing to worry about, not changing what's already formally verified, and pushing a feature for specific users to those users, not doing anything extra for others. But yes, not a pretty solution",
        "created_at": "2019-11-29T13:25:43.330000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "I would suggest that regardless of these potential solutions:\n\nIf the deposit contract is given a deposit with specific withdrawal credentials it should result in either the deposited amount being withdrawable by those credentials or the deposit rejected.\n\nAnything else should be viewed as incorrect operation.",
        "created_at": "2019-11-29T13:29:37.635000+00:00",
        "attachments": null
    }
]