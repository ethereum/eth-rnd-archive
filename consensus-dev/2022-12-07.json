[
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "I have another question, Is the state we receive through checkpoint sync good to go? for some reason the ssz library cannot generate the valid state root from it but it seems to be able to marshal to the same exact bytes we unmarshaled it from",
        "created_at": "2022-12-07T00:28:58.837000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "My repressentation of the bellatrix beacon state does not seem(at least look) wrong either",
        "created_at": "2022-12-07T00:30:49.427000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "How are you hashing the state? You're also getting a block from checkpoint sync right?",
        "created_at": "2022-12-07T00:35:32.597000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "I'm not quite sure what you mean by \"cannot generate the valid state root\". If you only have the state how do you know what the valid state root is?",
        "created_at": "2022-12-07T00:37:21.244000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Generating the state root should be straight forward - it's just a generic SSZ object, nothing special about the state.  And yes you should be able to just use the SSZ downloaded from the `/eth/v2/debug/beacon/states/{state_id}` endpoint directly.",
        "created_at": "2022-12-07T00:38:18.032000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Are you on Go? Perhaps you're using fastssz to hash the beacon state? In which case that will not give you the right answer Afaik",
        "created_at": "2022-12-07T00:42:32.245000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "I use fastssz yes and no I am not getting the block. I just compare my result with beaconchain explorer. Anyway I will try figuring out the issue",
        "created_at": "2022-12-07T08:44:59.794000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "Knowing it is probably related on the object structure makes my life easier",
        "created_at": "2022-12-07T08:45:30.926000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "fastssz stopped working for  Beaconstates a while ago when new types of lists were introduced. That's why we had to fork it and we maintain a fork of it. We hash many things with that fork, but for the beacon state we use custom hashing. I do not know if fast ssz merged our PRs or if it fixed those issues. One way you could try to figure that out is by grabbing a phase0 state instead of a Bellatrix one and see if you get the right answer. Instead of checkpoint sync, you can get any state from the beacon API of a fully synced node, or you can simply try the genesis state.",
        "created_at": "2022-12-07T10:25:32.953000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "cc \u003c@476250636548308992\u003e that may have followed fastssz development",
        "created_at": "2022-12-07T10:26:03.864000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Afaik I don't think it was fixed, it would be easy to check, you could just run fast-ssz's hashing method for the state and it would fail spec tests the last time I checked",
        "created_at": "2022-12-07T10:29:28.077000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "so you guys have a fork of the ssz library that works? or are you guys just hashing it in a completely different custom way?",
        "created_at": "2022-12-07T10:47:06.114000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "We use gohashtree by default to hash big lists, this requires using something different than fastssz unless they they change their hashing method. I think Ferrant was thinking on using it, but haven't heard back",
        "created_at": "2022-12-07T10:54:39.618000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "So we use completely custom hashing for the state",
        "created_at": "2022-12-07T10:54:55.962000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "sounds like more fun for meðŸ˜‹",
        "created_at": "2022-12-07T10:55:31.659000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "I think I will switch to your fork and try to pull some magic with it",
        "created_at": "2022-12-07T10:56:52.241000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "thanks for the help",
        "created_at": "2022-12-07T10:57:14.980000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "The beacon state is very rarely hashed from a cold start. We all keep a cashed version and only rehash dirty leaves",
        "created_at": "2022-12-07T10:57:27.062000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "yes I understand how thats better, was planning the same",
        "created_at": "2022-12-07T10:57:57.647000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "I just wanted to see If I can get fresh generation working first",
        "created_at": "2022-12-07T10:58:37.704000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "If you're going to follow our hashing code pay attention to the flash named `VectorizedHtr` or something like that. We still support two hashing methods: we default to gohashtree that's faster, but support fastssz if the user requests it",
        "created_at": "2022-12-07T10:59:31.216000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "I thought that fastssz now works for beacon state, attestantio/go-eth2-client seems to pass the eth2 spec tests for Capella beacon state",
        "created_at": "2022-12-07T11:05:06.429000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "cc \u003c@476250636548308992\u003e ^",
        "created_at": "2022-12-07T11:12:37.883000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "Which version of fast-ssz are you guys running ?",
        "created_at": "2022-12-07T12:34:05.167000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "0.1.2",
        "created_at": "2022-12-07T12:36:37.782000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "general",
        "parent": "",
        "content": "The main difference is how we represent participation bits:\nhttps://github.com/prysmaticlabs/prysm/blob/develop/proto/prysm/v1alpha1/beacon_state.pb.go#L255\n\nhttps://github.com/attestantio/go-eth2-client/blob/master/spec/altair/beaconstate.go#L47\n\nFast-ssz can handle the last one correctly but not the former",
        "created_at": "2022-12-07T12:52:47.464000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Ah right, we make it a uint8 rather than a byte.",
        "created_at": "2022-12-07T12:55:31.417000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "I just found that even with fastssz fork from prysm wrong root is generated still as a matter of fact I get the same root from both prysm and Erigon but after some digging I found that prysm hash root is customized and not automaticslly generated, interesting...",
        "created_at": "2022-12-07T17:12:43.001000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "And yes also saw the dirty leaves system that was mentioned",
        "created_at": "2022-12-07T17:16:39.344000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "Also thank you for the heads up on gohashtree, I see now a substantial improvement in performance too",
        "created_at": "2022-12-07T18:06:50.339000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "general",
        "parent": "",
        "content": "dumdidum... https://github.com/ethereum/consensus-specs/pull/2983 ...",
        "created_at": "2022-12-07T21:22:24.427000+00:00",
        "attachments": null
    }
]