[
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "was just curious how CLs pack bls to execution changes? just kinda glancing at what is being including in blocks, it seems like it is slowly sweeping across the entire validator set, depending on what is in the client's pool - is that bc of the packing strategy or im just more likely to see large operators setting the creds for their own validators (and the strategy for that is mostly incremental)?",
        "created_at": "2023-04-14T14:46:07.866000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Prysm+lighthouse do filo, teku is random. Nimbus and Lodestar I have no clue",
        "created_at": "2023-04-14T16:06:50.982000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "Nimbus is FILO",
        "created_at": "2023-04-14T16:07:59.612000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "right so it confuses me how nicely ordered the validator indexes are",
        "created_at": "2023-04-14T16:11:17.304000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "is this withdrawals or BLS changes?",
        "created_at": "2023-04-14T16:11:59.663000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "bls changes",
        "created_at": "2023-04-14T16:12:05.330000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "slot 6222056\n```\n      \"validator_index\": \"479456\",\n      \"validator_index\": \"479479\",\n      \"validator_index\": \"479460\",\n      \"validator_index\": \"479455\",\n      \"validator_index\": \"479452\",\n      \"validator_index\": \"479462\",\n      \"validator_index\": \"479473\",\n      \"validator_index\": \"479454\",\n      \"validator_index\": \"479428\",\n      \"validator_index\": \"479458\",\n      \"validator_index\": \"479435\",\n      \"validator_index\": \"479430\",\n      \"validator_index\": \"479429\",\n      \"validator_index\": \"479432\",\n      \"validator_index\": \"479425\",\n      \"validator_index\": \"479433\",\n```\n\nslot 6222057:\n```\n      \"validator_index\": \"402985\",\n      \"validator_index\": \"358236\",\n      \"validator_index\": \"402965\",\n      \"validator_index\": \"413912\",\n      \"validator_index\": \"398416\",\n      \"validator_index\": \"413850\",\n      \"validator_index\": \"410394\",\n      \"validator_index\": \"467012\",\n      \"validator_index\": \"350280\",\n      \"validator_index\": \"413950\",\n      \"validator_index\": \"467060\",\n      \"validator_index\": \"467050\",\n      \"validator_index\": \"418669\",\n      \"validator_index\": \"413879\",\n      \"validator_index\": \"398612\",\n      \"validator_index\": \"398370\",\n```\nslot 6222058:\n```\n      \"validator_index\": \"421988\",\n      \"validator_index\": \"422173\",\n      \"validator_index\": \"422153\",\n      \"validator_index\": \"422349\",\n      \"validator_index\": \"422354\",\n      \"validator_index\": \"422338\",\n      \"validator_index\": \"422434\",\n      \"validator_index\": \"422416\",\n      \"validator_index\": \"422417\",\n      \"validator_index\": \"422443\",\n      \"validator_index\": \"422438\",\n      \"validator_index\": \"422516\",\n      \"validator_index\": \"422522\",\n      \"validator_index\": \"422515\",\n      \"validator_index\": \"422959\",\n      \"validator_index\": \"422530\",\n```",
        "created_at": "2023-04-14T16:15:28.891000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Isn't this because pools are (slow) spamming in sequential'ish order? I took down my listener nodes though, but maybe someone has logs of when they see what BLS change message _arrive_ (over gossip)",
        "created_at": "2023-04-14T16:21:20.580000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "In other random news on the BLS -\u003e Execution topic, I seem to have been the only one broadcasting them early (before the fork).",
        "created_at": "2023-04-14T16:28:16.988000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "Two of the CLs, I believe (including Nimbus) weren't listening on the topic at all before Capella fork epoch",
        "created_at": "2023-04-14T16:29:49.241000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I think no CL listens on the topic before the fork epoch",
        "created_at": "2023-04-14T18:27:48.375000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "so what \u003c@397389662085185547\u003e did should have had no effect",
        "created_at": "2023-04-14T18:53:35.327000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Yes, Prysm does an epoch in advance, LH does 2 slots in advance",
        "created_at": "2023-04-14T18:56:29.160000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "I don't know about the others",
        "created_at": "2023-04-14T18:56:37.255000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "I couldn't quite figure out where Prysm ignores the early messages though. For Lighthouse it was rather easy to find.",
        "created_at": "2023-04-14T18:58:23.952000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "Is it in any topic-specific way, where it special-cases BLS change messages, or is it a natural consequence of how Prysm and LH handle fork topic subscription changes in general?",
        "created_at": "2023-04-14T19:00:41.450000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "the latter",
        "created_at": "2023-04-14T19:01:18.773000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "So it's at most a couple epochs before the fork, from what you say, not just indefinitely, still.",
        "created_at": "2023-04-14T19:01:56.317000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Indeed, and there's something weird about LH not subscribing to the new fork's topics (I think) if it's within the 2 slot window",
        "created_at": "2023-04-14T19:02:47.461000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "(or longer in my case, I modified LH)",
        "created_at": "2023-04-14T19:02:53.641000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Still have to a little bit more digging on that, would at most be a small bug easily solved with a restart. Probably something weird on my end though",
        "created_at": "2023-04-14T19:04:14.694000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "The only reason I started those listeners is because there was a rather easy way to counter the CLWP initiative by adversaries (if they were smart / willing enough)",
        "created_at": "2023-04-14T19:05:11.723000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "(which is to just broadcast that whole list to a lot of peers a few seconds before the fork)",
        "created_at": "2023-04-14T19:07:04.512000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "Yeah, it would need to work with the LIFO order most clients use",
        "created_at": "2023-04-14T19:07:28.419000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "Not as easy as under a FIFO regime",
        "created_at": "2023-04-14T19:07:55.955000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "At least for Prysm and Lighthouse, because they subscribe early, the ~33 slot \"time cache\" on the gossip layer kicks in",
        "created_at": "2023-04-14T19:08:16.563000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "so Prysm and Lighthouse see the early BLS change (pre-Capella), don't process it (because early), but the libp2p layer will ignore those same message (with matching message ID) when they arrive _after_ the fork. And then Prysm and Lighthouse will just not process them (or even see them really)",
        "created_at": "2023-04-14T19:09:17.624000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "I don't know about the other clients, but with LH and Prysm making up most of the network, I was kinda worried about that attack. Turns out no one exploited it ü§∑‚Äç‚ôÇÔ∏è",
        "created_at": "2023-04-14T19:10:04.186000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "Sure, part of the point of the months of testing of all these forks is to cover these possibilities though. It's kind of generically true that most contingencies planned for don't occur",
        "created_at": "2023-04-14T19:11:20.141000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Yeh, and this has nothing to do with the consensus layer. That's all working as intended. It's purely and attack possible because of the public nature of CLWP",
        "created_at": "2023-04-14T19:11:51.186000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "There was concern about also just a brute-force DoS of BLS change messages, which didn't really happen",
        "created_at": "2023-04-14T19:11:56.358000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Just me apparently xD",
        "created_at": "2023-04-14T19:12:14.040000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "But what you found applies more broadly to future forks, it sounds like, because you found general behavior of LH and Prysm around forks which seems worth understanding",
        "created_at": "2023-04-14T19:12:56.092000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Yes, but I'm not sure there are these \"race to get in first\" in future forks (and subsequently attacks to get clients to effectively _block_ messages for an epoch). This withdrawal one was the big one I'd say",
        "created_at": "2023-04-14T19:14:01.995000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "It was certainly framed that way in the Ethstaker discussion and some others, and this is one way the fork has been framed, as sort of \"completing\" the merge. Whether the merge happened and finished with bellatrix or constituted an extended time period until Capella forked on mainnet is to taste, but it reflects, yeah, what you're observing that there's a likely qualitative shift in future forks",
        "created_at": "2023-04-14T19:16:14.702000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "If there's future forks where you can \"register\" things by getting in first, then indeed the same problem arises. Something to keep in mind, but I also can't really think of something like that on the roadmap.",
        "created_at": "2023-04-14T19:16:58.274000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "No we dont, we subscribe but we ignore everything before the fork",
        "created_at": "2023-04-14T19:49:42.006000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Same with lighthouse",
        "created_at": "2023-04-14T19:49:47.757000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Not really, at least for LH I'm sure",
        "created_at": "2023-04-14T19:58:26.770000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "The issue is that subsequent equal messages are ignored for roughly an epoch (with the libp2p implementations with their time cache, deferring to the clients for the calculations of the message ID).",
        "created_at": "2023-04-14T19:59:03.525000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "general",
        "parent": "",
        "content": "Interesting attack. In LH, we subscribe 2 slots in advance to give enough time for gossipsub meshes to form. \nSo you can send a BlsToExecutionChange message pre-capella which will result in us marking the message as Ignored on gossipsub. We will not accept a message with the same message id for the next 1 minute after which it will get ejected from the duplicate caches. So in that 1 minute window, the attacker could then inject the \"malicious\"  non-CLWP message and front run the withdrawal change operation",
        "created_at": "2023-04-14T19:59:46.829000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "not 1 minute, 6 minutes",
        "created_at": "2023-04-14T20:00:06.726000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "33 slots ish iirc",
        "created_at": "2023-04-14T20:00:18.214000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "```rust\n/// Therefore, we must accept attestations across a span of 33 slots (where each slot is 12\n/// seconds). We add an additional second to account for the 500ms gossip clock disparity, and\n/// another 500ms for \"fudge factor\".\npub const DUPLICATE_CACHE_TIME: Duration = Duration::from_secs(33 * 12 + 1);\n```",
        "created_at": "2023-04-14T20:00:52.103000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "general",
        "parent": "",
        "content": "6 minutes is the mcache afaik, but we remove the message from the mcache if the message is marked ignored",
        "created_at": "2023-04-14T20:00:53.441000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "general",
        "parent": "",
        "content": "ohh no sorry you are right, i was looking at default values",
        "created_at": "2023-04-14T20:01:23.880000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Ok so I may missunderstand the argument here, we do register before the fork and indeed we mark as ignored the messages that come in before the fork and rely on libp2p, so probably we aren't contradicting eachother. I just meant that we would not process any bls change before the fork if it comes through gossip, and no CL does this as far as I know.",
        "created_at": "2023-04-14T20:03:37.368000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Oh yes, the whole point is that the message is ignored by Prysm and LH, _and_ that it is then subsequently ignored by the libp2p/gossip layer for an entire epoch as well",
        "created_at": "2023-04-14T20:04:18.997000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "oh, that 0.5 epochs before fork, it comes in, it's ignored, and then even if it comes in at 0.25 epochs after fork, it's still ignored?",
        "created_at": "2023-04-14T20:04:46.490000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "whereas if it didn't come in before fork at all, the second one would have been processed",
        "created_at": "2023-04-14T20:05:04.637000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "correct",
        "created_at": "2023-04-14T20:05:14.866000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Kept it on the DL, but since CLWP was a 100% success I feel it's an interesting \"quirk\" to now disclose/discuss. I personally don't foresee it being particularly relevant in the future, but you guys know a lot more about that.",
        "created_at": "2023-04-14T20:08:26.315000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "in fact this may have been the reason why CLWP was a success üôÇ assuming they themselves didn¬¥t start broadcasting before the fork, hackers may",
        "created_at": "2023-04-14T20:09:59.518000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I hadn't thought of this problem indeed, we always assumed that network latency would be such that most clocks would be past the epoch when we received the messages",
        "created_at": "2023-04-14T20:10:39.383000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "so the few that ignore them would not matter much",
        "created_at": "2023-04-14T20:10:48.372000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "but you're right that if CLWP started broadcasting early then they'd be screwed by this feature",
        "created_at": "2023-04-14T20:11:10.613000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "Yep, exactly why I was worried about it. If any adversary had thought about this as well, they could've easily broadcasted the CLWP list a little early to give themselves a massive advantage. \nJust for reference, I also \"spammed\" the network (from 300 ms before the fork, until 300 ms after) with 100 differing messages all for the same validator. That validator was also part of the CLWP list, but my spam ones got in. So clearly some big node operators didn't pre-load the CLWP list (they didn't have to, just interesting to know).",
        "created_at": "2023-04-14T20:24:21.031000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "general",
        "parent": "",
        "content": "Its important to note though that Ignored messages on gossipsub aren't sent to other nodes. So the attacker had only 1 node broadcasting the pre-fork message, only the nodes in it's mesh (6 by default) would get the message and ignore it. So spinning up `X` number of nodes would propagate it to `6X` nodes at max. Not sure how many nodes mainnet has running right now, but the attacker would have to spin up a lot of nodes. Still pretty doable though",
        "created_at": "2023-04-14T20:33:10.399000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Ah I‚Äôve been wondering whether there was any attempt to steal keys. Sounds like it was just you and you managed to ‚Äústeal‚Äù despite the CLWP.",
        "created_at": "2023-04-14T21:34:04.773000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Ahh you sent 100 differing but valid changes? cool!",
        "created_at": "2023-04-14T21:52:51.951000+00:00",
        "attachments": null
    }
]