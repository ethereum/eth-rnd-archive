[
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**shahankhatch**\nHi all, I'm wondering whether there's more definition available for the 'bonding' mechanism to share ENRs which are then added to the Discovery node table in order to be trusted for FINDNODES queries. afaict clients are statically bootstrapping ENRs into their node table.",
        "created_at": "2020-01-24T16:03:58.879000+00:00",
        "attachments": null
    },
    {
        "author": "jannik8974",
        "category": "general",
        "parent": "",
        "content": "\u003e **shahankhatch**\n\u003e Hi all, I'm wondering whether there's more definition available for the 'bonding' mechanism to share ENRs which are then added to the Discovery node table in order to be trusted for FINDNODES queries. afaict clients are statically bootstrapping ENRs into their node table.\n\u003c@!598575636012859412\u003e The bonding mechanism is described in these two documents:\n- https://github.com/ethereum/devp2p/blob/master/discv5/discv5-wire.md\n- https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md",
        "created_at": "2020-01-24T16:11:47.117000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**shahankhatch** (in reply to **\u003c@434217287986184203\u003e**)",
        "created_at": "2020-01-24T16:30:09.388000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "I've already gone through those docs; they don't describe the bonding mechanism of how ENRs are shared. There's some mention of Kademlia but it's not part of the spec.",
        "created_at": "2020-01-24T16:30:09.621000+00:00",
        "attachments": null
    },
    {
        "author": "jannik8974",
        "category": "general",
        "parent": "",
        "content": "ENRs are requested with `FINDNODE` messages and sent with `NODES` messages. `FINDNODE` messages are sent as part of the lookup process which the second document I linked to describes.",
        "created_at": "2020-01-24T16:37:38.894000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**shahankhatch**\nA FINDNODE query can only be issued after a session is established. If I'm a single peer with another node's ENR, and that node doesn't have my ENR in their node table, they won't respond. Similarly, after issuing a FINDNODE query which returns ENRs, the ENR is known only to one party, however the specification requires that the target peer have the ENR of the source node. So there's a data race condition without a separate ENR sharing mechanism, which is what Kademlia has been proposed for.",
        "created_at": "2020-01-24T16:56:22.079000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**shahankhatch**\nIn particular, the phrase \"Node A must have a node record for node B and know B's node ID to communicate with it.\" is the ambiguous part of the spec on the wire page.",
        "created_at": "2020-01-24T17:01:27.124000+00:00",
        "attachments": null
    },
    {
        "author": "jannik8974",
        "category": "general",
        "parent": "",
        "content": "Node B doesn't need to know node A's ENR. They'll just respond to the endpoint where they got A's message from.",
        "created_at": "2020-01-24T18:00:20.711000+00:00",
        "attachments": null
    },
    {
        "author": "jannik8974",
        "category": "general",
        "parent": "",
        "content": "In their response, they're supposed to include \"the highest known ENR sequence number of node A's record.\", but they can just use 0 if they don't have any",
        "created_at": "2020-01-24T18:01:28.169000+00:00",
        "attachments": null
    },
    {
        "author": "jannik8974",
        "category": "general",
        "parent": "",
        "content": "that's what trinity does at least and what I think makes the most sense, that's probably something the spec should clarify",
        "created_at": "2020-01-24T18:02:00.365000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**shahankhatch**\nI think node B responding anyways makes sense, such as with a seqnum of 0. It seems though that node A's ENR is never transmitted to B during the handshake.",
        "created_at": "2020-01-24T18:27:08.572000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**shahankhatch**\nThanks for pointing me to Trinity's approach. A closer look there shows the following constraint check on presence of a peer in the node table, if I am reading that correctly? https://github.com/ethereum/trinity/blob/7224a5a8da41e77d36c03f7e5f5e6a7b6771fa5f/p2p/discovery.py#L692",
        "created_at": "2020-01-24T18:27:15.072000+00:00",
        "attachments": null
    },
    {
        "author": "jannik8974",
        "category": "general",
        "parent": "",
        "content": "A sends their ENR to B as part of the WHOAREYOU packet",
        "created_at": "2020-01-24T18:36:46.814000+00:00",
        "attachments": null
    },
    {
        "author": "jannik8974",
        "category": "general",
        "parent": "",
        "content": "the code you're looking at is for discovery v4 (used for eth1). v5 is here: https://github.com/ethereum/trinity/tree/7224a5a8da41e77d36c03f7e5f5e6a7b6771fa5f/p2p/discv5",
        "created_at": "2020-01-24T18:38:22.362000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_bridge_bot",
        "category": "general",
        "parent": "",
        "content": "**shahankhatch**\nThanks, Jannik. That's very helpful. Much appreciate it.",
        "created_at": "2020-01-24T23:28:23.999000+00:00",
        "attachments": null
    }
]