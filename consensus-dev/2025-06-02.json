[
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "\u003c@911437720994324570\u003e left a couple of comments, one is independent on the spec (namely I can implement it like that in Prysm regardless if you want to merge it or not). The other is a blocker for implementation because it's the SSZ type of the object. I'd appreciate if you can tell me what you think about it so that I see how I start implementing it.",
        "created_at": "2025-06-02T15:49:18.734000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "Thanks a lot, appreciate it! Taking a look now",
        "created_at": "2025-06-02T15:52:17.198000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "BTW, I think the PR is sound, the only leftover comment I have is that there's a tradeoff in complexity in adding this in epoch processing vs slot 10 for example. I see that simplicity in the spec makes it that epoch transition is good, but perhaps doing this change when the unrealized justification changes or something else would prevent the extra computation in epoch processing. Anyway, just throwing this out there and definitely not suggesting this change at this stage. The PR seems good to me as is",
        "created_at": "2025-06-02T15:58:30.773000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "\u003e BTW, I think the PR is sound, the only leftover comment I have is that there's a tradeoff in complexity in adding this in epoch processing vs slot 10 for example.\nYeah, the computation added at epoch processing is definitely importat and something we looked into. \u003c@554799849288105986\u003e did some preliminary benchmarking in Lighthouse and found ~3-4 % additional overhead in the epoch processing time, and ~2-3 % overhead after adding parallelization (compute each proposer index in lookahead in parallel). Seems like a reasonable overhead to me (even the non-parallel ver), but let me know if you think otherwise or find the overhead to be bigger in Prysm",
        "created_at": "2025-06-02T16:05:16.658000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I'll implement this as is with your acknowledgement that a vector would be better, should be able to bench a baby version in a couple of days. I just don't trust \u003c@554799849288105986\u003e and the Lighthouse guys that this was a simple change. At least in our implementation, it removes a cache for proposers, it removes a cache for duties, it changes the way we signal the VC of possible changes in the duties, etc. By the way I see no mention of dependent roots and anything on the Beacon API related to this EIP, I hope that you guys have looked into that because the beacon API for get duties may need to change, at least it seems to me that `currentDependentRoot` becomes irrelevant, and API changes are something that people love to argue forever about.",
        "created_at": "2025-06-02T16:15:23.783000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "\u003e At least in our implementation, it removes a cache for proposers, it removes a cache for duties, it changes the way we signal the VC of possible changes in the duties, etc\nAren't these more like optional nice-to-haves that utilize the EIP, but not requirements?",
        "created_at": "2025-06-02T16:17:08.032000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "\u003e I just don't trust \u003c@554799849288105986\u003e that this was a simple change\n\nskill issue :p",
        "created_at": "2025-06-02T16:17:11.928000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "Jk lol",
        "created_at": "2025-06-02T16:18:32.790000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "well, these things are entrenched in our code, definitely having this EIP makes our code much easier to maintain and much more efficient (modulo the harder epoch transition computation), but still this is something that needs to be implemented eventually",
        "created_at": "2025-06-02T16:18:33.568000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "I didn't go far enough to implement the ef tests so there's a possibility I missed something",
        "created_at": "2025-06-02T16:19:15.851000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "\u003e By the way I see no mention of dependent roots and anything on the Beacon API related to this EIP, I hope that you guys have looked into that because the beacon API for get duties may need to change, at least it seems to me that currentDependentRoot becomes irrelevant, and API changes are something that people love to argue forever about.\nNot sure if I follow this part. Is this also about the potential to simplify due to the removed edge-case-undeterminism? Or do you think there are more critical API changes needed? My understanding is that we don't really change the interface of the beacon chain so there isn't *required* API changes (apart from nice-to-have simplifications), but let me know if I am missing something",
        "created_at": "2025-06-02T16:25:29.309000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "these are nice to have, but it is probable tech-debt. The call to get duties returns the dependent root, I am not sure if the dependent root is needed anymore",
        "created_at": "2025-06-02T16:32:33.212000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "perhaps it is though because the VC does not know that the reorg happened anyway so probably it's a good idea to keep it",
        "created_at": "2025-06-02T16:33:16.103000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "\u003e perhaps it is though because the VC does not know that the reorg happened anyway so probably it's a good idea to keep it\nAgree, the duties can still change if the reorg is across a epoch boundry hence changes the RANDAO at the end of previous epoch, so seems good to keep it.",
        "created_at": "2025-06-02T16:35:59.415000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "yeah but that's only the \"previous_dependent_root\" that one is clearly still useful",
        "created_at": "2025-06-02T16:36:36.490000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "the issue is for the \"current_dependent_root\"",
        "created_at": "2025-06-02T16:36:44.039000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "which now seems irrelevant",
        "created_at": "2025-06-02T16:36:52.527000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "Where can I read more about this \"current_dependent_root\"? From this doc I only see one \"dependent root\", so probably looking at the wrong thing: https://www.quicknode.com/docs/ethereum/eth-v1-validator-duties-proposer-epoch",
        "created_at": "2025-06-02T16:39:09.994000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "oh it's when you get duties for the given epoch, yeah perhaps I am mixing PRysm specific behavior with the beacon API itself.",
        "created_at": "2025-06-02T16:41:47.939000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "i will check once i get back from the gym \u003c@755590043632140352\u003e",
        "created_at": "2025-06-02T16:46:07.091000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "In general, I do agree that EIP-7917 will add tech debt around  edge-case handling of proposer lookahead changes - more accurately it will make certain edge case handling irrelevant and as a result make the edge case handling code tech debt. But was also hoping we can keep such clean ups as issues in the backlog but not be a blocker, at least for now.",
        "created_at": "2025-06-02T16:47:53.766000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "\u003c@554799849288105986\u003e \u003c@1016224469704003675\u003e (and anyone else who is implementing EIP-7917) In below commit I have changed the type of `proposer_lookahead` field in beacon state to `List` to `Vector`. Please change your implementations accordingly, or else I believe you won't be able to parse the spectest vectors\nhttps://github.com/ethereum/consensus-specs/commit/c8811a074ee9099290f6af02d5a334e536418005",
        "created_at": "2025-06-02T16:58:26.769000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "the honest reorg mechanism should definitely change",
        "created_at": "2025-06-02T17:05:13.316000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "the rest I don't care much, but having useless functions in forkchoice spec is not nice",
        "created_at": "2025-06-02T17:05:32.411000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "This is about [this comment](https://github.com/ethereum/consensus-specs/pull/4190#pullrequestreview-2884378390) you left in the PR, right? Still wrapping my head around it, will try to reply and address soon.",
        "created_at": "2025-06-02T17:07:08.551000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "yes, the changes are simple off-the-top-of my head, you need to remove the is-shuffling-stable function completely and avoid the slot 0 reorg condition",
        "created_at": "2025-06-02T17:15:32.474000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "cc \u003c@602753420033785856\u003e in case Michael disagrees",
        "created_at": "2025-06-02T17:15:50.699000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "I am having trouble to see whether we can remove `is_shuffling_stable` as I am having trouble understanding why it was included in the first place (there is no documentation in the specs). From looking at the [original discussion](https://github.com/sigp/lighthouse/pull/2860#issuecomment-1118150000), the only mention I see around epoch boundaries is in the context of attestations and justifications. Quote from \u003c@602753420033785856\u003e \n\u003e I think it's probably still better to play it safe at the epoch boundary. The block in slot 31 might include just enough attestations to justify the epoch (while the block at slot 30 does not). If we build a new block at 32 on 30, then it will have a lower justified checkpoint than 31, which I think will make it inferior from fork choice's PoV, even with the newest changes?\n\nIf it's about attestations and justifications, I don't think EIP-7917, which is about proposer lookahead, is relevant? The issue around \"having just enough attesations to justify\" at epoch boundaries seems still needed even with the new EIP. But I may be quoting the wrong thing here, would be great if \u003c@602753420033785856\u003e can also help clarify.",
        "created_at": "2025-06-02T18:44:48.300000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "the question remains still valid, you can still lose justification by reorging a block from the previous epoch. But the shuffling doesn't change at all now, which makes it safer to reorg, we still only make reorgs of depth 1.",
        "created_at": "2025-06-02T19:03:00.281000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "If \"you can still lose justification by reorging a block from the previous epoch.\", won't it be safer to keep the check? Even in the original discussion, there was [people saying](https://github.com/sigp/lighthouse/pull/2860#issuecomment-1118055601) that the check is not needed, but it was still added to \"play safe\". It's a critical part that impacts fork-choice, don't want to remove it unless we can say that it is 100% not needed.",
        "created_at": "2025-06-02T19:09:31.941000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I assume it's fine to keep it, it feels weird still to have a function \"is_shuffling_stable\" when we will not change the shuffling at all now lol ðŸ™‚",
        "created_at": "2025-06-02T19:14:59.630000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "Yeah, if anything I think the initial `is_shuffling_stable` naming was unfortunate, as it doesn't seem to be (at least only) about shuffling.",
        "created_at": "2025-06-02T19:18:43.179000+00:00",
        "attachments": null
    },
    {
        "author": "linoscope",
        "category": "general",
        "parent": "",
        "content": "I am inclined to keep it if you are ok with it, to play it safe",
        "created_at": "2025-06-02T19:19:21.814000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "So our proposer's cache was already using the updated function. It's a bit redundant after 7917 because it's caching what's already cached in the `BeaconState` but since we still need it for earlier forks I don't know that we'll modify it significantly.",
        "created_at": "2025-06-02T19:25:11.747000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "our proposer's cache is a pain in the butt... I don't know what I'll do but that may be indeed a good compromise, just keep it and hook it to the function post-fulu",
        "created_at": "2025-06-02T19:26:23.833000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "we will need like 3 years without a fork to clean up all this crap, perhaps the Beam chain start from zero was not a bad idea after all. I hope the people that start the beam chain clients do know all these nuances of block processing.",
        "created_at": "2025-06-02T19:27:15.375000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "our's already hooks into `state.get_beacon_proposer_index()` which changes under this EIP to have one behavior before and one after fulu",
        "created_at": "2025-06-02T19:27:46.568000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "yeah that's probably the best option",
        "created_at": "2025-06-02T19:28:17.432000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "general",
        "parent": "",
        "content": "Devs, please approve if you're satisfied with this PR. Will merge when there are several approvals.",
        "created_at": "2025-06-02T22:51:45.940000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Looks good to me and I approved. I would feel better to merge this *after* I implemented it and not before, but if there's a rush to merge it I don't see anything wrong with the EIP.",
        "created_at": "2025-06-02T22:58:14.215000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I assume you want to merge it to provide vectors in the tarball?",
        "created_at": "2025-06-02T22:58:33.923000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "general",
        "parent": "",
        "content": "The only rush is to not block fusaka-devnet-1 which is planned for June 9th. The sooner can get this merged, the sooner there will be test vectors for it. If we merge soon, there will be nightly test vectors which clients can use when implementing.",
        "created_at": "2025-06-02T23:01:13.127000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "general",
        "parent": "",
        "content": "https://notes.ethereum.org/@ethpandaops/fusaka-devnet-1",
        "created_at": "2025-06-02T23:01:57.240000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Yeah that's what I meant by the tarball, the test vectors are welcome",
        "created_at": "2025-06-02T23:02:05.502000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I hope to be able to test tomorrow, but I doubt Fulu will be able to rebase on top of this so soon cc \u003c@531934490826768418\u003e",
        "created_at": "2025-06-02T23:02:56.568000+00:00",
        "attachments": null
    },
    {
        "author": "sproul",
        "category": "general",
        "parent": "",
        "content": "I think the issue with epoch boundaries and reorgs is due to attestation inclusion deadlines. Attestations can be included up to 2 epochs after being produced. I think it could be the case that there are attestations in slot 31 of an epoch which trigger justification/finalisation, but cannot be included in slot 0. However, I think this should be handled by the `is_ffg_competitive` check. I might take a look at removing the `shuffling_is_stable` restriction",
        "created_at": "2025-06-02T23:03:08.178000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "general",
        "parent": "",
        "content": "~~What we could do is merge the PR tomorrow so that test vectors exist, then make the release on Thursday after clients have implemented it. If we discover an issue while implementing, we could fix it with another PR before the release.~~\n\nBetter yet, I updated the reference test generator action to take a repository/branch input, so we can easily generate test vectors for any PR now. I've started [this run](https://github.com/ethereum/consensus-specs/actions/runs/15407367653) with \u003c@911437720994324570\u003e's repo/branch for EIP-7917. When it's finished please use these reference tests to verify your implementations work. I expect these to be ready 10:00am UTC.",
        "created_at": "2025-06-02T23:05:38.737000+00:00",
        "attachments": null
    }
]