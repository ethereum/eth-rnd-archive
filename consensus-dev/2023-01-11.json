[
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "\u003c@360491619402776577\u003e if you are still interested, I made the ssz tx root function in Erigon that uses both gohashtree and zero leaves, should end up being similar for geth: https://github.com/ledgerwatch/erigon/blob/d451e67cd4bd65d43e9202b573b4038398ffdcc8/cl/merkle_tree/list.go#L137",
        "created_at": "2023-01-11T01:20:09.467000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I suspect all of those big brains have dealt with LE/BE in the past and have an internal heuristic built up that such conversions are a very likely place to see bugs.",
        "created_at": "2023-01-11T03:10:48.068000+00:00",
        "attachments": null
    },
    {
        "author": "siladu",
        "category": "general",
        "parent": "",
        "content": "Not speaking on behalf of all besu but agree that this will add delay to Shanghai. I am weakly against doing that, mainly because it's currently not clear how much it would delay besu.\nI am not confident we would have it ready for the public testnet next week, or even before the interop.\n\nI do agree that SSZ is the right move at some point soon, but I'm not convinced how much of an issue the withdrawals RLP techdebt will be.\nI don't really have a sense of the potential tech debt for contracts, but if we can somehow avoid that, then won't the remaining tech debt just be the same amount of work as migrating transactions, receipts, etc over to SSZ (which is out of scope for this proposal I think)?\n\nI am also weakly against using gwei for Withdrawal because it means the API (as well as the EL) will be a mix of wei and gwei. I can see that being a source of confusion and complexity down the line, although only a minor one.\n\nI think some other besu devs favour a delay, and I may too once I'm convinced it is a small delay and that the tech debt issue is significant enough to warrant it.",
        "created_at": "2023-01-11T06:57:07.721000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "This is slightly odd to me that the conversion happens on the \"client\" (CL) side. But it looks like we're already too far to make any changes to that part.",
        "created_at": "2023-01-11T09:28:57.752000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "Yeah, it's quite common with some details like this only being revealed after doing implementation progress for a bit. This issue is especially hidden because it is right at the interface between CL and EL, and if only looking at one of the systems in isolation, the issue won't be spotted.",
        "created_at": "2023-01-11T10:03:32.965000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "Here is a Nimbus version that supports amounts in Gwei and SSZ for the inconsistent fields:\nâ€“Â https://github.com/status-im/nimbus-eth2/pull/4487\nIf you need something for testing, feel free to give it a shot.",
        "created_at": "2023-01-11T10:04:20.424000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "Not speaking in the name all of the Erigon, but generally we think that a delay is worth it in order not to create tech debt",
        "created_at": "2023-01-11T14:48:36.298000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "Again gwei to wei conversion would be the last of our problems if we had mismatching hashes. We are talking about execution payload header not being an execution payload header which makes even less sense",
        "created_at": "2023-01-11T14:49:30.638000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "ideally we can discuss during the CL call tomorrow so if you are reading this and want to add your perspective, please join!",
        "created_at": "2023-01-11T15:14:37.075000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "fwiw i hear the tech debt argument and think that saying \"its ok just this one time\" is how we end up saying that consistently and ending up with a large amount of tech debt in the long run; that being said this is a somewhat invasive change and would delay shanghai which i don't think anyone wants\n\nmy personal disposition: do not delay shanghai with this change, while acknowledging this is a corner of the protocol we need to change in the future -- the nature of the RLP -\u003e SSZ conversion arc is such that it is something we wont really \"forget\" and is big enough to justify its own focus (i.e. we can scope converting the entire EL structure from RLP to SSZ modulo the state in the next hard fork)",
        "created_at": "2023-01-11T15:17:24.576000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "What are your thoughts on the fact that we have delayed the introduction of SSZ in the EL multiple times now, each time saying \"we'll do it later\"?  Do you think that there will be a *better* \"later\" than now?",
        "created_at": "2023-01-11T15:38:02.811000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "People say that 4844 requires SSZ in the EL, but is that a hard requirement or something where we can once again say \"we'll do RLP in the EL for now, but we'll switch to SSZ later\"?",
        "created_at": "2023-01-11T15:38:59.685000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "general",
        "parent": "",
        "content": "+1 on this: \u003c@\u0026688101493978562687\u003e \u003c@\u0026836981603216654336\u003e \u003c@\u0026652918665943056397\u003e \u003c@\u0026688090867927482525\u003e, if you all can send someone with context about this to the CL call tomorrow, it'd be great to make a final call on this then vs. waiting another week until ACD",
        "created_at": "2023-01-11T15:40:53.887000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "Simon's opinion is more informed than mine for besu, I'd put besu at \"-0\"",
        "created_at": "2023-01-11T15:42:03.019000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Negative means RLP withdraws and mismatched CL/EL block headers, positive means SSZ withdraws and matching CL/EL headers?",
        "created_at": "2023-01-11T15:42:59.743000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "general",
        "parent": "",
        "content": "I roughly agree with \u003c@687974325072035882\u003e . (Caveat: I am not implementing it, \u003c@360491619402776577\u003e is). I wonder if people aren't overestimating the complexity of adding ssz root? I mean, there must surely exist good java support for ssz. Dotnet maybe less so, which I fully understand. \n\nMaybe unrelated: the eth gossip protocol will not be affected, imo. Only the way the response is verified. Either way: that is up for EL devs to decide ðŸ™‚",
        "created_at": "2023-01-11T15:48:08.726000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "There is to say that you do not need neither full serialization or deserialization of ssz, ELs would just require to implement the SSZ hash function, which for Withdrawals list is not so complicated imo. Again you used the 4 fields as leaves and then hash them as a tree",
        "created_at": "2023-01-11T15:55:49.944000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "At least for me it was straightforward",
        "created_at": "2023-01-11T15:56:13.858000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Have we made a decision to convert wei to gwei before calculating withdrawals root on EL side to match CL one?",
        "created_at": "2023-01-11T15:56:45.575000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "general",
        "parent": "",
        "content": "Sounded like the CL side were pretty solid locked into Gwei. So yes I guess? (But I reserve my right to grumble about it)",
        "created_at": "2023-01-11T15:57:43.883000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I haven't seen anyone argue that we should have them not match.  There was some grumbling that CL should use attoeth (wei) but I think everyone has accepted defeat on this from what I have seen.  So nanoeth (gwei) for both.",
        "created_at": "2023-01-11T15:58:00.379000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "I agree that other than that the implementation satisfying our needs (working with withdrawals only) should not be difficult and can be covered by tests pretty well.",
        "created_at": "2023-01-11T15:58:05.060000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "Would it be terrible to delay Shangai by one to 2 months anyway? Just asking for feedback",
        "created_at": "2023-01-11T16:01:38.941000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "Although I doubt any of the changes above would realistically lead to a delay",
        "created_at": "2023-01-11T16:02:19.080000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Converting to gwei effectively means that eventually once EL becomes fully SSZ-aware, withdrawals will have to be converted into a bit different structure to compute the root. This discrepancy will stay there forever which is annoying",
        "created_at": "2023-01-11T16:04:32.403000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Hmm, why would withdraws need to change if we choose nanoeth?",
        "created_at": "2023-01-11T16:07:41.589000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Oh, you mean make change to the existing EIP?",
        "created_at": "2023-01-11T16:08:20.620000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I thought picking nanoeth meant we *wouldn't* have to change the structure later?",
        "created_at": "2023-01-11T16:08:20.933000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I assumed what we were talking about here was having the EL calculate the withdraw root *exactly* the same as the CL.",
        "created_at": "2023-01-11T16:08:55.619000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Which means using nanoeth (gwei) as the unit for ether amounts during the calculation.",
        "created_at": "2023-01-11T16:09:35.620000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Right, there are two ways to achieve that. One is do a dirty conversion every time, the other one is to change withdrawals to gwei on EL.",
        "created_at": "2023-01-11T16:09:41.993000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Where else in consensus, gossip, or engine API are withdraw amounts referenced that is currently in attoeth (wei)?",
        "created_at": "2023-01-11T16:10:37.170000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "CL converts gweis to weis before passing withdrawals to engine API method calls, that's it on CL/EngineAPI side",
        "created_at": "2023-01-11T16:11:31.192000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "general",
        "parent": "",
        "content": "Changing EL to work with gwei gets rid of this odd conversion as well",
        "created_at": "2023-01-11T16:12:57.449000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Hmm, yeah, I would prefer to get rid of all similar warts before they are introduced in a hard fork (Shanghai).  That being said, we *can* deprecate engine API code eventually so that one isn't infinite tech debt.",
        "created_at": "2023-01-11T16:17:21.147000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "won't \"scoping it for the next hard fork\" essentially delay said hard fork even more, because now instead of just doing the conversion, it also comes with the legacy code that will need to be maintained forever? Concretely, would delaying this mean that EIP4844 gets delayed by more than we would save for Capella by delaying it?",
        "created_at": "2023-01-11T17:19:01.138000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "Or, the other way around, would EIP4844 be easier if this conversion is already done from the getgo?",
        "created_at": "2023-01-11T17:19:41.902000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "(Considering that we want to eventually do the conversion anyway, and looking at long-term)",
        "created_at": "2023-01-11T17:21:19.054000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "multiple times? i just count once w/ the merge, potentially twice if we assume the current 4895 is a decision as well\n\nand i call it out bc to me this doesn't seem like we are just putting it off forever but it is the type of thing that could become the thing we keep putting off",
        "created_at": "2023-01-11T17:26:47.023000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "i think saying \"lets do as much of the conversion as is reasonable in cancun\" is a _better later_ than now, simply given how far along we are in the shanghai process and the fact that it seems a bit better to batch the conversion process as much as possible",
        "created_at": "2023-01-11T17:27:56.742000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "i don't think we should convert all EL elements to SSZ in shanghai; i could be convinced to do this _just_ for withdrawals in shanghai",
        "created_at": "2023-01-11T17:28:38.832000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "but given its easier to just \"do it all at once\", then why not just wait until we have the time to do it all together, i.e. the next hard fork",
        "created_at": "2023-01-11T17:29:01.933000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "can someone point out the 4844 dependency to me? ill go take a look, the dependency doesn't immediately come to mind",
        "created_at": "2023-01-11T17:30:01.159000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "i think given that the \"legacy code\" is mostly already written we can benefit from the sunk cost in terms of shipping shanghai faster",
        "created_at": "2023-01-11T17:30:56.543000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "i don't think this is big enough to delay 4844 (there will be 4844 implicit things that will delay that feature plenty w/o any other protocol shenanigans)",
        "created_at": "2023-01-11T17:31:38.925000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "it _is_ big enough in my view to delay shanghai",
        "created_at": "2023-01-11T17:31:46.583000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "arguably even having this conversation is evidence of this",
        "created_at": "2023-01-11T17:31:58.098000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "the calculus would be different if we had opened this in say november or early december",
        "created_at": "2023-01-11T17:32:17.818000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "again, no direct interaction b/t serialization of existing things + withdrawals and 4844, we _could_ have a convo about the timelines of the fork that could contain 4844 (which maybe is what you meant)",
        "created_at": "2023-01-11T17:33:19.106000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "https://ethereum-magicians.org/t/eip-4895-beacon-chain-withdrawals-as-system-level-operations/8568/28\nhaha, that's around when it started ðŸ˜…",
        "created_at": "2023-01-11T17:35:59.351000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "ah of course, we want to use it for the serialization of the new transaction type",
        "created_at": "2023-01-11T17:36:14.456000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "which is really just following this philosophy of \"we should move to SSZ in the medium/long run as it improves upon RLP in several ways\"",
        "created_at": "2023-01-11T17:36:44.811000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "if its not in the court of ACD, it didn't happen :p",
        "created_at": "2023-01-11T17:37:10.204000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "so the way i see this, assuming 4844 ships in the fork after shanghai:\n\noption 1: no change, withdrawals are RLP encoded and EIP-4895 stays as written and updated in the next fork (along w/ transaction and receipt encoding to pair w/ the use of SSZ in 4844)\noption 2: withdrawals (only) are updated to be SSZ-encoded in shanghai -- main blocker: adding relatively large untested code this late in the shipping process for shanghai so needs implementation work and testing work; we target converting transaction and receipt encodings to SSZ along w/ 4844",
        "created_at": "2023-01-11T17:43:31.458000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "i personally expect the 4844 feature set to take long enough that it can easily \"absorb\" the time cost of getting quality SSZ libraries ready for each EL client along w/ the relevant testing",
        "created_at": "2023-01-11T17:44:31.263000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "and while it is unfortunate to have a period of one fork where the withdrawals are written a different way, i think we have to acknowledge the importance of shipping withdrawals as quickly as possible for the community",
        "created_at": "2023-01-11T17:45:14.512000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "I think the debt of changing the withdrawal accumulator later on is much higher on application side than the client side. So, a forward compatible idea: have a precompile or opcode that takes in a withdrawal and witness and returns whether it is valid. We can later, as part of a fork, extend the precompile/op to support SSZ tree verification in addition to MPT",
        "created_at": "2023-01-11T17:52:25.317000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "It *feels* like a precompile like that would be more work than just switching withdraw_root to SSZ?  I may be wrong on this though.",
        "created_at": "2023-01-11T18:00:49.444000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "i think in the interest of shipping shanghai we should either be making no change or very incremental change at this point",
        "created_at": "2023-01-11T18:07:49.936000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "opening up the conversation to making a universally compatible accumulator scheme opens a can of worms imo",
        "created_at": "2023-01-11T18:08:12.036000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "Yeah, I prefer just deploying withdrawals as it is specified. I don't think the client debt is very high, especially if we're already going to move the other accumulators over in the future.\n\nBut I think some are making the argument that SSZ is this endgame thing that will allow applications to just hard code the structure and call it a day, and I don't think that is the case. Withdrawals are probably less susceptible to changing than other consensus structures, but if one day we decide we need another field in the withdrawal object, we would run into problems with applications that already rely on the exact structure.\n\nSo basically, if you're an application, don't rely 100% on consensus structures and accumulators staying the exact same",
        "created_at": "2023-01-11T18:11:12.713000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "general",
        "parent": "",
        "content": "if anything we need a precompile that takes in a hard fork version, a global identifier for a SSZ schema and then returns a generalized index into the queried data -- this problem has come up in a number of other conversations and i agree it is something to think about but out of scope for this one local decision about what to do w/ shanghai",
        "created_at": "2023-01-11T18:13:18.543000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "agreed",
        "created_at": "2023-01-11T18:13:58.529000+00:00",
        "attachments": null
    },
    {
        "author": "siladu",
        "category": "general",
        "parent": "",
        "content": "I think that means EL will forever have a mix of fields in wei and gwei.\n\nEven at the engine API level, base fee is in wei. That can technically go as low as 7 wei. Not sure about other wei fields...guess we don't need to worry about transactions for the engine API?",
        "created_at": "2023-01-11T22:15:58.129000+00:00",
        "attachments": null
    }
]