[
    {
        "author": "stefa2k.eth",
        "category": "general",
        "parent": "",
        "content": "are attest aggregations rewarded on top of attesting rewards?",
        "created_at": "2020-12-06T09:25:55.581000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "No, aggregating is a common good.",
        "created_at": "2020-12-06T09:46:42.118000+00:00",
        "attachments": null
    },
    {
        "author": "benjaminion",
        "category": "general",
        "parent": "",
        "content": "There's no extra reward for the validators that aggregate attestations. Block proposers have an implicit incentive to pack attestations well as there is limited block space - but most blocks are nowhere near full yet, so there's little pressure to do so right now. The ultimate result is that there is an _implicit_ reward for me as a validator to produce good aggregations: if I want _my_ attestation to be included, I should try to include it in a juicy aggregate to make it attractive for the proposer to include.",
        "created_at": "2020-12-06T09:46:45.848000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Coming back to yesterday's conversation about block delays in slot 0 of an epoch, here is a scatter plot that nicely shows the problem on mainnet.\n\nThe x axis is slot in epoch, the y is milliseconds from the start of the slot until a `head` event is received by my process.  That big empty space in terms of early receipt of blocks in slot 0 of an epoch is pretty clear.\n\n(In case anyone cares, this is running against a Teku node 20.11.1 and using the `/eth/v1/events` endpoint to receive the head event).",
        "created_at": "2020-12-06T13:11:34.427000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "blockdelay.png",
                "content": "1d9e058eb2c0aaaab009e10de357150483000794f0c9f7ac0f6d824a6d9a0250"
            }
        ]
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "Very interesting! Ive been suspecting this a bit. Glad to see some data. \n\nI know teku can have a slow epoch transition locally. Do we know if the teku node will have a head event while doing an epoch transition? If not, the local node might skww the result a bit",
        "created_at": "2020-12-06T14:21:50.136000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "I'm a bit surprised to see nothing below that 1800ms portion. I know teku has a sizable epoch transition optimisation in the release queue which makes me worried the node thats aggregating this data might be skewed",
        "created_at": "2020-12-06T14:31:42.144000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Yeah, not sure if we'll get the head event beforehand or not.  Probably not, just from a guess.\n\nWill point it at a prysm node instead for a while and see how that looks.",
        "created_at": "2020-12-06T14:34:59.937000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "Awesome! Thanks \u003c@144468805697929216\u003e",
        "created_at": "2020-12-06T14:35:18.924000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "When I woke up today, i thought I might poke into this issue, but your graph was already sitting here waiting to be read :)",
        "created_at": "2020-12-06T14:35:59.317000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "(Actually I'll run it for both at the same time, so we have a contemporaneous comparison)",
        "created_at": "2020-12-06T14:36:35.981000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I posted essentially the same data a couple of days ago on the pyrmont channel, based on prysm",
        "created_at": "2020-12-06T15:04:42.493000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "So this is about all clients",
        "created_at": "2020-12-06T15:05:05.211000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "According to \u003c@476250636548308992\u003e's comment this may be something in the p2p layer more than a delay in submitting the block",
        "created_at": "2020-12-06T15:32:14.499000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "I have trouble thinking of a reason the p2p layer would be slower here and so sharply with nothing below 1800ms.  The much more likely culprit, imo, is slow initial propagation  due to epoch transition load \n\nCurious to see \u003c@144468805697929216\u003e's graphs none the less",
        "created_at": "2020-12-06T15:40:46.241000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "That was my guess but Nishant benchmarked the calculation in 100ms max",
        "created_at": "2020-12-06T15:41:40.058000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Also note that currently 30% of the votes in mainnet are wrong on slot 0",
        "created_at": "2020-12-06T15:42:14.563000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "This goes to 75% on pyrmont, so this may be an issue as validators onboard",
        "created_at": "2020-12-06T15:42:39.791000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "Yeah, I know its pretty efficient in most clients\n\nDid you also see the sharp start at 1000ms+ or did it scatter nearer 0 than jims data?",
        "created_at": "2020-12-06T15:42:50.599000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "My data on mainnet is exactly like jgm",
        "created_at": "2020-12-06T15:43:58.480000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Not entirely sure, but pyrmont is both higher load + less frequent updates. About to update all EF nodes + try experimental teku optimizations. Let's see how things change",
        "created_at": "2020-12-06T15:44:00.621000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Pyrmont is much worse",
        "created_at": "2020-12-06T15:44:04.246000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "In pyrmont the average delay in slot 0 is 8 seconds!!",
        "created_at": "2020-12-06T15:44:34.354000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "wasn't there a target-checkpoint voting bug on first epoch slot? Maybe pyrmont nodes are still running that, making the problem worse",
        "created_at": "2020-12-06T15:45:24.867000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I don't think that would be a reason @proto: on pyrmont 50% of blocks come after 4 seconds",
        "created_at": "2020-12-06T15:46:23.396000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "So that all clients will vote wrong at least 50% of times",
        "created_at": "2020-12-06T15:46:40.761000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "The wrong vote of 75% is in accordance to the delay data",
        "created_at": "2020-12-06T15:47:05.242000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Assuming that essentially 25% of the nodes are Teku's, the changes should be statistically noticeable, can you please let me know in which epoch you deploy the changes?  I'll keep track of this measure. If it improves it'll certainly  point to submission as an issue",
        "created_at": "2020-12-06T15:54:21.157000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I could keep track of delays of Teku-proposed nodes only on pyrmont that's easy given the graffiti",
        "created_at": "2020-12-06T15:55:06.801000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "So the plan is to spin up a new set of nodes, and retire the old set. Reducing the EF count to 20, to try and make running pyrmont more sustainable. First I'll have to get the new nodes synced, and then I'll move over validators.",
        "created_at": "2020-12-06T15:56:10.492000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "In the meantime, I'll look into pushing the change to existing teku nodes",
        "created_at": "2020-12-06T15:56:38.866000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Update to existing teku pyrmont nodes is slowly rolling out now. *Experimental changes*",
        "created_at": "2020-12-06T16:07:52.773000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Ok so I assume by epoch 4100 it will be done? I'll start tracking only Teku-produced blocks",
        "created_at": "2020-12-06T16:10:41.138000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Before 4088 and after 4100",
        "created_at": "2020-12-06T16:11:09.588000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "We're only running 5% of total validators for each client. Other nodes are client devs, and some users. Don't think consensys is running the latest teku optimizations yet, they have 20% of the net.",
        "created_at": "2020-12-06T16:11:59.931000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I can filter by Your graffiti",
        "created_at": "2020-12-06T16:12:29.865000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Or Teku's since \u003c@573787335796326400\u003e said they'll be deploying as well",
        "created_at": "2020-12-06T16:12:59.958000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "if it's teku, and validator index is \u003c 20_000, then it's an EF teku validator (on pyrmont)",
        "created_at": "2020-12-06T16:13:05.544000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Luckily my 10 leaking validators didn't make it before 20000 üòÜ",
        "created_at": "2020-12-06T16:13:49.155000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "hahaa, oh right that was you. Yea, little bit of noise in the data, no easy filtering",
        "created_at": "2020-12-06T16:14:26.713000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "When I move validators to new nodes I'm planning to redo the assignments, and select continuous 5% batches for each client type, out of the EF validators",
        "created_at": "2020-12-06T16:15:07.777000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "So it will be easier to filter with just some if statements. Should have done that from the start, but node assignments were more complicated (going for a lot more shuffling between regions, eth1 nodes, etc.)",
        "created_at": "2020-12-06T16:16:20.771000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "But now I can filter by graffiti without trouble",
        "created_at": "2020-12-06T16:17:14.900000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I am interested in proposed blocks only",
        "created_at": "2020-12-06T16:17:30.487000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "yea, will keep node type in graffiti",
        "created_at": "2020-12-06T16:17:32.758000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "I see an ef teku node proposing a block on pyrmont, should be up to date now",
        "created_at": "2020-12-06T16:22:46.079000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "updating existing nimbus nodes next, those also had some new improvements to deploy",
        "created_at": "2020-12-06T16:45:37.322000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "\u003c@!203220829473996800\u003e teku/v20.11.1 has the improvements? or should I look for \"21-g66afa36\" in the teku nodes?, the EF nodes by themselves will take a while to gather enough data",
        "created_at": "2020-12-06T19:45:51.680000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Not in master branch yet, I'm looking at PRs: https://github.com/ConsenSys/teku/pull/3265 https://github.com/ConsenSys/teku/pull/3352\nMerged (and resolved conflicts) here: https://github.com/protolambda/teku/tree/fasterteku - Beware, experimental",
        "created_at": "2020-12-06T19:47:42.010000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "ok, I'll be monitoring delay on only EF Teku nodes then, but that will take a probably several days to reach something relevant",
        "created_at": "2020-12-06T19:48:57.269000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Thanks for looking into this so deep \u003c@!755590043632140352\u003e üëç  I'll ask Teku folks what they run on Pyrmont now, if they can trial the PRs too, etc.",
        "created_at": "2020-12-06T19:53:38.989000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I already DM \u003c@!573787335796326400\u003e, probably sleeping though",
        "created_at": "2020-12-06T19:54:04.150000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I'm just curious, who knows I'll end up finding something wrong with the RNG explaining why the hell my lonely validator hasn't been assigned a block yet",
        "created_at": "2020-12-06T19:55:11.902000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "üôÇ",
        "created_at": "2020-12-06T19:55:12.999000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "On pyrmont or mainnet? With 1 validator in a 100k pool, chances are just very low to get a block proposal. Approx 7% for a day I think",
        "created_at": "2020-12-06T20:07:03.886000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Mainnet, haven't proposed yet since genesis. On pyrmont I have tons of proposals",
        "created_at": "2020-12-06T20:08:02.837000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "think the chance of that happening is about a 1/4? It's more complicated with bigger changes in active validator set count. Someone should make a calculator that accounts for validator set changes",
        "created_at": "2020-12-06T20:11:49.502000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Yeah I only computed binomial with the weighted average and gives a little below 1/4. Eventually I'll be part of some historical batch :)",
        "created_at": "2020-12-06T20:15:48.368000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "We've been running 3352 on a couple of our pyrmont nodes and the results aren't amazing.  I suspect https://github.com/ConsenSys/teku/pull/3265 is actually the more important change.  Plus once that one's in we can precompute epoch transitions and essentially eliminate the extra processing cost.",
        "created_at": "2020-12-06T20:31:39.023000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I suspect that the precompute is not going to make much difference to the issue of the first block delay, I tend to agree with \u003c@!476250636548308992\u003e on this, prysm already precomputes the state and still both on mainnet and pyrmont we are seeing these delays. Anyway I'll restrict the search to Teku just to have some specific implementation to benchmark against the previous general",
        "created_at": "2020-12-06T20:33:47.176000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "The thing with the status-precompute is that it should try reduce the amount of times you touch those attestation bitfields, and try to convert it to a more efficient lookup. All the work involved with getting individual bits over and over again from those attestation objects is very slow.",
        "created_at": "2020-12-06T20:35:15.446000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "general",
        "parent": "",
        "content": "Another thing that causes epoch-transition lag, and I remember it slowing down Lodestar way back, was the attestation-clearing. Every epoch transition the attestation pools are cleaned up: nodes start to iterate through huge amounts of attestations to filter out the old ones. This may be part of the epoch transition hiccup problem.",
        "created_at": "2020-12-06T22:48:44.421000+00:00",
        "attachments": null
    }
]