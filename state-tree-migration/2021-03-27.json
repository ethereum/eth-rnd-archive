[
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I may be missing something, but the selfdestruct main performance problem is with deleting unbounded number of storage slots, not code, so selfdestruct would be fine if it leaves storage alone, and only deletes code?\nI know people that use create2 contracts as upgradeable wallets because it's cheaper than delegatecall eventually (300-400x calls iirc). removing selfdestruct altogether would potentially brick them, but leaving storage alone would actually make it a more useful pattern",
        "created_at": "2021-03-27T08:25:50.154000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think long term (verkle tries) we want storage to be a flat key-value store.",
        "created_at": "2021-03-27T08:47:08.843000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The short term plan last I heard was to just remove the storage refund.",
        "created_at": "2021-03-27T08:47:19.059000+00:00",
        "attachments": null
    },
    {
        "author": "vorot93",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "first of all, selfdestruct is rather complex to implement, without *that* much to bring to the table",
        "created_at": "2021-03-27T12:43:36.877000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e I may be missing something, but the selfdestruct main performance problem is with deleting unbounded number of storage slots, not code, so selfdestruct would be fine if it leaves storage alone, and only deletes code?",
        "created_at": "2021-03-27T12:43:57.968000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think doing this would lead to *more* bugs",
        "created_at": "2021-03-27T12:44:03.809000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Becuase the behavior of a contract is a complex interaction between storage and code",
        "created_at": "2021-03-27T12:44:15.372000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So better to either remove both or remove neither",
        "created_at": "2021-03-27T12:44:40.402000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh also, another thing: if we remove code, than that takes away the ability to greatly increase code size in the future if we want to do that",
        "created_at": "2021-03-27T12:45:01.756000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hence the preference to just neuter the selfdestruct opcode all the way, and make it a \"send all ETH\" opcode",
        "created_at": "2021-03-27T12:45:29.517000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "just removing the ability - what happens if someone is currently missing for some reason and has a lot of funds that depend on the ability to upgrade code to be accessible? removing that would be a big backwards compatibility break\nmaybe make it so that selfdestruct replaces the first byte with 0xfe (invalid) and sets a special flag that allows overwriting the existing code?",
        "created_at": "2021-03-27T14:12:18.985000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "doesn't have to be a special flag - should be enough to set all header fields to defaults for an empty account:\nhttps://github.com/ethereum/go-ethereum/blob/44c0bb2b44ca71790ccf8a842eccaa72619a2a02/core/vm/evm.go#L454",
        "created_at": "2021-03-27T14:26:32.014000+00:00",
        "attachments": null
    },
    {
        "author": "vorot93",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "it's only a big compatibility break for those who (ab)use selfdestruct for contract upgrades\n\nOTOH removing it will *greatly* simplify client implementations when coupled with regenesis",
        "created_at": "2021-03-27T14:36:29.507000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "how is that abuse? it's a valid use pattern and there was no indication it's going to be removed in the future.\nhttps://devpost.com/software/will-o-the-wisp public example",
        "created_at": "2021-03-27T14:42:52.990000+00:00",
        "attachments": null
    },
    {
        "author": "vorot93",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I must admit I wasn't there when Ethereum launched, but my impression was that selfdestruct's purpose was to encourage cleaning up state, not provide for overwriting contract code",
        "created_at": "2021-03-27T14:48:31.480000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the possibility was created with create2, not when selfdestruct was created, so you can blame people that proposed create2 for not blocking this use pattern I guess. unlike calls with static gas costs bricking contracts that use this can't be blamed on poorly written contracts as there was zero indication to think it could ever be taken away.\nthis doesn't mean selfdestruct has to actually clean storage and code, it's enough to just reset the header",
        "created_at": "2021-03-27T14:53:17.533000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "in fact if I remember correctly the possibility of upgradeable contracts was a big discussion when create2 was proposed and at the end the conclusion was that it's fine",
        "created_at": "2021-03-27T14:56:59.290000+00:00",
        "attachments": null
    },
    {
        "author": "vorot93",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we do have special *incarnation* index in TG, but doesn't mean that it's all fine and not complicated\n\ntook weeks to months to get it working 100% correctly\n\none of those gotchas that any new client implementations will have to hop through - again, to very little benefit to the network",
        "created_at": "2021-03-27T14:58:41.138000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I couldn't disagree more with 'little benefit'. what's the plan if someone appears with stuck funds after the hard fork - tell them it's their fault for not following the technical changes in every hard fork? that would make it very hard to trust ethereum.",
        "created_at": "2021-03-27T15:03:21.542000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the issue here is not the possibility of upgradeable contracts itself but breaking backwards compatibility in a way that can brick contracts that could reasonably be assumed to keep working forever",
        "created_at": "2021-03-27T15:04:15.065000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Brainstorming:  What if `SELFDESTRUCT` no longer cleared the state, but instead left the state in place.  We then modify `CREATE2` so that it cannot be performed if the state root for the contract is non-empty.  Then we introduce a mechanism for manually clearing the state from a \"dead\" contract.  Someone wishing to take advantage of the upgradable contract pattern would then be responsible for paying the gas gosts to clear out the state after a `SELFDESTRUCT` before they can put new code into place...",
        "created_at": "2021-03-27T15:25:46.003000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(I don't love the complexity, but maybe this is a direction towards a largely backwards compatible way to remove the O(n) complexity of SELFDESTRUCT behavior.)",
        "created_at": "2021-03-27T15:27:48.925000+00:00",
        "attachments": null
    },
    {
        "author": "vorot93",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sometimes, you just have to do what's right, even if it means stepping on others' toes...\n\nPretty sure that the vast majority of contract developers are aware of the plan to kill selfdestruct",
        "created_at": "2021-03-27T15:32:20.108000+00:00",
        "attachments": null
    },
    {
        "author": "vorot93",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We shouldn't sacrifice simplicity for the sake of few contracts imo",
        "created_at": "2021-03-27T15:33:57.172000+00:00",
        "attachments": null
    },
    {
        "author": "0xsadcat",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "found an article that proposes using upgradeable contracts as a way to store data, requiring to separately clean the state could break it. this one is more likely to be in production imo, although I don't know anyone using it.\nsetting headers to empty (from the verkle proposal) and nonce to 0 would save this approach too by allowing overwrites\nhttps://medium.com/coinmonks/on-efficient-ethereum-storage-c76869591add",
        "created_at": "2021-03-27T15:36:44.851000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the main reason `CREATE2` was introduced was not for the upgradeable contracts (in fact, upgradability with `create2` does not really work well, because the storage is cleared - so you have to use `DELEGATECALL` proxy in any case), the main reason was the use in state channels (creating ephemeral contracts that can be deployed at any time by any party to the state channel, to perform on-chain adjudication)",
        "created_at": "2021-03-27T15:38:31.482000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that intended use does not depend on `SELFDESTRUCT`",
        "created_at": "2021-03-27T15:40:43.666000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "it has been later discovered that `CREATE2` and `SELFDESTRUCT` could be used for a more efficient gasTokens (than `CREATE` and `SELFDESTRUCT`), which are Chi tokens. Also, some people started use the pair for so-called \"wisp\" pattern, to emulate the functionality where you would have code injected into the transaction, instead of deploying that code first. Wisp pattern can be made obsolete if there was a possibility of running code from tx without deployment.",
        "created_at": "2021-03-27T15:45:09.432000+00:00",
        "attachments": null
    }
]