[
    {
        "author": "controlcthenv",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That sounds about right for mainnet, since I know there is a discussion on how to do \"The Verge\" in a way that doesn't introduce an unreasonable burden on full-nodes who have to sync + verkelize their merkle db's (which could in turn take months)",
        "created_at": "2022-09-06T02:26:16.537000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "sounds good, that's on par with what I have when I don't use preimages (early estimates tend to overshoot because there's a lot of very big contracts at the start of the account space, so it might be faster than that in the end)",
        "created_at": "2022-09-06T11:51:19.653000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What is meant by preimage?",
        "created_at": "2022-09-06T13:41:13.040000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "preimages = the addresses / slot numbers, not the hashes of these, that are used as MPT tree keys",
        "created_at": "2022-09-06T15:22:29.475000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ah right, Geth do not have a plain state",
        "created_at": "2022-09-06T15:43:58.380000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "BTW, I was thinking if we could merge together code size, nonce and balance leaves",
        "created_at": "2022-09-06T16:23:50.633000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we could represent them as a 32 bytes value made of [8 byte (nonce), 8 byte (code size) and 16 byte balance]",
        "created_at": "2022-09-06T16:24:28.349000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "btw a balance of 16 byte to overflow, must be over 340282366920938487808 ethers",
        "created_at": "2022-09-06T16:24:59.711000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "which is 2835686391007.821x current Ether circulating supply",
        "created_at": "2022-09-06T16:25:41.827000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think this may improve the situation?",
        "created_at": "2022-09-06T16:25:51.478000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "max code size would be 16 exabytes(not even sure where that stands)",
        "created_at": "2022-09-06T16:28:06.609000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "also, this might be a stupid consideration, but we already store address key =\u003e code hash, why do we need to also store plain contract code",
        "created_at": "2022-09-06T16:35:02.603000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that would unfortunately not improve the situation, because the medium-term goal is to use zk proofs, and extracting all these from zk proofs would make the circuits more complex.",
        "created_at": "2022-09-06T16:36:02.826000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Why? What difference would it make if we change the value format",
        "created_at": "2022-09-06T16:36:28.068000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Still the value we going to get",
        "created_at": "2022-09-06T16:36:34.409000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm not a zk expert, what I understand is they work better for functions that are 32x32 input -\u003e 32 output",
        "created_at": "2022-09-06T16:37:26.063000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "No i understand",
        "created_at": "2022-09-06T16:37:41.356000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But it is 32 -\u003e 32",
        "created_at": "2022-09-06T16:37:50.780000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if you cram everything together, you lose that property",
        "created_at": "2022-09-06T16:37:50.984000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "how so?",
        "created_at": "2022-09-06T16:38:21.042000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "what I see is that if you have balance, size and nonce cramed into a single 32-byte, you have 32 -\u003e 32x32x32",
        "created_at": "2022-09-06T16:38:45.670000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "No",
        "created_at": "2022-09-06T16:38:51.960000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thats not what i said, what i said is that you concatenate 8 bytes(nonce) + 8bytes(code size) + 16 bytes (balance)",
        "created_at": "2022-09-06T16:39:37.230000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That amount to 32 bytes",
        "created_at": "2022-09-06T16:39:43.945000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes",
        "created_at": "2022-09-06T16:39:49.935000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "and if you want to prove an execution step that only accesses, e.g. balance, you need more circuitry to extract the balance into another 32 byte value",
        "created_at": "2022-09-06T16:40:50.030000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I mean you would have to decode it and the pre append 16 leading zeroes",
        "created_at": "2022-09-06T16:41:41.087000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It does not sound bad?",
        "created_at": "2022-09-06T16:41:51.406000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think maybe there are some complexities involved",
        "created_at": "2022-09-06T16:42:04.110000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "like I said, I'm not a zk expert. My uderstanding is that, yes it makes the circuit more complex.",
        "created_at": "2022-09-06T16:42:41.745000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@555483069038198827\u003e could you please shine some light on this?",
        "created_at": "2022-09-06T16:43:33.303000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Who wrote the zk circuit maybe he can answer the question, I might be very wrong",
        "created_at": "2022-09-06T16:43:37.853000+00:00",
        "attachments": null
    },
    {
        "author": "tanishqjasoria",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "as far as I can understand, if we concatenate the values, then we will have to add the decoding part( i.e., for balance taking first 16 byte and appending 16 zeros) to the zk circuit and that would be an issue , I guess.",
        "created_at": "2022-09-06T16:45:25.642000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "An issue in implementing it or would it make things actually way worse in terms of performance?",
        "created_at": "2022-09-06T16:47:57.518000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "and the answer this question: the code is broken into multiple chunks, and only the code that is touched by a transaction is included.  Because this needs to be proven, the code chunks have to belong to the tree to keep the proof shorter. Af for the hash, it's not the has of the chunified code, it's the keccak.",
        "created_at": "2022-09-06T16:49:10.860000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ah okay that makes sense",
        "created_at": "2022-09-06T16:49:24.398000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "so it's like a marker so that we know if the code is to be stored deduplicated in the db.",
        "created_at": "2022-09-06T16:49:52.500000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that is my understanding, yes",
        "created_at": "2022-09-06T16:50:08.768000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "On another note, when computing the keys for code chunks, I think we can just use the initial key with the last byte increased by `i` and recomputing each time we overflow that byte, i see go-ethereum do not do that",
        "created_at": "2022-09-06T16:51:23.033000+00:00",
        "attachments": null
    },
    {
        "author": "tanishqjasoria",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i think implementation issues, because of breaking 32 byte values into 16 bytes.",
        "created_at": "2022-09-06T16:51:23.628000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "uh? yes it does, you might be looking at an old version",
        "created_at": "2022-09-06T16:52:38.855000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the PR I sent you definitely does that",
        "created_at": "2022-09-06T16:53:14.849000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "is it done automatically in `GetTreeKeyCodeChunkWithEvaluatedAddress`?",
        "created_at": "2022-09-06T16:55:27.646000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "because i see this `for i := 0; i \u003c totalEvals; i++ {\n            chunkEvals[i] = utils.GetTreeKeyCodeChunkWithEvaluatedAddress(contract.AddressPoint(), uint256.NewInt(uint64(i)*256))\n        }`",
        "created_at": "2022-09-06T16:55:41.514000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah that's old code",
        "created_at": "2022-09-06T16:56:05.277000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "oh I see, yes indeed it's not in the 'main' branch",
        "created_at": "2022-09-06T16:56:15.497000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "my bad",
        "created_at": "2022-09-06T16:56:19.528000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I am working on a big update to the code that will bring all of this in the main branch, I need a couple more days to make sure that everything works",
        "created_at": "2022-09-06T16:57:20.677000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the outstanding change is here https://github.com/gballet/go-ethereum/pull/125/files#diff-c3757dc9e9d868f63bc84a0cc67159c1d5c22cc5d8c9468757098f0492e0658cR545",
        "created_at": "2022-09-06T16:58:03.144000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "okay thank you ðŸ™‚",
        "created_at": "2022-09-06T16:58:34.551000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I will then fork some of your code and optimizations like in the old good days of turbo-geth ðŸ˜¤",
        "created_at": "2022-09-06T16:59:33.064000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But on a more serious note, if we can get the verkle tree to be compact, it would be really nice, if it is just hard to implement I think it should at least be attempted. current Erigon is taking 1 day to generate verkle trees while Geth 6 days, so a tree more compact would be appreciated.",
        "created_at": "2022-09-06T17:04:17.316000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "agreed, it we can make it more compact it's better. At the same time, even a 6 day generation is nothing if we have a future-proof tree structure that does not have to be updated for years. But smaller is always better.",
        "created_at": "2022-09-06T17:55:34.281000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In any case, could you also indicate me how we then verify the verkle proof (and how to generate those headers field)",
        "created_at": "2022-09-06T18:12:19.427000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "as far as I understand only the block producers actually need the full tree",
        "created_at": "2022-09-06T18:12:36.381000+00:00",
        "attachments": null
    }
]