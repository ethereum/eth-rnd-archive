[
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@353136597522448385\u003e , \u003c@427491045308235776\u003e ,  some news here. I did a PR in my repo of benchmarks with the following changes:\n- For Keccak benchmarks, we use the same hasher as go-ethereum which uses a trick for avoiding allocations. Also, it now gives representative benchmark results.\n- Include benchmarks to compare Keccak and Pedersen hash for accounts and storage slots.\n- Include benchmarks for finite-field inverses and multiplication, comparing go-ipa and blst (CGO).\n- To be safe about comparing Go and BLST, I created some Test* to be sure both libraries have the same results. This is an obvious expectation, but I want to be sure endianess or any other potential difference isn't playing out in benchmark results.\n- Create native C benchmark for Inv and Mul using blst.\n- Create Makefile to do local runs easily.\n- I posted the benchmark results on two different setups in the README.\n- General refactors in benchmark code and namings.\n\nThe main benchmark results can be seen in the README: https://github.com/jsign/verkle-vs-patricia\n\nI'd recommend seeing my comments in the PR https://github.com/jsign/verkle-vs-patricia/pull/1/files  (no need to review, it's merged already, just see the PR comments)\nThere I commented about:\n- The README benchmark results, with some extra details and my opinion about it. (cc \u003c@555483069038198827\u003e  you might be interested in only looking at this)\n- I also commented the code, if you want to double-check the benchmarks (Go or C for blst)",
        "created_at": "2022-10-31T22:24:31.197000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Very cool! (Still reading :D)",
        "created_at": "2022-10-31T22:32:02.605000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "All these results are with the latest version of `blst`, `go-ipa`, and `go-ethereum` (beverly-hills-head version).\nBefore diving into some analysis of the MPT depth suggested by \u003c@555483069038198827\u003e , I want to check out if I see some other Go implementations of some of these things out there. I've some ideas...",
        "created_at": "2022-10-31T22:32:05.696000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It seems that benchmarking a multiplication with go-blst is a red herring because the multiplication operation is so fast",
        "created_at": "2022-10-31T22:32:50.379000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I mentioned in the PR comment there that the CGO boundary is dominating there. So, only look at the C blst benchmark :)",
        "created_at": "2022-10-31T22:33:21.614000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The field multiplication code in go-ipa needs to pull an update, which should give improvements for arm. I haven't checked if they have been merged upstream yet",
        "created_at": "2022-10-31T22:34:22.592000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Cool. Both benchmark results are in amd64 machines.  Would be interesting to see how it behaves on ARM",
        "created_at": "2022-10-31T22:35:23.869000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So extrapolating, there is roughly a 300-400ns difference in the inversion between the go-ipa field code and the blst code",
        "created_at": "2022-10-31T22:35:44.151000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Also, anyone feel free to run these benchmarks locally. You only need the Go and C compiler.\nWith that only do: `make bench-go` and `make bench-blst`",
        "created_at": "2022-10-31T22:35:58.038000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`make bench-go` gives me:\n\n```\ncpu: Intel(R) Core(TM) i9-9980HK CPU @ 2.40GHz\nBenchmarkFpInverse/go-ipa-16                      504774              1988 ns/op               0 B/op          0 allocs/op\nBenchmarkFpInverse/go-blst-16                     684110              1538 ns/op              32 B/op          1 allocs/op\n```\n\nMy laptop is usually down bad, so these results are expected",
        "created_at": "2022-10-31T22:40:18.135000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`make bench-blst` doesn't work off immediately:\n\n```\ncd blst-bench \u0026\u0026 ([ -f libblst.a ] || (git clone https://github.com/supranational/blst.git \u0026\u0026 ./blst/build.sh ; rm -rf blst))\nCloning into 'blst'...\nremote: Enumerating objects: 4900, done.\nremote: Counting objects: 100% (1234/1234), done.\nremote: Compressing objects: 100% (306/306), done.\nremote: Total 4900 (delta 1003), reused 1099 (delta 916), pack-reused 3666\nReceiving objects: 100% (4900/4900), 1.47 MiB | 9.79 MiB/s, done.\nResolving deltas: 100% (3482/3482), done.\n+ cc -O2 -fno-builtin -fPIC -Wall -Wextra -Werror -mno-avx -c ./blst/src/server.c\nIn file included from ./blst/src/server.c:7:\nIn file included from ./blst/src/keygen.c:7:\nIn file included from ./blst/src/consts.h:8:\n./blst/src/vect.h:402:11: fatal error: 'stdlib.h' file not found\n# include \u003cstdlib.h\u003e\n          ^~~~~~~~~~\n1 error generated.\ncd blst-bench \u0026\u0026 cc -I . main.c libblst.a -o main \u0026\u0026 ./main \u0026\u0026 rm main\nclang: error: no such file or directory: 'libblst.a'\nmake: *** [bench-blst] Error 1\n```",
        "created_at": "2022-10-31T22:41:14.493000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Out of curiosity, which Go version do you have? `go version`",
        "created_at": "2022-10-31T22:41:15.079000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`go version go1.17.2 darwin/amd64`",
        "created_at": "2022-10-31T22:41:37.189000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah, that's somewhat oldish. You can update to go1.19 and probably you'll get some improvements.",
        "created_at": "2022-10-31T22:42:06.128000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Uhm, looks like it can't find the C standard library.",
        "created_at": "2022-10-31T22:42:23.201000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think MSV for geth is 1.17",
        "created_at": "2022-10-31T22:43:50.964000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Uhm, that seems quite conservative, but looks like they say \"or later\" here https://github.com/ethereum/go-ethereum#building-the-source\nThe version listed in the `go.mod` is for \"language version\" (https://github.com/ethereum/go-ethereum/blob/master/go.mod#L3), and not strictly Go compiler verision.\n\nBut maybe the policy is to recommend two previous minor versions for security/stability reasons?",
        "created_at": "2022-10-31T22:47:36.586000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I'll run it on AWS (these spurious errors usually occur for me)",
        "created_at": "2022-10-31T22:48:28.278000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I've to say that writing that C program felt like the \"wild west\" again... felt so unsafe (compared to Go or Rust). ðŸ˜„",
        "created_at": "2022-10-31T22:50:47.077000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "undefined behaviour is your friend ðŸ™‚",
        "created_at": "2022-10-31T22:51:55.297000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@774033563732541451\u003e reading the benchmarks, the go-ipa Mul operation is 10x faster than the blst one?",
        "created_at": "2022-10-31T22:52:15.627000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, that was suprising... here's my interpretation of that: https://github.com/jsign/verkle-vs-patricia/pull/1/files#r1009912729",
        "created_at": "2022-10-31T22:53:10.967000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "TL;DR the \"go-ipa\" is a red herring since the underlying impl is actually fully written in assembly hehe",
        "created_at": "2022-10-31T22:54:02.346000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@427491045308235776\u003e , actually is ~5x, not 10x",
        "created_at": "2022-10-31T22:55:06.959000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah that would make sense, since the scalar field is not usually optimised. For the inversion, I think blst just has a better algorithm",
        "created_at": "2022-10-31T22:55:19.512000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes sorry ðŸ™‚",
        "created_at": "2022-10-31T22:56:52.188000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The numbers comparing pedersen to keccak are unsuprising to me, so I guess it's now a question of how many times keccak is called vs pedersen for the same access patterns",
        "created_at": "2022-10-31T23:05:24.434000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think so, yes. I guess that's where \u003c@555483069038198827\u003e  was trying to get to with the quetsion of average MPT depth for accounts and storage (but I'm guessing).\nWhat we can do is also compare building a dataset of 1 million (key, value), build the MPT and the VKT, and measure the latency of adding a single next entry in both cases. That should theoretically cover that question too.",
        "created_at": "2022-10-31T23:11:46.023000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For Go, the elephant in the room is trying to avoid allocations as much as possible too. Not only they ask for more memory, but also create \"garbage\" and you'll have the GC in the background eating up to 25% of your CPU and blowing up your CPU caches.",
        "created_at": "2022-10-31T23:12:51.113000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm pretty sure that can offset many of the subtle microbenchmark differences we're seeing",
        "created_at": "2022-10-31T23:13:26.702000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yep, though I think the 1M would need to be representative of the average usecase, so maybe you can get these keys and values from blocks instead of using a random distribution for example",
        "created_at": "2022-10-31T23:14:45.288000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Definitely.",
        "created_at": "2022-10-31T23:14:55.563000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I've a semi-synced Goerli node. (Since I don't have a big enough disk for a mainnet one :(, I've to buy some disk soon)",
        "created_at": "2022-10-31T23:15:30.004000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Maybe I can try getting the snapshot from Goerli and use that as a \"reasonable\" distribution",
        "created_at": "2022-10-31T23:15:44.571000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah I think that will do, let me know if you need to borrow an AWS instance (not synced though)",
        "created_at": "2022-10-31T23:17:38.783000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Now that I think about it, for the \"accounts\" MPT I think \"random\" should have the same distribution?\nThe trie keys are the addresses, so that should be random (last 20 bytes of keccak)",
        "created_at": "2022-10-31T23:19:02.256000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For storage slots I agree the real data seems more important, since the distirbution of storage slots probably isn't entirely random.",
        "created_at": "2022-10-31T23:19:51.643000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(Please anyone correct me if wrong because can be the case!)",
        "created_at": "2022-10-31T23:20:03.824000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I donâ€™t know about the MPT tbh, I was mainly thinking about how GetTreeKey produces the same 31 bytes for the same address in the VT case",
        "created_at": "2022-10-31T23:21:16.660000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh yeah, for VKTs makes sense since the account data is mapped to different trie keys (that should be close).",
        "created_at": "2022-10-31T23:22:26.698000+00:00",
        "attachments": []
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@427491045308235776\u003e, thanks for your feedback about this. I'll meditate a bit more and I'll end up doing these more e2e benchmarks with representative data soon.",
        "created_at": "2022-10-31T23:24:39.821000+00:00",
        "attachments": []
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thanks for the benchmarks and the report, itâ€™s been super helpful! ðŸ˜¬",
        "created_at": "2022-10-31T23:26:02.874000+00:00",
        "attachments": []
    }
]