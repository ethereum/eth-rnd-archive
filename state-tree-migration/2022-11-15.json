[
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@427491045308235776\u003e, I summarized here the benchmark against that branch for `go-ipa` and `go-verkle`: https://hackmd.io/@jsign/Syq7DcWIs\nThe TL;DR is that there're regressions. Most of the regressions seem to be related to allocs (and thus some CPU impact).\nThe only way to potentially solve this is to look case by case why and see if:\n- That relates to some optimization we did before that isn't in the original gnark-crypto\n- Maybe new extra allocs in the updated version implementations.",
        "created_at": "2022-11-15T22:50:52.151000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So I'd guess the ideal thing would be to figure out each case, see if we can save the same allocations as we did before, and try to upstream as much as possible to gnark-crypto. (And eventually see if any impl changed in a way that we can't make it \"on par\" with what we have today).",
        "created_at": "2022-11-15T22:58:22.962000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah those look pretty bad, the delta is not large, but since they are used so often, they have a significant impact on upstream libraries",
        "created_at": "2022-11-15T23:13:07.050000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I donâ€™t remember modifying the finite field code in any meaningful way ðŸ¤”",
        "created_at": "2022-11-15T23:14:07.766000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Most of it is auto-generated, the only thing that was changed was the endianness",
        "created_at": "2022-11-15T23:15:16.268000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The code makes use of big.Int in some places which is probably the root cause of the allocs (Iâ€™m guessing the newer code is more liberal with its usage of it)",
        "created_at": "2022-11-15T23:16:18.832000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we did https://github.com/crate-crypto/go-ipa/pull/18 a while ago in even a previous version of the lib. but not sure how much of that really has survived further updates",
        "created_at": "2022-11-15T23:24:41.498000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think those changes are preserved, I only pulled down the â€˜fpâ€™ package from gnark-crypto",
        "created_at": "2022-11-15T23:26:32.664000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "oh true. didn't touch `fp` or `fr`",
        "created_at": "2022-11-15T23:27:38.850000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "uhm, so all this might be actually new unknown regressions",
        "created_at": "2022-11-15T23:27:55.541000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Unless the fp I pulled down is using an old goff version like what you found, though that would be weird as Iâ€™d expect them to update everything",
        "created_at": "2022-11-15T23:28:47.128000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Iâ€™ll check the release",
        "created_at": "2022-11-15T23:28:51.593000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "oh i think it's old, yes. the Inverse(..) in this new branch https://github.com/crate-crypto/go-ipa/blob/kw/gnark-merge-dep/bandersnatch/fr/element.go#L902 feels to me is the old one that we changed.",
        "created_at": "2022-11-15T23:30:32.555000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "let me double check...",
        "created_at": "2022-11-15T23:31:18.243000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "~~ \u003c@427491045308235776\u003e , there's something weird I think.\n- Current master: this is the `fp` implementation https://github.com/crate-crypto/go-ipa/blob/master/bandersnatch/fp/element.go#L908\n- Your branch: this is the `fp` implementation https://github.com/crate-crypto/go-ipa/blob/kw/gnark-merge-dep/bandersnatch/fp/fp.go#L35, where `basefield` there refers to `fr`. and that `fr` is https://github.com/crate-crypto/go-ipa/blob/kw/gnark-merge-dep/bandersnatch/fr/element.go#L905 ~~",
        "created_at": "2022-11-15T23:36:02.427000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "scratch ^. ðŸ˜…",
        "created_at": "2022-11-15T23:37:25.647000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Haha no worries ðŸ™‚ yeah that basefield refers to the fr of bls12-381",
        "created_at": "2022-11-15T23:38:01.088000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It seems that the code has not changed in four months for the field generator binary in gnark",
        "created_at": "2022-11-15T23:38:48.675000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So we are using the most updated one I think",
        "created_at": "2022-11-15T23:39:01.063000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There was this PR which shows that thereâ€™s precedence to remove code if newer versions of golang make them obsolete: https://github.com/ConsenSys/gnark-crypto/pull/192",
        "created_at": "2022-11-15T23:43:55.048000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Iâ€™m guessing you used 1.18 or a fairly new version on the benchmarks?",
        "created_at": "2022-11-15T23:44:27.360000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, 1.19. But feels to me the new allocations shouldn't be related to that.",
        "created_at": "2022-11-15T23:45:49.624000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "pkg:github.com/crate-crypto/go-ipa/bandersnatch/fr\n\nIn the hackmd, should this say fp?",
        "created_at": "2022-11-15T23:46:49.839000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There're no benchmarks in the `bandersnatch/fp`  folder",
        "created_at": "2022-11-15T23:47:47.873000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh right because itâ€™s now a type alias, the benchmarks live in the gnark-crypto crate",
        "created_at": "2022-11-15T23:48:41.252000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "As fr in bls12-381",
        "created_at": "2022-11-15T23:48:58.014000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The fr benchmarks might be a red herring then as they should not have been modified",
        "created_at": "2022-11-15T23:49:27.269000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think what confused me before is that, our `bandersnatch/fr`  isn't the same as the `gnark-crypto/..../fr` \nIs that fine?",
        "created_at": "2022-11-15T23:50:14.793000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yep, the fr from bls12-381 is being used as the fp for bandersnatch and then bandersnatch defines a different fr",
        "created_at": "2022-11-15T23:50:57.123000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Cool, I think makes sense. Bandersnatch is a curve \"inside\" of BLS?",
        "created_at": "2022-11-15T23:51:58.459000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yep exactly",
        "created_at": "2022-11-15T23:52:06.953000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "On mobile right now, but tomorrow I can generate the fp again for bandersnatch using goff, so it looks exactly like it was before and you can run benchmarks locally",
        "created_at": "2022-11-15T23:53:02.176000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sounds good. In any case, the benchmarks runs in `go-verkle` probably are the ones that gives the most signal. LMK whenever you have a new version, and I can run again the benchmarks of both repos so we're sure.",
        "created_at": "2022-11-15T23:54:42.006000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sounds good, thanks for the hackmd and apologise for the confusion (might be an argument to generate fr and fp in go-ipa as itâ€™s also less confusing to read ðŸ¤”)",
        "created_at": "2022-11-15T23:57:02.538000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Not problem at all.. these things are messy :)",
        "created_at": "2022-11-15T23:57:46.515000+00:00",
        "attachments": null
    }
]