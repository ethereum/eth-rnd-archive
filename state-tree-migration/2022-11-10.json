[
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@353136597522448385\u003e do you have a branch that you want to test with PoS, can you point me to it? I'll make the changes to prysm to try to run with your branch this weekend",
        "created_at": "2022-11-10T02:14:52.826000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Well, `toFr` takes the commitment to a child node (a Point) and turns it into a field element, so that it can be used to evaluate the parent node's polynomial. I agree that it returns an Fp value and not an Fr. It feels wasteful to call `Bytes` on one, and then immediately call `SetBytesLe` on the other.",
        "created_at": "2022-11-10T06:51:21.604000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "on my block-replay test, `Inverse` itself takes 42% less time",
        "created_at": "2022-11-10T07:07:04.947000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that'd be great. I do have this branch: https://github.com/gballet/go-ethereum/pull/136 There's a caveat in your case: it won't perform the verkle transition, so if you have to start in pow mode and then merge, the verkle transition has to happen at genesis time, i.e. before the merge.",
        "created_at": "2022-11-10T07:15:35.506000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That's fine by me, do you have instructions on how to generate the genesis state? An example genesis.Json would be awesome",
        "created_at": "2022-11-10T08:51:44.340000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the genesis file is given in the issue : https://github.com/gballet/go-ethereum/pull/136#issuecomment-1304886725",
        "created_at": "2022-11-10T09:52:47.365000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "thanks, I'll let you know if I have issues, I will need to change so that we do not start merged, hopefully that genesis.json does not assume  that",
        "created_at": "2022-11-10T09:59:40.333000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "oh I see, yes it will assume that, but you can simply set the tdd to a higher value and that should do the trick",
        "created_at": "2022-11-10T10:15:24.652000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ah, yeah, that may work, thanks, will try this weekend. I need to find out the format of the new payload, but will look at the EIP or your code for the marshalling/unmarshalling",
        "created_at": "2022-11-10T10:24:37.494000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I can expose a method named MapToScalarField which merges the two maps together. It wouldnâ€™t change performance but this may be an easier abstraction for clients as they are doing less and have one less endianness code path to worry about, since itâ€™s done inside of the crypto lib",
        "created_at": "2022-11-10T10:58:36.253000+00:00",
        "attachments": null
    },
    {
        "author": "gballet",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if it doesn't change the performance, then it's not urgent, but I guess it would be helpful to write cleaner code, yes",
        "created_at": "2022-11-10T12:44:54.764000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This should now be merged into master. You should be able to use `MultiMapToScalarField` which will implicitly call `SetBytesLe` to turn the byte array into a field element in the scalar field",
        "created_at": "2022-11-10T23:04:15.159000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I updated my original benchmark PR, that's 10% faster: https://github.com/gballet/go-verkle/pull/291#issuecomment-1311036587",
        "created_at": "2022-11-10T23:25:09.689000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hmm thatâ€™s unexpected, have switched to phone so I canâ€™t check what  the difference is or what allocs are being skipped",
        "created_at": "2022-11-10T23:38:55.142000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It actually makes sense. What was happening before your change is that we have to re-deserialize the slice bytes to Frs again, so that involved making another slice of Frs",
        "created_at": "2022-11-10T23:42:06.033000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah the alloc is from making another slice, I thought you were iterating the slice and converting to Fr",
        "created_at": "2022-11-10T23:43:46.340000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We can actually make the code a bit faster, by preallocating the slice elements \u003c@774033563732541451\u003e not sure if you want to do it and re-bench or I can tomorrow",
        "created_at": "2022-11-10T23:44:53.543000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, I was actually doing that now. hehe",
        "created_at": "2022-11-10T23:45:25.275000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I allowed ~6% extra if the slice is somewhat biggish (bigger than 128)",
        "created_at": "2022-11-10T23:45:52.658000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Please submit a PR for that!",
        "created_at": "2022-11-10T23:46:01.893000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But I think we can go further and avoid allocating by switching to the other style of API that receives a `[]*Fr` for the result",
        "created_at": "2022-11-10T23:46:13.973000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh maybe we are talking about different things? Because we can allocate the exact amount of elements",
        "created_at": "2022-11-10T23:46:23.476000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So you don't create slices in `go-ipa`",
        "created_at": "2022-11-10T23:46:26.040000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@427491045308235776\u003e , maybe :) \nI'm refering to avoiding this `append` entirely https://github.com/crate-crypto/go-ipa/blob/master/banderwagon/element.go#L157",
        "created_at": "2022-11-10T23:47:02.031000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh yep thatâ€™s what I meant and also the line above for ys ðŸ™‚",
        "created_at": "2022-11-10T23:47:34.577000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We know the exact number of elements, so I donâ€™t think we need to allocate extra space?",
        "created_at": "2022-11-10T23:48:01.610000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh cool, I though you were refering to doing `scalars := make([]Fr, len(elements))`",
        "created_at": "2022-11-10T23:48:03.396000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yep I was",
        "created_at": "2022-11-10T23:48:14.050000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh, but I mean an extra thing. Not doing that entirely",
        "created_at": "2022-11-10T23:48:22.683000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Expect that the client send you the `[]*Fr`",
        "created_at": "2022-11-10T23:48:30.250000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Because usually in `go-verkle` we know where we might want those results already",
        "created_at": "2022-11-10T23:48:45.002000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(and if we don't, let the client allocate that slice if wants new values)",
        "created_at": "2022-11-10T23:49:00.587000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think this is what I donâ€™t understand, the 6% extra",
        "created_at": "2022-11-10T23:49:03.843000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The 6% extra is when doing `scalars := make([]Fr, len(elements))`",
        "created_at": "2022-11-10T23:49:21.303000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah this makes sense, you can do one alloc in the client and re-use the slice",
        "created_at": "2022-11-10T23:50:42.131000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Why would you add 6% extra here?",
        "created_at": "2022-11-10T23:50:55.251000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Today we do the following in go-ipa:\n```\n    var scalars []fr.Element\n\n    // Multiply x by yInv\n    for i := 0; i \u003c int(len(elements)); i++ {\n        var mappedElement fp.Element\n\n        mappedElement.Mul(\u0026elements[i].inner.X, \u0026yInvs[i])\n        byts := mappedElement.BytesLE()\n\n        var res fr.Element\n        res.SetBytesLE(byts[:])\n        scalars = append(scalars, res)\n    }\n```\nWhat happens here is that `scalars` isn't preallocated. So that `append` will have to grow the slice doubling the size.",
        "created_at": "2022-11-10T23:51:46.553000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That produces some extra allocs that are unnecessary since we know htat `scalars` should have lenght `len(elements)`.",
        "created_at": "2022-11-10T23:52:05.435000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If we do that optimization, it runs 6% faster.",
        "created_at": "2022-11-10T23:52:19.015000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Now... that still makes the `make([]Fr, len(elements)` allocation.",
        "created_at": "2022-11-10T23:52:33.249000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What I mean is that we can also avoid that if we receive the resulting slice from the client.",
        "created_at": "2022-11-10T23:52:46.280000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh, I though you meant to pre-allocate 6% extra elements",
        "created_at": "2022-11-10T23:52:48.240000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh no",
        "created_at": "2022-11-10T23:52:54.433000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "AH okay that makes sense now ðŸ˜„",
        "created_at": "2022-11-10T23:53:15.040000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'll do the `go-ipa` PR, and run the benchmark again letting the client decide if needs to allocate or not.",
        "created_at": "2022-11-10T23:53:39.551000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Did you change it for ys also, so L140 ?",
        "created_at": "2022-11-10T23:53:52.354000+00:00",
        "attachments": null
    },
    {
        "author": "jsign",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "uhm, no, but we should do that too!",
        "created_at": "2022-11-10T23:54:29.582000+00:00",
        "attachments": null
    }
]