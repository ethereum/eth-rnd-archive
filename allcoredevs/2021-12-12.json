[
    {
        "author": "yperbasis",
        "category": "general",
        "parent": "",
        "content": "Also I'd like to highlight that everybody (incl. geth) will probably have to switch to the plain state (i.e. with unhashed keys) as the fundamental state format since it's a prerequisite for the Verkle tree.",
        "created_at": "2021-12-12T10:19:10.176000+00:00",
        "attachments": null
    },
    {
        "author": "yperbasis",
        "category": "general",
        "parent": "",
        "content": "Which (as least that's my understanding) entails a big refactoring of the snap sync.",
        "created_at": "2021-12-12T10:22:42.655000+00:00",
        "attachments": null
    },
    {
        "author": "yperbasis",
        "category": "general",
        "parent": "",
        "content": "One approach would be to have a population of geth (or erigon) nodes synced from genesis that are able to serve all pre-images so that snap-synced geth nodes can convert to the plain state (i.e. with unhashed keys).",
        "created_at": "2021-12-12T10:34:28.952000+00:00",
        "attachments": null
    },
    {
        "author": "yperbasis",
        "category": "general",
        "parent": "",
        "content": "Or bypass conversion based on pre-images and resync afresh using updated snap protocol where the keys are unhashed.",
        "created_at": "2021-12-12T10:37:11.495000+00:00",
        "attachments": null
    },
    {
        "author": "yperbasis",
        "category": "general",
        "parent": "",
        "content": "But to bootstrap that you probably also need a population of nodes synced  from genesis.",
        "created_at": "2021-12-12T10:38:53.459000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "I think that, if the only reason why erigon cannot use snap sync is hashed vs not hashed keys, then we should all just agree on non-hashed keys and that will be it",
        "created_at": "2021-12-12T15:21:46.544000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "There is no super-good reason why our snap sync and db snapshots use hashed keys",
        "created_at": "2021-12-12T15:22:08.231000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "It just seemed like a good idea years ago when we started designing",
        "created_at": "2021-12-12T15:22:57.595000+00:00",
        "attachments": null
    },
    {
        "author": "yperbasis",
        "category": "general",
        "parent": "",
        "content": "Well, one reason is probably that for the Merkle-Patricia trie you need hashed keys, and so with unhashed keys it's not clear how you can immediately verify account ranges and such.",
        "created_at": "2021-12-12T15:29:32.368000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "For state sync, what are the rough requirements here? Ability to fetch contiguous ranges from the various tries using unhashed keys? If so, I believe that our plans for the state network portion of the portal network will satisfy these requirements",
        "created_at": "2021-12-12T18:57:25.333000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "Definitely for account trie. Contact storage tries might end up being too sparsely spread around the network for highly efficient retrieval. State network should allow for massive concurrent download of contiguous ranges of data from the main account trie.",
        "created_at": "2021-12-12T18:59:10.137000+00:00",
        "attachments": null
    },
    {
        "author": "lukaszrozmej",
        "category": "general",
        "parent": "",
        "content": "proofs included in snap sync are merkle proofs, based on hashes",
        "created_at": "2021-12-12T20:44:07.833000+00:00",
        "attachments": null
    },
    {
        "author": "lukaszrozmej",
        "category": "general",
        "parent": "",
        "content": "I'm under same impression that this is the main reason, though there might be something less obvious. Also snap sync is tamper-proof and that's why it uses hashes",
        "created_at": "2021-12-12T20:45:24.560000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "Yeah, I didn't think it through enough",
        "created_at": "2021-12-12T20:48:21.564000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "There has to be something we can do long term though. Maybe verkle trees will solve it.",
        "created_at": "2021-12-12T21:29:00.661000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "That creates the interesting question: do verkle trees support range proofs?",
        "created_at": "2021-12-12T21:29:26.044000+00:00",
        "attachments": null
    }
]