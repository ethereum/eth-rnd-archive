[
    {
        "author": "karalabe",
        "category": "general",
        "parent": "",
        "content": "\u003c@!329594653097721856\u003e Even Option B could work well for you because you can just drop all other eth protocols and just assume eth/66 is the request+typedtx combo",
        "created_at": "2020-11-18T08:44:52.300000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "general",
        "parent": "",
        "content": "So as long as a client o nly wants the latest, the two options lead to the same last protocol result apart of a number bump",
        "created_at": "2020-11-18T08:45:21.401000+00:00",
        "attachments": null
    },
    {
        "author": "draganrakita",
        "category": "general",
        "parent": "",
        "content": "For OpenEthereum, Option A will push back our berlin hardfork support so that we have more time to impl/test changes, Option B is more preferable and timeline laid out seems reasonable.",
        "created_at": "2020-11-18T08:58:48.477000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "It sounds like there is consensus on no legacy transactions in blocks.  Do we want to allow legacy transactions over gossip in eth/67?",
        "created_at": "2020-11-18T09:44:18.769000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Or more generally, do we want to allow gossip of unwrapped legacy transactions once blocks are no longer including them.",
        "created_at": "2020-11-18T09:45:29.599000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I *think* we cannot drop gossip of legacy transactions until some time after the fork block else we run into some weird situations around the fork block.  So clients will start accepting wrapped transactions sometime before the fork block, and then stop accepting unwrapped transactions sometime after the fork block.",
        "created_at": "2020-11-18T09:46:58.816000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Ugh.  I now remember why we didn't deprecate legacy transactions in 2972.  While wrapped and unwrapped transactions are signature compatible, they are not hash compatible (and we don't want them to be, given recent discussions about SSZ).",
        "created_at": "2020-11-18T09:59:52.388000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "By allowing legacy transactions in a block, it means we don't have to deal with the problem of transactions having two hashes for a period of time around the fork block.  If someone submits a transaction and it is included before the fork block, the hash in the block will be `keccak256(rlp(...))`.  If the transaction is included *after* the fork block, the hash in the block will be `hash_or_merkleize(TypeByte || rlp_or_ssz(...))`.",
        "created_at": "2020-11-18T10:04:48.418000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "We can do things to deal with this like storing *both* hashes in memory for some number of blocks before and after the fork block so that users of JSON-RPC can query by either new or old hash.  This is client complexity, but it is complexity we can delete after we are past the fork block since it isn't something that people syncing need to deal with, only the network head has to deal with pending pool stuff.",
        "created_at": "2020-11-18T10:06:11.743000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "\u003c@!206016661470314496\u003e I'm curious if this information changes your calculus on whether dropping legacy transactions from blocks with Berlin is more or less complexity overall?",
        "created_at": "2020-11-18T10:07:14.764000+00:00",
        "attachments": null
    },
    {
        "author": "0xraino",
        "category": "general",
        "parent": "",
        "content": "\u003e We can do things to deal with this like storing *both* hashes in memory for some number of blocks before and after the fork block so that users of JSON-RPC can query by either new or old hash.  This is client complexity, but it is complexity we can delete after we are past the fork block since it isn't something that people syncing need to deal with, only the network head has to deal with pending pool stuff.\n\u003c@!301186049323958275\u003e Actually, I think this might end up happening anyway if they're hash incompatible since they're stored in a map keyed by hash.",
        "created_at": "2020-11-18T12:57:18.183000+00:00",
        "attachments": null
    },
    {
        "author": "0xraino",
        "category": "general",
        "parent": "",
        "content": "We would need to tie them together somehow for querying though",
        "created_at": "2020-11-18T12:58:19.385000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I suppose since they are signature compatible, but not hash compatible, it means that even if we allowed both in a block, a malicious miner could include an unwrapped transaction as a wrapped transaction just to be a dick.",
        "created_at": "2020-11-18T12:59:12.898000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "So even in that case, clients are going to need to deal with dual-hashes for a time.  ðŸ˜¢",
        "created_at": "2020-11-18T12:59:26.954000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Well, deal with dual hashes or just tell people \"probably best to not transact right around fork block.  ðŸ˜¬",
        "created_at": "2020-11-18T12:59:51.777000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "Devils advocate: what's wrong with unwrapped legacy tx on the chain alongside wrapped TXes? If all legacy Txes must be unwrapped then 0xf8-0xff becomes the \"id\" of all legacy transactions.  And we skip the whole dual-hash issue.  Only the part where txes are deserialized will the need to pack the ID into the opaque blob to get valid RLP",
        "created_at": "2020-11-18T15:31:00.434000+00:00",
        "attachments": null
    }
]