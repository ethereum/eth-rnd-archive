[
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "hey all, looking for comments on a `CREATE3` opcode that i want to present in the next all core devs meeting https://github.com/ethereum/EIPs/pull/3171",
        "created_at": "2020-12-23T05:18:39.841000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "at vbuterin, it is pretty much identical to the create2 eip you wrote but without the init code hash. motivation in the eip",
        "created_at": "2020-12-23T05:19:33.955000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "\u003c@!383836935480803339\u003e what is the use case for `CREATE3`?",
        "created_at": "2020-12-23T16:12:01.167000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "uniswap wants to use immutables",
        "created_at": "2020-12-23T16:12:19.364000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "immutables must be initialized in constructor arguments",
        "created_at": "2020-12-23T16:12:25.219000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "if you use constructor arguments, the init code includes those constructor arguments",
        "created_at": "2020-12-23T16:12:43.256000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "why do you need to calculate the address?",
        "created_at": "2020-12-23T16:12:59.848000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "we calculate it onchain rather than making a call to the factory to get the pair address",
        "created_at": "2020-12-23T16:13:13.299000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "the call + sload is more expensive than calculating the pair address",
        "created_at": "2020-12-23T16:13:21.682000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "by 3-4x",
        "created_at": "2020-12-23T16:13:26.809000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "is it infeasible to store the address at some top level frame and SLOAD from there? this would be much cheaper over time than recalculating something millions of times",
        "created_at": "2020-12-23T16:14:58.139000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "the factory stores the addresses, but the swaps don't go through the factory, so you have to call the factory to get the pair address",
        "created_at": "2020-12-23T16:15:29.255000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "even 1 sload is more expensive than computing the create2 address onchain at 649 gas",
        "created_at": "2020-12-23T16:15:47.456000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "we don't recalculate pair addresses, we only calculate once and store into memory, but if we have to include the entire pair bytecode in the router and hash `ceil(len(pair bytecode / 32))` words to do it, it is almost certainly better to just callthe factory.getPair method",
        "created_at": "2020-12-23T16:17:17.889000+00:00",
        "attachments": null
    },
    {
        "author": "hudsonjameson",
        "category": "general",
        "parent": "",
        "content": "\u003c@!383836935480803339\u003e thanks for posting! My recommendation would be to re-post your request for feedback in January after the holidays ðŸ™‚",
        "created_at": "2020-12-23T16:18:14.907000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "would you all mind letting me present it in the next all core dev meeting",
        "created_at": "2020-12-23T16:18:57.877000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "i can keep iterating on it until then",
        "created_at": "2020-12-23T16:19:15.478000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "\u003c@!383836935480803339\u003e that makes sense. On principle, I don't like the idea of removing the relationship of the address to the code deployed at it. However, `create2` has already broken this relationship.",
        "created_at": "2020-12-23T16:20:20.283000+00:00",
        "attachments": null
    },
    {
        "author": "hudsonjameson",
        "category": "general",
        "parent": "",
        "content": "\u003c@!383836935480803339\u003e Please add a comment to next meeting's agenda requesting that it be added. Time permitting I think we can include it. https://github.com/ethereum/pm/issues/232",
        "created_at": "2020-12-23T16:21:07.001000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "indeed i was adding a link to this discussion about it https://ethereum-magicians.org/t/potential-security-implications-of-create2-eip-1014/2614",
        "created_at": "2020-12-23T16:21:30.670000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "the init code hash also creates a lot of usability problems because the init code with the solidity compiler by default includes the metadata hash, which (by default) depends on the machine where the code was compiled",
        "created_at": "2020-12-23T16:22:03.689000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "countless people have run into issues using the uniswap v2 library which hard codes the init code hash of uniswap v2 pairs, because they compile the pair locally and get a different init code hash than is hard coded",
        "created_at": "2020-12-23T16:22:58.928000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "is it fair to say that would you propose with create3 is already possible by delegate calling out of create2?",
        "created_at": "2020-12-23T16:25:15.372000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "no i don't think so",
        "created_at": "2020-12-23T16:30:20.110000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "you mean doing a delegate call in the constructor?",
        "created_at": "2020-12-23T16:30:49.184000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "Yes",
        "created_at": "2020-12-23T16:30:54.238000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "if it's possible, it's extremely difficult, you need to set some immutable variables in the constructor which iiuc modifies the runtime code",
        "created_at": "2020-12-23T16:31:39.857000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "well, actually no, because the init code still depends on the constructor arguments",
        "created_at": "2020-12-23T16:32:44.708000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "Yes, but you can forward those to the delegate call",
        "created_at": "2020-12-23T16:33:09.162000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "but the fact that you have to include constructor arguments in the init code means you need all the bytecode  + the constructor arguments to compute the init code hash",
        "created_at": "2020-12-23T16:41:51.225000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "No the init code hash is fixed by your delegate call ramp",
        "created_at": "2020-12-23T16:45:25.135000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "what would you do the in the delegate call?",
        "created_at": "2020-12-23T16:46:19.512000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "You would deploy the entire deployment payload to a specific address (e.g. including the constructor) then fixed init code would call its caller to get the address to delegate call to, then it would delegate call to desired contact deploy logic",
        "created_at": "2020-12-23T16:47:47.782000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "Obviously this is much more expensive and complex than create3, Iâ€™m just trying to understand if create3 is just an optimization of this flow and if so if the uses of it are wide ranging enough to necessitate an op code",
        "created_at": "2020-12-23T16:49:37.861000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "Looking at this from a  client developer perspective this makes polymorphic contracts (accounts with different code over time) way too easy.  I would much prefer a CREATE3 that takes the hash from the actual contract code and salt rather than init code and salt (CREATE2), and rather than just the caller and salt (this CREATE3).",
        "created_at": "2020-12-23T16:58:27.420000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "why is this something we want to prevent though? the actual contract code (runtime code) is just as hard to get with immutables",
        "created_at": "2020-12-23T16:59:34.480000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "Also, maybe a different name than just a number.  CREATE_CALLER?  (and CREATE2-\u003eCREATE_INIT)",
        "created_at": "2020-12-23T16:59:42.761000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "people can enforce deterministic bytecode in the factory contract, it's weird to enforce it at the protocol/opcode level",
        "created_at": "2020-12-23T16:59:54.381000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "there are whole categories of storage optimizations that are invalidated with polymprphic contracts.",
        "created_at": "2020-12-23T17:00:29.588000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "but i thought you couldn't even depend on the code being fixed for an address with create2",
        "created_at": "2020-12-23T17:01:04.040000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "With this CREATE 3 we would need to get rid of two opcodes instead of one.  With some of the major changes coing up for eth2 such broad strokes are viable.",
        "created_at": "2020-12-23T17:02:00.087000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "There has also been talk of getting rid of SELFDESTRUCT, which would also end polymorphic contracts.",
        "created_at": "2020-12-23T17:02:23.160000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "as an alternative, what about a NONCE opcode that will return the account's nonce?  You could then deterministically derive the resulting address.",
        "created_at": "2020-12-23T17:04:21.696000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "without needing polymorohic account code.",
        "created_at": "2020-12-23T17:05:06.726000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "where would you get the nonce associated with a given set of constructor arguments? you will still need a call/sload",
        "created_at": "2020-12-23T17:05:13.956000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "the NONCE opcode would be a new opcode.",
        "created_at": "2020-12-23T17:05:29.751000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "it's not about getting the deterministic address before deployment, it's about computing it for a specific set of constructor arguments",
        "created_at": "2020-12-23T17:05:38.266000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "that were used in the past",
        "created_at": "2020-12-23T17:05:48.051000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "if it's all constructor arguments that still leaves the door open for polymorphic code accounts.",
        "created_at": "2020-12-23T17:07:18.587000+00:00",
        "attachments": null
    },
    {
        "author": "_shemnon",
        "category": "general",
        "parent": "",
        "content": "We will need to see how the other client devs feel.  Not a hill I'll die on but I want to make sure we do this knowing the side effects.",
        "created_at": "2020-12-23T17:09:19.699000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "IIUC \u003c@!383836935480803339\u003e, you want a unique address per set of constructor arguments, but you don't want the constructor arguments to be part of the address generation algorithm?",
        "created_at": "2020-12-23T17:16:06.469000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I'm assuming there is some factory similar to Uniswap v2 where each exchange is an instance with a couple of constructor arguments.",
        "created_at": "2020-12-23T17:16:25.870000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I assume you want the salt in your case to contain those constructor arguments so you can \"find\" the address later (since constructor args won't otherwise be part of the address derivation)?",
        "created_at": "2020-12-23T17:17:26.827000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "yes this is correct",
        "created_at": "2020-12-23T17:18:44.615000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "```ts\ncontract Factory {\n    address public temp1;\n    address public temp2;\n    function spawn(address first, address second) external {\n        temp1 = first;\n        temp2 = second;\n        new Exchange{salt: keccak256(abi.encodePacked(first, second))}();\n        temp1 = address(0);\n        temp2 = address(0);\n    }\n}\n\ncontract Exchange {\n    address immutable first;\n    address immutable second;\n    constructor() {\n        Exchange.first = Factory(msg.sender).temp1();\n        Exchange.second = Factory(msg.sender).temp2();\n    }\n}\n```",
        "created_at": "2020-12-23T17:24:29.728000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Contract creation is a bit spendy, but you get your deterministic address from salt with a no-argument constructor I think.",
        "created_at": "2020-12-23T17:24:52.163000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "This may be along the lines of what \u003c@!543900561460822016\u003e was talking about.  It is what gave me the idea.",
        "created_at": "2020-12-23T17:25:17.883000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "interesting, let me look into it",
        "created_at": "2020-12-23T17:25:23.165000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "would be dope if this works!",
        "created_at": "2020-12-23T17:26:21.293000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "\u003c@415548822983278593\u003e has written something like this as well",
        "created_at": "2020-12-23T17:26:47.473000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "hardhat has stopped giving revert reasons now that i've done this, but it does solve the issue. the usability is still a problem though. specifically the init code hash is different depending on who compiled the contracts",
        "created_at": "2020-12-23T18:39:52.892000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "\u003c@383836935480803339\u003e why is the init code dependent on who compiled?",
        "created_at": "2020-12-23T18:43:27.856000+00:00",
        "attachments": null
    },
    {
        "author": "sendmoodz",
        "category": "general",
        "parent": "",
        "content": "because solidity appends the metadata hash by default, which depends on the machine unfortunately (https://docs.soliditylang.org/en/v0.7.6/metadata.html)",
        "created_at": "2020-12-23T18:48:11.160000+00:00",
        "attachments": null
    }
]