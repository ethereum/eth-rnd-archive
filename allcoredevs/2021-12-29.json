[
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "I am a bit confused with https://eips.ethereum.org/EIPS/eip-2681 \n\n\u003e The CREATE and CREATE2 instructions to abort with an exceptional halt, where the account nonce is 2^64-1.\n\nWhat does this exceptional halt mean? Does it mean that when I try to CREATE and contract has a nonce of 2^64-1, then we put 0 on the stack OR we invalidate the current call frame?",
        "created_at": "2021-12-29T20:50:49.322000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "In particular what is the definition of \"exceptional halt\"?",
        "created_at": "2021-12-29T20:51:13.828000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Also in https://eips.ethereum.org/EIPS/eip-3860\n\nIs the initcode calldata cost (so the 2 gas per word) considered to be part of the upfront cost? So if I have a transaction where I have enough gas to pay for the calldata, but not enough to also cover this 2 gas per word, is this considered to be an invalid transaction which thus can never be included in a block, or can it included in a block where it immediately consumes all gas and thus goes out-of-gas?",
        "created_at": "2021-12-29T20:54:04.175000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Hmm I guess it's in the EIP, the second rule",
        "created_at": "2021-12-29T20:54:51.732000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "Exceptional halt is a term used in the yellow paper, which in practice means \"out of gas\".",
        "created_at": "2021-12-29T20:56:16.566000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "Actually we want to update the EIP to instead of out-of-gas for it to mean \"return 0 for failure\".\n\nThe `CREATE*` opcodes have two kinds of failure modes, either it does \"out of gas\" or returns 0 to signal failure. Out of the numerous failure cases only two use \"out of gas\" which are more related to interpreter loop, while the create-specific checks do the second case.",
        "created_at": "2021-12-29T20:58:18.190000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Yes those 2 are the stack depth violation and not having enough funds in current contract to cover the `value` param of the create opcode right?",
        "created_at": "2021-12-29T20:59:00.496000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "It is a bit of a mess, but I think those two are the ones.",
        "created_at": "2021-12-29T20:59:22.417000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Well it are 3 right? Also on a contract collission with CREATE2?",
        "created_at": "2021-12-29T20:59:23.994000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Yes so in this case I don't put 0 on stack but instead go OOG in the frame/contract which calls CREATE",
        "created_at": "2021-12-29T21:00:35.006000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "Just checked, actually these two cases return 0 ðŸ™‚",
        "created_at": "2021-12-29T21:03:40.575000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "We haven't made a decision yet on the proposal for the EIP, but \u003c@!275684146658148352\u003e was looking into it and may have some good comments here.",
        "created_at": "2021-12-29T21:05:05.681000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Cool, thanks ðŸ˜„",
        "created_at": "2021-12-29T21:05:30.200000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Could you re-check https://eips.ethereum.org/EIPS/eip-2681 ? It states that if contract nonce is 2^64-1 and there is a CREATE then it goes OOG/exceptional halt. I do recall that there are tests in ethereum/tests. I just checked our code; we are putting 0 on stack instead of going OOG and if indeed ethereum/tests has these then we do pass them. So either that case is not covered for some reason, or the test output is wrong (which means that the client which generated the tests also has a \"wrong\" implementation)",
        "created_at": "2021-12-29T21:09:49.217000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "The geth implementation done by \u003c@!275684146658148352\u003e returns 0 (same as depth+balance), as far as I can tell, so the tests are consistent with geth.",
        "created_at": "2021-12-29T21:22:56.857000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "It is a bit late here though so I should not make assertions ðŸ™‚",
        "created_at": "2021-12-29T21:23:06.504000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "If that's the case then the EIP should be updated ðŸ™‚",
        "created_at": "2021-12-29T21:23:16.828000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "It states \"The CREATE and CREATE2 instructions to abort with an exceptional halt, where the account nonce is 2^64-1.\"",
        "created_at": "2021-12-29T21:23:43.101000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "Definitely, will discuss this in the coming days as we wanted to rectify EIP-3860. Thanks for pointing it out.",
        "created_at": "2021-12-29T21:23:53.236000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "I think for 3860 rule (1) should be that transactions with calldata too long are invalid and cannot be included in a block and that rule 3 should instead not go out-of-gas but indeed put a zero on the stack. \n\n(1) is good UX, since basically \"wasting\" funds is now prevented in that case at protocol level\n(3) is consistent if (1) is included because this now treats the behavior the same as not enough endowment: those transactions can never be created (callvalue + gas cost \u003e account balance can never be included in block since this would give the account a negative balance at the start of the execution). If you try that with a CREATE/CREATE2, then 0 is put on stack",
        "created_at": "2021-12-29T21:32:13.609000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "general",
        "parent": "",
        "content": "I think it is fine to return 0. It is somehow caller fault, but the same not enough balance is. Also keep in mind this will not happen in practice.",
        "created_at": "2021-12-29T21:34:18.118000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Why would this not happen in practice? If these txs are OK and can be included but immediately run out-of-gas then UX tools like MetaMask would need extra logic to block the user for signing these txs. In a \"naive\" implementation where metamask tries to figure out the gas limit for the tx, then metamask would keep increasing the gas limit because it always goes OOG.",
        "created_at": "2021-12-29T21:42:12.435000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "For UX I would definitely say to completely invalidate these txs",
        "created_at": "2021-12-29T21:42:40.477000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "I think \u003c@!425274498732916736\u003e referred to the nonce case, that should never happen on mainnet.",
        "created_at": "2021-12-29T21:45:18.003000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "general",
        "parent": "",
        "content": "Ah right yes that makes sense ðŸ™‚",
        "created_at": "2021-12-29T21:53:03.216000+00:00",
        "attachments": null
    }
]