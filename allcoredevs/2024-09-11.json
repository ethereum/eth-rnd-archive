[
    {
        "author": "holgerd77",
        "category": "general",
        "parent": "",
        "content": "â€žReusable execution spec testsâ€œ\n\nOut of interest, because I canâ€™t fully parse it: what does â€žreusableâ€œ mean in this context?",
        "created_at": "2024-09-11T07:13:12.834000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "general",
        "parent": "",
        "content": "**ACDE tomorrow 14:00 UTC**\n\nAgenda: https://github.com/ethereum/pm/issues/1143\nStream: https://youtube.com/live/A_DuQRICW70\nWill post zoom here before the call\n\n**Please review the candidate PFI \u0026 CFI Pectra EIPs prior to the call.** I've listed them in this PR (can't merge it beacuse some EIPs aren't in `Review` yet): https://github.com/ethereum/EIPs/pull/8846",
        "created_at": "2024-09-11T12:47:54.839000+00:00",
        "attachments": [
            {
                "type": "image/png",
                "origin_name": "Screenshot_2024-09-11_at_8.47.31_AM.png",
                "content": "80d5010d5e9ca568d62d9bf04b604b251d84772bdc3dd1ea3eaac548fd01b38d"
            }
        ]
    },
    {
        "author": "timbeiko",
        "category": "general",
        "parent": "",
        "content": "Thanks Reth for sharing your thoughts in advance! Will cross-post this to the agenda ðŸ™‚",
        "created_at": "2024-09-11T12:48:19.529000+00:00",
        "attachments": null
    },
    {
        "author": "spencer_tb",
        "category": "general",
        "parent": "",
        "content": "\u003c@892053833121923094\u003e created a new function in EEST called `execute` which essentially allows you to send our tests as transactions to a live network or devnet ðŸ™Œ \nSo reusable in the sense of using the exact same tests but in another environment",
        "created_at": "2024-09-11T12:54:09.781000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "\u003c@194432762315407360\u003e We discussed internally at Prysm and we would support https://github.com/ethereum/execution-apis/pull/577 but we do want to stress the risk of enshrining unions in SSZ and/or delaying SSZ adoption on the EL which we would definitely oppose. We can see how it would really lift a task from the EL if you can keep the opaque bytes for the requests and just prefix the type, as long as we have a commitment that when we move the engine API at least to SSZ this list of hexbytes does not turn into a union, then we're fine. Personally (not prysm now),  I think we could always keep the logic of decoding into the CL by serializing this list as a list of opaque byte slices, which then the CL will reinterpret correctly the SSZ encoded part of each request. Problem is that this precludes encoding the full payload as an SSZ object.",
        "created_at": "2024-09-11T14:41:22.581000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Posting here in advance of this week ACD so as to signal for this",
        "created_at": "2024-09-11T14:41:46.507000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "Also -- to summarize my comments there a bit, the other thing it needs is ordering/consensus guarantees",
        "created_at": "2024-09-11T14:43:37.764000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "right now it leans too heavily on the EIP, which itself is woefully underspecified",
        "created_at": "2024-09-11T14:43:52.416000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "but even the guarantees provided by the EIP don't naturally/automatically carry over. No, CLs cannot currently assume based on the resulting spec text they don't have to reconstruct the orders from near-scratch",
        "created_at": "2024-09-11T14:44:39.772000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "that only applies to the EL blocks, which isn't actually what the engine API exposes",
        "created_at": "2024-09-11T14:44:58.326000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "\u003c@654267572107083777\u003e if you are worried about ordering we can definitely add more text about it in the spec",
        "created_at": "2024-09-11T14:49:59.087000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "The EIP defines the canonical ordering",
        "created_at": "2024-09-11T14:50:21.649000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "The EIP defines it, for EL blocks",
        "created_at": "2024-09-11T14:50:33.372000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "the engine API does not",
        "created_at": "2024-09-11T14:50:45.973000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "Yeah that's what I meant, we can define it in the engine API spec",
        "created_at": "2024-09-11T14:51:08.734000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "Another thing, the list is a part of the EL blockhash, so any differences in ordering will be detected",
        "created_at": "2024-09-11T14:51:43.391000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "I know it's been linked before, but is there a concise summary somewhere of what the problem is with SSZ Unions that I can read.  I think it was something about them being difficult to implement in some language?",
        "created_at": "2024-09-11T14:52:02.252000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "I think it's more the issue that they are not implemented in some of the libraries",
        "created_at": "2024-09-11T14:52:50.388000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "In Go, it's also less clear how to actually map them",
        "created_at": "2024-09-11T14:57:13.235000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "general",
        "parent": "",
        "content": "But there are definitely some ways to do it",
        "created_at": "2024-09-11T14:57:31.839000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "If that's the case, I am going to advocate for the libraries to implement them (IMHO). The Portal protocol is using them very effectively and I don't think stable containers are a drop in replacement for their functionality (tell me if I'm wrong about this)...  I think removing them makes our protocol worse, and shuttling them off into an *optional* feature set feels somewhat rude as it is effectively signalling that SSZ is only a tool for the work that you guys are doing and that other are second class citizens",
        "created_at": "2024-09-11T14:59:19.020000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "What SSZ libraries don't have support for Unions?",
        "created_at": "2024-09-11T15:00:42.937000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "https://discord.com/channels/595666850260713488/598292067260825641/1278854293566263459 for example",
        "created_at": "2024-09-11T15:01:40.669000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "or rather https://discord.com/channels/595666850260713488/598292067260825641/1279462640439001179",
        "created_at": "2024-09-11T15:02:02.389000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "Is the idea that stable container is a drop in replacement that you can do this?\n\n```\nStableContainer:\n  a: Optional[TypeA]\n  b: Optional[TypeB]\n\n# meant to be the same as\nUnion[TypeA, TypeB]\n```\n\nIs this the concept?  If so, this is not a drop in replacement.\n\n- It allows for both to be included when a union is exclusively a **xor** b\n- It allows for neither to be included, allowing neither a **or** b to be included.",
        "created_at": "2024-09-11T15:04:23.034000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "Looking at the conversation, there appear to be multiple implementations that include Unions, some in the actual same languages as the ones that don't implement Unions.  There appear to be some developers that dislike them and thus are not wanting to implement them in their SSZ library.  And this from my perspective looks like a few developers trying to force them out of the SSZ specification because:\n\n- They don't like the manner in which they have to implement them in their language\n- They aren't using them in their project\n\nWhich ignores the collateral damage this causes other projects, Portal being a specific example of this, by making Unions second class citizens of SSZ.",
        "created_at": "2024-09-11T15:11:02.352000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "it is a supported case, to simulate unions with that. however, there is no semantic union behaviour here?\n- deposit, withdrawal and consolidation come from different sources\n- deposit, withdrawal and consolidation are processed at different locations\n- there is no overlap between deposit, withdrawal and consolidations\n\nso, in an SSZ world, one would do it like this:\n\n```python\nStableValidatorRequests(StableContainer[8]):\n  deposit_requests: Optional[List[DepositRequest, MAX_DEPOSIT_REQUESTS_PER_PAYLOAD]]\n  withdrawal_requests: Optional[List[WithdrawalRequest, MAX_WITHDRAWAL_REQUESTS_PER_PAYLOAD]]\n  consolidation_requests: Optional[List[ConsolidationRequest, MAX_CONSOLIDATION_REQUESTS_PER_PAYOAD]]\n\nElectraValidatorRequests(Profile[StableValidatorRequests]):\n  deposit_requests: List[DepositRequest, MAX_DEPOSIT_REQUESTS_PER_PAYLOAD]\n  withdrawal_requests: List[WithdrawalRequest, MAX_WITHDRAWAL_REQUESTS_PER_PAYLOAD]\n  consolidation_requests: List[ConsolidationRequest, MAX_CONSOLIDATION_REQUESTS_PER_PAYOAD]\n```\nthe `StableContainer` guarantees that:\n- if future forks add new request kinds, the overall `hash_tree_root` stays the same\n- if future forks remove old request kinds, the overall `hash_tree_root` stays the same\n- the gindices for `deposit_requests`, `withdrawal_requests`, and `consolidation_requests` stays consistent across forks\n- client applications and smart contracts do not need to support different proof shapes across forks",
        "created_at": "2024-09-11T15:12:12.486000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "For reference, we use them here:\n\n- https://github.com/ethereum/portal-network-specs/blob/d3b92d0afeb51f52e66c21dbbb85419c400d6c95/portal-wire-protocol.md#L84\n- https://github.com/ethereum/portal-network-specs/blob/d3b92d0afeb51f52e66c21dbbb85419c400d6c95/portal-wire-protocol.md#L171\n- https://github.com/ethereum/portal-network-specs/blob/d3b92d0afeb51f52e66c21dbbb85419c400d6c95/history/history-network.md#L160",
        "created_at": "2024-09-11T15:13:42.125000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "the way that's used here is just a \"message ID\" + \"message\" wire format. there are no inner unions here?",
        "created_at": "2024-09-11T15:14:35.151000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "consensus-specs uses the same, with a 4-byte forkdigest prefix",
        "created_at": "2024-09-11T15:14:46.607000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "I understand this part of the intended use case for StableContainer and I think it's awesome and should definitely be included.  I am just saying that it isn't a drop in replacement for Union types.",
        "created_at": "2024-09-11T15:14:46.637000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "https://github.com/ethereum/portal-network-specs/blob/d3b92d0afeb51f52e66c21dbbb85419c400d6c95/history/history-network.md#block-header is just an optional",
        "created_at": "2024-09-11T15:15:08.023000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "you could simulate unions in the way that you suggested, with additional logic that ensures only a single case is set at any time",
        "created_at": "2024-09-11T15:15:16.646000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "which comes with the StableContainer SSZ updates",
        "created_at": "2024-09-11T15:15:45.381000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "but, there is no hash_tree_root on the messages in portal, there is no reason to use SSZ for the outer message frame, just doing a message id + message with message being SSZ achieves the goal",
        "created_at": "2024-09-11T15:15:47.099000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "(or can be added separately, but it's been developed as part of that)",
        "created_at": "2024-09-11T15:16:01.873000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "I am in no way trying to suggest that we cannot implement our protocol without a Union. I am saying they provide a tool that makes it so that we don't have to do these kind of \"message id\" prefixes, which is useful and makes our protocol easier to write and implement.",
        "created_at": "2024-09-11T15:16:14.325000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "Correct, this would mean that our encoding doesn't enforce this and requires that it be enforced by application logic which makes our protocol worse.",
        "created_at": "2024-09-11T15:16:40.465000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "you'll have to, eventually, transition away anyway, because the union draft that was used for an early version of custody game / execution sharding does not allow holes in the enum, so you can never deprecate a message",
        "created_at": "2024-09-11T15:17:05.515000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "I don't understand this reasoning.  We don't need this kind of message stability in our protocol so this isn't an issue for us (assuming I'm understanding your intent here)",
        "created_at": "2024-09-11T15:17:53.394000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "for the same reason, it also doesn't work for TransactionTypes, because they have a hole at 0x05 (a signing domain used for eip-7702 authorizations) and at 0x19 (a generic non-transaction signature domain)",
        "created_at": "2024-09-11T15:17:57.180000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "I'm not suggesting that Unions should be used in these cases such as TransactionTypes.  I'm saying that we are using them, they are useful to us, and removing them makes what we are doing worse.",
        "created_at": "2024-09-11T15:18:45.163000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "instead of removing them, can they be moved to the portal specs as an addon? portal appears to work fine in nimbus/fluffy despite nim-ssz-serialization not having proper union support",
        "created_at": "2024-09-11T15:19:22.295000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "the `StableContainer` thing prefixes the messages with a bitmask btw, so the `TypeA` case would have a `0x01` prefix, and the `TypeB` case would have a `0x02` prefix, `TypeC` then `0x04`. so in the end it's the same, just with different values in the first 1-2 byte prefix. application logic can just look at the initial byte to determine the underlying profile, same as it does now, and can error if there is an unknown prefix",
        "created_at": "2024-09-11T15:25:51.515000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "btw, how does snappy compression work in portal? is it compressed in two frames, the first only for the union type, followed by the rest in a second frame? in consensus-specs the format is a 4-byte prefix to indicate the data type, followed by the compressed payload as indicated by the data type prefix",
        "created_at": "2024-09-11T15:34:46.344000+00:00",
        "attachments": null
    },
    {
        "author": "kolbyml",
        "category": "general",
        "parent": "",
        "content": "We don't use snappy compression yet in our protocol. We do use snappy compression in e2store formats though such as `.era`, `.era1`, `.era2` but that isn't exactly related to your question",
        "created_at": "2024-09-11T15:55:45.608000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "See my comments above about treating other projects as second class citizens.  Unions have been present in SSZ for a while.  Many libraries support them.",
        "created_at": "2024-09-11T16:41:38.177000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "Worth noting that our Union use cases are ugly with `payload_type + payload` encoding.  Some of them are indeed embedded within other SSZ objects.  Our use of Unions is not always on the outermost layer of the protocol and thus it isn't a viable solution for our use case.  And as I've said, the use of a stable container as a replacement is also unappealing because of it's lack of ability to enforce that exactly one of the optional types is present.\n\nAnd the idea to move Unions to some sort of second class \"optional\" location in the spec is not a solution I'm happy with for reasons I've stated above about treating other projects as second class citizens.",
        "created_at": "2024-09-11T16:55:02.413000+00:00",
        "attachments": null
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "interesting, would you mind pointing to a usage where it's inside a nested layer? \nthe locations I found either denote a message type, or are of the form `Union[None, T]` where its used as a hack for `Optional[T]`.\nmaybe I am overlooking something.",
        "created_at": "2024-09-11T18:46:59.794000+00:00",
        "attachments": [
            {
                "type": "image/png",
                "origin_name": "image.png",
                "content": "d08448fe5004694e558a366f04dd38687611fa1c64671fe58ba510be948da0c4"
            }
        ]
    },
    {
        "author": "etan_status",
        "category": "general",
        "parent": "",
        "content": "also, if there is a genuine use case for it, would be great to know if that is solely for serialization, or also for merkleization. reason for the question being that one of the aspect making unions difficult to deal with in some SSZ libraries is because they introduce ambiguity into what member a particular generalizedindex may refer to",
        "created_at": "2024-09-11T18:54:07.909000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "The 'BlockHeaderProof' object is nested. It's defined and then if you look a few lines down it is part of a container",
        "created_at": "2024-09-11T19:16:37.952000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "Also the 'content' message is part of our outermost level union which contains all of the message types and is itself defined as a union.",
        "created_at": "2024-09-11T19:35:02.376000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "general",
        "parent": "",
        "content": "I'm not familiar enough with the generalized indices functionality to have an informed opinion on this, but this seems to suggest the spec for unions should be improved to remove this ambiguity?",
        "created_at": "2024-09-11T19:36:02.202000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "That's one of the `Optional[T]` cases",
        "created_at": "2024-09-11T22:47:10.974000+00:00",
        "attachments": null
    }
]