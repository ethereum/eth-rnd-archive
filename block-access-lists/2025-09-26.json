[
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "Quick update on the self-destruct tracking in the specs:\n\nIt was quite a headache to get to a clean implementation. There are multiple scenarios that we should have test cases to:\n\n* Account has pre-balance of 0, deployment -\u003e selfdestruct = no post-balance in BAL\n* Account has pre-balance of 0, deployment -\u003e fund account -\u003eselfdestruct = no post-balance in BAL\n* Account has a pre-balance of \u003e 0, deployment -\u003e self-destruct = post-balance of 0 in BAL\n\nThis is the latest now:\nhttps://github.com/fselmo/execution-specs/pull/10",
        "created_at": "2025-09-26T06:59:34.553000+00:00",
        "attachments": null
    },
    {
        "author": "jwasinger",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003e Account has a pre-balance of \u003e 0, deployment -\u003e self-destruct = post-balance of 0 in BAL\n\n~~Why?  there is no balance change~~ edit: I misread it.  I agree with the cases you've laid out",
        "created_at": "2025-09-26T07:00:37.053000+00:00",
        "attachments": null
    },
    {
        "author": "raxhvl",
        "category": "Cross-layer",
        "parent": "",
        "content": "Think there will some interesting edge case wrt how clients handle account reads internally for BAL since they are implementation dependent even if it doesn't impact the end state of tx.\n\nIn effect, BAL will force to clients sync on reads now too, not just writes like before.\n\n Dumping some scenarios for feedback here.",
        "created_at": "2025-09-26T10:06:20.145000+00:00",
        "attachments": null
    },
    {
        "author": "raxhvl",
        "category": "Cross-layer",
        "parent": "",
        "content": "üîç BAL MUST NOT include target of a 7702 delegation (since the account need not be loaded for the delegation to be created.\n\nToni just clarified this here: https://github.com/ethereum/EIPs/pull/10434",
        "created_at": "2025-09-26T10:08:52.742000+00:00",
        "attachments": null
    },
    {
        "author": "raxhvl",
        "category": "Cross-layer",
        "parent": "",
        "content": "üîç  Do you forsee accounts from the preloader leaking into BAL read somehow? \u003c@402853454126776320\u003e ? Not sure if they share the same logging/tracking mechanism",
        "created_at": "2025-09-26T10:10:44.861000+00:00",
        "attachments": null
    },
    {
        "author": "raxhvl",
        "category": "Cross-layer",
        "parent": "",
        "content": "üîç BAL MUST include Authority as an account read for an invalid 7702 Authoriztion  even if the authorization is invalid (because of nonce read)? TBD",
        "created_at": "2025-09-26T10:19:08.735000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "Thanks for the summary! 100% agree, clients will have to carefully handle edge cases, and some might require additional logic in some clients while others are fine.\nHaving tests about every scenario possible becomes super important.\nIn theory, we should have tests (not bal specific) around all the scenarios possible, so, such bugs will become obvious early on, when failing interop, but even better to iron them our with BAL tests!",
        "created_at": "2025-09-26T11:03:29.176000+00:00",
        "attachments": null
    },
    {
        "author": "jwasinger",
        "category": "Cross-layer",
        "parent": "",
        "content": "we don't \"preload accounts\" so no it won't",
        "created_at": "2025-09-26T11:05:22.820000+00:00",
        "attachments": null
    },
    {
        "author": "jwasinger",
        "category": "Cross-layer",
        "parent": "",
        "content": "but yeah, I think  overall that it's a huge amount of scary edge-cases that are opened up by reads",
        "created_at": "2025-09-26T11:06:14.938000+00:00",
        "attachments": null
    },
    {
        "author": "jwasinger",
        "category": "Cross-layer",
        "parent": "",
        "content": "or at least, seems like it could turn out that way as we further explore undefined edge-cases in the spec",
        "created_at": "2025-09-26T11:06:39.477000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "I think we're quite far when it comes to edge cases and have now dealt with all the endbosses: self destructs in same transaction, system contracts, precompiles, excetional halts, account deletion, etc. I'm confident that with comprehensive tests, we'll make it work. \nBut yeah, you're totally right that reads add additional complexity",
        "created_at": "2025-09-26T11:09:43.507000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "Just as a heads-up, Jason published the Preconf \u003c\u003e BALs piece on ethresearch:\nhttps://ethresear.ch/t/bals-for-proposer-commitments/23095",
        "created_at": "2025-09-26T11:10:09.439000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "In the specs we do access the state trie for validation:\n```\nget_account(state, authority)\n    -\u003e get_account_optional(state, address)\n      -\u003e trie_get(state._main_trie, address)  # Line 198\n```",
        "created_at": "2025-09-26T11:29:02.647000+00:00",
        "attachments": null
    },
    {
        "author": "jwasinger",
        "category": "Cross-layer",
        "parent": "",
        "content": "that's for the authority.  the existence of the target is not checked.",
        "created_at": "2025-09-26T11:30:41.321000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "Right yeah, the target is not included, only if it is then actually accesses",
        "created_at": "2025-09-26T11:32:27.814000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "This is quite clear now in the eip",
        "created_at": "2025-09-26T11:32:34.849000+00:00",
        "attachments": null
    },
    {
        "author": "draganrakita",
        "category": "Cross-layer",
        "parent": "",
        "content": "My guideline about what needs to be inside BAL is if BAL will have all info (or at least all slot keys) for me to execute this tx.",
        "created_at": "2025-09-26T14:05:40.609000+00:00",
        "attachments": null
    },
    {
        "author": "garyrong",
        "category": "Cross-layer",
        "parent": "",
        "content": "BAL construction should be made through the chain processing, rather than the pre-fetcher. I don't think it matters whether the prefetcher is enabled or not, it's just for accelerating.",
        "created_at": "2025-09-26T14:36:42.569000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "What would you say about an invalid 7702 delegation. Do you first load nonce and code of that account or first validate signature. This might affect if the authority lands on the BAL or not. In the specs, we load nonce and code first, for example.",
        "created_at": "2025-09-26T17:24:21.609000+00:00",
        "attachments": null
    },
    {
        "author": "draganrakita",
        "category": "Cross-layer",
        "parent": "",
        "content": "You need to recover signature to get to the address of the account.",
        "created_at": "2025-09-26T17:45:13.993000+00:00",
        "attachments": null
    },
    {
        "author": "draganrakita",
        "category": "Cross-layer",
        "parent": "",
        "content": "how do you do it in diferent order?",
        "created_at": "2025-09-26T17:45:29.477000+00:00",
        "attachments": null
    },
    {
        "author": "raxhvl",
        "category": "Cross-layer",
        "parent": "",
        "content": "Aah right since address is derived from ecrecover",
        "created_at": "2025-09-26T17:45:44.998000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "True yeah, this one is clear.",
        "created_at": "2025-09-26T17:49:55.801000+00:00",
        "attachments": null
    },
    {
        "author": "draganrakita",
        "category": "Cross-layer",
        "parent": "",
        "content": "For eip7702 edge case, chain id check is done before loading as we can do it before.",
        "created_at": "2025-09-26T19:59:32.908000+00:00",
        "attachments": null
    },
    {
        "author": "jih2nn",
        "category": "Cross-layer",
        "parent": "",
        "content": "We're getting closer to the first interop. Terence and I made Prysm work yesterday. And today, I've opened a PR that makes communication between Prysm, Lodestar and Geth work. Please have a look into this PR: https://github.com/jwasinger/go-ethereum/pull/17\n\nAfter having the code change, the following error will occur. It looks like some BALs logic subsequent to `NewPayloadV5` requires careful examination. Here is the log. cc \u003c@427903869226582018\u003e \n\n```\n[el-1-geth-prysm] ########## BAD BLOCK #########\n[el-1-geth-prysm] Block: 32 (0xfba1159335316efde30f6a0ee5b3cddb6d924bfba8a403812daac83efdf198de)\n[el-1-geth-prysm] Error: BAL contained account e8427f8325f7e8a7124a9b12ae1b85a569de27e4 which wasn't present in computed state diff\n[el-1-geth-prysm] Platform: geth v1.16.2-0.20250925164202-a1918f0ef3b0+dirty go1.24.7 arm64 linux\n[el-1-geth-prysm] VCS: a1918f0e-20250925\n[el-1-geth-prysm] Chain config: \u0026params.ChainConfig{ChainID:3151908, HomesteadBlock:0, DAOForkBlock:\u003cnil\u003e, DAOForkSupport:false, EIP150Block:0, EIP155Block:0, EIP158Block:0, ByzantiumBlock:0, ConstantinopleBlock:0, PetersburgBlock:0, IstanbulBlock:0, MuirGlacierBlock:\u003cnil\u003e, BerlinBlock:0, LondonBlock:0, ArrowGlacierBlock:\u003cnil\u003e, GrayGlacierBlock:\u003cnil\u003e, MergeNetsplitBlock:0, ShanghaiTime:(*uint64)(0x40004a75e0), CancunTime:(*uint64)(0x40004a75e8), PragueTime:(*uint64)(0x40004a75f0), OsakaTime:(*uint64)(0x40004a75f8), AmsterdamTime:(*uint64)(0x40004a7600), VerkleTime:(*uint64)(nil), BPO1Time:(*uint64)(nil), BPO2Time:(*uint64)(nil), BPO3Time:(*uint64)(nil), BPO4Time:(*uint64)(nil), BPO5Time:(*uint64)(nil), TerminalTotalDifficulty:0, DepositContractAddress:0x00000000219ab540356cBB839Cbe05303d7705Fa, EnableVerkleAtGenesis:false, Ethash:(*params.EthashConfig)(nil), Clique:(*params.CliqueConfig)(nil), BlobScheduleConfig:(*params.BlobScheduleConfig)(0x4000df3ea0)}\n[el-1-geth-prysm] Receipts: \n[el-1-geth-prysm] ##############################\n```",
        "created_at": "2025-09-26T20:09:03.082000+00:00",
        "attachments": null
    },
    {
        "author": "jih2nn",
        "category": "Cross-layer",
        "parent": "",
        "content": "After the PR is merged and the autobuilder does it work, this config will be all we need.\n\n```\nparticipants:\n  - el_type: geth\n    el_image: ethpandaops/geth:jwasinger-bal-execution\n    cl_type: lodestar\n    cl_image: ethpandaops/lodestar:bal-devnet-0-b7cdde2\n  - el_type: geth\n    el_image: ethpandaops/geth:jwasinger-bal-execution\n    cl_type: prysm\n    cl_image: ethpandaops/prysm-beacon-chain:bal-devnet-0\n    vc_type: prysm\n    vc_image: ethpandaops/prysm-validator:bal-devnet-0\n    count: 2\nnetwork_params:\n  genesis_delay: 20\n  fulu_fork_epoch: 0\n  gloas_fork_epoch: 1\n  perfect_peerdas_enabled: true\n  seconds_per_slot: 6\n  num_validator_keys_per_node: 32\nsnooper_enabled: true\ndora_params:\n  image: ethpandaops/dora:eip7928-support\nadditional_services:\n  - dora\n  - tx_fuzz\n  - spamoor\nport_publisher:\n  additional_services:\n    enabled: true\n    public_port_start: 65500\nspamoor_params:\n  spammers:\n    - scenario: eoatx\n      config:\n        throughput: 100\n    - scenario: uniswap-swaps\n      config:\n        throughput: 100\n```\nI've opened a PR that adds this .norun config to ethereum-package: https://github.com/ethpandaops/ethereum-package/pull/1197 Please have a look when you have some time cc \u003c@199561711278227457\u003e",
        "created_at": "2025-09-26T20:10:01.114000+00:00",
        "attachments": null
    },
    {
        "author": "jih2nn",
        "category": "Cross-layer",
        "parent": "",
        "content": "By the way, this [PR](https://github.com/jwasinger/go-ethereum/pull/17) fixes the payload version issue. It was nothing to do with Lodestar, I was mistaken. cc \u003c@586161934425128960\u003e \n\nAt the last slot of Fulu, when calling ForkchoiceUpdated to build a block for slot N, both Prysm and Lodestar set `params.timestamp` to the start time of slot N, i.e., it's within Gloas. So Geth returns `PayloadV4`, which `GetPayloadV6` accepts, and it just works. It was the same when we transitioned into Deneb.",
        "created_at": "2025-09-26T20:13:20.746000+00:00",
        "attachments": null
    },
    {
        "author": "nflaig",
        "category": "Cross-layer",
        "parent": "",
        "content": "right, it should be timestamp of slot N (the slot we prepare), since we calculate it based on slot of pre state",
        "created_at": "2025-09-26T20:52:07.196000+00:00",
        "attachments": null
    },
    {
        "author": "jih2nn",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yes, in the code, it sets `prepareSlot = clockSlot + 1`, which I believe clockSlot represents current slot",
        "created_at": "2025-09-26T20:56:54.544000+00:00",
        "attachments": null
    },
    {
        "author": "nflaig",
        "category": "Cross-layer",
        "parent": "",
        "content": "I merged in some fulu related fixes and build another image `ethpandaops/lodestar:bal-devnet-0-b7cdde2`, non critical but might be better to use latest image",
        "created_at": "2025-09-26T21:24:54.666000+00:00",
        "attachments": null
    }
]