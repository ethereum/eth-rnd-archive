[
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e It's not the hashing, it's the random disk access of over a billion different trie nodes.  With low latency for both reads and writes.\n\nYeah, implementations definitely should be storing code as a blob exactly as they do today; there's no reason at all to store code chunks the way we store storage slots",
        "created_at": "2020-12-02T01:15:47.427000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So I read: https://blog.ethereum.org/2020/11/30/the-1x-files-code-merkleization/ but I don't understand \"The Merkle proof needed for Stateless Ethereum is called a ‘witness’, and it attests to a state change by providing all of the unchanged intermediate hashes required to arrive at a new valid state root. \"",
        "created_at": "2020-12-02T05:48:06.977000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Can someone explain it to me or point me to an explanation?",
        "created_at": "2020-12-02T05:48:36.892000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The part I'm struggling with is \"...providing all of the unchanged intermediate hashes required to arrive at a new valid state root. \"",
        "created_at": "2020-12-02T05:51:18.544000+00:00",
        "attachments": null
    },
    {
        "author": "roboteddy",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003c@!334899589582946306\u003e take this with a grain of salt since I haven't developed a serious understanding, but: I think the text is saying that the witness needs to include a proof of the state that the transaction reads, *prior* to the transaction having taken effect",
        "created_at": "2020-12-02T06:06:09.844000+00:00",
        "attachments": null
    },
    {
        "author": "roboteddy",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "e.g. if the call reads pieces of state x, y, z, — then it'll be necessary to show a path through the merkle tree from those values all the way up to the root",
        "created_at": "2020-12-02T06:07:30.284000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Ok",
        "created_at": "2020-12-02T06:15:08.544000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Correct",
        "created_at": "2020-12-02T06:15:34.628000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The witness is basically all of the pieces of the state that the transaction reads or writes, plus the merkle branches to those pieces",
        "created_at": "2020-12-02T06:15:58.573000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Plus a witness of the code that forms the transaction?",
        "created_at": "2020-12-02T06:17:52.050000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "code is part of the state",
        "created_at": "2020-12-02T06:18:02.610000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So you start at state A and execute function F and the result is state B. The witness is some proof that B is the correct state given F(A)?",
        "created_at": "2020-12-02T06:22:22.517000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "In order to be useful the witness must take less storage space than A + F? (Maybe + B?)",
        "created_at": "2020-12-02T06:23:53.268000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "actually you don't need B to be part of the witness",
        "created_at": "2020-12-02T06:24:14.762000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "You don't need to transmit F as F is just part of client code",
        "created_at": "2020-12-02T06:24:37.248000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "A + the merkle branch needs to be smaller than the entire code, but that's always true and by a lot",
        "created_at": "2020-12-02T06:24:55.635000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Ok so the code merklization \"problem\" is what is the most efficient representation of the part of A that is the code for the transaction?",
        "created_at": "2020-12-02T06:27:25.590000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "right, that and the merkle branch",
        "created_at": "2020-12-02T06:27:54.046000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Don't you need the inverse of the merkle proof of B to validate that the new head block's merkle root is correct?",
        "created_at": "2020-12-02T06:29:15.313000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "no because you can always generate that from B + the pre-state proof",
        "created_at": "2020-12-02T06:29:45.469000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Given that the witnessing node needs to execute the code can you simply concat the opcode's (and maybe thier parameters) as you execute and take a hash of that as a proof?",
        "created_at": "2020-12-02T06:30:11.154000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Does the pre-state proof include storage slots that are being set but not read then?",
        "created_at": "2020-12-02T06:30:11.769000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Unless there are parts of the block that are written but not read; so for simplicity I think it's best to just count all writes as being reads",
        "created_at": "2020-12-02T06:30:15.635000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So the pre-state proof will be invalid if the contract tries to write to anything that isn't included in the proof.",
        "created_at": "2020-12-02T06:31:11.117000+00:00",
        "attachments": null
    },
    {
        "author": "mrsimicsak",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "What happens when F() changes and Fv1(A) != Fv2(A)?",
        "created_at": "2020-12-02T06:45:36.939000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "`F()` is consensus rules?",
        "created_at": "2020-12-02T06:56:23.723000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e So the pre-state proof will be invalid if the contract tries to write to anything that isn't included in the proof.",
        "created_at": "2020-12-02T07:09:17.485000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "yes",
        "created_at": "2020-12-02T07:09:19.166000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Both the reads and the writes need to be known to generate the proof",
        "created_at": "2020-12-02T07:09:42.695000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "though for the writes you technically don't need to include the leaves",
        "created_at": "2020-12-02T07:09:51.672000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "F can be modeled as unchanging",
        "created_at": "2020-12-02T07:09:58.932000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "F would only change in practice when there's a hard fork, but if that happens then it would be given to clients weeks in advance",
        "created_at": "2020-12-02T07:10:19.694000+00:00",
        "attachments": null
    }
]