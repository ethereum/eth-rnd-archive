[
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "It does. Otherwise, it can't verify the payload and take it into account in the new ternary forkchoice rule",
        "created_at": "2021-09-06T04:21:29.921000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Do you mean that at the Merge you're expecting block builders' market to be implemented?",
        "created_at": "2021-09-06T04:30:40.844000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e What I was trying to state during the Engine API discussion re: `preparePayload`, `getPayload` is the following. If we want to have a protection from malicious transaction that take too much execution time then the time restriction parameter should be passed on both calls. As during `preparePayload` which is called in advance there is more chance to create a payload with large execution time as this call has more time for payload construction.\n\nAnd I also think that this protection may be out of the communication protocol standard and up to client implementers.",
        "created_at": "2021-09-06T04:46:43.886000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "`preparePayload` would include a parameter that lets the execution client know approximately how long until `getPayload` is called?",
        "created_at": "2021-09-06T04:48:49.228000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "`preparePayload` would include a parameter that sets the restriction on the payload execution time. If the execution of the payload takes more time then the client should try to re-shape the payload by throwing away transactions taking too much time to get executed",
        "created_at": "2021-09-06T04:51:43.668000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Getting back to the when `getPayload` is called with the different parameter set than the `preparePayload` has been called with. You were suggesting to cap the execution time in this case, right? My thought is that it just should take the current state of the mempool, build the payload out of it and send it back to the consensus client",
        "created_at": "2021-09-06T04:54:12.026000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "I feel like if the execution client has time to build a block then prepare should be called, not get.",
        "created_at": "2021-09-06T04:54:57.608000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "To me, `get` is the \"last call\" and execution client should understand that if it doesn't return a block ASAP the slot may get missed.",
        "created_at": "2021-09-06T04:55:24.570000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "If get is received without prepare then execution client should submit an empty block, because that is the fastest thing it can do.",
        "created_at": "2021-09-06T04:55:49.076000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Right, but what if the head of the beacon chain changed 10 milliseconds before `getPayload` is called? What should be returned in this case? It could be an empty payload",
        "created_at": "2021-09-06T04:55:58.526000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "Either consenus client should send a prepare with a 10ms warning, then a get 10ms later, or it should send a get only and expect an empty block.",
        "created_at": "2021-09-06T04:56:51.380000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "I see",
        "created_at": "2021-09-06T04:57:54.023000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "I like always sending a prepare in any case where there is time to create a real block.",
        "created_at": "2021-09-06T04:58:19.135000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "The only time only get should be called without prepare IMO would be when there is no time left and for some reason you need an emergency placeholder block.",
        "created_at": "2021-09-06T04:58:42.868000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "So, if `getPayload` is send but `preparePayload` hasn't \"prepared\" anything then `getPayload` should return immediately with an empty payload",
        "created_at": "2021-09-06T04:58:58.456000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "We want the `get` to be as late as possible, so execution client can maximize revenue in block.  To achieve this, `get` needs to have strong guarantees that it will return very quickly in all cases.",
        "created_at": "2021-09-06T05:00:16.093000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "I agree. As Danny has mentioned `getPayload` may be implemented without `preparePayload`. And in this case it could build a payload and then return to the consensus client.",
        "created_at": "2021-09-06T05:00:38.929000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "It sounds like it will be possible to have multiple prepare calls?",
        "created_at": "2021-09-06T05:01:57.299000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "In general case yes. It should be called each time the head has changed",
        "created_at": "2021-09-06T05:02:21.507000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "Consensus client sends a prepare, then things change (reorg or whatever) and so it sends a new prepare with new parameters, then finally a get after that.",
        "created_at": "2021-09-06T05:02:37.640000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "So, basically I messed up what you have been talking about re: time restriction and what I had in my mind about it.",
        "created_at": "2021-09-06T05:04:01.792000+00:00",
        "attachments": null
    },
    {
        "author": "thegostep",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yes - a trust based version of it",
        "created_at": "2021-09-06T10:48:00.076000+00:00",
        "attachments": null
    },
    {
        "author": "thegostep",
        "category": "Cross-layer",
        "parent": "",
        "content": "Specifically: whitelisted validators will receive full block proposals from flashbots in plaintext and flashbots will monitor to make sure they don't unbundle the content",
        "created_at": "2021-09-06T10:48:52.928000+00:00",
        "attachments": null
    },
    {
        "author": "thegostep",
        "category": "Cross-layer",
        "parent": "",
        "content": "mev-geth-like clients at the merge would ignore the `preparePayload` call as it serves no purpose for outsourced block construction",
        "created_at": "2021-09-06T10:53:39.610000+00:00",
        "attachments": null
    },
    {
        "author": "thegostep",
        "category": "Cross-layer",
        "parent": "",
        "content": "I would also caution against designing the `preparePayload` api without taking into consideration outsourced block construction given \u003e85% of miners currently outsource construction and \u003e60% of blocks mined come from third party block builders",
        "created_at": "2021-09-06T10:57:55.340000+00:00",
        "attachments": null
    },
    {
        "author": "thegostep",
        "category": "Cross-layer",
        "parent": "",
        "content": "The block builder market exists already and will continue to exist at the merge",
        "created_at": "2021-09-06T10:58:37.978000+00:00",
        "attachments": null
    },
    {
        "author": "thegostep",
        "category": "Cross-layer",
        "parent": "",
        "content": "The question is: are execution clients sufficiently prepared to support it or will validators all run 3rd party forks of the clients",
        "created_at": "2021-09-06T10:59:18.320000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e I've convoluted two things, the protection from malicious transaction that take ages to execute and the necessity of `getPayload` to return immediately.",
        "created_at": "2021-09-06T11:14:38.815000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Cross-layer",
        "parent": "",
        "content": "`getPayload` could be used without the corresponding `preparePayload` call and be implemented in a different way in mev-geth-like clients. As for clients support of the market. Do you propose to have a separate API call to get the payload from the market?",
        "created_at": "2021-09-06T11:18:27.636000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "Cross-layer",
        "parent": "",
        "content": "Sounds like an mev-based execution client would have `preparePayload` as a no-op and `getPayload` as \"return best full block proposal received to date\".\n\nWe already have items that act as no-ops like this in the consensus API (subscriptions for beacon committees, for example, that are ignored if the node has certain flags configured) so  it doesn't seem unreasonable for the caller to call everything they should, and the execution client to act on the call as they see fit.",
        "created_at": "2021-09-06T11:24:42.213000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "No, my sentiment mirrors \u003c@144468805697929216\u003e's.",
        "created_at": "2021-09-06T13:10:11.777000+00:00",
        "attachments": null
    },
    {
        "author": "thegostep",
        "category": "Cross-layer",
        "parent": "",
        "content": "makes sense - just want to make sure everyone is aware it is likely it will be ignored in delegated construction and avoid using this call for passing necessary information for block construction",
        "created_at": "2021-09-06T13:13:43.507000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Cross-layer",
        "parent": "",
        "content": "The current plan is to re-include all of the necessary information in the `get` call.",
        "created_at": "2021-09-06T14:07:15.206000+00:00",
        "attachments": null
    }
]