[
    {
        "author": "nc1234",
        "category": "Cross-layer",
        "parent": "",
        "content": "This basically says if the head block you are voting for is this slot, then you as a attester does not need to indicate the payload status, because payload status can be obtained by PTC votes in the block body that you are voting for.\nBut if you are voting for a head block that is in previous slots, you are basically saying there is a missed block in the current slot, and payload status cannot be derived because no beacon block = no PTC votes. Now you as an attester need to step in to attest for the payload status. \nDon't know about fork choice",
        "created_at": "2025-12-13T00:09:41.715000+00:00",
        "attachments": null
    },
    {
        "author": "nc1234",
        "category": "Cross-layer",
        "parent": "",
        "content": "Regarding the concern that 1ETH deposits will bloat `state.builders`, can we add a field something like `last_won_bid_epoch` to `Builder`, and we periodically evict builders from `state.builders` that haven't been winning a single bid in the last x epochs?",
        "created_at": "2025-12-13T00:15:27.174000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "I thought of this but with quick deposits it may surface weird bugs. We're changing a large thing late in the process. If we keep the scope minimal it's better IMO. We can always add reuse in the next fork",
        "created_at": "2025-12-13T00:15:47.647000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "The first paragraph here doesn't make much sense to me. The PTC vote in the body you're voting for is only for timelines of the previous Payload. You need to validate that payload and attest to it's validity. The index is set to zero because it's referring to a future payload that the attester couldn't have seen",
        "created_at": "2025-12-13T00:19:13.336000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "I took a first look, left some feedback, and I am fine keeping balance under builder field instead of a separate list. I do not think the performance impact is meaningful and I would prefer sanity here...\n\nOne concern I do have is have we seriously considered not touching `PendingPartialWithdrawal`, `Withdrawal`, and `WithdrawalRequest` at all? The spec moves these from validator index based to validator pubkey, which means more new Gloas types and touching every state transition code that uses with them. The scope may seem ok in spec, but such complexity could easily cascade in client code and turn into a huge scope creep",
        "created_at": "2025-12-13T04:49:33.760000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yeah I have thought about it. The alternative is worse in my opinion. We'd have to create separate queues (with new types) in the state just for builders.",
        "created_at": "2025-12-13T05:17:53.614000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Also I just fixed the last batch of tests. Everything's still very messy but I believe all tests should pass now.",
        "created_at": "2025-12-13T05:18:27.405000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "I also got to delete a few unnecessary ones which was nice (eg slashed builders).",
        "created_at": "2025-12-13T05:18:45.520000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003c@520034910149410861\u003e I'm about to call it a night. Please make whatever improvements you want ðŸ™‚  I'll continue working on this in ~10 hours.",
        "created_at": "2025-12-13T05:23:36.502000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Cross-layer",
        "parent": "",
        "content": "presumably this is based on builders not being identified by validator index?",
        "created_at": "2025-12-13T06:05:36.879000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Cross-layer",
        "parent": "",
        "content": "i.e. it's worse in that scenario",
        "created_at": "2025-12-13T06:05:55.478000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yes but I believe this is one of those things that looks easier in the spec and it's massive in implementations which is the worse possible trade-off",
        "created_at": "2025-12-13T09:14:32.194000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Moving to pubkey in these structures will be a nightmare",
        "created_at": "2025-12-13T09:14:54.017000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Adding new lists for builders is not that bad. A ha ck to deal only with indices could be to use maxuint - idx to signal builder idx.",
        "created_at": "2025-12-13T09:20:37+00:00",
        "attachments": null
    },
    {
        "author": "kudeta",
        "category": "Cross-layer",
        "parent": "",
        "content": "Does forwarding the \"current highest bid\" imply that that the proposer can't express any other preferences about what / from whom they receive over p2p? Ideally they would be able to ask for bids from non-censoring builders that support e.g. a preconf protocol X. It might be reasonable just to start here, though, and iterate later. I guess if the proposer can express their preferences in advance then forwarding nodes could check other parts of the preference-set.",
        "created_at": "2025-12-13T13:16:46.659000+00:00",
        "attachments": null
    },
    {
        "author": "nero_eth",
        "category": "Cross-layer",
        "parent": "",
        "content": "Such proposers can just directly connect to non-censoring/preconf builders and fetch bids from those. The bid-over-p2p is more a fallback if the direct connections fail.",
        "created_at": "2025-12-13T14:41:24.682000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "The devil is in details. My concerns are: \n1. We have to add new withdrawals code that is 3 new types \n2. We have to touch existing caches. Most client have some form of index to pubkey cache or other way around",
        "created_at": "2025-12-13T15:20:19.571000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "What do we think about keeping index fields in withdrawal structures but setting a bit of the index to indicate which type of index it is. For example:\n```python\nVALIDATOR_INDEX_FLAG = 0x0100000000000000\nBUILDER_INDEX_FLAG = 0x0200000000000000\n\ndef has_validator_index_flag(index: GenericIndex) -\u003e bool:\n    return (index \u0026 VALIDATOR_INDEX_FLAG) != 0\n\ndef has_builder_index_flag(index: GenericIndex) -\u003e bool:\n    return (index \u0026 BUILDER_INDEX_FLAG) != 0\n```\nThis feels a little hacky but it might be a good compromise. I prefer short-term suffering (pubkeys) over long-term confusion though.\n(apparently \u003c@755590043632140352\u003e suggested something like this somewhere but I cannot find it)",
        "created_at": "2025-12-13T15:43:42.201000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "I would still want to rename the fields though (`validator_index` -\u003e `index`)",
        "created_at": "2025-12-13T15:47:02.162000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Any change in the existing structures I think it's a big change in implementations TBH",
        "created_at": "2025-12-13T16:13:07.260000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "We can work this without them",
        "created_at": "2025-12-13T16:13:19.795000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "So in withdrawal structs, you want to use the `ValidatorIndex` type for builders \u0026 validators?",
        "created_at": "2025-12-13T16:14:21.517000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "I mean we can do this, but it's awfully confusing long-term.",
        "created_at": "2025-12-13T16:14:37.065000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "This. Or add new structures for builders",
        "created_at": "2025-12-13T16:14:56.731000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "I'll work on a branch with the \"index hack\". I do not support new structs just for builders.",
        "created_at": "2025-12-13T16:30:45.801000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "As a proof of concept. So we can compare.",
        "created_at": "2025-12-13T16:30:53.617000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "what do we mean by adding new structures for builders. I thought we already are doing it regardless",
        "created_at": "2025-12-13T17:14:57.262000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "No, we'd need pending partial withdrawals and withdrawals/deposits for builder indices especially",
        "created_at": "2025-12-13T17:17:44.101000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Anyway I take something back: although I believe it's a big drawback to have pubkeys inside helpers and it's going to surely affect performance. It's not as horrible of a rework as I thought cause the helpers can be backported to use pubkey on previous fork and won't affect sync.",
        "created_at": "2025-12-13T17:19:19.435000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "Ya If that would be easier but not ideal long term so I will prefer to move everything to pubkey. And take the short term pain",
        "created_at": "2025-12-13T17:21:05.703000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "I won't. Having pubkeys in this helpers is still a very bad idea",
        "created_at": "2025-12-13T17:21:50.693000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "neither is pretty, but i think the two options on the table are:\n1. change all withdrawal related structures to pubkey\n2. add new queues in state for builder\nright? \u003c@592004585506340885\u003e",
        "created_at": "2025-12-13T17:37:57.189000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "there's a third one which is to hack the index",
        "created_at": "2025-12-13T17:38:26.318000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "and use maxuint-idx for builder index idx",
        "created_at": "2025-12-13T17:38:36.163000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "for example",
        "created_at": "2025-12-13T17:38:38.504000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yes, there's a 3rd option. Here's a branch with these changes. All tests are passing.\nhttps://github.com/ethereum/consensus-specs/compare/builders-no-updated-withdrawal-types",
        "created_at": "2025-12-13T17:42:53.089000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "I'd prefer to just keep it simple \u0026 use a bit flag. See the branch.",
        "created_at": "2025-12-13T17:47:19.071000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "cc \u003c@520034910149410861\u003e too.",
        "created_at": "2025-12-13T17:47:51.024000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "changing the structure is bad eitherway, with the bit or the pubkey, we'd need to add new structures and deal with them pre/post-fork, it really blows this simple rewrite of the helper into thousands of lines of boilerplate",
        "created_at": "2025-12-13T17:51:21.172000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Have you looked at the branch? It doesn't change the withdrawal structures.",
        "created_at": "2025-12-13T17:54:22.594000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "And boilerplate is annoying but not a huge deal, right? I'd like for us to make the best long-term decision.",
        "created_at": "2025-12-13T17:56:01.924000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "I agree, and I think that moving pubkeys into internals is a huge change for such a secondary feature. We currently only lookup pubkeys for signature verification.",
        "created_at": "2025-12-13T17:57:25.243000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "So the `is_builder_index()` approach is equivalent to my hack right?",
        "created_at": "2025-12-13T18:01:01.517000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yes.",
        "created_at": "2025-12-13T18:02:40.297000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "yeah that's an option",
        "created_at": "2025-12-13T18:03:39.294000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "i like this one the most\nwill be good to open a PR so people can start leave comments",
        "created_at": "2025-12-13T19:27:08.669000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "So now there's the following PRs:\n* [Make builders non-validating staked actors (option 1)](https://github.com/ethereum/consensus-specs/pull/4787)\n* [Make builders non-validating staked actors (option 2)](https://github.com/ethereum/consensus-specs/pull/4788)",
        "created_at": "2025-12-13T19:41:36.385000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Cross-layer",
        "parent": "",
        "content": "will have to see how `is_builder` and `is_validator` are actually implementable",
        "created_at": "2025-12-13T19:54:44.042000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Cross-layer",
        "parent": "",
        "content": "`is_validator` is something some CLs have already basically",
        "created_at": "2025-12-13T19:55:11.159000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Meaning there would be a naming conflict?",
        "created_at": "2025-12-13T19:55:45.139000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "To be honest, we could probably just remove those helpers.",
        "created_at": "2025-12-13T19:56:15.343000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Cross-layer",
        "parent": "",
        "content": "I mean, these caches can be expensive",
        "created_at": "2025-12-13T19:56:21.427000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Cross-layer",
        "parent": "",
        "content": "Nimbus does a fairly nuanced thing to make it not expensive (either RAM or CPU) for validators. it _should_ work for the builders one",
        "created_at": "2025-12-13T19:56:55.668000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "But these is_builder or is_validator is an arithmetic operation only, not a cache. The other global index-\u003epubkey one we can just duplicate what we already do for validators.",
        "created_at": "2025-12-13T20:50:07.841000+00:00",
        "attachments": null
    }
]