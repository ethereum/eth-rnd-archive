[
    {
        "author": "stefanbratanov",
        "category": "Cross-layer",
        "parent": "",
        "content": "One thing to ask, I am running a test locally just processing a block and then processing an envelope on top of the block state and this check always fails for me:\n\n```\n# Verify prev_randao\nassert payload.prev_randao == get_randao_mix(state, get_current_epoch(state))\n```\n\nI briefly remember we mentioned that before, but am I doing something wrong or the spec is not clear and the `randao_mixes`  change from pre-state of the block and post processing",
        "created_at": "2025-11-07T10:37:01.579000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "what is not clear? `process_block` calls `process_randao` which hasn't changed",
        "created_at": "2025-11-07T11:04:27.012000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Ohh you mean the payload cannot be verified",
        "created_at": "2025-11-07T11:05:51.419000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yes this looks like a bug in the spec",
        "created_at": "2025-11-07T11:07:03.945000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "How was this not found before?!@#",
        "created_at": "2025-11-07T11:07:41.139000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Didn't we have the exact same paths in our interop \u003c@641548687813902336\u003e ?",
        "created_at": "2025-11-07T11:08:08.761000+00:00",
        "attachments": null
    },
    {
        "author": "stefanbratanov",
        "category": "Cross-layer",
        "parent": "",
        "content": "I remember commenting out that part of the code haha, but I forgot the discussion back then",
        "created_at": "2025-11-07T11:08:30.916000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "lol, probably we did too, \u003c@363800010518822915\u003e we're lacking a bunch of tests then, this should have failed on every single block/payload processing",
        "created_at": "2025-11-07T11:09:03.752000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "problem is that fixing this may need actual changes to structures üò¢",
        "created_at": "2025-11-07T11:10:13.398000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "the EL does require a check for this cause this is exposed in the EVM",
        "created_at": "2025-11-07T11:10:29.096000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "So we will need to cache the previous randao in the beacon state or do something similar.... Please add this topic to the call, will go for a bike ride before that call... this is not good",
        "created_at": "2025-11-07T11:11:48.027000+00:00",
        "attachments": null
    },
    {
        "author": "stefanbratanov",
        "category": "Cross-layer",
        "parent": "",
        "content": "or maybe put it in the bid and verify it during block processing and then just compare the value of the payload vs the commited bid during execution processing, will add the topic",
        "created_at": "2025-11-07T11:13:47.450000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "ePBS breakout call in 5 minutes!\nhttps://ethereumfoundation.zoom.us/j/86537060608?pwd=9jE9RCE0QzbSP43jpkiHajtXYFnXUw.1",
        "created_at": "2025-11-07T13:54:34.562000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "hm i thought we talked about this in previous breakouts and you already fixed it, it must have fell through the cracks then.... üôÅ",
        "created_at": "2025-11-07T14:00:00.515000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "Thanks for catching this Stefan! what i learn today is teku is miles ahead of prysm in terms of implementation üôÇ",
        "created_at": "2025-11-07T14:30:48.988000+00:00",
        "attachments": null
    },
    {
        "author": "stefanbratanov",
        "category": "Cross-layer",
        "parent": "",
        "content": "Haha maybe, I am deliberately avoiding fork choice for now though, so wouldn't want to speak too soon ;d",
        "created_at": "2025-11-07T14:42:02.615000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Thanks \u003c@641548687813902336\u003e and \u003c@780792191244566529\u003e for looking deeply at the spec and catching these things. I think we agreed on the fix for Stefan's issue, not clear to me what to do with the effective balances thing. My intuition is to leave as is.  \u003c@520034910149410861\u003e I'm pretty sure that the issue you were thinking about is that `process_pending_consolidations` should be before `process_effective_balance_updates`, we could move these builder pending payments between the two in principle.",
        "created_at": "2025-11-07T14:45:44.287000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "I'm really pissed at the randao mix one (ashamed is a better word, but honestly pissed at myself)",
        "created_at": "2025-11-07T14:48:59.300000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "FWIW this is the third time the randao mix issue is raised, Terence told me years ago, Stefan raised it again, and up until now we neglected it",
        "created_at": "2025-11-07T15:01:19.956000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "https://discord.com/channels/595666850260713488/1337362307671654472/1342471778521317491",
        "created_at": "2025-11-07T15:01:21.821000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "In code in Prysm in the ePBS branch we are also commenting that",
        "created_at": "2025-11-07T15:01:37.603000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "It was even discussed in a breakout https://github.com/ethereum/pm/issues/1321",
        "created_at": "2025-11-07T15:02:27.890000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003c@592004585506340885\u003e added regression tests, Fulu tests are failing, checking locally takes a long time here, so I may delay in fixing those, the two I'm adding I know they pass at least locally on Gloas",
        "created_at": "2025-11-07T15:05:12.534000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "minute 10, we discussed that time moving where we process randao_mixes...  which didn't make any sense (we explicitly said that it was dangerous) so we decided to cache it and we didn't lol.",
        "created_at": "2025-11-07T15:07:55.836000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "One last one. There's still some value in having separate values in the bid: the builder is guaranteeing: \"at least you'll get this much\"",
        "created_at": "2025-11-07T15:23:12.748000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Can we push the next breakout call back a week? From Nov 21st to Nov 28th. Many will still be at devconnect.",
        "created_at": "2025-11-07T15:25:09.062000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Alternatively, just skip the next call \u0026 have the next one on Dec 5th.",
        "created_at": "2025-11-07T15:25:43.637000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "I think skipping (cancelling) the call on he the 21st would be easiest.",
        "created_at": "2025-11-07T15:26:30.362000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Pretty sure I'll be OOO on Nov 28th anyway, due to thanksgiving in the US.",
        "created_at": "2025-11-07T15:27:16.547000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "Either work. Hopefully we will be already running interop by then",
        "created_at": "2025-11-07T15:31:24.843000+00:00",
        "attachments": null
    },
    {
        "author": "jtraglia",
        "category": "Cross-layer",
        "parent": "",
        "content": "Okay. I'm going to cancel the breakout call on the 21st then.",
        "created_at": "2025-11-07T15:34:50.684000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003c@755590043632140352\u003e \u003c@592004585506340885\u003e looking at old notes, i think there's 1 more item we may have missed:\n```\nProposers building on an empty block cannot deterministically retrieve withdrawals from the beacon state\n```\nI think we agreed to have clients cache the withdrawals in this case and it needs to be mentioned in the validator spec right? (correct me if i am wrong here)",
        "created_at": "2025-11-07T15:48:01.189000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Cross-layer",
        "parent": "",
        "content": "yes, we decided not to do anything on this",
        "created_at": "2025-11-07T15:49:26.173000+00:00",
        "attachments": null
    },
    {
        "author": "terencechain",
        "category": "Cross-layer",
        "parent": "",
        "content": "i think the plan was to mention this in the validator spec, but i dont see any mention. Should i open a PR and add it now? can be a few sentences under the withdrawals section",
        "created_at": "2025-11-07T15:50:29.022000+00:00",
        "attachments": null
    },
    {
        "author": "blockkshane",
        "category": "Cross-layer",
        "parent": "",
        "content": "hi, following up from the breakout room chat\n\nin the [spec](https://ethereum.github.io/consensus-specs/specs/gloas/beacon-chain/#epoch-processing), `process_builder_pending_payments` runs at the end of `process_epoch`, which is after the `process_effective_balance_updates` run\n\n`process_builder_pending_payments` \u003e [compute_exit_epoch_and_update_churn](https://ethereum.github.io/consensus-specs/specs/electra/beacon-chain/#new-compute_exit_epoch_and_update_churn) which relies on the total effective balance in its nested [get_balance_churn_limit](https://ethereum.github.io/consensus-specs/specs/electra/beacon-chain/#new-get_balance_churn_limit) call as part of the update to the `state.exit_balance_to_consume` and `state.earliest_exit_epoch`\n\ncurrently, during `process_epoch`,  `process_registry_updates` calls `initiate_validator_exit` which runs [compute_exit_epoch_and_update_churn](https://ethereum.github.io/consensus-specs/specs/electra/beacon-chain/#new-compute_exit_epoch_and_update_churn)  before the `process_effective_balance_updates`  run\n\nso my point here is that it's potentially error prone to be calling `compute_exit_epoch_and_update_churn` to update `state.exit_balance_to_consume` and `state.earliest_exit_epoch` before and after `process_effective_balance_updates` runs, during `process_registry_updates` and `process_builder_pending_payments` respectively, since they'd be using different effective balances to update the states",
        "created_at": "2025-11-07T16:41:31.086000+00:00",
        "attachments": null
    },
    {
        "author": "blockkshane",
        "category": "Cross-layer",
        "parent": "",
        "content": "furthermore, the point of `process_builder_pending_payments` running during `process_epoch` is to convert pending payments to withdrawals for blocks where the envelope was not released.  if the envelope was released earlier in the epoch, we call `compute_exit_epoch_and_update_churn` during [process_execution_payload](https://ethereum.github.io/consensus-specs/specs/gloas/beacon-chain/#new-process_execution_payload), which would be using the effective balances of the current epoch. so it seems logically consistent to use the current epoch's effective balance when running `process_builder_pending_payments` as well, since we're handling payments from the current epoch",
        "created_at": "2025-11-07T16:41:49.447000+00:00",
        "attachments": null
    },
    {
        "author": "blockkshane",
        "category": "Cross-layer",
        "parent": "",
        "content": "proposal is to move `process_builder_pending_payments` above `process_effective_balance_updates` during `process_epoch` so we ensure it uses effective balance from current epoch. I'm happy to make consensus spec PR for this. super small lol\n\ndownside considerations: from looking at `process_builder_pending_payments`, the only state changes are to `state.exit_balance_to_consume` and `state.earliest_exit_epoch`, which we've covered as to why the proposal would be an improvement. and also to `state.builder_pending_withdrawals` and `state.builder_pending_payments` which I dont see a downside for either. if anything, it becomes consistent with the conversion that happens during `process_execution_payload` as mentioned\n\nlooking for some alternative considerations or if it's ok for me to open the PR",
        "created_at": "2025-11-07T16:42:06.476000+00:00",
        "attachments": null
    }
]