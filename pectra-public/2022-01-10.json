[
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Ok, so looking into a teku+geth node that's on the wrong chain, it looks like it's following all the chains \"correctly\" (ie it has blocks from all the chains) but fork choice is leading it to pick the invalid chain.  From the beacon node perspective that chain is valid - the only thing that could tell us it's not is the EL and because we incorrectly switched to optimistic sync, the EL wound up telling us it was valid (by inference when a descendant was found to be valid).\n\nEven if we deployed the fix to stop Teku switching to optimistic sync, there's nothing that will cause us to go back and re-execute an old payload to check if it's suddenly become invalid.  I think the only way out of this is to resync enough validators to get fork choice to start choosing the valid chain and then theoretically teku should reorg to that and eventually the invalid chain will be pruned when finalization happens again.",
        "created_at": "2022-01-10T01:15:03.749000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "What is interesting is that on teku-geth-11 where I happen to be playing around, geth is repeatedly crashing (and thus Teku keeps winding up back in optimistic sync mode and possibly isn't managing to validate the payloads even for the valid chain):\n\n```\nWARN [01-10|01:09:48.507] Served engine_executePayloadV1           conn=127.0.0.1:33808 reqid=127458 t=\"573.802¬µs\" err=\"blockhash mismatch, want 985b2adaf7cf726748c986b52c957e0f03131556908c5f14f37f1875ee55bce1, got 5f41708d290182c6a980d4741863a7c29712b06e7e6cee15389f5c455443d08a\"\nWARN [01-10|01:09:48.507] Served engine_executePayloadV1           conn=127.0.0.1:33828 reqid=127462 t=\"81.609¬µs\"  err=\"blockhash mismatch, want 88f48f7fd9b87f0ef8c3dffbdbf7e42d4375011656619392a5c638dfa4999ca5, got b08da25f0a905498b8c8c36c2a90c11a6a43266113014f08edf6c5ebdc98f573\"\nDEBUG[01-10|01:09:48.514] Served engine_executePayloadV1           conn=127.0.0.1:33822 reqid=127463 t=7.221393ms\npanic: runtime error: invalid memory address or nil pointer dereference\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0xa82d92]\n\ngoroutine 102 [running]:\ngithub.com/ethereum/go-ethereum/eth/downloader.(*skeleton).initSync(0xc0002d1420, 0xc006cc6000)\n    github.com/ethereum/go-ethereum/eth/downloader/skeleton.go:441 +0x452\ngithub.com/ethereum/go-ethereum/eth/downloader.(*skeleton).sync(0xc0002d1420, 0xc006cc6000)\n    github.com/ethereum/go-ethereum/eth/downloader/skeleton.go:317 +0x58\ngithub.com/ethereum/go-ethereum/eth/downloader.(*skeleton).startup(0xc0002d1420)\n    github.com/ethereum/go-ethereum/eth/downloader/skeleton.go:242 +0x18e\ncreated by github.com/ethereum/go-ethereum/eth/downloader.newSkeleton\n    github.com/ethereum/go-ethereum/eth/downloader/skeleton.go:213 +0x1df\n```\nWe don't set the chain head when we're optimistically syncing which may explain why it's not moving forward.  Getting similar crashes on teku-geth-1 and teku-geth-20 as well.",
        "created_at": "2022-01-10T01:15:19.766000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "1 to less than 1 technically, since a beacon block can be empty.",
        "created_at": "2022-01-10T01:24:31.025000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "It may also be possible to use geth's `--whitelist` option to force geth onto the right chain.  If that option also caused it to treat anything from a different fork as invalid it may then start reporting new blocks on the invalid chains as INVALID and eventually all the attestations for those forks would be pruned out of fork choice leaving the valid chain as the best one again and hopefully we then reorg to it.",
        "created_at": "2022-01-10T01:26:52.050000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "hello, do mergemock also provides invalid payloads other than always correct ones?",
        "created_at": "2022-01-10T01:42:41.174000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "no atm, only valid ones",
        "created_at": "2022-01-10T02:59:58.562000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "I'm on this issue already üôÇ might take a couple of days to figure it out though",
        "created_at": "2022-01-10T08:12:53.840000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Cool. Let me know if there‚Äôs anything I can help with from the CL side.",
        "created_at": "2022-01-10T08:25:07.996000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "I thought slots could be empty, but you're saying a beacon block without an execution payload is valid?",
        "created_at": "2022-01-10T08:48:21.095000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "I believe that a beacon block must have an execution payload, but the execution payload can have 0 transactions in it.\n\nBut of course a slot can be empty, with no beacon block at all.",
        "created_at": "2022-01-10T08:50:12.289000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Sorry, I meant slot above.",
        "created_at": "2022-01-10T08:50:42.018000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "I didn't even know there was such a thing as a \"beacon block\".  üò¨",
        "created_at": "2022-01-10T08:51:08.233000+00:00",
        "attachments": null
    },
    {
        "author": "pietjepuk",
        "category": "general",
        "parent": "",
        "content": "And I meant blocks when I said 1 to 1 ;)",
        "created_at": "2022-01-10T08:51:09.896000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "What exactly is a beacon \"block\"?",
        "created_at": "2022-01-10T08:51:21.719000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "The blocks that form the beacon chain. Post merge they will be the only actual blocks. Execution clients will execute the execution payload from within the beacon block - to the EL that is a ‚Äúblock‚Äù and it does reference a parent execution payload so that‚Äôs not wrong as such but it‚Äôs just a part of the beacon chain block.",
        "created_at": "2022-01-10T08:54:08.764000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Who generates the block hash?  Consensus or execution?",
        "created_at": "2022-01-10T08:58:40.586000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "The EL creates the EL block hash aka ExecutionPayload hash",
        "created_at": "2022-01-10T09:03:00.787000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "The ExecutionPayload/EL block is mostly a black box to the CL currently [there are things which might change that, and a check or two the CL does on it]",
        "created_at": "2022-01-10T09:03:47.317000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "[shouldn't equate the EP and EL block. They're ... interconvertible, sort of]",
        "created_at": "2022-01-10T09:10:46.638000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "general",
        "parent": "",
        "content": "Thanks for this! I'd wager Lighthouse is doing the exact same thing and that's why the lh nodes are in different forks as well. \n\nIs our mainnet response also going to be the same? That we advise users to wipe and resync? Or is a discussion about how to handle this edge case needed? (I guess with geth returning invalid instead of a json-rpc error, it would prevent such a thing from happening again?)\n\nIf \u003c@!491624610215886849\u003e or someone from \u003c@\u0026595683849225240704\u003e can confirm that adrian's analysis applies to lighthouse as well and that there are no other open questions, then that'd leave the following bugs that are open:\n- Geth's invalid memory address issue (marius has acknowledged it and is working on it). \n\nSo the gameplan for the chain would be:\n- ID validators on the wrong fork\n- Nuke their db and resync them\n- Let them come back up, monitor that it's on the correct chain (same as explorer)\n- We should see finality then\n\nAre there any other things that need to be done? Anyone has an update they'd like pushed beforehand? \n\nWould saving one or two node's disks as a snapshot be valuable to anyone?",
        "created_at": "2022-01-10T09:21:12.369000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "Is nuking and resyncing really the best way? Shouldn't the network fix itself? More and more nodes reorging to the same chain",
        "created_at": "2022-01-10T09:24:54.894000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "Or is this not possible in the beacon chain?",
        "created_at": "2022-01-10T09:25:14.612000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "LH stopped optimistically importing on error a couple of weeks ago. Anyone with a recent-enough build should be patched against it. Any older, affected nodes might need a resync since they‚Äôve imported invalid data into the DB.\n\nIt‚Äôs not immediately clear to me why the nodes aren‚Äôt following the same head. I would expect them to converge, unless there were 2/3rds voting on bad blocks at some point.",
        "created_at": "2022-01-10T09:31:46.098000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "The beacon chain can permanently diverge too, so that‚Äôs an option. I wouldn‚Äôt have expected there to have been enough time for this yet, though.",
        "created_at": "2022-01-10T09:33:06.564000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "So resyncing the beacon chain is normally really easy because you can use checkpoint sync so it does tend to be a much more common and simpler solution that in the EL side.",
        "created_at": "2022-01-10T09:33:31.602000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "I am slightly curious why the right chain still doesn‚Äôt have the majority of votes and wonder if nodes would reorg back to it properly or if something else is going wrong. Having geth crashing will likely be preventing the teku nodes I looked at from making any progress so that may explain part of it.",
        "created_at": "2022-01-10T09:35:14.478000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Would be interesting to get a view into the protoarray state to see if the bad chain really does have the most votes but I don‚Äôt have that api in the deployed versions of teku - lighthouse might?",
        "created_at": "2022-01-10T09:36:06.383000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "Having a copy of the database could be quite interesting yes.",
        "created_at": "2022-01-10T09:36:36.387000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "I *think* we can dump the proto-array state but we don‚Äôt have a meaningful way to view it.",
        "created_at": "2022-01-10T09:37:09.637000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "My guess is that there‚Äôs justification of a block in a chain with error-raising payloads.",
        "created_at": "2022-01-10T09:38:49.171000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "That‚Äôs possible. Teku knows about both chains so finalisation has happened but it was hard to compare the chain heads teku had to the explorer because the explorer was so far behind so not sure if it saw the right chain as viable.",
        "created_at": "2022-01-10T09:40:18.772000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "general",
        "parent": "",
        "content": "I can add you to one of the healthy lighthouse nodes so you have access to the api if it would help. \n\nrafael is looking into making the lighthouse backing the explorer into a public api (with auth), so everyone can use it as a datasource.",
        "created_at": "2022-01-10T09:43:05.457000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "general",
        "parent": "",
        "content": "And I'll make a copy of a few of the databases and upload it somewhere for whoever needs it.",
        "created_at": "2022-01-10T09:43:31.097000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "oh yeah I could use the healthy teku+nethermind actually.",
        "created_at": "2022-01-10T09:43:50.741000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "Thanks üôèIt would be great to note the commit hash for the version using the DBs.",
        "created_at": "2022-01-10T09:44:05.917000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "general",
        "parent": "",
        "content": "added your keys to `kintsugi-lighthouse-geth-14` anyway üôÇ",
        "created_at": "2022-01-10T09:47:56.756000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "ok so teku+geth (unhealthy) has the same current justified checkpoint as teku+nethermind (healthy).  But teku+geth doesn't seem to have a chain head that matches the canonical head from teku+nethermind.",
        "created_at": "2022-01-10T09:48:00.801000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "In fact it doesn't have that head block, but it did have the chain head block the block explorer was reporting when I checked earlier today.",
        "created_at": "2022-01-10T09:49:45.769000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "QQ: Does the CL call executePayload on payloads that it itself created (with getPayload)?",
        "created_at": "2022-01-10T12:55:06.522000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "general",
        "parent": "",
        "content": "we currently do",
        "created_at": "2022-01-10T13:25:11.760000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e This is as intentioned in the spec\nEL could choose to cache what was generated by getPaylaod in expectation that executePayload will subsequently be called but we wanted to avoid exceptional code paths and any added/implied statefulness in the two methods (re @merge_chat_bot: \u003cMariusVanDerWijden\u003e QQ: Does the CL call executePayload on payloads that it itself created (with getPayload)?)",
        "created_at": "2022-01-10T13:36:31.829000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "general",
        "parent": "",
        "content": "I had to add that \"loopback\" codepath for things to work without glitches",
        "created_at": "2022-01-10T16:10:46.807000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "general",
        "parent": "",
        "content": "I tried finding some teku nodes with a healthy EL and on the wrong fork, but I couldn't. Should I wipe some ELs and re-deploy geth on them? Maybe they still end up on the wrong fork, in which case it'd atleast give you a node to test the fork stuff on?",
        "created_at": "2022-01-10T18:21:34.794000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "general",
        "parent": "",
        "content": "here's a dump of the protoarray from earlier today, its from a lighthouse node",
        "created_at": "2022-01-10T18:22:07.811000+00:00",
        "attachments": [
            {
                "type": "application/json; charset=utf-8",
                "origin_name": "protarray_explorer_node.json",
                "content": "653a239da11456c9779926837fceec6cdd90e324f61131de25515a1b39f66973"
            }
        ]
    }
]