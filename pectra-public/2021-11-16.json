[
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Hey all. Unsure when it happened that you guys decided that the TTD will be removed from execution clients, but I refuse to remove it from Geth. FYI",
        "created_at": "2021-11-16T08:39:25.558000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Execution clients need to know when a hard fork happens, it's configured all over the code. I can't rely on someone from the outside telling me that oh hey, btw, fork happened 5 mintues ago and all your internal state is shit. Sorry, fix it",
        "created_at": "2021-11-16T08:40:13.749000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "We do not and will not support dynamically reconfiguring forks during runtime",
        "created_at": "2021-11-16T08:40:36.137000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "This asynchonicity that results in the consensus clients telling us after the fact that the merge happened makes everything insanely brittle within an execution client. All of a sudden every single code path needs to be aware that the rug might be pulled from underneath at any point in time. Miners need notification logic to abort PoW mining and switch to PoS mining in the middle of mining. What happens if they manage to mine a block before the consensus client tells us TTD was passed? Well, we just have an invalid chain that we need to undo, because of async",
        "created_at": "2021-11-16T08:42:59.082000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "You know what, let's switch roles. Lets keep the merge notion completely hidden from consensus clients and let execution clients notify consensus that hey, we jsut forked, better reorg all your shit. Lets see how you like it",
        "created_at": "2021-11-16T08:44:28.073000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "hey Peter, TTD is not removed entirely. But yes, the current spec expects that EL will switch over to PoS with the first `forkchoiceUpdated` received from CL -- this is where actual switch happens because this method switches the fork choice rule as per EIP-3675. The recent change to the spec says that EL must follow `forkchoiceUpdated` disregarding whether it happens on the terminal block (wrt TTD) or not. Not sure I understand your concern about asynchronicity. The switch may cause a re-org if miner managed to mine a block on top of a terminal block before the PoS block arrives and the switch happens but this re-org shouldn't be deeper than 1 block and EL should be able to do such re-org.\n\nThe reason why it was done is because we have TTD override + terminal block hash override options that will be used to accelerated the merge, and there are difficulties in synchronizing this overrides between the layers. Thread with detailed discussion is here: https://github.com/ethereum/consensus-specs/issues/2643. Worth considering that the shift may happen only in one direction (i.e. TTD may only be reset to a lower value than the hardcoded one) and EL still must stop processing blocks that have total difficulty \u003e= TTD -- this requirement is preserved.\n\nThese overrides will only be used in emergency cases when either network is under attack or significant hashpower disappeared delaying the merge by a month. In a normal case TTD will be the same on both layers. But yes, EL can't entirely rely on this hardcoded value anymore",
        "created_at": "2021-11-16T09:41:20.841000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e  The recent change to the spec says that EL must follow forkchoiceUpdated disregarding whether it happens on the terminal block (wrt TTD) or not.\nGeth will not follow this change ðŸ™‚",
        "created_at": "2021-11-16T10:02:42.506000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e EL should be able to do such re-org\nIt makes EL code extremely brittle",
        "created_at": "2021-11-16T10:03:27.057000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "because I need to be able to dynamically, retrospectively apply a fork",
        "created_at": "2021-11-16T10:03:43.144000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "and I need every single code handling forks to be updated",
        "created_at": "2021-11-16T10:03:53.611000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "also when a new EL client joins the network, how does it know what the switchover block is?",
        "created_at": "2021-11-16T10:04:13.543000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "CL says it's in POS mode, awesome. So when do I stop verifying PoW blocks?",
        "created_at": "2021-11-16T10:04:34.122000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "when do I start rejecting blocks with uncles?",
        "created_at": "2021-11-16T10:05:00.034000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I don't see why this entire thing is even discussed just to avoid the user having to specify 1 more flag, which they already need to for the CL client",
        "created_at": "2021-11-16T10:06:01.734000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "As I said, if you want, I can accept Geth driving the consensus and telling CL that the fork already happened",
        "created_at": "2021-11-16T10:06:31.719000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I assume you will face similar backlash from CL clients",
        "created_at": "2021-11-16T10:06:39.128000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Even with TTD syncronized across the layers geth should be able to import sisters of a terminal PoW block after the switch has happened",
        "created_at": "2021-11-16T10:06:49.981000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "it makes everything extremely complicated inside the code to support suprise forks",
        "created_at": "2021-11-16T10:06:53.352000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Geth does not support changing consensus rules on the fly. It does not support converting a valid block into an invalid one",
        "created_at": "2021-11-16T10:08:39.907000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "What happens if I cached a block? Now all of a sudden I need cache invalidation logic all over the place",
        "created_at": "2021-11-16T10:09:09.409000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I notify clients of a block, turns out that not only it was reoreg, it was even invalid from the get go",
        "created_at": "2021-11-16T10:09:40.266000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Reorging blocks is one thing, that Geth can handle, side chains geth can handle",
        "created_at": "2021-11-16T10:09:57.852000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "but you are requiring us to add logic to invalidate previously valid blocks",
        "created_at": "2021-11-16T10:10:09.107000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "that has consequences",
        "created_at": "2021-11-16T10:10:12.681000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "everything is solveble, it just makes absolutely no sense to introduce this complexity to save the user from specifying 1 flag",
        "created_at": "2021-11-16T10:11:02.451000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "We actually don't. If a block is not a terminal one wrt TTD and is a valid PoW block then it will stay valid for a time being. And it shouldn't affect the switch to PoS",
        "created_at": "2021-11-16T10:12:17.104000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "wrt hardcoded TTD*",
        "created_at": "2021-11-16T10:12:35.928000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "if a block is mined on top of the terminal and you tell us after the fact that the merge happened 1 block before, you are invalidating a block",
        "created_at": "2021-11-16T10:12:50.681000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'm no enumerating problems to solve btw, I'm highlighting the complexity added all over the place dumped on us just to avoid 1 flag",
        "created_at": "2021-11-16T10:15:37.016000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "E.g. I receive a header from the network, I can't even validate its difficutly field, because I've no idea whether it belongs to the PoW or PoS chain",
        "created_at": "2021-11-16T10:16:50.315000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I see what you mean. It's invalid because it's not a PoS block. I am trying to understand now what additional implications a 1-2 blocks re-org in this case comparing to a regular re-org.",
        "created_at": "2021-11-16T10:17:54.388000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "it's a consensus rule reorg",
        "created_at": "2021-11-16T10:18:19.062000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "not a block reorg",
        "created_at": "2021-11-16T10:18:21.336000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you are changing the rules of the chain",
        "created_at": "2021-11-16T10:18:32.034000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "geth only support consensus rule changes on startup; then it will discard anything that's above a new ruleset and will start from that point onward",
        "created_at": "2021-11-16T10:19:12.353000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "but in that case you don't have tens of subsystems needing dynamic rule changes",
        "created_at": "2021-11-16T10:19:37.134000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "but not retroactively with respect to the chain, it's  probably retroactive wrt the tree and on different branches of the tree may be different rules at the same block height. This is what I was assuming like it's not a big problem to handle",
        "created_at": "2021-11-16T10:19:41.131000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "yes, you are changing retroactivly on the chain",
        "created_at": "2021-11-16T10:20:12.402000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you retrospecitvely tell me the TTD was smaller than my last block",
        "created_at": "2021-11-16T10:20:23.697000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you invalidate my head potentially",
        "created_at": "2021-11-16T10:20:28.692000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you all of a sudden tell me that my mining code needed to have stopped and exited PoW mode. Now my mining code needs to be able to handle sudden rug pulls",
        "created_at": "2021-11-16T10:21:36.295000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "that's again an extra bit of production code that's needed to be implemeted and tested, just to avoid 1 flag",
        "created_at": "2021-11-16T10:22:02.384000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "what happens if I switch to PoS mode after starting mining on PoW and someone delivers a valild PoW solution to the mining work taks?",
        "created_at": "2021-11-16T10:22:32.481000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I don't know. it needs to be handled",
        "created_at": "2021-11-16T10:22:39.164000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "whereas previously we would simply never make the next work packet in the firs tplace",
        "created_at": "2021-11-16T10:22:56.796000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "currently geth accepts solutions to all past works too even on side chains, so it's not a simple reorg",
        "created_at": "2021-11-16T10:23:22.666000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I actually need logic to invalidate and remove stuff from the miner",
        "created_at": "2021-11-16T10:23:33.213000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "hard? no. useless effort? yes",
        "created_at": "2021-11-16T10:23:42.635000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "EL is at the block `A` which has `N+1` height currently. And then CL may ask EL to switch to `A'` with the same `N+1` height which has common ancestor with `A`. It's not in the way that CL says that `A` suddenly became a PoS block.",
        "created_at": "2021-11-16T10:24:25.290000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "EL is at block A, starts mining B, finishes mining B when CL says A was the terminal one. Now I have B which became invalid",
        "created_at": "2021-11-16T10:25:11.389000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I get it. So, you've been mining B and B appeared to be on a stale fork, B would never happen if you'd know in advance",
        "created_at": "2021-11-16T10:26:30.323000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "B didn't appear on a stale fork, B is invalid because it never should have been allowed to be created",
        "created_at": "2021-11-16T10:27:09.665000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The same would happen if a user forgot to override TTD on EL side, right?",
        "created_at": "2021-11-16T10:27:11.013000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yes, but then the user stops Geth, and on restart I clean out B, before starting up everything",
        "created_at": "2021-11-16T10:27:35.910000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Then when all subsystems come online, there's no invalid block in the chain",
        "created_at": "2021-11-16T10:27:45.535000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I mean stale = the one that would never be accepted by the network",
        "created_at": "2021-11-16T10:28:04.904000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It was accepted by my node, so my internal state is whacked",
        "created_at": "2021-11-16T10:28:20.279000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "and then it's been re-orged, right? it's ok to have this block because it won't be a part of canonical chain. I am thinking about user forgetting to restart geth with overridden TTD. In this case geth would refuse switching to PoS until it reaches the TTD -- this is dangerous for a node",
        "created_at": "2021-11-16T10:30:01.617000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "restarting with a new td means I clean out invalid blocks before geth starts up internally, so there's never a \"reorg\"",
        "created_at": "2021-11-16T10:34:07.746000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "old geth saw one chain state and ruleset, new geth sees a new ruleset and new chain state",
        "created_at": "2021-11-16T10:34:28.036000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "both are always consistent and valid",
        "created_at": "2021-11-16T10:34:36.105000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you are askign us to make a geth that can handle both old and new rulsets within a single database",
        "created_at": "2021-11-16T10:34:50.398000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e and then it's been re-orged, right? it's ok to have this block because it won't be a part of canonical chain. I am thinking about user forgetting to restart geth with overridden TTD. In this case geth would refuse switching to PoS until it reaches the TTD -- this is dangerous for a node\nThe solution is simple. Have the TTD EL side and have the EL ping the CL client that the TTD was exceeded",
        "created_at": "2021-11-16T10:35:53.663000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Except CL will revolt for the same reason I'm revolting now ðŸ™‚",
        "created_at": "2021-11-16T10:36:07.558000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If the user needs to restart one client anyway, it's completely acceptable to have them restart both",
        "created_at": "2021-11-16T10:37:00.756000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you can add a check and warning if either side detects an inconsistency",
        "created_at": "2021-11-16T10:37:11.141000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "it is trivial to ensure the two TTDs are the same on both sides than to hack either side to dynamically swap out TTD on the fly",
        "created_at": "2021-11-16T10:37:39.003000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003c@!206016661470314496\u003e IIUC, your primary complaint is not knowing the TTD on startup?",
        "created_at": "2021-11-16T10:38:09.155000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It doesn't have as much to do with *where* the TTD is coming from, but rather it has to do with *when* you learn about the TTD (at startup vs at runtime)?",
        "created_at": "2021-11-16T10:38:30.478000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Polling terminal block data from EL is the complexity on CL side as it's difficult to implement this in a robust way. Checking the consistency of TTD between the layers would add a complexity to the Engine API -- we'd need a kind of status message exchange and a point where we can do this kind of check",
        "created_at": "2021-11-16T10:39:45.382000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "yup",
        "created_at": "2021-11-16T10:40:06.684000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I want it to remain static across the entire lifetime of geth",
        "created_at": "2021-11-16T10:40:24.190000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Updating it after it's set means all internal code needs to handle the update",
        "created_at": "2021-11-16T10:40:40.237000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I hear you and I understand the complexity now (I hope). THe assumption was that it would be a re-org similar to a regular re-orgs",
        "created_at": "2021-11-16T10:40:40.718000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "But isn't that what we do right now? The CL is always polling the EL for the current block so they know when they reached ttd",
        "created_at": "2021-11-16T10:40:50.719000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I believe in all but the most pathological scenarios, TTD should be known *before* it is reached, not after.  Would it be reasonable for Geth to just write TTD to disk and halt if it receives a TTD in the past, and then on next boot it would start with that saved TTD?",
        "created_at": "2021-11-16T10:41:13.180000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It doesn't receive a TTD in a clear way. It rather receives a `forkchoiceUpdated` message that triggers the switch",
        "created_at": "2021-11-16T10:41:58.657000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Or does it need to know the TTD at startup even if the TTD is in the future?",
        "created_at": "2021-11-16T10:42:05.128000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "And then the new TTD is released with the new client version",
        "created_at": "2021-11-16T10:42:13.963000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Hmm, I see.  So the issue is having TTD *change* during a run of Geth, regardless of whether it moved forward or backward.",
        "created_at": "2021-11-16T10:43:11.090000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "yup",
        "created_at": "2021-11-16T10:43:24.559000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "how would EL handle the TERMINAL_BLOCK_HASH override? as it skips TTD checks altogether?",
        "created_at": "2021-11-16T10:43:35.555000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Geth would know this at startup, so it wouldn't be a problem IIUC what Peter is saying.",
        "created_at": "2021-11-16T10:43:56.952000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It won't know it at start up according to current design",
        "created_at": "2021-11-16T10:44:17.693000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "how can get know TERMINAL_BLOCK_HASH in future?",
        "created_at": "2021-11-16T10:44:27.237000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "unless restart is required",
        "created_at": "2021-11-16T10:44:41.773000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I am quite surprised at the lengths we're going to in order to avoid the user needing to set a flag on both the CL and EL, given that we don't expect the flag to be needed at all anyway.  And we'd be pushing out releases hard coding that TTD asap anyway. Personally I'd be in favour of both EL and CL just knowing the TTD (and TERMINAL_BLOCK_HASH if there is one).",
        "created_at": "2021-11-16T10:44:49.365000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "terminal block hash is not relevant tohugh from this perspective",
        "created_at": "2021-11-16T10:44:53.896000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "that just selects which chain to go with",
        "created_at": "2021-11-16T10:45:02.544000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "but all chains are equally valid",
        "created_at": "2021-11-16T10:45:08.029000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "my fit is with ttd, which can change the rules",
        "created_at": "2021-11-16T10:45:19.954000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "as per my understanding of CL specs, merge transition in CL occurs at TERMINAL_BLOCK_HASH",
        "created_at": "2021-11-16T10:45:57.376000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yeah, it seems like doing it this way is the least of all evils",
        "created_at": "2021-11-16T10:45:58.618000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "so all the blocks mined after TERMINAL_BLOCK_HASH are sort of invalid as per the logic you have elaborated",
        "created_at": "2021-11-16T10:46:15.193000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Right, but if geth would be restarted with TBH then it could invalidate all other chains on start up",
        "created_at": "2021-11-16T10:46:46.681000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "well yeah, but terminal block hash will be of a block that exceeds ttd, so ttd already handles that part",
        "created_at": "2021-11-16T10:46:47.156000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "it's not necessary a block that exceeds TTD btw",
        "created_at": "2021-11-16T10:47:11.144000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "not setting ttd and only setting tbh is also bad btw",
        "created_at": "2021-11-16T10:47:12.805000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I am actually now confused to the utility of two competing ways to set the terminal pow",
        "created_at": "2021-11-16T10:47:28.411000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "because I again am missing the data and need to derive stuff async until I figure out what the rulesets are",
        "created_at": "2021-11-16T10:47:36.100000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "yes as per current specs",
        "created_at": "2021-11-16T10:47:54.688000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "terminal_block_hash seems a bad idea really",
        "created_at": "2021-11-16T10:48:05.185000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "retrieving the block itself from the network is not enough either",
        "created_at": "2021-11-16T10:48:12.500000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'd need to sync to even figoure out what the ttd was",
        "created_at": "2021-11-16T10:48:21.495000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I hough that TERMINAL_BLOCK_HASH would at max allow us to lock  into a specific block, but it would not be used as the signal for the merge",
        "created_at": "2021-11-16T10:49:31.473000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "We need TBH to be able to pick up the chain in case if attack happens in the network. And this exact block will be the terminal one. All other PoW chains should be invalidated",
        "created_at": "2021-11-16T10:49:47.475000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The rulset update still needs to be driven by a ttd",
        "created_at": "2021-11-16T10:50:31.289000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "ok, so we assume restarts for EL will happen if TERMINAL_BLOCK_HASH scenario is set",
        "created_at": "2021-11-16T10:50:36.819000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you can set both on the CLi I guess if you want",
        "created_at": "2021-11-16T10:50:41.841000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It would be used actually, because you may have multiple forks created after a block pointed by TBH. Then we also have to adjust the TTD?",
        "created_at": "2021-11-16T10:50:49.666000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "that would be my guess yes",
        "created_at": "2021-11-16T10:51:09.638000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "since again, you're just piling complexity on top to make 2 signals for the merge",
        "created_at": "2021-11-16T10:51:24.348000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "if ttd is already a signal, use that to tell EL that the fork happened/s and if you want to lock in a specific branch, use the hash to tell it which",
        "created_at": "2021-11-16T10:52:08.203000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yeah you'd want to stop importing new blocks/mining them even if you haven't yet found the actual TBH block so having TTD set to match TBH would ensure that and provide extra consistency to things.",
        "created_at": "2021-11-16T10:52:23.234000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "My 2c is that making everything insanely ocmpliated to have the user only stop 1 client instead of 2 is a bit strange",
        "created_at": "2021-11-16T10:53:20.695000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Especially since this is supposed to be a one off emergency procedure",
        "created_at": "2021-11-16T10:53:41.424000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Seems saner to keep emergency procedures \"simple\" rather that complicated",
        "created_at": "2021-11-16T10:53:51.646000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Setting the same settings on both clients requires synchronization between EL and CL, which adds code to both layers for a scenario we expect not to happen.",
        "created_at": "2021-11-16T10:54:35.657000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Unless your thinking is that we *don't* add any synchronization logic and one or both clients just halt at fork block time if they are out of sync?",
        "created_at": "2021-11-16T10:55:18.860000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yes",
        "created_at": "2021-11-16T10:55:30.145000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I would say that TBH is stricter than TTD in terms of pointing out to the terminal block. But we want only one trigger that clearly switches EL client logic and we want this trigger to be respected in all scenarios and known in advance. This is my understanding",
        "created_at": "2021-11-16T10:55:31.243000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "that's what I'm saying",
        "created_at": "2021-11-16T10:55:34.449000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "In that though case you end up with a bad situation turning into a worse situation because people won't realize their configuration is broken until the fork block.  So at fork block we'll suddenly have a bunch of nodes go offline (anyone who failed to configure both clients the same).",
        "created_at": "2021-11-16T10:56:01.177000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "halt, tell the user that the clients mismatch and have the user restart one or the other",
        "created_at": "2021-11-16T10:56:06.027000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "well, if you expect an emergency change of ttd, everyone needs to be at their computer either way",
        "created_at": "2021-11-16T10:56:28.320000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "(\"bad situation\" being the fact that we had to override the TTD, \"worse situation\" being that we have a large portion of the network go offline at hardfork time)",
        "created_at": "2021-11-16T10:56:39.241000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "That's essentially indistinguishable from all the people who didn't get the message about needing to set the override anyway which is likely to be far, far more people.",
        "created_at": "2021-11-16T10:56:59.755000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'm assuming that if we did a TTD override, it would be weeks before the new TTD.",
        "created_at": "2021-11-16T10:57:02.631000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If we have weeks we'd just put out new client releases.",
        "created_at": "2021-11-16T10:57:19.493000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Then we'd just do a new release",
        "created_at": "2021-11-16T10:57:21.073000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The TTD override is only useful if we're applying it in less than a day or two at most.",
        "created_at": "2021-11-16T10:57:43.212000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I think the override flag mostly is needed if you want to fork within 1-2 days notice",
        "created_at": "2021-11-16T10:57:51.681000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "hah",
        "created_at": "2021-11-16T10:57:57.266000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": ":))",
        "created_at": "2021-11-16T10:57:58.074000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It is strictly more people I believe.  The set of people who will go offline at TTD in an override scenario is the combination of the set of people who didn't hear about the change and the set of people who applied the change wrong.  This proposal increases the size of the latter set.",
        "created_at": "2021-11-16T10:57:59.779000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003c@!340345049063882753\u003e I'm echoing you here :))",
        "created_at": "2021-11-16T10:58:17.040000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I was under assumption that it takes days to upgrade client software for some large infra and providers while restarting it with a new flag could take hours",
        "created_at": "2021-11-16T10:58:50.031000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e Well, you are right. But if a bug messed up the execution client then the set of people going offline will be 100% ðŸ˜›",
        "created_at": "2021-11-16T10:59:07.208000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I think the best parallel here that I can think of is the cancelled Constantinople release where we discovered and issue and cancelled the upgrade very late.  There was an override available for at least some clients but most people solved it by just upgrading to the new emergency release.",
        "created_at": "2021-11-16T10:59:28.435000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I think we should revisit this part of the spec and discuss it during the next ACD",
        "created_at": "2021-11-16T10:59:32.551000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "We can revisit, but Geth not supporting dynamic TTD updates wasn't a question, it was a statement ðŸ˜›",
        "created_at": "2021-11-16T11:00:12.595000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So I think it's useful to have the upgrade so that bigger staking outfits etc can apply it if that's faster/easier for them than upgrading but those people are also very competent so unlikely to miss applying it to both nodes.",
        "created_at": "2021-11-16T11:00:17.295000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I don't think we should ignore the Geth team's concerns here, but I do think that we should use this situation to help empathize with Erigon in the future when they request we don't make a change because it is complicated for them due to their architecture.\n\nThe Erigon team has, on many occasions, complained that certain design choices make their life hard due to the way their client is architected compared to other clients and in almost every case we ignore them.  This situation feels essentially like the same argument, but coming from Geth.  The primary difference here is that Geth has the clout to get a design change made that favors their architecture while Erigon does not.",
        "created_at": "2021-11-16T11:00:28.704000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Er? We've always accomodated Erigon requests AFAIK",
        "created_at": "2021-11-16T11:01:03.750000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "OK, so probably we don't need a TTD override option and can fallback to release/upgrade procedure if we need it. But then what to do with TBH?",
        "created_at": "2021-11-16T11:01:05.180000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Unsure where this comes from",
        "created_at": "2021-11-16T11:01:08.381000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It's not just Geth. PÃ©ter's right - I've already complained about the complexity when it was suggested that the CL poll the EL. ðŸ™‚",
        "created_at": "2021-11-16T11:01:17.706000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It comes from you outright refusing to implement rather than starting the conversation with, \"we would rather not do this\".",
        "created_at": "2021-11-16T11:01:50.261000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'd keep the override to be honest, but I'd have it present on both EL and CL. It is useful in some situations.",
        "created_at": "2021-11-16T11:02:13.768000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Erigon doesn't have that luxury, and I don't want to drag this off-topic but I think someone from that team could give a laundry list of concessions they have had to make.  ðŸ™‚",
        "created_at": "2021-11-16T11:02:16.985000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It is not a mandatory feature though. Other clients can implement it, Geth will terminate",
        "created_at": "2021-11-16T11:02:36.134000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It's not a onsensus issue that would make any diff on the protocol",
        "created_at": "2021-11-16T11:02:45.510000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Is it possible to put all the terminal block logic inside the EL? Itâ€™s already the authority on what the total difficulty is, can it just be the authority on everything terminal block related?",
        "created_at": "2021-11-16T11:02:53.565000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Then why is it in the spec if it isn't a consensus issue?",
        "created_at": "2021-11-16T11:02:59.132000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The problem will be the same we're discussing now. CL needs to dynamically handle surprise updates",
        "created_at": "2021-11-16T11:03:35.193000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It probably doesn't need to be in the spec - I was going to put it into Teku regardless, just as we have an option to override the altair fork epoch.",
        "created_at": "2021-11-16T11:03:45.772000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I agree, a clear cut precise signal and driver of transition is required",
        "created_at": "2021-11-16T11:03:47.878000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If it is just a \"recommended practice\", then it shouldn't be in the spec IMO.",
        "created_at": "2021-11-16T11:03:48.981000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "That seems to be the simple solution.  ðŸ˜„  Just remove this whole topic from the spec.",
        "created_at": "2021-11-16T11:04:00.620000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "CL would also need to poll TTD anyway, to verify the conditions in the fork choice code",
        "created_at": "2021-11-16T11:04:17.981000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "But not putting it in the spec guarantees we have a flag on both the CL and EL.  I like that solution but if you wanted to avoid that it needs spec support.",
        "created_at": "2021-11-16T11:04:37.499000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Fork choice code is just verifying TTD numbers from the EL. Why not just accept a bool saying itâ€™s valid or not?",
        "created_at": "2021-11-16T11:05:05.285000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Why does it guarantee two flags?  Couldn't some EL clients derive the TTD from the the CL, while others *only* get it from local configuration?",
        "created_at": "2021-11-16T11:05:23.581000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Actually yeah might be able to do it that way for the EL side. But the CL reading it from the EL approach would require engine API support for it (in some form).",
        "created_at": "2021-11-16T11:06:12.289000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "What happens if you update your consensus client after the fork tho'?",
        "created_at": "2021-11-16T11:06:20.442000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "it could be done this way I guess. and piggy back on executePayload even",
        "created_at": "2021-11-16T11:06:41.430000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I don't think anyone is proposing this at the moment (aside from the weak strawman from Peter above)?",
        "created_at": "2021-11-16T11:06:49.143000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yeah, it wasn't a serious proposal",
        "created_at": "2021-11-16T11:07:01.742000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I think it's horrible",
        "created_at": "2021-11-16T11:07:04.775000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Itâ€™s not hard for the CL. Weâ€™re expecting to have to invalidate blocks to make sure the EL can continue to use fancy sync algorithms (snap sync).",
        "created_at": "2021-11-16T11:07:18.800000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I do think updateing both CLIs is the dead simple solution",
        "created_at": "2021-11-16T11:07:21.538000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "That's what paulhauner is suggesting now and it's not a bad suggestion.  Particularly if it does mean I can piggy back on executePayload and not have to check the TTD in the CL directly at all that would simplify a bunch of code.",
        "created_at": "2021-11-16T11:07:44.696000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "But proposer will have to poll anyway",
        "created_at": "2021-11-16T11:08:10.178000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Proposer has to poll the EL head whenever they produce a block in the current scheme.",
        "created_at": "2021-11-16T11:08:40.795000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Couldn't the proposer  just call getPayload and the EL would reject the request prior to TTD?",
        "created_at": "2021-11-16T11:09:05.919000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Iâ€™m also totally fine with two flags. I guess Iâ€™m just adding suggestions to the mix and hopefully indicating that CL clients are here to help as well.",
        "created_at": "2021-11-16T11:09:32.567000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "need to specify parent root....",
        "created_at": "2021-11-16T11:09:33.128000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Again, why are we trying to solve a non-existent problem with complexity? ðŸ˜›",
        "created_at": "2021-11-16T11:09:35.135000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "you mean, `forkchoiceUpdated` with payload attributes",
        "created_at": "2021-11-16T11:09:37.626000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "ðŸ™‚ Yes.",
        "created_at": "2021-11-16T11:09:46.323000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "with the question can I build on top of the head or not?",
        "created_at": "2021-11-16T11:10:07.258000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So I tend to like just having a flag on CL and EL as the simplest solution. But if we did manage to reduce complexity *and* shift all responsibility for TTD to the EL that would be even better. I'm not sure if that's possible, but it sounded promising for a moment there.",
        "created_at": "2021-11-16T11:10:53.734000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "This is true and I don't completely understand why polling any kind of transition state is more complicated",
        "created_at": "2021-11-16T11:11:09.733000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Because this brings a lot of fun ðŸ˜†",
        "created_at": "2021-11-16T11:11:34.924000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Getting the current head to propose a block is quite different to getting an important config value for every block we validate.",
        "created_at": "2021-11-16T11:11:51.616000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "But I must admit I'm a bit behind on exactly how the block proposal process has to work with the latest spec.",
        "created_at": "2021-11-16T11:12:15.526000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It has to poll blocks and TD of those blocks and then decide on what it has seen, i.e. figure out if there a TBH or a block that matches TTD",
        "created_at": "2021-11-16T11:13:29.514000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "if merge transition conditions are met, just ask EL for prepare payload (using terminal pow as parent) and execute, notify.. spread...",
        "created_at": "2021-11-16T11:13:32.149000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "and the receivers will have to validate is_merge_block on receivings",
        "created_at": "2021-11-16T11:14:47.124000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "plus verify execution",
        "created_at": "2021-11-16T11:15:22.404000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "To be serious, it could be harmful for the Merge procedure if we do it in a wrong way. If we want to have these overrides then we have to deal with the complexity. Otherwise, we gave up on quick overrides and doesn't rely on them during the merge but rather rely on release/update procedure which is slower than passing TBH to the CLI of a client. If we don't have an override option then we don't have a safe net and so forth...",
        "created_at": "2021-11-16T11:15:50.259000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Btw, is there a way to force the exact fork by passing the block hash to geth?",
        "created_at": "2021-11-16T11:17:04.117000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "You donâ€™t have to just get the current head, you have to get the head and then maybe hop back until your find the block that crosses the TTD threshold (if any).\n\nUltimately, those calls give you the TD half of the TD \u003e= TTD check that starts bringing execution into the beacon chain. So those calls are already about as critical as they get.",
        "created_at": "2021-11-16T11:20:07.207000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Thatâ€™s on the proposer side. On the verifier side you grab the block by itâ€™s hash and check the TD value.",
        "created_at": "2021-11-16T11:22:22.283000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "about piggy backing on `executePayload`. It may return `VALID_TRANSITION_BLOCK` in addition to `VALID` -- it would mean that the block is valid and it's build on top of a valid terminal block",
        "created_at": "2021-11-16T11:23:10.336000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "You can whitelist any block and Geth will enfocre a chain that has that block. You can't enable fork rules with block hashes. Fork rules are directed by block number (or in this case TTD), both of which clearly - and self contained - define when a rule update happens",
        "created_at": "2021-11-16T11:23:19.527000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I see, so, TBH functionality as it is currently specified can be implemented by whitelisting the hash and adjusting TTD",
        "created_at": "2021-11-16T11:24:08.266000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "yes",
        "created_at": "2021-11-16T11:24:18.048000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I see TBH to be more of as a Post Merge (finalization), eth (social consensus) fixed param, sort of a (merge) genesis value to be baked in the versions of client released post merge for eth mainnet",
        "created_at": "2021-11-16T11:25:44.145000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "but the validator who gets to propose merge block (and finalized) at difficulty \u003e=TTD is the actual decider of TBH (amongst pow forks candidates to choose from if any)",
        "created_at": "2021-11-16T11:29:31.923000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "so in my opnion, the other (receiving/non proposing ELs) will have to consider the scenario of invalidation",
        "created_at": "2021-11-16T11:30:31.790000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "of a competing pow block with difficulty \u003e= ttd",
        "created_at": "2021-11-16T11:30:58.346000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "easy resolution will be for those ELs to terminate and restart with the autoset of the TBH param in case the received  merge block's (terminal) pow is not the same as the local EL's one",
        "created_at": "2021-11-16T11:32:19.247000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "so both ttd and TBH could be useful, but with only ttd set and TBH (auto restart) to be used if the receiver's EL will have to invalidate the one it sees as terminal",
        "created_at": "2021-11-16T11:34:42.370000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Also another Q: CL clients will (most likely) use weak subjectivity sync as many do currently, but that will put the EL into syncing status till it gets the entire chain (i guess), which as per current optimistic sync plans will not let CL propose,attest, sync committee.. which will sort of kill the weak subjectivity sync.",
        "created_at": "2021-11-16T11:55:35.104000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "unless CL's wss state will also specify EL's state, with option to set it  as a new EL (wss) genesis to not do syncing below (or rather to not give syncing status for if blocks below wss pow hash are not with EL)",
        "created_at": "2021-11-16T12:00:17.456000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "just throw in EIP 4444 concerns into mix for wss sync support on EL side",
        "created_at": "2021-11-16T12:08:48.744000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Pulling blocks, receipts and state happens simultaneously in EL clients and I don't think that blocks delays the sync process",
        "created_at": "2021-11-16T12:56:06.370000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I am filing an issue related to our discussion today. Will drop it here for everyone's review once done",
        "created_at": "2021-11-16T12:57:11.062000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "understood. ðŸ‘  and lets say post merge a new CL spins up from a recent  checkpoint state (finalized state 2 epochs back)  and CL will lets say pass the corresponding block hash to the EL (via forkchoiceUpdate), how long will the CL have to wait till EL starts executing the payloads and not returning syncing? (best case estimate considering all conditions favorable)",
        "created_at": "2021-11-16T13:03:04.204000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Snap sync takes a few hours, there are numbers for not that recent EL block here https://github.com/ethereum/devp2p/blob/master/caps/snap.md#expected-results",
        "created_at": "2021-11-16T13:13:01.218000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "thank you! this link is quite helpful ðŸ™‚",
        "created_at": "2021-11-16T13:14:05.047000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It does not invalidate your head. Your head is still valid. It is a re-org on your valid block tree (which PoS can do even if you have TTD set locally because any valid TTD sister/cousin can be the valid terminal block)",
        "created_at": "2021-11-16T14:10:58.071000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "ah, I see the problem. it's the *rules* of the logic within the block that you claim would be invalidated. OR at least that the meechanism you have to execute rules within a block must be premised upon TTD or block height and can't be upon a signal from PoS",
        "created_at": "2021-11-16T14:14:34.308000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "In the case of a sister of a terminal block there is still a clear boundary at which consensus upgrade is applied. This is the essence of the concern as I understand it. So, EL client will not have two sister blocks one of which is PoW and another one is PoS",
        "created_at": "2021-11-16T14:14:35.540000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I would presume it's the writing of logic like `if TTD: execute_RANDOM_opcode_logic()` that is making this difficult whereas it's really `if on_POS_brach: execute_RANDOM...` as currently specified\n\nArguably, the spec allows for no 4399 on any continued pow branch whereas it enables 4399 (and other header changes) on the PoS branch, whenever that is triggered by external code. I see that knowing TTD and triggering logic changes across all branches in the tree at that point could make the code simpler -- rather than flagging a branch as PoS enabled and triggering logic changes premised on that.",
        "created_at": "2021-11-16T14:19:16.834000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": ".\nI'm fine with reverting the TTD logic in EL and assuming synchronization between the layers\nI'm also fine considering removing TTD and TBH override from CL (rather than adding to EL) and assuming that in an attack scenario, new releases are cut. It's not like we can use override logic in sub-24-hour time frames so in all likelihood releases will be made anyway\nThe alternative being that the override is specified in EL as well. Fine with this too, but want to consider just removing from CL first",
        "created_at": "2021-11-16T14:21:15.840000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Cutting a release in the case when the Merge is delayed due to haspower migration is perfectly fine, so, we don't have to override the TTD. On the other hand TBH can't be a fork trigger as it's been discussed, it should be a whitelisted block via its hash value + TTD override.\n\nNeed to think about TBH functionality and how bad do we want it. My question how fast the \"restart with new parameter\" in comparison to \"release and update\" strategy is.",
        "created_at": "2021-11-16T14:26:33.572000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e I'm fine with reverting the TTD logic in EL and assuming synchronization between the layers\nAssuming or enforcing? Enforcing could be done via Engine API by returning errors when a block is going to be executed by it's not yet a terminal block wrt TTD.",
        "created_at": "2021-11-16T14:27:48.107000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "the think is with TBH is that you need to pick an epoch in the future (at least 24 hours?) because you need everyone to trigger it at the same time",
        "created_at": "2021-11-16T14:28:15.332000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "so it's not really \"how fast\" this particular thing is",
        "created_at": "2021-11-16T14:28:26.892000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "it's \"how fast can we communicate and coordinate out of band\"",
        "created_at": "2021-11-16T14:28:46.384000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "which  even 24 hour would be dangerous, imo",
        "created_at": "2021-11-16T14:28:59.520000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\"release/upgrade\" strategy does also involve coordination part. But if say upgrade after it's been well communicated takes additional 24hrs because some infra has a special upgrade procedure that delays it then it would take 48hrs vs 24hrs. And if we're OK with this additional Xhrs requiring for the upgrade then yes, we don't need any kind of overrides. I was under impression that it worth doing because it could save a lot of time during which the chain could be a kind of in chaos due to attacks",
        "created_at": "2021-11-16T14:32:40.388000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Oh, yes. Of course, there will be a kind of synchronization between layer if we want TBH as there is an epoch on CL side that must be set",
        "created_at": "2021-11-16T14:49:22.350000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "because if TBH is overriden anyhow on EL side while epoch isn't set properly then we face with the same issue as if EL and CL were using two different TTD values",
        "created_at": "2021-11-16T14:56:28.851000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "https://github.com/ethereum/consensus-specs/issues/2724",
        "created_at": "2021-11-16T14:57:37.672000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Right, I'm just no convinced of how much time can be saved. Is modifying a production deploy with a flag  that much faster than running with a new binary?",
        "created_at": "2021-11-16T15:29:17.776000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yes, for any enterprise clients who do thorough binary vetting.",
        "created_at": "2021-11-16T17:18:29.384000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "For example, one can imagine an enterprise client who builds from source, and does a review of the changeset from the previous build they ran.",
        "created_at": "2021-11-16T17:18:57.571000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "This is one of those things where the time difference isn't related to actual execution as much as it is related to the processes around upgrades and changes of critical infrastructure.",
        "created_at": "2021-11-16T17:19:38.162000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Pretty sure Coinbase/Infura could provide feedback on what would be easiest for them if asked, but I think we should make sure client teams are in agreement about a proposal before going to them",
        "created_at": "2021-11-16T19:15:34.682000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Can we make this a topic for the Kintsugi office hours on the CL call this week? \u003c@!206016661470314496\u003e could you join if so (14:00 UTC thursday)",
        "created_at": "2021-11-16T19:17:02.626000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I am convinced that a shift in TTD expecations on EL back to prior logic will simplify things *at least* on geth and likely other EL clients.\n\nSo the question then is about if/where to do overrides. We should def discuss on thursday, but Peter's point has been made regardless\n\nFortunately -- overrides are not expected to be used in Kintsugi standard testnets so clients can assume the built-in TTD on both EL and CL is correct/the same. Essentailly, this exceptional path will not be exercised in the upcoming tests so we can hammer out the details in parallel without derailing the core",
        "created_at": "2021-11-16T19:38:05.515000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "FWIW updating args or a new binary are roughly the same level of effort for us for standard deployments.  More generally, I suspect updating binaries is simpler than adding arguments in most cases, e.g. it's a lot less error prone to `scp` a new binary to a machine and restart a process than it is to for example update an init script or systemd unit in place.",
        "created_at": "2021-11-16T22:04:43.564000+00:00",
        "attachments": null
    }
]