[
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yeah I think its worth trying to get geth working on a node as a starting point.  Looking at teku-geth 11 today, the head block it's reporting is on the right chain but way back at slot 161,441. After that it might has likely optimistically sync'd a bunch of blocks but it seems to think it's chain head isn't optimistically imported. We don't have a lot of tooling around viewing the optimistic head at the moment so it would be very helpful to have geth working and see what the head does then.",
        "created_at": "2022-01-11T05:11:46.214000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "One thing \u003c@!504202741933932544\u003e noticed is that teku will be spamming the living daylights out of the EL as it likely now has a ton of different forks it's optimistically sync'd and will be regularly retrying to execute the head of each fork.  I'm not seeing any timeouts in the box I've looked at but he has so we will likely need to add some throttling to the number of concurrent messages we send to the EL (as we have for the previous eth1 chain tracking for voting).",
        "created_at": "2022-01-11T05:15:22.963000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Here's the heads from that dump, sorted in ascending order by weight:\n\n```\n{'root': '0xc109a0d85f0907a9dfe9e23f298095564dc77838643b259294c3d358a901a774', 'slot': '165664', 'weight': 1184000000000, 'execution_status': {'Valid': '0xa1b50f29117159d2d9137c4145165b5ad02a25ad3044c598d69723a8f2c239a7'}}\n{'root': '0x25c935c594a7e7b4c799ac202de8cf74a6b8045da0f3fe5f8589e60a0e74babd', 'slot': '179327', 'weight': 1472000000000, 'execution_status': {'Valid': '0x451c658011b4195e099ee7909f98d20c9ac6bfd1b1e55f840e8e5d7e8309cd80'}}\n{'root': '0xd53b213664001f2c3752e8c0a0853408c7065bd723da294bf2cd60655048be04', 'slot': '175396', 'weight': 1664000000000, 'execution_status': {'Valid': '0x10008f391a796c7258b9ebd47b95b9b79c1f9f9c486fe65e0cc7d9581461af50'}}\n{'root': '0x01cc70dbc20e86ff4d8a8ce6966e2d6a458f37a7a65de28964f3dc4d4f553fb7', 'slot': '179197', 'weight': 1792000000000, 'execution_status': {'Valid': '0xfc9e5dd7545cee9ec7f5c8603e93a8343c5be3558926fe1d5bc1f13db8af426f'}}\n{'root': '0xa2c72cf1e1805d753affb2c81ad36c6f9e9376d61553167ac951fd2c507ad624', 'slot': '176441', 'weight': 3584000000000, 'execution_status': {'Valid': '0xa5ed42c6513768ffcc9e54acafdc2b3d65f3ffe5da5cb71755f6e3abe17fa848'}}\n{'root': '0x2fb8cae37a1ea05bb46a180331649b48750e2c57f16bfcd0c6a825fa995fe1b0', 'slot': '166126', 'weight': 3776000000000, 'execution_status': {'Valid': '0x3f58b6a2241416176d28e50e9e91d3284e5e995ac1f8daf2be9119890f037370'}}\n{'root': '0x20758dc7ab2b2ca6850fcd0159a10e32678d4e43bf2bec26b141d385cf2977e2', 'slot': '155095', 'weight': 7136000000000, 'execution_status': {'Unknown': '0xed342f0e588e0cbc8b4afa2852f5cf2c518983c7c500e513528332b9daa1292a'}}\n{'root': '0xfe585c1816b8236e10380bc4399759c7d157831b7c88db3460ba5215b0f47dfc', 'slot': '165638', 'weight': 18592000000000, 'execution_status': {'Valid': '0x4c4a2d4f591a5b56087d6aab64198cb57fb263de6bd8cfd445502c72a3ae1568'}}\n```",
        "created_at": "2022-01-11T07:14:21.110000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Looks like the second-most weighted head is optimistic (`execution_status: Unknown`)",
        "created_at": "2022-01-11T07:14:49.284000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "All of those heads have the same justified checkpoint",
        "created_at": "2022-01-11T07:15:52.935000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "and the justified checkpoint is pre-split? (first split happened at slot 154542 i think)",
        "created_at": "2022-01-11T07:33:30.254000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I've wiped geth's DB on teku-geth-11, its resyncing now. Let's see if it stays on the correct head post sync. \n\nI'll also do the same on teku-geth-1, so that we have more teku nodes to debug with - potentially on different forks.",
        "created_at": "2022-01-11T07:38:44.729000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "What was the slot of the nasty block that kicked this off?",
        "created_at": "2022-01-11T07:44:48.206000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "things start to break from 154543 (I made this doc on the day we were collecting info, https://notes.ethereum.org/@ExXcnR0-SJGthjz1dwkA1A/SJA4XjS2Y - should still be valid)",
        "created_at": "2022-01-11T07:53:04.559000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "(nethermind has been fixed since then, so it should be returning correct information)",
        "created_at": "2022-01-11T07:57:17.619000+00:00",
        "attachments": null
    },
    {
        "author": "catwith1hat",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Meta question: Is Kintsugi also supposed to exercise the incident response processes for the parties involved or do we limit ourselves to the distributed system itself? If it was the former, then I would expect busy activity here, by some incident response leader, giving regular updates to the public and internally to client team subgroups. From the absence of activity, I can only assume that Kintsugi is treated as relaxed experiment, that we don't care. I wonder where and when that element of taking things seriously is going to come in? The next testnet maybe? https://sre.google/workbook/incident-response/ has some guidelines on how incident response is best prepared for, including pager duty/drills/prepared lists of contacts/agreement on what communication channels/sharing tools to use.",
        "created_at": "2022-01-11T08:17:23.796000+00:00",
        "attachments": null
    },
    {
        "author": "catwith1hat",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Drills are kinda hard to do in a meaningful way in a distributed system, so it's sad that this nice crisis on Kintsugi isn't being used to also exercise the human part.",
        "created_at": "2022-01-11T08:20:04.127000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "We already did the incident response trial on kintsugi. The finding and fixing of the bug was done (at least on my end) how a real crisis would work too.\nHowever we're not looking for a quick fix, but rather to have software that will be as stable as possible.\nSo hacking in a fix, releasing it and notifying the public about it, is not the right approach at this level imo.",
        "created_at": "2022-01-11T08:23:47.740000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Looks like geth is still crashing on teku-geth 11. Not sure if resyncing helps with that but it got back into a bad state or if it's just dependent on the payloads Teku is sending it.",
        "created_at": "2022-01-11T08:48:10.551000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "teku-geth-1 does seem to be making progress, though it looks pretty messy. Crashed once and has recovered, has imported a lot of blocks but also reporting a lot of invalid gas used - not sure where that's coming from.  Teku will be retrying quite a lot of chain heads it's previously optimistically sync'd and hasn't yet managed to validate but unless someone's started producing bad blocks I'm not sure why they'd have invalid gas used.",
        "created_at": "2022-01-11T08:53:49.663000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'm currently working on teku-geth-1",
        "created_at": "2022-01-11T08:54:09.699000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It seems to be reorging back to block 1 and then syncing up to 7000",
        "created_at": "2022-01-11T08:54:31.510000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "As in that's what teku is sending?",
        "created_at": "2022-01-11T08:54:48.649000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Encountering the first post merge block with the random opcode and marking it as invalid",
        "created_at": "2022-01-11T08:54:50.719000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I think so",
        "created_at": "2022-01-11T08:54:57.567000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'm trying to get another version of geth on the machine to have better logs",
        "created_at": "2022-01-11T08:56:30.401000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If you look in `~/beacon/logs/teku.log` it looks like we have trace logs enabled showing every request teku is making to geth.",
        "created_at": "2022-01-11T08:57:00.550000+00:00",
        "attachments": null
    },
    {
        "author": "catwith1hat",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I wasn't aware of that. Thank you for the clarification.",
        "created_at": "2022-01-11T08:58:26.369000+00:00",
        "attachments": null
    },
    {
        "author": "catwith1hat",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "But frankly, my personal bar would be a bit higher for incident response and include the quick fix. Why? Because one might be under the illusion that the quick fix arsenal is bigger than it actually is, and when crisis hits on main net you find that the tools you had planned for that, don't actually work.\n\nCan someone point me to how a quick fix would theoretically if the same incident would have occurred on main net? If the only option is to fix forward, and rush a release, then you might need to do exactly that you have a fast release process, that doesn't depend on someone sleeping in a different time zone. Or that a regression test suite is taking too long to complete.",
        "created_at": "2022-01-11T09:15:19.759000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It looks like teku does some weird thing here:\nLine 8 (or 9) we get a head at blocknumber 1",
        "created_at": "2022-01-11T09:15:33.269000+00:00",
        "attachments": [
            {
                "type": "text/plain; charset=utf-8",
                "origin_name": "message.txt",
                "content": "bb49eb2193aacd563909b6e7ee44ef639a1a4c60255f69c665984049478def94"
            }
        ]
    },
    {
        "author": "catwith1hat",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Or can someone point me to a summary doc of the incident response. Or was it all done here in Discord and I have to scroll up?",
        "created_at": "2022-01-11T09:16:35.403000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "A comprehensive incident response doc hasn't been written yet since we just found the core cause and not all the related bugs. We've left the testnet in its current state longer than we would in mainnet since its beneficial for debugging and the testnet exists to help us find bugs.\n\nOn a mainnet scenario, we'd prioritize fixes once we've identified the core issue(As long as we've triaged the related bugs). \n\nI'd make sure to post a comprehensive incident report once we've cleaned up and deployed fixes.",
        "created_at": "2022-01-11T09:21:04.078000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "hmm, interesting.  It looks like we're trying to validate a bunch of fork choice heads we happen to have including:\n\n```\n2022-01-11 09:14:01.805+00:00 | ExecutionEngineChannel-0 | TRACE | ExecutionEngineChannelImpl | calling executePayload(executionPayload=ExecutionPayload{parent_hash=0x086d0f2830456992621683669b4fa43bc0be43765ac3774eda84f00d87fc4d83, fee_recipient=SszByteVector{0x0000000000000000000000000000000000000001}, state_root=0xfcb741cb4f2c360cd8c309a8bafb2087ae8cc24d3c959539cbe510b6cd96e733, receipt_root=0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421, logs_bloom=S\nszByteVector{0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n0000000000000000000000000000000000000000000000000}, random=0x3c7d7d0b764f3e0795a830cc043e1b834ee0b7e5e73c30051112de27e7b87717, block_number=1, gas_limit=9402876, gas_used=0, timestamp=1641519492, extra_data=SszByteList{0x}, base_fee_per_gas=7, block_hash=0x51ab4ae0670d2f327f5d477a587cfdeeb6a7a5bd027f6e1904b35f4c11c37a78, transactions=SszList{size=0: }})\n```\nwhich is what you're seeing. I'm not entirely sure why we think that's valid but I'm also not sure the CL checks that the block_number is in sequence. I know we check the parentRoot is correct, but don't remember seeing the block number being checked....",
        "created_at": "2022-01-11T09:46:09.125000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Ha, this block is another one created by my fuzzer I think ðŸ˜„",
        "created_at": "2022-01-11T09:49:39.774000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yeah it's coming from block root 0xaf5fe676ef615c150850fad6fd5cb719878cc392df88864b321c0baff8c15048",
        "created_at": "2022-01-11T09:52:18.182000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "And yeah according to https://github.com/ethereum/consensus-specs/blob/dev/specs/bellatrix/beacon-chain.md#process_execution_payload the CL doesn't verify the blockNumber - it depends on the EL doing that.",
        "created_at": "2022-01-11T09:53:17.969000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yep, I think that's an error on our side",
        "created_at": "2022-01-11T10:04:29.547000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The block number check has been removed from CL as this one of the existing block validity rules that is enforced by EL",
        "created_at": "2022-01-11T10:15:26.558000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "ah, so that block is causing one of the newer forks?",
        "created_at": "2022-01-11T10:49:41.271000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'm pretty sure that it causes the bootloop at least",
        "created_at": "2022-01-11T10:50:59.380000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Oh and it also hits the `findBeaconAncestor` panic (that I shoddily fixed some time ago)",
        "created_at": "2022-01-11T10:54:26.567000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "My bad fix might even be part of why it explodes now",
        "created_at": "2022-01-11T10:54:52.107000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "got it, is there a newer version i should be deploying?",
        "created_at": "2022-01-11T11:18:20.856000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Not yet",
        "created_at": "2022-01-11T11:20:04.305000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The block number sequentiality check *must* be on EL (when EL does independent things like sync). In this case it doesn't necessarily need to be in CL",
        "created_at": "2022-01-11T13:49:57.646000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "if you want to take a look you can see timeouts in kintsugi-teku-geth-15 in teku_2022-01-07.log",
        "created_at": "2022-01-11T14:08:06.443000+00:00",
        "attachments": null
    }
]