[
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Isnt there another way to do this? You can take a recent deposit proof from the beacon chain to construct the right-most branch of the deposit tree and then just add deposits from there from the more recent EL history",
        "created_at": "2022-01-01T00:30:13.241000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e The rightmost branch is also in the dep contract",
        "created_at": "2022-01-01T00:33:34.610000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e But if this were to be spec'd it *might* live with the ws stuff in the CL spec but I personally think more appropriate to live in an eip, similar to slashing db standard and other things \nBUT there is a diversity of opinion here...",
        "created_at": "2022-01-01T00:34:32.772000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e And for reference, the discussions at amphora about breaking the log promise has manifested as eip 4444 and discussions around that",
        "created_at": "2022-01-01T00:45:33.920000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "\u003e right most branch\n\nThis is what I meant by \"the deposit Merkle tree can be significantly compressed\" - because the implementation I just wrote only stores the right most branch of the finalized tree + pending deposits",
        "created_at": "2022-01-01T01:03:27.167000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Gotcha, but I question whether that branch needs to be disseminated during ws sync",
        "created_at": "2022-01-01T01:04:53.056000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e And what needs to be transmitted in the beacon api?",
        "created_at": "2022-01-01T01:05:21.765000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "Does pulling the merkle branch from a block involve assumptions about deposit activity?",
        "created_at": "2022-01-01T01:06:23.280000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "I was transmitting the branch via an API endpoint",
        "created_at": "2022-01-01T01:07:07.477000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Indeed. Pulling it from the dep contract is more failsafe",
        "created_at": "2022-01-01T01:07:42.587000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Ah, assuming a ws provider would serve that endpoint to a bootstrapping node? I see (re @merge_chat_bot: \u003cethDreamer\u003e I was transmitting the branch via an API endpoint)",
        "created_at": "2022-01-01T01:08:11.915000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "Yes. Correct me if I'm wrong but the deposit contract can only serve the branch of the latest tree at the head of the chain - which is nearly always going to be different than the tree as it was at the finalized checkpoint",
        "created_at": "2022-01-01T01:12:09.120000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Right but you can sync to the head, then grab the branch and be able to build deposits from there, no?",
        "created_at": "2022-01-01T01:12:53.824000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e And if this or something like it does manifest as just a beacon api endpoint, that along with a quick note in the cl ws specs might be sufficient",
        "created_at": "2022-01-01T01:16:05.898000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "You need the right-most branch of the deposit contract at ws checkpoint - otherwise you can't verify Merkle proofs of deposits between the checkpoint and the head when you start syncing",
        "created_at": "2022-01-01T01:16:44.437000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "Unless I'm missing something..",
        "created_at": "2022-01-01T01:18:20.544000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "You can verify deposits in beacon blocks without any external data - you don't need an eth1 node at all to verify the beacon chain.",
        "created_at": "2022-01-01T01:18:40.320000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "(well, that is assuming you have the genesis state or some other checkpoint state",
        "created_at": "2022-01-01T01:20:09.584000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "But can you construct proofs for block proposals with deposits between the checkpoint and head when you started syncing?",
        "created_at": "2022-01-01T01:20:13.499000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e The deposits are constructed by each proposer and contain proofs",
        "created_at": "2022-01-01T01:21:55.926000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e See Deposit data structure",
        "created_at": "2022-01-01T01:22:01.054000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e So verifying the beacon chain is just a matter of verifying those proofs",
        "created_at": "2022-01-01T01:22:14.576000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Whereas constructing it requires knowing recent deposit logs and rightmost merkle branch",
        "created_at": "2022-01-01T01:22:37.112000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e And dep logs will be available within ws period because any 4444 like proposal will almost certainly only prune outside of longest ws period",
        "created_at": "2022-01-01T01:23:26.039000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "Rightmost branch *before* the deposit you're constructing the proof for though",
        "created_at": "2022-01-01T01:23:31.446000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Hmm right so you need a depth of pending_deposits rightmost branch",
        "created_at": "2022-01-01T01:24:30.354000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "I mean the data structure we came up with was:\n\nDepositTreeSnapshot {\n    branch: Vector[Hash32],\n    deposits: uint64,\n    eth1_block_hash: Hash32,\n}\n\nThough hash could be swapped out with height..",
        "created_at": "2022-01-01T01:26:33.423000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e So one thing that doesnt work with any of these ws bound methods is if deposit queue is deeper than 4444 pruning period  but if pruning period is 4 months or a year, thats quite an exceptional case",
        "created_at": "2022-01-01T01:30:23.627000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Right, makes sense (re @merge_chat_bot: \u003cethDreamer\u003e I mean the data structure we came up with was:\nDepositTreeSnapshot {\n    branch: Vector[Hash32],\n    deposits: uint64,\n    eth1_block_hash: Hash32,\n}\nThough hash could be swapped out with height..)",
        "created_at": "2022-01-01T01:30:59.215000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e I'd love to avoid needing another endpoint to bootstrap this but... the arbitrary depth of the rightmost branch of the earliest pending deposit (rather than the heas) is annoying",
        "created_at": "2022-01-01T01:31:55.711000+00:00",
        "attachments": null
    },
    {
        "author": "ethdreamer",
        "category": "general",
        "parent": "",
        "content": "You need more than the depth though. You need the whole branch at the ws checkpoint. Without them you can't construct proofs for deposits just after the checkpoint but before the point you started syncing (if you only have the branch from the deposit contract at the head). As  each deposit between the checkpoint and the head will change the lower hashes in the branch",
        "created_at": "2022-01-01T01:34:12.201000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e I meant a rightmost branch at an arbitrary depth in the chain",
        "created_at": "2022-01-01T01:40:33.810000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Hmm so if you backfill blocks to 4 months (which you should as per spec), you can get the rightmost branch assuming 1 deposit in that period \nNot sure if that is a reasonable assumption",
        "created_at": "2022-01-01T01:45:04.281000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e And you dont need the rightmost branch at the ws checkpoint (although this will suffice). You need the rightmost branch of the latest not yet included deposit. But I think we agree there",
        "created_at": "2022-01-01T01:46:41.676000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "If there wasn't a deposit in that period, wouldn't the current right most branch work as it would be the same? It seems like you'd need to have a deposit that hadn't been included for 4 months.",
        "created_at": "2022-01-01T01:54:10.723000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "It would be nice to avoid adding backfill as a dependency on block production.",
        "created_at": "2022-01-01T01:55:11.695000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "general",
        "parent": "",
        "content": "Slightly tangential, but you can quite nicely prove that some right branch is the latest (rightmost) branch against the beacon state eth1_data. Itâ€™s nice API consumers could verify that.",
        "created_at": "2022-01-01T01:58:40.463000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Ah right (re @merge_chat_bot: \u003cAdrian Sutton\u003e If there wasn't a deposit in that period, wouldn't the current right most branch work as it would be the same? It seems like you'd need to have a deposit that hadn't been included for 4 months.)",
        "created_at": "2022-01-01T01:58:45.515000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e So you can get it either from a dep in that range or the current read of the contract",
        "created_at": "2022-01-01T01:59:08.912000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Might be an edge case if eth1data voting has stalled out for a long time",
        "created_at": "2022-01-01T02:01:42.216000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "general",
        "parent": "",
        "content": "\u003cdannyryan\u003e Dropping that and stepping away to chill on the new year. Happy new year!",
        "created_at": "2022-01-01T02:02:19.042000+00:00",
        "attachments": null
    }
]