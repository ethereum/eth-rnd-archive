[
    {
        "author": "minaminao",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I have written a description of the EIP-1559 txpool for fast sorting. Please let me know if there are any unclear points :)\nhttps://hackmd.io/@VVsmryteTEWuiOBecRGFhw/Hy0ZyFn3w\n(https://ethereum-magicians.org/t/eip-1559-transaction-pool-for-fast-sorting/5051)",
        "created_at": "2020-12-20T10:00:50.639000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003c@!370136219927052298\u003e For the tree keys, you want first-seen-time as the secondary sort term, then `transaction_hash` as the final sort term.",
        "created_at": "2020-12-20T10:53:09.718000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Geth used to use `transaction_hash` as its secondary and this lead to some very bad behaviors as bots tried to back-run transactions (guarantee ordering immediately after a target transaction).",
        "created_at": "2020-12-20T10:53:43.089000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003c@!370136219927052298\u003e For the vector column, you have `Add a transaction` as an `O(1)` cost, but presumably when using a vector one is adding in sort order (not just to the end), which is not `O(1)`.",
        "created_at": "2020-12-20T11:17:29.842000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "That is, I don't think anyone uses a raw vector for transactions, it is *always* a sorted vector.",
        "created_at": "2020-12-20T11:18:05.731000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e `k` is small if the change of basefee is small.\nI believe this should be:\n\u003e `k` is small if the change of basefee results in few transactions becoming capped by `fee_cap`.\nWhether this true or not depends heavily on how much people are over-allocating to fee_cap.  One can imagine a world where the fee cap is quite low (e.g., 1 nanoeth) and people are regularly setting their `fee_cap` to 50 nanoeth.  In such a world even when the `basefee` moves the maximal distance per block, it still wouldn't cause a large number of transactions to jump pools.",
        "created_at": "2020-12-20T11:22:56.204000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "IIUC, this strategy essentially sacrifices memory in exchange for speed by keeping 3 separate indexes into the data?",
        "created_at": "2020-12-20T11:26:54.482000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Though, the memory costs may be inconsequential if your SBST data structure is reasonably efficient.",
        "created_at": "2020-12-20T11:27:25.421000+00:00",
        "attachments": null
    },
    {
        "author": "minaminao",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Thank you for the response!\n\u003e For the vector column, you have Add a transaction as an O(1) cost, but presumably when using a vector one is adding in sort order (not just to the end), which is not O(1).\nI don't know the implementation of Geth, but does it sort each time a transaction is added? I think that would be inefficient and it would be sorted in batch (for instance, when producing a block).",
        "created_at": "2020-12-20T11:28:01.936000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I have never looked, but I always imagined that the transactions were in a linked list and when one is added it was added in sort order.",
        "created_at": "2020-12-20T11:28:40.161000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Rather than re-sorting the whole thing every block.",
        "created_at": "2020-12-20T11:28:46.608000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It may be worth mentioning in this document dropping the least profitable transaction.  I believe that finding least profitable is effectively the same cost as finding the most profitable?",
        "created_at": "2020-12-20T11:29:42.280000+00:00",
        "attachments": null
    },
    {
        "author": "minaminao",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e I have never looked, but I always imagined that the transactions were in a linked list and when one is added it was added in sort order.\nIf we use a linked list, we can add and delete in O(log n) using a binary search, but if we use a vector, it is O(n).\n\n\u003e I believe that finding least profitable is effectively the same cost as finding the most profitable?\nYes! This can runs in O(log n).",
        "created_at": "2020-12-20T11:31:52.562000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "On a related topic, I do have to wonder if the simplest solution here is to target smaller mempools and just re-sort the whole thing after each run.  If your mempool is only 1000 items large, re-calculated the sort the index after every block may be sufficiently cheap that any additional complexity isn't worth it.",
        "created_at": "2020-12-20T11:33:30.856000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Perhaps there is a reason we want very large mempools though, in which case your proposal seems quite reasonable.",
        "created_at": "2020-12-20T11:34:00.859000+00:00",
        "attachments": null
    },
    {
        "author": "minaminao",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e IIUC, this strategy essentially sacrifices memory in exchange for speed by keeping 3 separate indexes into the data?\n\u003e Though, the memory costs may be inconsequential if your SBST data structure is reasonably efficient.\nThe space complexity is the same, but it is constant times less memory efficient.\nSince we have to prepare three SBSTs, we need to keep three times the transaction metadata (fee_cap, max_miner_brbe, hash, etc).",
        "created_at": "2020-12-20T11:35:54.975000+00:00",
        "attachments": null
    },
    {
        "author": "minaminao",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e On a related topic, I do have to wonder if the simplest solution here is to target smaller mempools and just re-sort the whole thing after each run.  If your mempool is only 1000 items large, re-calculated the sort the index after every block may be sufficiently cheap that any additional complexity isn't worth it.\nThat's right. I think that if there are only 1000 transactions, the vector implementation is fine. For at least 10,000 txs, we can see the speed advantage. I was told that the default value for the number of transactions held in Geth is 8192.",
        "created_at": "2020-12-20T11:39:48.527000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I question the reasonableness of the current Geth default.  ðŸ˜„  But that is a separate conversation.  ðŸ˜‰",
        "created_at": "2020-12-20T11:40:18.726000+00:00",
        "attachments": null
    },
    {
        "author": "minaminao",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003e If we use a linked list, we can add and delete in O(log n) using a binary search\nCorrection: A linked list cannot runs a binary search in O(log n). Addition and deletion in a linked list runs in O(n).",
        "created_at": "2020-12-20T12:01:41.515000+00:00",
        "attachments": null
    },
    {
        "author": "zulutu",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "this is probably a bad assumption to make, but assuming `(base_fee + tip) \u003c next_base_fee`, you could theoretically use a linked list of linked lists to significantly increase performance of all operations with little memory overhead",
        "created_at": "2020-12-20T19:46:43.062000+00:00",
        "attachments": null
    },
    {
        "author": "zulutu",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "since you could ignore all other transactions that don't have the same `base_fee`",
        "created_at": "2020-12-20T19:48:00.386000+00:00",
        "attachments": null
    },
    {
        "author": "zulutu",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "```\n^\n| base_fee 3 -\u003e tip1 -\u003e tip2 -\u003e tip3\n| base_fee 2 -\u003e tip1\n| base_fee 1 -\u003e tip1 -\u003e tip2 -\u003e tip3 -\u003e tip4 -\u003e tip5\n```",
        "created_at": "2020-12-20T19:56:20.267000+00:00",
        "attachments": null
    },
    {
        "author": "zulutu",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "now this goes completely out the window if `base_fee 2 + tip1 \u003e base_fee3`",
        "created_at": "2020-12-20T19:57:02.887000+00:00",
        "attachments": null
    },
    {
        "author": "zulutu",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "although it wouldn't be impossible to \"promote\" these transactions when a new `base fee` is generated ðŸ¤”",
        "created_at": "2020-12-20T20:17:18.488000+00:00",
        "attachments": null
    }
]