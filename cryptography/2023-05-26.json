[
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@301186049323958275\u003e Hi Micah! Following the Ledger black swan, I'm currently auditing some usual wallets signature schemes.\nTesting their message signature with this simple test:\n- private key = 1n,\n- message = \"hello\"\nYou provided me with some test code you wrote for this case: https://github.com/Zoltu/ethereum-crypto/blob/master/tests/source/index.ts#L403-L410\nIt is weird, because Metamask/Rabby/Frame/Geth all agree on a signature that is different than the one your test expects. And according to Etherscan, there is no \"\\x19Ethereum Signed Message:\\n32\" prefix in neither your signature, nor the wallet signatures, so the message hash is consistent I suppose (the k nonce is different?).\nI wrote a piece of code myself of ECDSA including RFC6979 in C++, and my code agrees with your signature...\nSo my question is: Is your test still valid and up-to-date with the latest canonical signature specification? Or have the common wallets moved away from RFC6979?",
        "created_at": "2023-05-26T09:37:20.514000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Most things will silently prepend the `\\x19Ethereum Signed Message:\\n...` stuff.",
        "created_at": "2023-05-26T09:39:17.937000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It makes me incredibly angry that they do.  If someone asks you to sign X, you either sign X or you say you cannot sign X.  You don't sign Y and then return the signature for Y to the request to sign X!",
        "created_at": "2023-05-26T09:39:49.067000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The test you linked does exactly what it says it does, which is signs the `messageHash`.  It does not mutate/alter the `messageHash` in any way before signing it.",
        "created_at": "2023-05-26T09:40:19.940000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In fact, `secp256k1.sign` will *only* sign integers, and they may even need to be less than 2**256 (not sure about this).",
        "created_at": "2023-05-26T09:41:38.740000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For that library in particular, you probably want to hash before signing if you want to match higher level library output.",
        "created_at": "2023-05-26T09:42:02.886000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(and again, many libraries will hash something other than you ask them to)",
        "created_at": "2023-05-26T09:42:10.933000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Well I thought it was this prefix thing too. But the signatures I get from MM/Rabby/Frame/Geth seem to NOT include the prefix; it would be otherwise detected by the etherscan tool I use for verification, which displays \"Message Signature Verified (with Geth Prefix).\" in such a case.",
        "created_at": "2023-05-26T09:43:59.067000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The process I follow is to import a private key = 1n in every wallet, and then go to the etherscan tool (https://etherscan.io/verifiedSignatures#) to sign \"hello\". Etherscan verifies successfully each of them, but never displays \" (with Geth Prefix)\" when it verifies them.",
        "created_at": "2023-05-26T09:47:13.431000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "EtherScan *used* to always add the prefix to every message it verified.",
        "created_at": "2023-05-26T09:48:03.455000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Still, I can clearly identify on etherscan 2 different behaviours during signature verification:\n- \"Message Signature Verified.\",\n- \"Message Signature Verified (with Geth Prefix).\"",
        "created_at": "2023-05-26T09:49:32.897000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "With the prefix, this is the output I get from Etherscan verification:",
        "created_at": "2023-05-26T09:50:01.040000+00:00",
        "attachments": [
            {
                "type": "image/png",
                "origin_name": "image.png",
                "content": "50a44b9e8f76974edf8522b0aff785e82be64124407521892526f8c64289733a"
            }
        ]
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The message is just \"hello\", not \"Hello World!\"",
        "created_at": "2023-05-26T09:50:28.347000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is not.  This is what I was talking about how the whole ecosystem is insane.",
        "created_at": "2023-05-26T09:50:45.900000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What was *actually* signed is not `Hello World!`.  Instead, what was actually signed was:\n```\n\\x19Ethereum Signed Message:\\n12Hello World!`\n```",
        "created_at": "2023-05-26T09:51:34.104000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```json\n{\n        \"address\": \"0x7E5F4552091A69125d5DfCb7b8C2659029395Bdf\",\n        \"msg\": \"hello\",\n        \"actualMsg\": \"\\x19Ethereum Signed Message:\\n5hello\",\n        \"sig\": \"0xe5ddc160e4c8f92de507c7db9b982d4f9b7197bfa421864aeadc586bc96b09ae0ba0c5b131650ae4994cff1839341d00f3735ef5abc62ac8fe2cf50f65208e2a1b\",\n        \"version\": \"2\"\n}\n```",
        "created_at": "2023-05-26T09:52:48.700000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Really? I thought it was ``keccak256(\\x19Ethereum Signed Message:\\n32\u003ckeccak256(Hello World!)\u003e)`",
        "created_at": "2023-05-26T09:54:16.062000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The code I wrote a while back says no.  ðŸ˜„",
        "created_at": "2023-05-26T09:54:38.761000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And that code verifies in Etherscan correctly.",
        "created_at": "2023-05-26T09:54:47.575000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok, let me try that in my C++ implementation...",
        "created_at": "2023-05-26T09:56:38.903000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Now we agree...ðŸ™‚",
        "created_at": "2023-05-26T09:58:12.630000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So there is never ``\\n32`` in the prefix. In fact, it is ``\\n\u003csize of the unhashed message\u003e\u003cunhashed message\u003e``if I understand properly...",
        "created_at": "2023-05-26T09:59:57.374000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Still if you sign ``keccak256(\\x19Ethereum Signed Message:\\n32\u003ckeccak256(message)\u003e))``, etherscan will validate your signature and display \"Message Signature Verified (with Geth Prefix).\"",
        "created_at": "2023-05-26T10:01:44.046000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm not familiar with this format.",
        "created_at": "2023-05-26T10:02:04.122000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I wouldn't be surprised if it exists though.",
        "created_at": "2023-05-26T10:02:09.226000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok, I was confused and thought it was the canonical way of prefixing. I was encouraged by etherscan verifying properly this format with the extra \"(with Geth Prefix).\" comment...",
        "created_at": "2023-05-26T10:04:19.712000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Is there an EIP specifying the correct way of prefixing (\"\\x19Ethereum Signed Message:\\n5hello\")?",
        "created_at": "2023-05-26T10:05:20.468000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "~~I don't think so.~~ Not that I know of, but maybe.",
        "created_at": "2023-05-26T10:06:01.054000+00:00",
        "attachments": null
    },
    {
        "author": "arxis75",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "OK, I will simply take this \"\\x19Ethereum Signed Message:\\n5hello\" format for granted. Thank you so much for your kind help, once again! ðŸ™‚",
        "created_at": "2023-05-26T10:08:31.106000+00:00",
        "attachments": null
    }
]