[
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@425274498732916736\u003e re. your tweet: thanks! it'll be \n```\nHAVE_OPENSSL=1 make bench\n./src/bench\n````\nNot sure even if it will compile, your CC has to be GCC though",
        "created_at": "2023-05-11T14:44:22.442000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But what project is this ðŸ˜“ ?",
        "created_at": "2023-05-11T14:45:16.969000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's this pull request https://github.com/prysmaticlabs/hashtree/pull/8",
        "created_at": "2023-05-11T14:45:50.166000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if you have an ARMv8 with crypto extensions I'm hoping that it doesn't go so bad against openssl",
        "created_at": "2023-05-11T14:46:19.429000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@449019668296892420\u003e \u003c@784446040073175040\u003e ran tests on his rock machine, using the sha instructions, which are not vectorized, the library still beats OpenSSL considerably because of the hardcoded padding block\n```\nrock@proteus:~/hashtree$ HAVE_OPENSSL=1 make  bench\nmake -C src bench\nmake[1]: Entering directory '/home/rock/hashtree/src'\ncc -g -fpic   -c -o sha256_armv8_neon_x4.o sha256_armv8_neon_x4.S\ncc -g -fpic   -c -o sha256_armv8_neon_x1.o sha256_armv8_neon_x1.S\ncc -g -fpic   -c -o sha256_armv8_crypto.o sha256_armv8_crypto.S\nar rcs libhashtree.a sha256_armv8_neon_x4.o sha256_armv8_neon_x1.o sha256_armv8_crypto.o \ncc -g -Wall -Werror -DHAVE_OPENSSL -L . -o bench bench.c -lhashtree -lm -lcrypto\nmake[1]: Leaving directory '/home/rock/hashtree/src'\nrock@proteus:~/hashtree$ src/bench\n[==========] Running 5 benchmarks.\n[ RUN      ] armv8.neon_x1_one_at_time\n[       OK ] armv8.neon_x1_one_at_time (mean 38.769ms, confidence interval +- 0.008991%)\n[ RUN      ] armv8.neon_x1\n[       OK ] armv8.neon_x1 (mean 38.197ms, confidence interval +- 0.016511%)\n[ RUN      ] armv8.neon_x4\n[       OK ] armv8.neon_x4 (mean 24.244ms, confidence interval +- 0.009266%)\n[ RUN      ] armv8.crypto\n[       OK ] armv8.crypto (mean 6.049ms, confidence interval +- 0.011850%)\n[ RUN      ] openssl.openssl_one_at_time\n[       OK ] openssl.openssl_one_at_time (mean 10.020ms, confidence interval +- 0.521858%)\n[==========] 5 benchmarks ran.\n[  PASSED  ] 5 benchmarks.\n```",
        "created_at": "2023-05-11T18:04:35.744000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have been summoned",
        "created_at": "2023-05-11T18:04:58.644000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Resident ARMbassador reporting for duty",
        "created_at": "2023-05-11T18:05:23.701000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So using Neon looses over native SHA2 instructions, but using native SHA2 vs native SHA2 it's still almost 65% faster than openssl",
        "created_at": "2023-05-11T18:06:01.879000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "it's considerable",
        "created_at": "2023-05-11T18:06:04.609000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How does OpenSSL implement this?",
        "created_at": "2023-05-11T18:06:50.286000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I haven't read that assembly, I presume it's pretty similar to mine, probably better than my pipelining as they are the experts. But hardcoding the padding block is a bit",
        "created_at": "2023-05-11T18:09:04.271000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If it's their usual style, it's Perl-as-macro-assembler",
        "created_at": "2023-05-11T18:09:34.517000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh lord",
        "created_at": "2023-05-11T18:09:44.389000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah that's always the case",
        "created_at": "2023-05-11T18:09:45.127000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So nontrivial to sort of directly read out any one architecture",
        "created_at": "2023-05-11T18:09:46.304000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "this is always the case, the difference here are twice: to run with open ssl you need to loop in C hashing chunks at the time, so there's a loop with lots of calls per chunk",
        "created_at": "2023-05-11T18:10:37.909000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "to implement using hashtree you just send each level of the tree to the library, so there's log(n) calls vs n calls",
        "created_at": "2023-05-11T18:11:03.371000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "on top of that there's the hardcoded padding block",
        "created_at": "2023-05-11T18:11:19.526000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "those are the only differences here, if someone cares to read openssl assembly and port it to hashtree I'm more than happy to take a PR, but with these results I'm already quite happy",
        "created_at": "2023-05-11T18:11:54.308000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "my first thought was actually to patch openssl (blst really) with the padding trick and call it a day - the block batching part requires much more surgery in our codebase to take advantage - but then I saw perl...",
        "created_at": "2023-05-11T18:13:16.615000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm all for boosting `arm` performance in BLST but I don't have the cycles to run openssl through IDA right now",
        "created_at": "2023-05-11T18:14:06.333000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So the biggest difference comes from that change, that's orders of magnitude gain vs just 20-50%",
        "created_at": "2023-05-11T18:18:19.598000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we did that change and it was a game changer, but still screwed up and are using `[][32]byte` instead of simply `[]byte` as the Erigon guys are doing",
        "created_at": "2023-05-11T18:18:46.125000+00:00",
        "attachments": null
    },
    {
        "author": "sauliusgrigaitis",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Regarding this blst adx issue, did anyone try to load two instances of blst (one that uses adx and another one that doesn't use it), then at runtime check does the cpu support adx, and then accordingly use the right instance of blst. Is it how nimbus does it? Any issues with this approach?",
        "created_at": "2023-05-11T18:34:55.160000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Nimbus,  unfortunately, does nothing interesting right now in this regard. We just added some support for an optimized flavor, but won't necessarily deploy it, because it comes with the usual `SIGILL` deployment risks",
        "created_at": "2023-05-11T18:36:53.492000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Trying to  load two instances of BLST is definitely an option, though one we've avoided in general if it relies on two separate split loadable libraries (`.dll`/`.so`) to retain the single-binary aspect, for now.",
        "created_at": "2023-05-11T18:38:08.784000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "teku does this by compiling to dll and dynamically choosing which to load at runtime",
        "created_at": "2023-05-11T18:38:14.111000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "batching or padding is \"orders of magnitude\"?",
        "created_at": "2023-05-11T18:39:02.354000+00:00",
        "attachments": null
    },
    {
        "author": "sauliusgrigaitis",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I see, so this is actually better than loading two instances and then choosing at runtime which to call.",
        "created_at": "2023-05-11T18:40:22.223000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "there's no difference really - runtime selection is effectively done by an indirect call in both cases",
        "created_at": "2023-05-11T18:41:16.954000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "or rather, if you like to distribute single binaries, there's a practical difference for your users that now have to deal with multiple files",
        "created_at": "2023-05-11T18:41:57.559000+00:00",
        "attachments": null
    },
    {
        "author": "sauliusgrigaitis",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "well, in this two instances approach actually two instances are loaded in memory. Teku approach seems only need one instance actually loaded",
        "created_at": "2023-05-11T18:42:18.893000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So the bench on your RPI that shows Neon being x4 faster on trees than openssl (or on AVX512 this is about 12 times faster than the usual approach) this is mostly because of the vectorization and has very little to do with the padding. So you have the most to gain by moving to using arrays and exploiting the signature of the library. However a disclaimer: this library is doomed in that most CPUs are starting to implement SHA natively, in which case vectorization is null and we only gain the padding block. On the other hand, on very large trees (think validator registry) vectorization beats native sha, that is, AVX512 is faster than SHAni on new intels. So if there's something like AVX1024 (coming soon) that will be way faster than native sha instructions, hashing 32 blocks at a time. Having vectorized versions of sha opcodes would be awesome though",
        "created_at": "2023-05-11T18:43:13.541000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but neon x1 was also faster, 3x vs openssl?",
        "created_at": "2023-05-11T18:44:51.184000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "63 vs 46 vs 160 - I mean, I'll take 63  for free without any refactoring any day ðŸ™‚",
        "created_at": "2023-05-11T18:46:21.868000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yeah, I never understood this, there was a comment of dot-asm somewhere that vectorizing ARM for scheduling was not worth it. But that  neon x1 the only vectorization it does is in scheduling 4 words at the time. I do not know why is it so much faster than the openssl version. Perhaps I screwed up in the benches ðŸ˜…",
        "created_at": "2023-05-11T18:48:28.748000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Anyway all the arm pipelining I think it's mostly mine, again, even running 1 block at a time the fact that you don't call the function in loops is already a big difference",
        "created_at": "2023-05-11T18:49:16.682000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "these algos are like a few kb of code - it's not like you'll notice their presence in memory really",
        "created_at": "2023-05-11T18:50:42.272000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but really - if dll:s are fine in your client, go for it!",
        "created_at": "2023-05-11T18:51:47.522000+00:00",
        "attachments": null
    },
    {
        "author": "sauliusgrigaitis",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yea, should not be much, but just looks not clean ðŸ™‚",
        "created_at": "2023-05-11T18:52:11.540000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "was looking for more information on this AVX-1024, and from e.g., https://dreampc.com.au/2022/09/05/intel-emerald-rapids-5th-gen-xeon-cpu-family-specs-leaked-up-to-64-cores-ddr5-5600-80-gen-5-0-lanes-125-350w-skus/ and some others it seems to be still basically Granite Rapids rumors which might appear in a couple of years?",
        "created_at": "2023-05-11T18:52:23.965000+00:00",
        "attachments": null
    },
    {
        "author": "sauliusgrigaitis",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "dlls actually feels tricky in terms of cross-platform support. Pretty sure it comes with some hassle.",
        "created_at": "2023-05-11T18:53:40.946000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@784446040073175040\u003e perhaps you know, how do I **disable** crypto extensions from `quemu-aarch64` on Arch linux (running in user mode)?",
        "created_at": "2023-05-11T19:11:16.911000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I want to test runtime CPU detection but the damned thing always supports them",
        "created_at": "2023-05-11T19:11:39.274000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I should get offchainlabs to buy me an Apple ðŸ˜„",
        "created_at": "2023-05-11T19:11:59.611000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm gonna level with you, if I want to test arm stuff these days I don't bother with qemu - I just do it on hardware now",
        "created_at": "2023-05-11T19:17:58.070000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't know how you'd tell it to ignore certain extensions unfortunately",
        "created_at": "2023-05-11T19:18:18.074000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't have that luxury ðŸ™‚ and I need to test constantly these libraries",
        "created_at": "2023-05-11T19:18:22.775000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Do you want an arm box",
        "created_at": "2023-05-11T19:18:32.277000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@755590043632140352\u003e \n```\n[ RUN      ] armv8.neon_x1_one_at_time\n[       OK ] armv8.neon_x1_one_at_time (mean 39.511ms, confidence interval +- 0.030296%)\n[ RUN      ] armv8.neon_x1\n[       OK ] armv8.neon_x1 (mean 39.221ms, confidence interval +- 0.056897%)\n[ RUN      ] armv8.neon_x4\n[       OK ] armv8.neon_x4 (mean 25.029ms, confidence interval +- 0.070985%)\n[ RUN      ] armv8.crypto\n[       OK ] armv8.crypto (mean 6.131ms, confidence interval +- 0.033526%)\n[ RUN      ] openssl.openssl_one_at_time\n[       OK ] openssl.openssl_one_at_time (mean 10.135ms, confidence interval +- 0.196459%)\n```",
        "created_at": "2023-05-11T19:18:52.057000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "nice! thanks \u003c@425274498732916736\u003e that's in line with Joe's bench",
        "created_at": "2023-05-11T19:19:55.364000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thanks Joe, I can ask the people at prysm, but now that I have qemu working was hoping it's something like -cpu cortex-a35,pmu=off or similar",
        "created_at": "2023-05-11T19:20:48.125000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok, I can't help there unfortunately but happy to help you test stuff at least",
        "created_at": "2023-05-11T19:21:25.011000+00:00",
        "attachments": null
    },
    {
        "author": "jcrtp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ping me when you need me",
        "created_at": "2023-05-11T19:24:33.387000+00:00",
        "attachments": null
    },
    {
        "author": "chfast",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Can't you setup SSH access?",
        "created_at": "2023-05-11T19:25:13.681000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "on an ARM box? yeah I suppose I can",
        "created_at": "2023-05-11T19:27:05.776000+00:00",
        "attachments": null
    }
]