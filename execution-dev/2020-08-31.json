[
    {
        "author": "s1na",
        "category": "general",
        "parent": "",
        "content": "Hey everyone, \u003c@!425279588009246720\u003e and I just pushed a rough spec on the fixed-size code merkleization approach here: https://github.com/ewasm/EIPs/blob/code-merkleization/EIPS/eip-2926.md\nWe'd appreciate feedback and are happy to answer questions either here or in the discussion thread: https://ethereum-magicians.org/t/eip-2926-chunk-based-code-merkleization/4555",
        "created_at": "2020-08-31T17:43:14.530000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e \u003e assign (PC + N + 1) - nextChunk.startOffset to nextChunk.firstInstructionOffset.",
        "created_at": "2020-08-31T22:28:22.699000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e This seems to not specify how nextChunk.startOffset is set",
        "created_at": "2020-08-31T22:28:32.866000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e I know it can be figured out from the other variables but still a dangling variable which is not too clean",
        "created_at": "2020-08-31T22:28:49.302000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e \u003e To build a Merkle Patricia Tree we iterate chunks and process each entry, C, as follows:",
        "created_at": "2020-08-31T22:28:58.811000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Why an MPT? Why not a plain binary tree?",
        "created_at": "2020-08-31T22:29:04.095000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e (MPTs are soo soo complicated; I really prefer avoiding them if we can ðŸ˜¢)",
        "created_at": "2020-08-31T22:29:35.577000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e \u003e Contract creation cost",
        "created_at": "2020-08-31T22:30:57.447000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Personally this feels to me to be not worth the cost",
        "created_at": "2020-08-31T22:31:03.764000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e A lot of complexity just for a 6% gas cost increase; better just leave it unchanged saying \"hashing costs are negligible\"",
        "created_at": "2020-08-31T22:31:26.962000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "I think that is an oversight in the spec section calling it \"MPT\". Later it is explained we rely on the \"binary tree\" introduced by 2958.",
        "created_at": "2020-08-31T22:31:29.872000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Is it a binary MPT or a binary regular tree though?",
        "created_at": "2020-08-31T22:31:43.504000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "To be honest we skipped discussing the trie question, and focused on finding what else needs to be discussed around changing code, hence all these sections about costs and accounts.",
        "created_at": "2020-08-31T22:32:22.167000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Yep that's fair!",
        "created_at": "2020-08-31T22:32:31.305000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Everything else looks good!",
        "created_at": "2020-08-31T22:32:48.147000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "Also today we figured out a potentially much simpler alternate structure (see \"index-based alternative\" in the rationale), but decided to publish this as-is and follow up with that later.",
        "created_at": "2020-08-31T22:33:36.684000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Yep, saw that! Definitely support this (re @eth1x_bridge_bot: \u003cAlex (axic)\u003e Also today we figured out a potentially much simpler alternate structure (see \"index-based alternative\" in the rationale), but decided to publish this as-is and follow up with that later.)",
        "created_at": "2020-08-31T22:34:02.545000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Though as I said I think saying \"no gas changes because hashing costs are negligible\" is cleanest; that's probably the only thing I'd do differently",
        "created_at": "2020-08-31T22:34:14.801000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e I also really like putting metadata into a separate object; makes it cleaner to extend over time",
        "created_at": "2020-08-31T22:34:29.975000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "\u003e \u003cvbuterin\u003e A lot of complexity just for a 6% gas cost increase; better just leave it unchanged saying \"hashing costs are negligible\"\n\nRight, that gas rule is rather complex and mostly based on what we think would happen. Do note that 6% increase is based on some \"hunch\" on what each of those components would cost. This hunch is based on what other, benchmarked, components in the system cost, like hashing precompiles. \n\nThis means that unless someone actually benchmarks this we cannot say for sure whether it is 6%, less, more, linear, or not.",
        "created_at": "2020-08-31T22:36:38.481000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Well we can tell from simple theoretical reasoning that tree construction is linear and is ~1 two-chunk-sized hash per chunk",
        "created_at": "2020-08-31T22:37:37.227000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "That is roughly what we have there ðŸ™‚",
        "created_at": "2020-08-31T22:38:36.199000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "Personally I am in favour of having \"nice\" equations, but I can understand the position to have some fixed cost per chunk instead.",
        "created_at": "2020-08-31T22:39:18.200000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e The thing is that there's like 12 EIPs coming out, so it's important for each of them to try to be \"just parameter changes\" as much as possible ðŸ˜ƒ",
        "created_at": "2020-08-31T22:40:03.523000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e And code merklization by default is actually really simple; it just replaces code hashing with another pure function (that you can probably write a 20-line python impl of)",
        "created_at": "2020-08-31T22:40:41.893000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e Even the gas cost of hashing itself is not a \"nice equation\"; given how merkle-damgard and sponge work it \"should\" be chunk-based but we just charge per byte ðŸ˜‚",
        "created_at": "2020-08-31T22:41:50.779000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "\u003e \u003cvbuterin\u003e This seems to not specify how nextChunk.startOffset is set\n\nThat is mentioned in the intro section: \n\u003e Note that startOffset corresponds to the absolute program counter, and firstInstructionOffset is the offset within the chunk to the first instruction, as opposed to data.",
        "created_at": "2020-08-31T22:42:07.876000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e right I see",
        "created_at": "2020-08-31T22:42:27.171000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e adding the 20-line python impl into the EIP would probably make it super-clean",
        "created_at": "2020-08-31T22:42:43.300000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "ðŸ˜†",
        "created_at": "2020-08-31T22:43:18.439000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "The truth is, it was a typescript snippet, translated into text, and the snipped moved into the implementation section. We knew Python is what many people prefer, but we're not really good with Python. If anyone wants to draft up a short python-esque pseudo code, please do!\n\n\u003c@!425343240212971521\u003e did write a complete Python version linked in the implementation section: https://github.com/hugo-dc/code-chunks/blob/master/main.py",
        "created_at": "2020-08-31T22:44:40.396000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "\u003e \u003cvbuterin\u003e Even the gas cost of hashing itself is not a \"nice equation\"; given how merkle-damgard and sponge work it \"should\" be chunk-based but we just charge per byte ðŸ˜‚\n\nActually we charge per word (32-bytes), while keccak-256 sponge is larger than that",
        "created_at": "2020-08-31T22:49:58.089000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "Thanks for the feedback! It is late here, will respond to anything else in the morning",
        "created_at": "2020-08-31T22:50:15.531000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e def generate_code_root(program):\n    return treefy(chunkify(program), len(program))\ndef chunkify(program):\n    chunks = []\n    pos = 0\n    this_chunk_start = 0\n    this_chunk_code_start = 0\n    while pos \u003c len(program):\n        pos += (program[pos] - 0x5f) if (0x60 \u003c= program[pos] \u003c= 0x7f) else 1\n        if pos \u003e= this_chunk_start + 32:\n            chunks.append(hash(program[this_chunk_start: this_chunk_start+32] + this_chunk_code_start.to_bytes(32, 'big')))\n            this_chunk_start += 32\n            this_chunk_code_start = pos\n    return chunks\ndef next_power_of_2(x):\n    return x if x \u003c= 2 else next_power_of_2((x +1) // 2) * 2\ndef treefy(chunks, length):\n    padded_length = next_power_of_2(len(chunks))\n    tree = [None] * padded_length + chunks + [b'\\x00'*32] * (padded_length - len(chunks))\n    for i in range(padded_length-1, 0, -1):\n        tree[i] = hash(tree[i*2] + tree[i*2+1])\n    metadata = length.to_bytes(32, 'big')\n    return hash(tree[1] + metadata)",
        "created_at": "2020-08-31T22:50:42.059000+00:00",
        "attachments": null
    },
    {
        "author": "eth2_gitter_bot",
        "category": "general",
        "parent": "",
        "content": "\u003cvbuterin\u003e There's a draft, I coded it in this chat so zero testing and I'm sure there's a bug and it doesn't follow the spec faithfully",
        "created_at": "2020-08-31T22:51:06.845000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "ðŸ‘€",
        "created_at": "2020-08-31T22:52:45.065000+00:00",
        "attachments": null
    },
    {
        "author": "axic3354",
        "category": "general",
        "parent": "",
        "content": "That's awesome! Will chew on this in the morning ðŸ™‚",
        "created_at": "2020-08-31T22:53:50.720000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "general",
        "parent": "",
        "content": "This code uses a nice trick for complete binary trees. If you store the nodes as an array in breadth-first order, then the node at index `i` has children at indices `2i` and `2i+1`. (Irrelevant for this discussion, but more fun facts: the node at index `i` has parent at index `floor(i/2)` , and these formulas are a special case of more general formulas for complete k-ary trees, where integer k\u003e2.)",
        "created_at": "2020-08-31T23:34:38.365000+00:00",
        "attachments": null
    },
    {
        "author": "pauld.9606",
        "category": "general",
        "parent": "",
        "content": "Complete binary trees have a maximum number of nodes at every depth, except maybe the bottommost depth where only the rightmost nodes are absent. Like this.\n```\n       x\n     /   \\\n    /     \\\n   x       x\n  / \\     / \\\n x   x   x   x\n/ \\  |\nx x  x\n```",
        "created_at": "2020-08-31T23:41:07.164000+00:00",
        "attachments": null
    }
]