[
    {
        "author": "abcoathup",
        "category": "general",
        "parent": "",
        "content": "This server is for discussion of core Ethereum R\u0026D.  You could try CryptoDevs discord: https://discord.gg/5W5tVb3",
        "created_at": "2022-08-29T01:10:07.765000+00:00",
        "attachments": []
    },
    {
        "author": "cheerful_piglet_95568",
        "category": "general",
        "parent": "",
        "content": "Hi team, we are trying to sync an archival node in preparation for the merge but we the sync rate has dropped to almost nothing and we keep seeing these messages in the log.\n\nWARN [08-29|10:37:02.662] Database compacting, degraded performance database=/data/goethereum/geth/chaindata\n\nAny idea what can be done ? Seems like there is enough space on the disk. At this rate we are concerned we may not be able to catch up.",
        "created_at": "2022-08-29T10:39:24.550000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "Which version do you run? We had to downgrade our leveldb dependency at some point because it kept running compactions",
        "created_at": "2022-08-29T10:41:06.746000+00:00",
        "attachments": []
    },
    {
        "author": "cheerful_piglet_95568",
        "category": "general",
        "parent": "",
        "content": "We are running geth v1.10.23 and lighthouse v3.0",
        "created_at": "2022-08-29T10:42:57.014000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "Hmm that should be fine. It might just be the way it is. Leveldb does a huge amount of compactions and with an archive node it is even worse",
        "created_at": "2022-08-29T10:45:53.003000+00:00",
        "attachments": []
    },
    {
        "author": "cheerful_piglet_95568",
        "category": "general",
        "parent": "",
        "content": "thanks. We will try to restart geth and see if help us move forward because it seem to be really stuck there for a few days. We are also creating a dev version of archival and that doesnt seem to be seeing the compacting issue. What would you say is a reasonable time it would take to sync an archival-node from scratch?",
        "created_at": "2022-08-29T10:51:00.107000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "3-4 weeks I think",
        "created_at": "2022-08-29T10:51:49.913000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "We are currently working on replacing leveldb with pebble",
        "created_at": "2022-08-29T10:52:06.697000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "If you are feeling adventurous you could try that",
        "created_at": "2022-08-29T10:52:33.545000+00:00",
        "attachments": []
    },
    {
        "author": "cheerful_piglet_95568",
        "category": "general",
        "parent": "",
        "content": "Are there any options other than syncing from scratch to get an archival node stood up like using a snapshot etc? Can you also pls share how you downgraded the leveldb dependency to work around the compaction?",
        "created_at": "2022-08-29T10:54:30.266000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "This is already in v1.10.23, the pr is here: https://github.com/ethereum/go-ethereum/pull/25413",
        "created_at": "2022-08-29T10:56:27.876000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "Nope, no other options unfortunately. Erigon has a way to sync an archive node via bittorrent afaik",
        "created_at": "2022-08-29T10:57:34.793000+00:00",
        "attachments": []
    },
    {
        "author": "lukaszrozmej",
        "category": "general",
        "parent": "",
        "content": "have you considered MDBX?",
        "created_at": "2022-08-29T12:07:20.908000+00:00",
        "attachments": []
    },
    {
        "author": "mariusvanderwijden",
        "category": "general",
        "parent": "",
        "content": "I don't know, we might have considered it. We want something in pure go though, since the go - c bridge is always a bit slow",
        "created_at": "2022-08-29T12:18:45.545000+00:00",
        "attachments": []
    },
    {
        "author": "treyzania",
        "category": "general",
        "parent": "",
        "content": "Which fs are you on?",
        "created_at": "2022-08-29T15:01:36.508000+00:00",
        "attachments": []
    },
    {
        "author": "cheerful_piglet_95568",
        "category": "general",
        "parent": "",
        "content": "We are using btrfs. The disk stats all look good. There does not seem to be an issue with IO throughput.",
        "created_at": "2022-08-29T21:37:03.170000+00:00",
        "attachments": []
    },
    {
        "author": "treyzania",
        "category": "general",
        "parent": "",
        "content": "I had *serious* slowdowns using geth on btrfs before",
        "created_at": "2022-08-29T21:41:53.736000+00:00",
        "attachments": []
    },
    {
        "author": "treyzania",
        "category": "general",
        "parent": "",
        "content": "switched back to ext4, not sure if there's a way to tune btrfs not to have the issues it did",
        "created_at": "2022-08-29T21:42:56.759000+00:00",
        "attachments": []
    },
    {
        "author": "yokem55",
        "category": "general",
        "parent": "",
        "content": "Btrfs is known to heavily fragment under db-ish loads. This can be mitigated by setting the db contents to nocow, but a lot of the benefits of using btrfs go away if you do that...",
        "created_at": "2022-08-29T21:53:10.485000+00:00",
        "attachments": []
    },
    {
        "author": "treyzania",
        "category": "general",
        "parent": "",
        "content": "I'm also compacting my db on ext4 right now as well and it's also taking close to 7 hours\n```\nINFO [08-29|21:33:12.429] Compacting database                      range=0xb0-0xc0 elapsed=5h46m30.984s\nINFO [08-29|21:53:35.151] Compacting database                      range=0xc0-0xd0 elapsed=6h6m53.705s\n```\nso btrfs would be way worse",
        "created_at": "2022-08-29T22:09:48.855000+00:00",
        "attachments": []
    }
]