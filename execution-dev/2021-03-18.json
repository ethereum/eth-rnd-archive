[
    {
        "author": "phabc",
        "category": "general",
        "parent": "",
        "content": "Currently, we can pretty much only estimate gas usage of a tx by doing binary search (because of refunds and EIP-114 ðŸ˜­ ). Is there any better way? Or could we discuss adding a monotonically increasing gas counter that such that simulating a tx gives us the exact gas used ignoring refunds and all shennanigans?",
        "created_at": "2021-03-18T18:34:03.296000+00:00",
        "attachments": []
    },
    {
        "author": "phabc",
        "category": "general",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e you would know ðŸ˜„",
        "created_at": "2021-03-18T18:34:11.694000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "No better way that I know of.  One can imagine a hypothetical contract that is just one giant switch on gas remaining, or a contract that loops until out of gas (but still completes).  In both cases, there is no way to correctly estamite gas usage.",
        "created_at": "2021-03-18T18:51:32.446000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "So the problem is currently impossible to solve in all cases.",
        "created_at": "2021-03-18T18:51:48.426000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "In simple cases though, just run the transaction with 12.5M gas and see how much it used.",
        "created_at": "2021-03-18T18:52:23.925000+00:00",
        "attachments": []
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Trouble with that is that it reports the gas used *after* the refund has been applied, so is not a lot of use if the requirement is to know how much gas to send with a transaction.",
        "created_at": "2021-03-18T18:57:02.944000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "`eth_estibateGas` (which I assumed we were talking about implementations for) reports total gas consumed, before refunds.",
        "created_at": "2021-03-18T18:59:55.685000+00:00",
        "attachments": []
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Ah okay, that's better then. (I haven't looked at it for too long, should probably stop spouting out-of-date info)",
        "created_at": "2021-03-18T19:06:43.195000+00:00",
        "attachments": []
    },
    {
        "author": "phabc",
        "category": "general",
        "parent": "",
        "content": "Are you sure about that? Would like to see where this is described",
        "created_at": "2021-03-18T19:07:07.248000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "The fact that you can `eth_estimateGas` and have your transaction not fail when you clear state is idence enough for me.  ðŸ˜„",
        "created_at": "2021-03-18T19:22:32.825000+00:00",
        "attachments": []
    },
    {
        "author": "phabc",
        "category": "general",
        "parent": "",
        "content": "But that's because estimageGas does a binary search and returns a gasLimit that makes the tx succeed, no?",
        "created_at": "2021-03-18T20:26:23.244000+00:00",
        "attachments": []
    },
    {
        "author": "phabc",
        "category": "general",
        "parent": "",
        "content": "It's also why it returns an absurd high gas limit if tx will fail, because binary-search can't find a gas limit that makes the tx pass so it goes to the edges",
        "created_at": "2021-03-18T20:26:55.350000+00:00",
        "attachments": []
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "Yeah I think there is some confusion between `estimateGas` and just dry-running a transaction with the block limit gas.\n\nIn the former case it does a binary search of the block's gas space and returns the lowest value it finds that succeeds.  So this does indeed give a value you can give to the transaction as a gas limit and assuming state doesn't change the TX should succeed.\n\nBut if you did a dry-run of a transaction with the block limit gas it will return the actual amount of gas used _after_ refund, which you cannot give to the transaction as the gas limit and expect it to succeed if there is any refund involved.\n\n(This is the reason that `estimateGas` exists at all, rather than the apparently simpler method of doing a single dry run.)",
        "created_at": "2021-03-18T21:13:13.879000+00:00",
        "attachments": []
    },
    {
        "author": "jgm",
        "category": "general",
        "parent": "",
        "content": "(It's possible that there is a dry run that gives a proper breakdown of gas used, both before and after the refund; I was talking about this a few years ago but at the time it didn't go anywhere.)",
        "created_at": "2021-03-18T21:14:32.057000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "general",
        "parent": "",
        "content": "It shouldn't be hard for a client to run a transaction with refunds disabled to get the gas required (certainly seems easier than implementing the binary search approach).  You can't do that via the JSON-RPI API today of course, I'm thinking of a client directly implementing estimateGas.  Would be interesting to know if the binary search is purely to deal with refunds or also potentially to deal with contracts that make decisions based on available gas or delegating some percentage of gas to calls etc.",
        "created_at": "2021-03-18T21:27:18.264000+00:00",
        "attachments": []
    }
]