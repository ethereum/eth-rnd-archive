[
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Hello, apologies for a massive ping but I'm dealing with some old code we have and I want to know if I can simplify it a lot. When the engine catches up and returns INVALID, it needs to return a LastValidHash value. Do all engines return a hash that is an ancestor of the passed payload? it used to be the case where Erigon did not do this, and this forced us to deal with a weird edge case, but I think this is no longer the case, is this right \u003c@687974325072035882\u003e ?\nPinging one from each of the others, apologies again, but this becomes a real nightmare on ePBS and would like to remove this extra case. \u003c@758579010027782144\u003e \u003c@827653956955406406\u003e \u003c@360491619402776577\u003e \u003c@122421399213047814\u003e \u003c@792822129019584562\u003e",
        "created_at": "2024-10-08T14:57:37.170000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "general",
        "parent": "",
        "content": "CC \u003c@976542403269910539\u003e . I think it is no longer the case",
        "created_at": "2024-10-08T15:00:12.425000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "so you only expect it to be the ancestor right?",
        "created_at": "2024-10-08T15:03:29.674000+00:00",
        "attachments": null
    },
    {
        "author": "rjected",
        "category": "general",
        "parent": "",
        "content": "\u003e Do all engines return a hash that is an ancestor of the passed payload\nhttps://github.com/paradigmxyz/reth/blob/e18b0bab90e17930c9a9a8413cb1b8b4b9839600/crates/consensus/beacon/src/engine/mod.rs#L735-L748\n\nAFAIK returning an ancestor is to spec",
        "created_at": "2024-10-08T15:04:16.173000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "ethereumjs looks up to: `engineParentLookupMaxDepth` (128) and give the hash else null because invalid could be for many reasons (for e.g. child of an invalid branch)",
        "created_at": "2024-10-08T15:05:53.805000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "yes, that's why I have this specific comment in code:\n```\n-       // Deal with the case that the last valid payload is in a different fork\n-       // This means we are dealing with an EE that does not follow the spec\n-       if firstInvalid.parent == nil {\n```",
        "created_at": "2024-10-08T15:06:02.145000+00:00",
        "attachments": null
    },
    {
        "author": "rjected",
        "category": "general",
        "parent": "",
        "content": "oof",
        "created_at": "2024-10-08T15:06:24.244000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "null also breaks us",
        "created_at": "2024-10-08T15:06:39.745000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "if you know the block to be invalid, you need to have connected it to a state",
        "created_at": "2024-10-08T15:07:01.487000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "if the parent was valid, then you will not get null",
        "created_at": "2024-10-08T15:07:02.321000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "so you need to know a valid parent",
        "created_at": "2024-10-08T15:07:06.863000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "it is impossible to return INVALID without knowing a VALID ancestor",
        "created_at": "2024-10-08T15:07:27.628000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "although I think we removed the return INVALID_BLOCKHASH",
        "created_at": "2024-10-08T15:08:07.895000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "which is a pain for this too now ðŸ¤¦",
        "created_at": "2024-10-08T15:08:16.955000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "only if its execution invalid",
        "created_at": "2024-10-08T15:08:27.666000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "yeah we used to have INVALID_BLOCKHASH for this specific case",
        "created_at": "2024-10-08T15:08:44.589000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "also this is a child of some long invalid child chain, though one could track of where exactly it became invalid, but will require some dev (though not much)",
        "created_at": "2024-10-08T15:09:22.754000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I wonder if CLs are actually safe over this.. we have quite complicated logic to deal with invalidation of branches in forkchoice",
        "created_at": "2024-10-08T15:10:14.333000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "And it becomes a nightmare on ePBS",
        "created_at": "2024-10-08T15:10:25.469000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "current lodestar handles null in some safe manner",
        "created_at": "2024-10-08T15:10:44.024000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "not only null, what happens if you get a LVG",
        "created_at": "2024-10-08T15:10:59.125000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "LVH that is not an ancestor of the passed root?",
        "created_at": "2024-10-08T15:11:09.594000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "even null is weird",
        "created_at": "2024-10-08T15:11:19.322000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "where do you stop prunning?",
        "created_at": "2024-10-08T15:11:26.204000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "then also we don't assume anything on lodestar and keep parent blocks syncing sttaus in forkchoice and mark only the current invalid",
        "created_at": "2024-10-08T15:11:52.983000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "So you would continue optimistically syncing over some possible invalid branches that are ancestors of the current invalid block right?",
        "created_at": "2024-10-08T15:13:02.525000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "eventually a valid should resolve a happy path, so that takes care of everything (but if valid\u003c\u003einvalid clash happens then we error and shutdown)",
        "created_at": "2024-10-08T15:13:03.354000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "yes if thats what forkchoice head gives at that point",
        "created_at": "2024-10-08T15:13:38.047000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "in fact I could forever send you blocks over the parent one as soon as Lodestar has synced a chain of lenght \u003e 1",
        "created_at": "2024-10-08T15:13:48.979000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "you can, but would it become head in forkchoice with sufficient weight",
        "created_at": "2024-10-08T15:14:24.455000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "it will if every client is Lodestar",
        "created_at": "2024-10-08T15:15:01.904000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "and they are optimistically syncing in a majority",
        "created_at": "2024-10-08T15:15:22.376000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "this is the sort of bugs that is fine as long as no one finds a way of triggering optimistic sync on most clients",
        "created_at": "2024-10-08T15:15:39.278000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "if there is no happy path block available how will you sync",
        "created_at": "2024-10-08T15:15:49.975000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "There can be a happy path block, but you can keep an invalid chain being head of all the optimistic nodes for a long time",
        "created_at": "2024-10-08T15:16:20.003000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "you mean all slots are colluding to form invalid blocks?",
        "created_at": "2024-10-08T15:17:10.117000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "and if every node becomes optimistic, I believe you don't recover at all, since you never catch up to head",
        "created_at": "2024-10-08T15:17:13.103000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "or majority of network is optimistic?",
        "created_at": "2024-10-08T15:17:33.599000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "why won't we catchup to head, new blocks will be added to forkchoice and happy path chain should win",
        "created_at": "2024-10-08T15:18:30.748000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "say every client is Lodestar, it's a single client network, I manage to propose a block that puts every node in optimistic sync mode. I send this block, and two descendants, the grandchild is found to be invalid, and removed, but now every single client is optimistic with an optimistic head that was not removed. How do you propose a single block now?",
        "created_at": "2024-10-08T15:18:55.817000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "if you did remove both blocks, then you are no longer optimistic and you can propose",
        "created_at": "2024-10-08T15:19:44.704000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I'm convinced there's plenty of bugs like these that are generalized in CLs including Prysm",
        "created_at": "2024-10-08T15:20:18.222000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "right, proposal/attestation flow has to take care of this fact that its head could be unavailable because of some bug",
        "created_at": "2024-10-08T15:21:08.032000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "but this should be even for all clients, since all would be put in syncing mode with a block which ELs can't sync back",
        "created_at": "2024-10-08T15:22:08.787000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "this can only happen if the invalid chain wins forkchoice, which i don't think it will",
        "created_at": "2024-10-08T15:24:29.994000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "no, if this happened to prysm and every client is put optimistic, as soon as we find out that the chain was invalid we would remove every invalid node in forkchoice that we can find, that means that we are no longer optmistic since our head cannot be an optimistic node",
        "created_at": "2024-10-08T15:25:06.265000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "\u003e  I manage to propose a block that puts every node in optimistic sync mode\nwe need an example of how this chain would win forkchoice",
        "created_at": "2024-10-08T15:25:08.022000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "\u003e as soon as we find out that the chain was invalid we would remove every invalid node in forkchoice that we can find,\nwe also do this, but only if LVH is not ancestor we don't do anything else we also invalidate till LVH",
        "created_at": "2024-10-08T15:25:35.469000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "\u003e this can only happen if the invalid chain wins forkchoice, which i don't think it will\nWell, this is the wishful thinking that gets broken in bad cases",
        "created_at": "2024-10-08T15:25:44.226000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "This is my complain with client diversity",
        "created_at": "2024-10-08T15:25:51.307000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "\u003e as soon as we find out that the chain was invalid we would remove every invalid node in forkchoice that we can find\nwhat if the the EL could never sync chain and it always remained optimistic",
        "created_at": "2024-10-08T15:31:59.268000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "if the EL is forever optimistic there's nothing we can do",
        "created_at": "2024-10-08T15:32:24.668000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "that's what I am asking here, but I actually think that this situation has become worse by the removal of `INVALID_BLOCKHASH`   that we had originally. cc \u003c@425572898787426305\u003e",
        "created_at": "2024-10-08T15:33:25.673000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "we also need a rule which says that CLs should vote/propose on their last valid head as long as it respects the finalized/justified (and other slashing conditions)",
        "created_at": "2024-10-08T15:34:54.514000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "atleast valid blocks will flow to the network",
        "created_at": "2024-10-08T15:35:25.671000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "no this is pretty bad",
        "created_at": "2024-10-08T15:37:44.658000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "you cannot perform duties if your head is optimistic",
        "created_at": "2024-10-08T15:37:53.867000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "not on optimistic head, but last valid head like you never synced optimistic blocks",
        "created_at": "2024-10-08T15:39:25.393000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "as long as the rollback is not pre justified",
        "created_at": "2024-10-08T15:41:16.077000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "that's what I am saying this is very dangerous, if you are syncing some valid blocks and some optimistic ones, and your forkchoice weight is on the optimistic ones, you should not perform any duties",
        "created_at": "2024-10-08T15:50:23.198000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "\u003e as soon as we find out that the chain was invalid we would remove every invalid node in forkchoice that we can find\nprsym can only do this if it gets an ancestor LVH right?",
        "created_at": "2024-10-08T15:53:21.287000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "We had some paths to resend the blocks from a common ancestor if they were on different forks. We ended up without it in the end",
        "created_at": "2024-10-08T15:56:10.378000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "But also there's the issue of actually removing entirely all blocks from forkchoice that come in... Say for example you have \n```\nA \u003c- B \u003c- C\n     \\--------D\n```\nall optimistic, you receive that D is invalid and that A is the last valid hash, do you remove C?",
        "created_at": "2024-10-08T15:57:33.147000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "if LVH is A, then B is invalid as per the definition of LVH",
        "created_at": "2024-10-08T16:02:04.227000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "yes, question is if you go back and remove from forkchoice C",
        "created_at": "2024-10-08T16:02:33.679000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "only when LVH is null or on some other fork (i guess that issue is resolved) then we have a problem",
        "created_at": "2024-10-08T16:02:36.268000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "yes, C is invalid",
        "created_at": "2024-10-08T16:02:52.203000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I know it's invalid",
        "created_at": "2024-10-08T16:02:57.870000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I'm asking if Lodestar removes it from forkchoice",
        "created_at": "2024-10-08T16:03:04.792000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "we go up till LVH  and then mark all child path nodes as invalid of all invalid marked parents",
        "created_at": "2024-10-08T16:03:08.589000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "we had discussions about this with Paul originally, cause the protoarray has no notion of children",
        "created_at": "2024-10-08T16:03:26.547000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "yes we mark B, C, D invalid",
        "created_at": "2024-10-08T16:03:34.568000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "general",
        "parent": "",
        "content": "yea we still traverse down ðŸ˜†",
        "created_at": "2024-10-08T16:04:46.140000+00:00",
        "attachments": null
    },
    {
        "author": "marekm3498",
        "category": "general",
        "parent": "",
        "content": "Yes, but there are cases where we will have to return null. For example, if the EL is syncing and the CL sends me an invalid block (such as an invalid header). I know the block is invalid, but I don't know if the parent or ancestor of that block was valid.",
        "created_at": "2024-10-08T22:36:35.891000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "Yeah thanks this is what got broke with INVALID_BLOCKHASH being removed as long as this is the return of notify_NewPayload and never FCU that's fine",
        "created_at": "2024-10-08T22:40:54.734000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "It would be terrible if this is on FCU",
        "created_at": "2024-10-08T22:41:13.466000+00:00",
        "attachments": null
    },
    {
        "author": "marekm3498",
        "category": "general",
        "parent": "",
        "content": "I think it can happen for both: newPayload and FCU, but it would mean that CL sends newPayload(X), CL got info that X was invalid and later it sends fcU(X)",
        "created_at": "2024-10-08T22:58:03.462000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "That's impossible in a spec following CL",
        "created_at": "2024-10-08T23:19:05.936000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "The CL can never send FCU to a block for which it hasn't sent a newPayload message",
        "created_at": "2024-10-08T23:19:39.470000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "general",
        "parent": "",
        "content": "I believe that clients that do this (perhaps even ourselves now) do so only on finalized blocks",
        "created_at": "2024-10-08T23:23:36.261000+00:00",
        "attachments": null
    }
]