[
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e thanks for the review",
        "created_at": "2021-04-14T11:29:24.405000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's updated again",
        "created_at": "2021-04-14T11:29:33.208000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(not done yet, had to eat dinner)",
        "created_at": "2021-04-14T11:29:37.668000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "About the rlp, I've also written my opinion on github, want to leave as-is for now",
        "created_at": "2021-04-14T11:30:01.226000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Honestly, at this point, I just want to get the change in and focus on documenting eth/66 next",
        "created_at": "2021-04-14T11:30:21.580000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Some docs is better than no docs at all",
        "created_at": "2021-04-14T11:30:37.196000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I appreciate you reviewing it in detail though, it does help to make it more correct",
        "created_at": "2021-04-14T11:31:00.974000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Just let me know if you think it's OK to merge, or whether you feel very strongly about changing something still",
        "created_at": "2021-04-14T12:05:07.724000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Just read your comment, your response makes me think that this may not be a disagreement on terminology, but actually a disagreement on the specification itself.",
        "created_at": "2021-04-14T12:12:33.594000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e we have to formally describe that the typed transaction is a RLP byte array\nThe transaction is **not** an RLP byte array.",
        "created_at": "2021-04-14T12:12:52.164000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is a **non**-RLP byte array.",
        "created_at": "2021-04-14T12:12:59.471000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Just regular sequence of bytes, with the first byte being the transaction type.  There is **no** length prefix.",
        "created_at": "2021-04-14T12:13:13.715000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Also, so far this is the only point of contention I have so far that I think is worth holding up a merge for because I believe it it to be *incorrect*, and incorrect is worse than nothing when it comes to documentation IMO.",
        "created_at": "2021-04-14T12:14:35.950000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Everything else is feedback on how I think the spec could be improved, but that can happen iteratively over time.",
        "created_at": "2021-04-14T12:14:56.885000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "OK",
        "created_at": "2021-04-14T12:27:35.890000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So for the purpose of the networking protocol, the typed transaction is a RLP byte array",
        "created_at": "2021-04-14T12:27:58.021000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you get a RLP list of transactions, the elements of the list are RLP objects",
        "created_at": "2021-04-14T12:28:25.914000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We have two types",
        "created_at": "2021-04-14T12:28:29.813000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If the object is RLP list, it's a legacy transaction",
        "created_at": "2021-04-14T12:28:42.850000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If the object is RLP byte array, it's a typed transaction",
        "created_at": "2021-04-14T12:28:55.301000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I know that for hashing and `eth_sendRawTransaction` RPC, typed transactions are not RLP",
        "created_at": "2021-04-14T12:29:47.760000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But it's different in the networking",
        "created_at": "2021-04-14T12:30:03.102000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In the spec, I'm not trying to say anything about typed transactions in general",
        "created_at": "2021-04-14T12:31:05.627000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm just trying to define clearly how they are encoded on the wire",
        "created_at": "2021-04-14T12:31:22.756000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "When you say \"RLP Byte Array\" do you mean \"byte array with a length prefix as the leading bytes in the array\" or do you mean \"A byte array that *can* be RLP encoded at a future step in the process\"?",
        "created_at": "2021-04-14T12:36:14.849000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In the networking, it is *also* not an RLP encoded byte array.",
        "created_at": "2021-04-14T12:36:41.121000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is a byte array that is put into a list and then that *list* is RLP encoded.",
        "created_at": "2021-04-14T12:36:52.144000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This gives a different result from RLP encoding the byte array and then putting it into a list that is then RLP encoded.",
        "created_at": "2021-04-14T12:37:06.101000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Damn it, why does it feel like we are talking about two different things",
        "created_at": "2021-04-14T12:37:08.956000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Possibly because we are?  üòÑ",
        "created_at": "2021-04-14T12:37:19.877000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So in RLP, there are two types of objects that can be encoded:",
        "created_at": "2021-04-14T12:37:28.990000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Lists and byte arrays",
        "created_at": "2021-04-14T12:37:32.850000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is a byte array.",
        "created_at": "2021-04-14T12:37:43.660000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "When I say RLP byte array, I mean an RLP object of byte array type",
        "created_at": "2021-04-14T12:37:45.777000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Legacy transactions are a list.",
        "created_at": "2021-04-14T12:37:48.573000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i.e. it's a couple of bytes with a length prefix specifying the bytes type",
        "created_at": "2021-04-14T12:38:10.744000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I see.  So you are referring to a \"byte array that *can* be RLP encoded\", not a byte array that *has* been RLP encoded?",
        "created_at": "2021-04-14T12:38:12.651000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "No, it has no length prefix (yet).",
        "created_at": "2021-04-14T12:38:24.741000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is where our misunderstanding is",
        "created_at": "2021-04-14T12:38:42.342000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you prematurely length prefix it then you'll end up double length prefixing it when you encode the list that contains it later.",
        "created_at": "2021-04-14T12:38:53.335000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I never think about it this way",
        "created_at": "2021-04-14T12:39:09.770000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`rlp_encode([rlp_encode(bytes)]) != rlp_encode([bytes])`",
        "created_at": "2021-04-14T12:39:30.996000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "When I think about RLP structures, it would never occur to me that one has to be careful not to doubly add the length prefix",
        "created_at": "2021-04-14T12:39:52.755000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I *think* maybe in your head the actual functions are more like:\n`lp_encode([lp_encode(bytes)]) == rlp_encode([bytes])`",
        "created_at": "2021-04-14T12:40:16.869000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you *non-recursively* encode the outer list, then I think your thinking makes sense.",
        "created_at": "2021-04-14T12:40:33.276000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But then it isn't **R**LP anymore, it is just LP.  üôÇ",
        "created_at": "2021-04-14T12:40:42.977000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm still not sure how to resolve this discussion",
        "created_at": "2021-04-14T12:41:33.109000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Let me give an example",
        "created_at": "2021-04-14T12:41:38.237000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Let's say we have some bytes 0x010203",
        "created_at": "2021-04-14T12:41:53.204000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "They are just bytes",
        "created_at": "2021-04-14T12:42:00.425000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Do a poll of 1000 random developers and see which mental model aligns closer to their natural one.  üòâ",
        "created_at": "2021-04-14T12:42:07.602000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "let's define the object `x` to be the bytes `0x010203`",
        "created_at": "2021-04-14T12:42:31.624000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I wouldn't call it an object, but that may not matter so we can move on without resolving that for now.",
        "created_at": "2021-04-14T12:42:57.304000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if i say \"the RLP byte array of x\", I mean `0x83010203`",
        "created_at": "2021-04-14T12:43:49.720000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That is also what I mean when I say that same phrase.",
        "created_at": "2021-04-14T12:44:06.376000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i.e. an RLP byte array is the bytes of x with the length prefix",
        "created_at": "2021-04-14T12:44:18.685000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For the purpose of the spec, when I say \"the object foo is `foo = [x, y, z]`\"",
        "created_at": "2021-04-14T12:44:47.369000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "then I assume that it is implied that x, y and z are RLP",
        "created_at": "2021-04-14T12:45:13.876000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In your mind, what happens when you do `rlp_encode([bytes1, bytes2])`?",
        "created_at": "2021-04-14T12:45:47.825000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Where `bytes1` and `bytes2` are byte arrays.",
        "created_at": "2021-04-14T12:46:00.970000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What's the `[` in there btw?",
        "created_at": "2021-04-14T12:46:19.497000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "you mean it's an array?",
        "created_at": "2021-04-14T12:46:31.714000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "An array.  In this case an array of two items (or a list of two items or a tuple of two items depending on language/terminology).",
        "created_at": "2021-04-14T12:46:54.250000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "OK",
        "created_at": "2021-04-14T12:46:59.552000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "so it depends",
        "created_at": "2021-04-14T12:47:03.906000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if `bytes1` is RLP, then it just gets included in the RLP list without encoding it another time",
        "created_at": "2021-04-14T12:47:29.444000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if `bytes1` is not RLP encoded, then it does get encoded",
        "created_at": "2021-04-14T12:47:44.492000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I see.  So in your mind an RLP encoded byte array can be differentiated from a non-RLP encoded byte array?",
        "created_at": "2021-04-14T12:47:55.626000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes",
        "created_at": "2021-04-14T12:47:59.223000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "it's not just in my mind actually, we also have the exact same distinction in go-ethereum",
        "created_at": "2021-04-14T12:48:20.865000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Meaning `rlp_encode(...)` does *not* return a byte array, it returns an object that contains a byte array and some metadata about the fact that it is RLP encoded?",
        "created_at": "2021-04-14T12:48:29.414000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "the notation in the spec is not a computer program, it's more like math notation",
        "created_at": "2021-04-14T12:49:56.636000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Unfortunately, everyone who reads the spec will be a computer programmer, not a mathematician.  üòÑ",
        "created_at": "2021-04-14T12:50:20.834000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "My fear is that we'll see what we have already seen, which is that people interpret `rlp(...)` to mean \"rlp encode and return a byte array\", which they then include in a list and then RLP encode that list later.",
        "created_at": "2021-04-14T12:51:03.046000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And I *suspect* that the common implementation (the naive one that most people do) will not carry around metadata indicating whether or not something is *already* RLP encoded or not.",
        "created_at": "2021-04-14T12:51:29.912000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This becomes even *more* confusing I think when you have items that actually *are* supposed to be double encoded, like the EIP-2930 payload.",
        "created_at": "2021-04-14T12:52:28.363000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "in the implementations, RLP encoding is generally handled by a library that takes an object and encodes it all recursively",
        "created_at": "2021-04-14T12:52:31.122000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That is what I have seen.",
        "created_at": "2021-04-14T12:52:43.915000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And which is why `rlp_encode([rlp_encode(bytes)])` will result in the *wrong* output.",
        "created_at": "2021-04-14T12:52:58.056000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But it sounds like Geth will encode ‚òùÔ∏è correctly (not double encoded)?",
        "created_at": "2021-04-14T12:53:14.008000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What I'm trying to tell you is that this `rlp_encode([rlp_encode(bytes)])` will never occur in the implementation code",
        "created_at": "2021-04-14T12:53:54.064000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In geth, when we deal with transactions, we always deal with them as an object of type `*types.Transaction`",
        "created_at": "2021-04-14T12:54:13.648000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You can RLP encode it, and that gives `[]byte`",
        "created_at": "2021-04-14T12:54:24.891000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(you can also encode it in other ways)",
        "created_at": "2021-04-14T12:54:38.076000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is exactly how someone implemented 2930 because someone read a specification the way I'm suggesting people will read the specification.  üôÇ",
        "created_at": "2021-04-14T12:54:52.243000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Resulted in a consensus failure and a bunch of discussion (very similar to this conversation) trying to figure out who was right.",
        "created_at": "2021-04-14T12:55:21.408000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\"The spec says we should RLP encode typed transactions, so I did that and then put them into the list which I gave to my wire protocol handler.\" (paraphrased)",
        "created_at": "2021-04-14T12:56:02.716000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Keep in mind, that a list of a single EIP-2930 transaction is:\n```\nrlp([concat(1, rlp([chainId, nonce, gasPrice, ...]))])\n```",
        "created_at": "2021-04-14T12:57:33.721000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So nested RLP encoding *is* a thing that happens in the protocol now.",
        "created_at": "2021-04-14T12:57:41.244000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I hate it",
        "created_at": "2021-04-14T12:57:47.252000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is what you get for trying to make consensus objects not RLP in the first place üòõ",
        "created_at": "2021-04-14T12:58:27.082000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Which is part of why I think it is very clear at what stage something should be RLP encoded.",
        "created_at": "2021-04-14T12:58:28.192000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You should mentally prepare, it is *going* to happen.  üôÇ",
        "created_at": "2021-04-14T12:58:42.527000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I know, and of course I'm joking",
        "created_at": "2021-04-14T12:58:56.197000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The consensus client (ETH2) doesn't have a dependency on RLP (only SSZ), and probably never will.",
        "created_at": "2021-04-14T12:59:01.435000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But you should know that we didn't have any issues with RLP up until the point where the second generation of ethereum enthusiasts starting digging in and didn't get it",
        "created_at": "2021-04-14T13:00:06.035000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The idea¬†behind RLP is that all complex values are lists, and simple leaf data is byte array",
        "created_at": "2021-04-14T13:00:43.047000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you start messing with it too much, odd things will happen",
        "created_at": "2021-04-14T13:00:55.172000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I also think RLP has its downsides, but the original idea behind it was kind of solid",
        "created_at": "2021-04-14T13:01:18.463000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Anyway, what should I write in the spec now?",
        "created_at": "2021-04-14T13:01:47.615000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Things would have been less murky if I got my way and 2930 was SSZ.  üòâ",
        "created_at": "2021-04-14T13:01:51.388000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I'm not sure why we didn't go with SSZ",
        "created_at": "2021-04-14T13:02:09.304000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ultimately, I'm a huge fan of ownership and you are the owner of that particular specification.  If you decide to ignore this particular feedback I won't hold it against you in any way and will support you continuing to own the networking spec.  I *do* disagree with the current wording because I fear it will lead to more confusion in the future similar to the confusion we have seen in the past, but I may be wrong and as not-the-owner and also not-volunteering-to-become-owner, my position is merely advisory and should not be given undue weight.",
        "created_at": "2021-04-14T13:03:18.455000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If it were me, I would just say that it is a byte array, not an RLP byte array.",
        "created_at": "2021-04-14T13:03:45.457000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What should be in the formula?",
        "created_at": "2021-04-14T13:04:01.267000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I promise that I will write a meta-spec about the RLP notation later",
        "created_at": "2021-04-14T13:04:15.733000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We're really missing that now",
        "created_at": "2021-04-14T13:04:35.985000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I *think* I would just put:\n```\ntyped-receipt = tx-type || receipt-data\n```",
        "created_at": "2021-04-14T13:05:20.932000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's good you reminded me that this model of thinking where it's implicit whether something is 'already RLP' is not universally understood",
        "created_at": "2021-04-14T13:05:25.100000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Since you have already defined `||` to mean \"byte concatenation\" in the RLPx spec.",
        "created_at": "2021-04-14T13:05:33.308000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, we use it in all specs",
        "created_at": "2021-04-14T13:05:46.352000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In all of the code I have written, `rlp_encode` just returns a byte array that is indistinguishable from any other byte array.  When `rlp_encode(...)` encounters any byte array during its recursive encoding, it length prefixes it as part of the encoding process.  Which is why `rlp_encode([rlp_encode(bytes)])` does something different than it sounds like it would in Geth.",
        "created_at": "2021-04-14T13:06:24.307000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yes, this is true for all implementations, I think",
        "created_at": "2021-04-14T13:06:54.929000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(though I still may be misundestanding exactly how Geth is identifying \"already length prefixed\" byte arrays)",
        "created_at": "2021-04-14T13:07:28.353000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we don't",
        "created_at": "2021-04-14T13:07:40.412000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I meant something else",
        "created_at": "2021-04-14T13:07:44.378000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "let's say that, in some part of geth we have a list of transactions `txs`",
        "created_at": "2021-04-14T13:08:11.196000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "if you `rlp.EncodeToBytes(txs)` it gives `[]byte`",
        "created_at": "2021-04-14T13:08:32.476000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "during this encoding process, for each transaction in `txs`, the method `tx.EncodeRLP` will be invoked",
        "created_at": "2021-04-14T13:08:56.395000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "this is done by the RLP encoder, and it obviously does know what's encoded and what's not encoded",
        "created_at": "2021-04-14T13:10:00.367000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "sure, if you would then encode the `[]byte` output again, it would be doubly length-prefixed",
        "created_at": "2021-04-14T13:10:26.823000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but this doesn't happen because it is not encoded another time",
        "created_at": "2021-04-14T13:10:39.199000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, same (pre 2930) for my code.  I only RLP encode *right* before I put something on the wire or *right* before I sign.",
        "created_at": "2021-04-14T13:11:16.919000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(just to make it clear, the Go type of the input `txs` here is `[]*types.Transaction`)",
        "created_at": "2021-04-14T13:11:21.985000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is the last step, and everything is more useable objects right up until that single `rlpEncode` call.",
        "created_at": "2021-04-14T13:11:36.838000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You need to understand the spec notation in the same way",
        "created_at": "2021-04-14T13:11:44.364000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah, interesting.  So your RLP encoder isn't agnostic?",
        "created_at": "2021-04-14T13:11:55.843000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "My RLP encoder literally only knows how to encode bytes and lists (recursively).",
        "created_at": "2021-04-14T13:12:07.740000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have to *first* run my object through an XXEncoder to turn a transaction into a lists of lists of byte arrays (it angers me greatly that there is no name for this protocol and my functions have weird ambiguous names).",
        "created_at": "2021-04-14T13:12:42.171000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The go-ethereum one is based on reflection, so it is essentially a two-way mapping between the Go type system and the RLP type system",
        "created_at": "2021-04-14T13:13:18.283000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```ts\n    const toEncode = [\n        stripLeadingZeros(bigintToUint8Array(transaction.nonce, 32)),\n        stripLeadingZeros(bigintToUint8Array(transaction.gasPrice, 32)),\n        stripLeadingZeros(bigintToUint8Array(transaction.gasLimit, 32)),\n        stripLeadingZeros(transaction.to !== null ? bigintToUint8Array(transaction.to, 32) : new Uint8Array(0)),\n        stripLeadingZeros(bigintToUint8Array(transaction.value, 32)),\n        new Uint8Array(transaction.data),\n    ]\n    if (!isSignedTransaction(transaction)) {\n        toEncode.push(stripLeadingZeros(bigintToUint8Array(transaction.chainId, 32)))\n        toEncode.push(stripLeadingZeros(new Uint8Array(0)))\n        toEncode.push(stripLeadingZeros(new Uint8Array(0)))\n    } else {\n        toEncode.push(stripLeadingZeros(bigintToUint8Array(transaction.v, 32)))\n        toEncode.push(stripLeadingZeros(bigintToUint8Array(transaction.r, 32)))\n        toEncode.push(stripLeadingZeros(bigintToUint8Array(transaction.s, 32)))\n    }\n```",
        "created_at": "2021-04-14T13:13:19.588000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "aaaaaaaaaaaaaa",
        "created_at": "2021-04-14T13:13:28.295000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That looks so horribly wrong",
        "created_at": "2021-04-14T13:13:34.626000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "RLP, as a specification/standard, does not know how to encode transactions.",
        "created_at": "2021-04-14T13:14:04.105000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The reflection-based approach is nice because the Go type system is limited",
        "created_at": "2021-04-14T13:14:14.298000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have a library for RLP encoding that is not Ethereum specific, it *only* knows how to RLP encode, not Ethereum pack.",
        "created_at": "2021-04-14T13:14:17.957000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So I have to prep a transaction before I can pass it to the RLP encoder.",
        "created_at": "2021-04-14T13:14:42.431000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In Go, we only have basic types `struct { ... }` , slice, array, map, integer, boolean",
        "created_at": "2021-04-14T13:14:45.783000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So what we have defined in the RLP encoder is how each of the basic Go types is encoded",
        "created_at": "2021-04-14T13:15:28.607000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For example, if transaction is defined like",
        "created_at": "2021-04-14T13:15:38.345000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\ntype Tx struct{ Nonce uint64; Gas uint64; Input []byte }\n```",
        "created_at": "2021-04-14T13:16:02.488000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Your RLP encoder is essentially Ethereum aware?",
        "created_at": "2021-04-14T13:16:07.477000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Or are you saying that you iterate over the struct in declaration order and use reflection to determine the type, and then encode based on that reflected type?",
        "created_at": "2021-04-14T13:16:33.502000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, the latter",
        "created_at": "2021-04-14T13:16:40.443000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's not specific to the type",
        "created_at": "2021-04-14T13:16:49.420000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The mapping is generic",
        "created_at": "2021-04-14T13:16:57.074000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(and goes both ways, so we also decode the same way)",
        "created_at": "2021-04-14T13:17:06.290000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We do all encoding/decoding this way",
        "created_at": "2021-04-14T13:18:11.885000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For example, here is the definition of the BlockBodies message of eth",
        "created_at": "2021-04-14T13:18:29.434000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ethereum/go-ethereum/blob/master/eth/protocols/eth/protocol.go#L214",
        "created_at": "2021-04-14T13:18:30.083000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's quite a complicated message, but if you want to convert it to RLP, you can just",
        "created_at": "2021-04-14T13:18:55.551000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`rlp.EncodeToBytes(msg)`",
        "created_at": "2021-04-14T13:19:02.262000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "and to decode, you can",
        "created_at": "2021-04-14T13:19:06.682000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\nvar msg BlockBodiesPacket66\nrlp.DecodeBytes(input, \u0026msg)\n```",
        "created_at": "2021-04-14T13:19:25.952000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "without ever thinking about length-prefixing, or double length-prefixing",
        "created_at": "2021-04-14T13:19:57.958000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "TypeScript doesn't have ordered named objects.",
        "created_at": "2021-04-14T13:20:05.532000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Well, that isn't quite true.  I think they added named tuples in the most recent update?  I haven't figured out how they work yet though.",
        "created_at": "2021-04-14T13:20:21.842000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't know anything about TypeScript",
        "created_at": "2021-04-14T13:22:01.925000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Anyway, I'm OK with removing the `rlp(...)` in the spec, so will do that now",
        "created_at": "2021-04-14T13:23:04.755000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "it's removed",
        "created_at": "2021-04-14T13:23:46.203000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "now can you please approve it?",
        "created_at": "2021-04-14T13:23:53.952000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah, I didn't realize you were wanting an actual PR approval.  Let me finish reading over it.",
        "created_at": "2021-04-14T13:24:13.003000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "FWIW, I really would love one day to see this spec expanded to actually include definition of all of the transaction types.",
        "created_at": "2021-04-14T13:25:15.297000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think that may be out of scope *today*, but would be nice to have I think and would allow being more explicit about expectations.",
        "created_at": "2021-04-14T13:25:47.278000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(like defining how to do signature validation for each transaction)",
        "created_at": "2021-04-14T13:25:57.013000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "btw, if you are interested in the actual Go \u003c-\u003e RLP type system mapping, it's defined here: https://pkg.go.dev/github.com/ethereum/go-ethereum/rlp#hdr-Encoding_Rules",
        "created_at": "2021-04-14T13:29:23.661000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(but don't get confused by the terminology, \"RLP byte array\" is called \"RLP string\" in those docs)",
        "created_at": "2021-04-14T13:30:02.066000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "it might be useful for you if you ever want to implement something like that in TypeScript",
        "created_at": "2021-04-14T13:30:44.186000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "TypeScript doesn't support reflection, so the same strategy doesn't work.",
        "created_at": "2021-04-14T13:54:42.155000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There are other things you can do to achieve similar results, but I think they end up being sufficiently different.",
        "created_at": "2021-04-14T13:55:07.326000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Do we have any examples of contracts which are broken due to 2929 but are \"fixed\" with 2930?",
        "created_at": "2021-04-14T15:16:52.716000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So I have just realised that new TxType prefix for EIP-2718 is added for constructing transaction RLP when computing TxHash, and when forming a receipt RLP, but not when transaction is encoded inside a block, or inside network packets... Is this intentional? I have probably missed relevant discussions, and was assuming that TxType byte is added everywhere, but now noticed it is not...",
        "created_at": "2021-04-14T16:09:29.033000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Or perhaps I have mis-interpreted the tests",
        "created_at": "2021-04-14T16:10:02.551000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah, sorry, I am wrong. I now realised it is an extra added envelope",
        "created_at": "2021-04-14T16:12:00.430000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ignore my message above",
        "created_at": "2021-04-14T16:12:06.963000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "now I realise parsing those things are harder than I thought it would be. Because you open the envelope, and there you need to read first item, it can either be a Nonce of a LegacyTx, or TxType of non-legacy Tx. Not enough to distinguish. Then you go to the second element. For legacy Tx, it is GasPrice (byte string), and for non-legacy transaction it is a structure. Only here you can distinguish between them",
        "created_at": "2021-04-14T16:26:44.765000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "now I understand why the code in geth was written in the way it was - lets try to parse it as LegacyTx, and if it fails, re-parse it as non-LegacyTx. I wanted to do it properly and now I am several days into refactoring üôÇ",
        "created_at": "2021-04-14T16:28:25.851000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but now it is becoming clearer",
        "created_at": "2021-04-14T16:30:12.832000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The similar situation for parsing receipts",
        "created_at": "2021-04-14T16:33:13.105000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't understand this part",
        "created_at": "2021-04-14T17:05:00.421000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We don't really try to parse as legacy tx first",
        "created_at": "2021-04-14T17:06:01.285000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It's always possible to decide if it's a legacy tx or typed tx: https://github.com/ethereum/go-ethereum/blob/master/core/types/transaction.go#L120",
        "created_at": "2021-04-14T17:06:22.936000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ethereum/go-ethereum/blob/master/core/types/transaction.go#L151",
        "created_at": "2021-04-14T17:06:35.677000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "They even restricted the range of tx-type values to 1..127 to make it impossible to have a conflict between valid RLP prefix bytes and tx type",
        "created_at": "2021-04-14T17:07:20.841000+00:00",
        "attachments": []
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/holiman/eip2929-stats",
        "created_at": "2021-04-14T17:09:38.708000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!194432762315407360\u003e thank you, I must have been looking at the wrong code, need to un-confuse myself again",
        "created_at": "2021-04-14T17:11:03.482000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm actually really happy with the way we integrated typed tx in go-ethereum",
        "created_at": "2021-04-14T17:11:53.636000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There were no API changes to core/types, and the API for creating txs is now better than ever with the `NewTx` constructor",
        "created_at": "2021-04-14T17:12:20.562000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "BTW, why is this line not checking for `rlp.Byte`: https://github.com/ethereum/go-ethereum/blob/a50251e6cbfecfaf26040d42c70d2812bc422a4a/core/types/transaction.go#L132  ?",
        "created_at": "2021-04-14T17:15:03.434000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Because transactions must be larger than 1 byte",
        "created_at": "2021-04-14T17:15:33.275000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah, I see",
        "created_at": "2021-04-14T17:15:42.771000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I confused it with the TxType, thanks",
        "created_at": "2021-04-14T17:15:53.505000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok, I think I have now understood my confusion",
        "created_at": "2021-04-14T17:17:11.367000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The tx envelope which contains `TxType || TransactionPayload` is a string, not a struct as I thought",
        "created_at": "2021-04-14T17:17:54.546000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "now it is cleared up, thanks for your help",
        "created_at": "2021-04-14T17:18:03.123000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "now I understand why the spec uses `||`",
        "created_at": "2021-04-14T17:18:30.789000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yea",
        "created_at": "2021-04-14T17:19:20.264000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "BTW, let it be known that I hate this design",
        "created_at": "2021-04-14T17:19:38.583000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but people really wanted a way out of the whole RLP situation",
        "created_at": "2021-04-14T17:19:56.114000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "we even discussed encoding the tx data as SSZ, but it didn't happen for some reason",
        "created_at": "2021-04-14T17:20:16.607000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't like it because it makes the specs and the parsing more complicated/inefficient",
        "created_at": "2021-04-14T17:21:02.979000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I guess we will be able to revamp it when blocks become SSZ at some point",
        "created_at": "2021-04-14T17:21:20.014000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, I am trying to get rid of buffering here:",
        "created_at": "2021-04-14T17:21:39.304000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\nvar b []byte\n        if b, err = s.Bytes(); err != nil {\n            return err\n        }\n        inner, err := tx.decodeTyped(b)\n```",
        "created_at": "2021-04-14T17:21:42.401000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you are still using go-ethereum package rlp, it's not possible for now",
        "created_at": "2021-04-14T17:22:02.646000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I know",
        "created_at": "2021-04-14T17:22:10.227000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I wanted to add a helper for it, but we also wanted to get it done, so it didn't happen in time",
        "created_at": "2021-04-14T17:22:30.567000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that's why I needed to change a lot of things üôÇ but if I hadn't done it, I would not have understood the design üôÇ",
        "created_at": "2021-04-14T17:22:43.351000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What could be done quickly is adding a method like ReadBytes on rlp.Stream, where the caller supplies the buffer",
        "created_at": "2021-04-14T17:23:25.688000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Alternatively, we could create a way to get an io.Reader for the content of the next bytes in stream",
        "created_at": "2021-04-14T17:24:07.454000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "but I didn't want to hack the internals of package rlp for the integration of typed txs",
        "created_at": "2021-04-14T17:24:26.389000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I am using a different approach, which might take longer (step by step), but lead to what I would like. Trying to de-compose RLP encoding/decoding in certain places, and then re-compose again in a more efficient way",
        "created_at": "2021-04-14T17:24:33.097000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't really care about the buffering for now because for us, allocation is not the problem",
        "created_at": "2021-04-14T17:25:29.684000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "There are always ways to reduce allocs at the expense of making the code super complicated",
        "created_at": "2021-04-14T17:25:55.753000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But I think life is too short for microoptimizing all the time",
        "created_at": "2021-04-14T17:26:19.527000+00:00",
        "attachments": []
    },
    {
        "author": ".fjl",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Better to focus on the high-level stuff, we can always make it faster later if it actually shows on the alloc profile",
        "created_at": "2021-04-14T17:26:52.407000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ha-ha, we are also doing quite a lot of high-level stuff (as you know), and these low-level optimisations are an experiment to see if it ever leads to some kind of \"localised implosion of complexity\" üôÇ",
        "created_at": "2021-04-14T17:28:59.238000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/holiman/eip2929-stats",
        "created_at": "2021-04-14T17:42:48.805000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "oh sorry i see martin already sent that üôÇ",
        "created_at": "2021-04-14T17:43:52.779000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thanks!",
        "created_at": "2021-04-14T18:26:09.456000+00:00",
        "attachments": []
    }
]