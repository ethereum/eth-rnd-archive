[
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hi,\nWhat happens if I create a type 2 tx, but add `808080` at the end (like EIP155 tx).\ne.g. Initial tx: `02e704808459682f008459682f0e82520894e18035bf8712672935fdb4e5e431b1a0183d2dfc8080c0`\nbecomes: `02ea04808459682f008459682f0e82520894e18035bf8712672935fdb4e5e431b1a0183d2dfc8080c0808080`\n\nShould the signatures of these two messages be different? Should they be the same? Should I throw an error because it's an unexpected format? Asking in the context of `hw-app-eth` which is Ledger's ethereum js library.",
        "created_at": "2021-08-24T07:46:08.314000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think `geth` would not throw an error and simply ignore `808080` (see https://github.com/ethereum/go-ethereum/blob/c368f728c19e7fd7a9613513edda68ffcb503af0/core/types/transaction_signing.go#L224-L236)\n`ethereumjs-tx` also ignores `808080`.\n\nWondering if that is the standard (if there is one)?",
        "created_at": "2021-08-24T07:47:17.040000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That shouldn't deserialize/validate I think?",
        "created_at": "2021-08-24T08:35:15.570000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Type 2 transactions have a well defined length number of items.  This is different from legacy transactions which can have either 6 items or 9 items depending on whether you are signing over a specific chain ID or not.",
        "created_at": "2021-08-24T08:36:50.875000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I haven't decoded the two examples you provided, but one of them should not validate and thus hard fail (not sign).",
        "created_at": "2021-08-24T08:37:25.993000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It would be very wrong to sign an invalid transaction, and one of those two is invalid (likely the second, but again I didn't decode them and I'm not sure what exactly you are doing here).",
        "created_at": "2021-08-24T08:38:09.508000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It is also worth noting that you shouldn't be just jamming 808080 onto the end of transactions when signing legacy transactions, if that is what you are currently doing.",
        "created_at": "2021-08-24T08:38:35.324000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You need to update the length prefix to accommodate the EIP-155 list length changes (which it actually looks like you are doing in your example), and it should be `\u003cchain_id\u003e.toBigEndianBytes()` followed by `8080`.  `chain_id` for Ethereum mainnet is `1`, which I believe RLP encodes as `0x01` (double check this), not `0x80`.  If you support signing for other Ethereum networks (like various test networks) then it will be something else, and possibly multiple bytes.",
        "created_at": "2021-08-24T08:41:40.033000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e Thanks for your timely response.\nTo give you some context, I'm currently investigating Metamask's integration of EIP1559 with Ledger (https://github.com/MetaMask/eth-ledger-bridge-keyring/pull/96).\nI indeed think that (2) is invalid, however ethereumjs-tx signs it without an issue. Hence, I think ethereumjs-tx probably has a bug here ðŸ™‚",
        "created_at": "2021-08-24T08:48:46.653000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Indeed, when ethereumjs-tx serializes \n```\n{\n  \"gasLimit\": \"0x5208\",\n  \"nonce\": \"0x0\",\n  \"to\": \"0xe18035bf8712672935fdb4e5e431b1a0183d2dfc\",\n  \"value\": \"0x0\",\n  \"maxFeePerGas\": \"0x59682f0e\",\n  \"maxPriorityFeePerGas\": \"0x59682f00\",\n  \"chainId\": \"0x4\",\n  \"accessList\": []\n  \"type\": 2\n}\n```\nit produces a rawTx that appends `808080` at the end, because `r, s, v` are `undefined` (even though it's a type 2 tx...)",
        "created_at": "2021-08-24T08:49:49.675000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, that is definitely wrong and you should not sign that.",
        "created_at": "2021-08-24T08:56:00.655000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Exactly what I thought too! ðŸ™‚ Thanks ðŸ™‚ Hopefully we'll have MM + Ledger sending out EIP-1559 tx soon ðŸ™‚",
        "created_at": "2021-08-24T08:56:32.239000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And for the record, you **should** get a different signature for every byte array provided.",
        "created_at": "2021-08-24T08:56:46.621000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you can provide two different byte arrays and get the same signature then there is a bug in your signer.",
        "created_at": "2021-08-24T08:56:57.988000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is indeed the behaviour with our device. So all is well ðŸ™‚",
        "created_at": "2021-08-24T08:57:02.399000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In that PR, why does `rawTx` have VRS on it if it doesn't have a signature?",
        "created_at": "2021-08-24T08:58:19.271000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(maybe that question is for someone else, not you)",
        "created_at": "2021-08-24T08:58:26.684000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "An unsigned transaction should *not* have a `v,r,s` on it.",
        "created_at": "2021-08-24T08:58:49.839000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Replied to MM: https://github.com/MetaMask/eth-ledger-bridge-keyring/pull/96#issuecomment-904457569\nAttached some screenshots of our conversation: if you disagree \u003c@!301186049323958275\u003e pls let me know, I'll remove them",
        "created_at": "2021-08-24T08:58:55.564000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Not sure I get your question.\nFor EIP-155 tx, we do need to add `chainID,80,80` at the end of the tx right? (in this case `v` == chainId, `r` == EMPTY, `s` == EMPTY)\nFor typed transactions, those fields should not be here. Correct?",
        "created_at": "2021-08-24T09:00:53.373000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Signatures are always over byte arrays.  There are 4 valid transaction types in Ethereum today:\n1. Legacy transactions which is a 6 item RLP encoded list.\n2. 155 transactions, which is a 9 item RLP encoded list.\n3. 2930 transactions, which is a `0x01` byte followed by an 8 item RLP encoded list.\n4. 1559 transactions, which is a `0x02` byte followed by a 9 item RLP encoded list.",
        "created_at": "2021-08-24T09:03:01.225000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "None of those RLP encoded lists include a v, r, or s.",
        "created_at": "2021-08-24T09:03:13.485000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "155 transactions are `rlp([signer_nonce, gas_price, gas_limit, destination, amount, payload, chainId, 0, 0])`",
        "created_at": "2021-08-24T09:03:47.064000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ok well, my bad I guess on using the wrong terminology. I'm calling `v, r, s` the last three fields of (2) (eip-155 tx)",
        "created_at": "2021-08-24T09:03:47.216000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "where in my mind I say `r == 0` and `s == 0` ðŸ™‚",
        "created_at": "2021-08-24T09:04:04.029000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, they aren't v,r,s at all.  ðŸ™‚",
        "created_at": "2021-08-24T09:04:15.131000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Indeed, v, r, s correspond to the signature :p",
        "created_at": "2021-08-24T09:04:26.001000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Just 3 more items in an RLP list, `chainId, 0, 0` that goes into the final byte array that gets hashed and signed.",
        "created_at": "2021-08-24T09:04:28.589000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Got it! will be using clearer wording next time ðŸ™‚",
        "created_at": "2021-08-24T09:04:40.828000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It isn't just your fault.  That PR references code that does the same thing.",
        "created_at": "2021-08-24T09:05:17.538000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Seems a lot of people call those \"v,r,s\" incorrectly, which I think is part of the reason why there is so much confusion around EIP-155 transactions.",
        "created_at": "2021-08-24T09:05:37.594000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "When I first was exposed to EIP-155 I also was quite confused at least in part because people would refer to those fields as v,r,s.",
        "created_at": "2021-08-24T09:06:15.951000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "By the way, I'd be interested in hearing you POV on this particular topic:\nSay I'm building a js lib for signing transaction (https://www.npmjs.com/package/@ledgerhq/hw-app-eth?activeTab=readme#signtransaction)\n\nWhat would you expect to happen if you sign a EIP155 transaction that has the last two fields not set to `0`.\nShould the lib:\n1. Throw an error (saying \"hey we're expecting `0` for the last two fields)\n2. Sign the transaction but with  hardset `0`s\n3. Sign the tx as it (thus creating... an invalid tx)",
        "created_at": "2021-08-24T09:07:36.647000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I would go with `(1)`, but right now the behaviour is  `(3)`. Trying to see if there's any situation where behaving like `(3)` is something we'd like to do (maybe some weird testnet settings of whatever)",
        "created_at": "2021-08-24T09:08:41.751000+00:00",
        "attachments": null
    },
    {
        "author": "pscott1337",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ledger doesn't want to change the behaviour and introduce breaking changes that we'd have to revert because we were wrong",
        "created_at": "2021-08-24T09:09:04.995000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(1) or (3) depending on how big of a nanny your library is.",
        "created_at": "2021-08-24T09:09:53.549000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(3) is saying, \"you gave us bytes, we'll sign them for you.  if you gave us bytes you didn't actually want to sign that is on you\".\n(1) is saying, \"you gave us bytes that don't make sense to us, we only will allow you to sign things we understand\".",
        "created_at": "2021-08-24T09:10:44.468000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This same policy should generally apply throughout the library.  Either your library signs arbitrary bytes, or it only signs things it understands.  There is huge value in being consistent on this front.",
        "created_at": "2021-08-24T09:11:42.759000+00:00",
        "attachments": null
    },
    {
        "author": "_danjm",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e \u003c@!212146572736200704\u003e I'm the author of that MetaMask PR. Just wanted to say thanks for looking at this and for your discussion above. Very helpful. I will be following up with ethereumjs-tx.",
        "created_at": "2021-08-24T16:45:27.330000+00:00",
        "attachments": null
    }
]