[
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Moving from \u003c#745077610685661265\u003e re: 3074",
        "created_at": "2021-02-23T05:49:59.996000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://discord.com/channels/595666850260713488/745077610685661265/813648764489039932",
        "created_at": "2021-02-23T05:50:07.440000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Is there a canonical ABI encoding?",
        "created_at": "2021-02-23T05:50:31.482000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Transaction is signed over `rlp(...)` but I wonder if it would be a tad easier to sign over `abi_encode(...)` instead.",
        "created_at": "2021-02-23T05:50:52.441000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "RLP inside the EVM is hard, ABI encoding inside the EVM is easy.",
        "created_at": "2021-02-23T05:51:07.662000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Someone else wanted EIP-712 encoding",
        "created_at": "2021-02-23T05:51:10.279000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Why?",
        "created_at": "2021-02-23T05:51:26.926000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Wallet support, I would assume",
        "created_at": "2021-02-23T05:51:35.370000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How does that provide wallet support?",
        "created_at": "2021-02-23T05:51:43.842000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You could sign a transaction-like package with the same calls as signing an EIP-712 message I guess",
        "created_at": "2021-02-23T05:52:20.940000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That is not a compelling reason for me, especially given how much bigger the payload would need to be or how much more complexity you would introduce in code that executes inside the EVM to construct the thing to sign over.",
        "created_at": "2021-02-23T05:53:20.522000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I thought EIP-712 was a constant abi-encoded with the fields?",
        "created_at": "2021-02-23T05:53:58.133000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I haven't used it in a hot minute, so I might be mistaken.",
        "created_at": "2021-02-23T05:54:09.181000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "712 is too many things IMO.  ðŸ˜¢",
        "created_at": "2021-02-23T05:54:24.988000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "lol, yeah.",
        "created_at": "2021-02-23T05:54:31.984000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Has it been completed yet?",
        "created_at": "2021-02-23T05:54:38.653000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Still draft.",
        "created_at": "2021-02-23T05:54:48.232000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ugh, that's a reason to avoid it.",
        "created_at": "2021-02-23T05:55:03.299000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(On that note, I don't mind the idea of prefixing it with a byte to further mitigate collision attacks.)",
        "created_at": "2021-02-23T05:56:09.736000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This should definitely have a TransactionType (EIP-2718).",
        "created_at": "2021-02-23T05:56:36.042000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In fact, I would outright oppose it without that.",
        "created_at": "2021-02-23T05:56:48.671000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Like reserving a transaction type for it?",
        "created_at": "2021-02-23T05:57:03.431000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah.",
        "created_at": "2021-02-23T05:57:06.629000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But not implementing it like one",
        "created_at": "2021-02-23T05:57:08.214000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, I'm fine with that.",
        "created_at": "2021-02-23T05:57:16.706000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It needs the number and it needs to follow the signing rules.  But it doesn't show up in block bodies or receipts so it wouldn't technically be a 2718 transaction.",
        "created_at": "2021-02-23T05:57:31.203000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Noted it down for my next pass.",
        "created_at": "2021-02-23T05:58:54.147000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Invoker:\n```ts\nfunction sponsor(\n    bool yParity,\n    uint256 r,\n    uint256 s,\n    bytes32 extra,\n    uint64 mingas,\n    address to,\n    uint256 value,\n    address invoker,\n    bytes data\n) {\n    data = abiencode(yParity, r, s, extra, mingas, to, value, invoker, data);\n    gas = signed_data.mingas + PRECOMPILE_GAS_OVERHEAD;\n    require(call(gas, CALL_PRECOMPILE, value, data, data.length));\n}\n```\n`CALL_PRECOMPILE` pseudocode:\n```ts\nfunction call_precompile(\n    bool yParity,\n    uint256 r,\n    uint256 s,\n    bytes32 extra,\n    uint64 mingas,\n    address to,\n    uint256 value,\n    address invoker,\n    bytes data\n) returns (bool) {\n    gas_provided = gasleft();\n    require(mingas \u003c= gas_provided);\n    require(invoker == msg.sender);\n    require(value == msg.value);\n    signed_data = abi_encode(extra, mingas, to, value, invoker, data);\n    address caller = recover(yParity, r, s, keccak256(TYPE || signed_data));\n    // NOTE: caller() == caller within the following call\n    return to.call(gas_provided, to, value, data, data.length);\n}\n```",
        "created_at": "2021-02-23T06:15:41.331000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Would you still encode chainid in there?",
        "created_at": "2021-02-23T06:16:41.270000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "No, I still think chainid should be a problem for the sponsor, not call_precompile.",
        "created_at": "2021-02-23T06:16:59.168000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Notes from above:\n~~abi_encode rather than RLP encode.  RLP decoding in the EVM is a pain, ABI decoding is not.  I would also accept SSZ.  ðŸ˜„~~",
        "created_at": "2021-02-23T06:18:32.099000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "~~Specifically, it needs to be easy for the sponsor to be able to pluck data out of the signed_data structure, so we don't want that to come into the contract as RLP.  We also need to be able to pass the signed data to the call in a consistent format, and ABI encoding is *usually* how this is done in the EVM.~~",
        "created_at": "2021-02-23T06:19:58.060000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "~~I wouldn't be opposed to avoiding tuples here if that simplifies things substantially.~~",
        "created_at": "2021-02-23T06:20:42.805000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "~~```\nabi_encode(yParity, r, s, extra, mingas, to, value, invoker, data)\n```~~",
        "created_at": "2021-02-23T06:21:35.937000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "* Signature is up front, and data (the only variable length field) last.  Just makes some things a bit simpler in various places.",
        "created_at": "2021-02-23T06:22:07.836000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "* `yParity` and not `v`.  We should be getting rid of the concept of `v` anywhere we can, and 2930 and 1559 both have dropped it in favor of `yParity`.",
        "created_at": "2021-02-23T06:22:31.162000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "* Naming: `mingas` rather than `gaslimit` to better show what exactly it represents.",
        "created_at": "2021-02-23T06:23:10.909000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "* 2718 `TYPE` is the first byte in the signature.",
        "created_at": "2021-02-23T06:23:45.170000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "* code above uses `abi_encode(signed_data)` for the signature, but I'm a bit ambivalent.  I have a mild preference for `abi_encode` since it is generally easier to construct by hand and we don't care about size compression.",
        "created_at": "2021-02-23T06:25:31.666000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Hmm... \u003c@689161464829050960\u003e doesn't this spec allow someone to call functions from random addresses?  Is there any problem with that?",
        "created_at": "2021-02-23T06:33:56.113000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think it isn't a problem.",
        "created_at": "2021-02-23T06:34:26.435000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Couldn't you call functions from random addresses anyways?",
        "created_at": "2021-02-23T06:57:31.457000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you have a private key for them, yes.",
        "created_at": "2021-02-23T06:58:01.439000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If someone can call `withdraw` on some random erc20 token, from the `0x00..` address, that'd be a problem",
        "created_at": "2021-02-23T06:58:15.410000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "You can't control the from address, just that you don't actually need the private key for it.",
        "created_at": "2021-02-23T06:58:33.064000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But maybe I'm missing some detail?",
        "created_at": "2021-02-23T06:58:35.004000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, you'd still need to brute-force to get a particular address",
        "created_at": "2021-02-23T06:58:43.794000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Essentially the issue is that you can recover pretty much *any* inputs and you'll get *an address* out the other side.",
        "created_at": "2021-02-23T06:59:03.623000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`recover(false, randomNumber, randomNumber, randomNumber)` will in many cases yield a valid address out.",
        "created_at": "2021-02-23T07:00:05.122000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So that precompile above internally calls another precompile?",
        "created_at": "2021-02-23T07:00:15.147000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "No, what I have above is just a pseudocode.",
        "created_at": "2021-02-23T07:00:29.009000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Not necessarily, but it does verify a signature",
        "created_at": "2021-02-23T07:00:38.046000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "*recover an address from a signature",
        "created_at": "2021-02-23T07:00:48.485000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, that.",
        "created_at": "2021-02-23T07:00:59.923000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We actually *don't* want to use the `ecrecover` precompile because that one is malleable (there are two valid signatures for any given data, and you can get one signature from the other).",
        "created_at": "2021-02-23T07:01:36.791000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "ðŸ¤” actually, maybe with the changes we discussed most recently that is no longer the case.",
        "created_at": "2021-02-23T07:02:15.739000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@689161464829050960\u003e Are you interested in pushing for this in London?",
        "created_at": "2021-02-23T07:02:25.470000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If there's enough interest, for sure",
        "created_at": "2021-02-23T07:03:01.092000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I actually have a call tomorrow to get some feedback.",
        "created_at": "2021-02-23T07:03:15.248000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "... later today.",
        "created_at": "2021-02-23T07:03:20.746000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm definitely interested.  The lack of sponsored transactions has been a thorn in the side of dapps for quite some time.",
        "created_at": "2021-02-23T07:03:21.759000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think it'd be worth going for london then ðŸ™‚",
        "created_at": "2021-02-23T07:04:51.359000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Let me know if you want help on making any of the changes I proposed above to the EIP, or shepherding it through the EIP process.  The quicker we can get to Review state, the more likely we'll be able to get included in Berlin.",
        "created_at": "2021-02-23T07:10:34.088000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Will do!",
        "created_at": "2021-02-23T07:19:48.956000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I've been thinking a bit about how EIP-3074 could be implemented in geth, I see two things that would make it easier to implement:\n\n- The current `PrecompiledContract` interface assumes precompiles are \"pure\" functions w/o any side effects and static gas costs, I think it'd probably be cleaner to define a new interface for precompiles that need a reference to the EVM itself and consume a variable amount of gas.  `evm.precompile` would then maybe return an enum instead of `isPrecompile bool` (and probably need to be renamed).\n- Currently `Message` assumes that `from` is the caller, might be cleaner to have separate `.From()` and `.Caller()` accessors that for current txs always return `from` but at least signal the intended usage.  Or maybe caller needs to be a field on the EVM instance that the 3074 precompile could update (and revert once the inner message is processed), not sure which is cleaner.",
        "created_at": "2021-02-23T23:50:39.026000+00:00",
        "attachments": null
    }
]