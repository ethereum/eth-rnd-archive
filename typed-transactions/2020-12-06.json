[
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have been thinking about the current spec a bit more (option A) and I'm starting to un-convince myself that it is incompatible with Option B of \u003c@!206016661470314496\u003e's devp2p proposals that we decided to go with.",
        "created_at": "2020-12-06T03:07:56.310000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "We could say that `[nonce1, ...]` is still valid and to be interpreted as a legacy transaction, but `rlp([nonce1, ...])` is *also* valid and strongly preferred after fork block.  We could even go so far as to say that something like `n` weeks after the fork block clients can stop supporting `[nonce1, ...]` which is a step toward what the Geth team wants in terms of removing old networking code paths.",
        "created_at": "2020-12-06T03:10:29.787000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!543900561460822016\u003e Reading over your original argument for option C, I think I may have mis-represented it.",
        "created_at": "2020-12-06T03:31:22.398000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Which of these aligns with what you were thinking?\n```py\nrlp_encode([\n    [nonce1, ...],\n    0x01,\n    rlp_encode([chainId2, nonce2, ...]),\n    [nonce3, ...],\n    0x01,\n    rlp_encode([chainId4, nonce4, ...]),\n)]\n``````py\nrlp_encode([\n    [nonce1, ...],\n    0x01,\n    [chainId2, nonce2, ...],\n    [nonce3, ...],\n    0x01,\n    [chainId4, nonce4, ...],\n)]\n```",
        "created_at": "2020-12-06T03:32:11.316000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I was thinking the second",
        "created_at": "2020-12-06T03:32:49.708000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That won't work past Berlin because 2718 transaction payloads are not all RLP.",
        "created_at": "2020-12-06T03:33:28.875000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Though, I suppose we don't *have* to share encoding between devp2p and hashing and signing.  ü§î",
        "created_at": "2020-12-06T03:34:07.801000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "technically there shouldn't be a difference between the two examples you have",
        "created_at": "2020-12-06T03:34:30.885000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I do think I have had it stuck in my head that we need to share encoding schemes across different parts of the system (signing, transport, block), but that isn't necessarily true.",
        "created_at": "2020-12-06T03:34:40.214000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "unless you mean `rlpBytes` for the inner list",
        "created_at": "2020-12-06T03:34:49.818000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What does `rlp(...)` mean to you?",
        "created_at": "2020-12-06T03:35:01.790000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Maybe I should change that to `rlp_encode(...)` for clarity?",
        "created_at": "2020-12-06T03:35:12.840000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Anywhere I put `rlp(...)` I mean `rlp_encode(...)` which is a function that returns a byte array.",
        "created_at": "2020-12-06T03:35:27.599000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "that confuses me because there are bytes which represent rlp and then there are bytes which are encoded *in* the rlp as a byte string",
        "created_at": "2020-12-06T03:36:03.749000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "i have encoded the typed tx payload as an rlp item with a list length prefix",
        "created_at": "2020-12-06T03:36:32.185000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "these are those raw bytes https://gist.github.com/lightclient/af944a74f6e8debcbb1232ac007df3cc",
        "created_at": "2020-12-06T03:36:58.362000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```ts\ntype RlpItem = RlpItem[] | ByteArray\nfunction rlp_encode(item: RlpItem): ByteArray\n```",
        "created_at": "2020-12-06T03:37:44.337000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think you are the only one who can read encoded RLP directly with your eyeballs.  üò¨",
        "created_at": "2020-12-06T03:38:36.164000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'll change to `rlp_encode` to add more clarity.  Though, I find it surprising that you see `rlp(...)` as a no-op when it shows up inside another `rlp(...)`.  I would be curious to better understand why you make that assumption.  I'm guessing it has something to do with the way your encoder/decoder is written?",
        "created_at": "2020-12-06T03:40:13.251000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(note ‚òùÔ∏è is purely to satiate my curiosity)",
        "created_at": "2020-12-06T03:41:20.071000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "actually, I thought there was a conversation a while back where someone said that `rlp([x, rlp([y, z])])` was the same as `rlp([x, [y, z]])` so there was no need for the inner `rlp` but now I can't find any reference to that!",
        "created_at": "2020-12-06T03:50:36.796000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Perhaps you are thinking of SSZ where that *is* a major feature?",
        "created_at": "2020-12-06T03:51:31.652000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If I allow myself to be open to the idea of having different transport encoding vs merklization encoding vs hash encoding, then I think there is another option available:\n```py\nrlp_encode([\n    [nonce1, ...],\n    [1, [chainId2, nonce2, ...]],\n)]\n```",
        "created_at": "2020-12-06T03:52:20.085000+00:00",
        "attachments": []
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm not sure I agree with this though - we should be switching off the tx type to determine how to decode the payload. Once we see it is an rlp decoder, we can decode it immediately - we shouldn't need to first decode and rlp byte list",
        "created_at": "2020-12-06T03:52:38.123000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The problem with this and your suggestion is that it means we need to define devp2p encoding separately for *every* new typed transaction.",
        "created_at": "2020-12-06T03:52:57.603000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This isn't the end of the world, but I do find it a bit unfortunate.  If we share a devp2p encoding with merklization encoding then we don't need to define multiple encoding mechanisms for every typed transaction.",
        "created_at": "2020-12-06T03:54:25.305000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I *think* you are assuming that everyone does manual stream decoding?  This strategy very much will not work for my RLP decoder for example.",
        "created_at": "2020-12-06T03:54:57.592000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "For example, my RLP decoder (not a stream decoder) simply is `function rlp_decode(bytes: ByteArray): RlpItem`.",
        "created_at": "2020-12-06T03:56:46.386000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "*grumble* we also need to define how typed transactions are hashed I think.",
        "created_at": "2020-12-06T04:02:48.129000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I thought I defined this somewhere, but now I can't find it.  üò¢",
        "created_at": "2020-12-06T04:03:04.246000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "My gut tells me that the client devs aren't going to like having a different encoding for hashing, merklization, and devp2p.  The idea is growing on me personally though.",
        "created_at": "2020-12-06T04:06:42.724000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@213672586264051717\u003e Which of these did you implement?  https://discordapp.com/channels/595666850260713488/779922457631916064/784985515899486209",
        "created_at": "2020-12-06T04:17:00.841000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@543900561460822016\u003e can you check out https://github.com/ethereum/pm/issues/231#issuecomment-739465644 and provide feedback?  I'm trying to simplify the discussion as much as possible so we can (hopefully) resolve this issue rapidly.",
        "created_at": "2020-12-06T07:14:18.570000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(the linked comment specifically)",
        "created_at": "2020-12-06T07:14:29.594000+00:00",
        "attachments": []
    },
    {
        "author": "0xraino",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I took \u003c@!543900561460822016\u003e 's block rlp and tried to parse it. While I had to fix an unrelated bug and I haven't implemented 2930 yet, I can confirm that it would parse it correctly.",
        "created_at": "2020-12-06T18:48:21.836000+00:00",
        "attachments": []
    }
]