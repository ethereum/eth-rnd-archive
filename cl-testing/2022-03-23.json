[
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Is there a write up somewhere of how a shadow fork works under the hood ?",
        "created_at": "2022-03-23T02:33:34.819000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "We sync el nodes on the normal chain, and deploy a deposit contract with all the validators that we want. Then we set the ttd on our nodes. Our nodes will see if ttd is hit and tell our cl nodes. Our cl nodes will start creating the pos chain. The normal chain will just move on, basically as if not enough miners updated their nodes. We've seen on our last shadow fork that the two networks will stay connected, s.th. transactions from goerli will also be executed on our fork. Since they might be ordered differently, the state of the network will diverge over time",
        "created_at": "2022-03-23T06:02:36.222000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "",
        "created_at": "2022-03-23T07:28:32.066000+00:00",
        "attachments": [
            {
                "type": "image/jpeg",
                "origin_name": "IMG_20220323_082825_869.jpg",
                "content": "fec39b7fe77cf98de52547e2372b6b482d540bf41705abf73bffca9cecbb23d0"
            }
        ]
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Thanks for the summary ! Once the EL nodes switch over to pos mode with the beacon, wouldn't the other 'normal' EL nodes kick them out for being on a fork ? Ex: Normal node performing a handshake would reject the shadow nodes as they have a different fork-id",
        "created_at": "2022-03-23T07:42:44.868000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "EL clients in the shadow fork should maintain the same `chainId` and `networkId` to stay connected and be able to replay transactions between blocks.",
        "created_at": "2022-03-23T08:00:43.770000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "\u003e Our nodes will see if ttd is hit and tell our cl nodes\nThis sounds like a deviation from the EIP. Why not set TTD into the future and wait while it hits as it would be in a normal transition scenario?",
        "created_at": "2022-03-23T08:01:58.008000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Would these shadow EL nodes cause issues for normal EL nodes ? Ex: They return requests with blocks from the shadow chain to nodes following the normal chain. Nodes try to process these blocks but can't because of altered consensus rules in the shadow fork.",
        "created_at": "2022-03-23T08:06:17.657000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "Yeah, I see what you mean. Post-Merge difficulty remains the same and new node that is connecting to the network should favour regular goerly nodes because their TD will be bigger than TD advertised by nodes that are in PoS network. This is just my guess from how a node observes the network in PoW/Clique and makes a decision on what to sync with. \u003c@!360491619402776577\u003e must know better",
        "created_at": "2022-03-23T08:09:33.610000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "afaik the `mergeForkBlock` param in the modified genesis.json means that the EL would be on a different fork and wouldn't actively peer with the canonical goerli nodes but it'll stay connected and listen to gossip",
        "created_at": "2022-03-23T09:15:44.694000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "How does that work though ? not being actively peered with goerli nodes but still being able to listen and propagate tx traffic",
        "created_at": "2022-03-23T09:17:02.325000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "that sounds like a marius question to me, so I'll hit passüòÖ",
        "created_at": "2022-03-23T09:17:21.825000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "Oh, it actually means that nodes will disconnect once forkId doesn't match as \u003c@!476250636548308992\u003e has mentioned",
        "created_at": "2022-03-23T09:26:06.535000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Yes",
        "created_at": "2022-03-23T09:40:01.941000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Thats why we don't activate the mergeForkBlock on shadow forks",
        "created_at": "2022-03-23T09:40:25.416000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Since we don't have peer scoring on the el the nodes will not disconnect each other",
        "created_at": "2022-03-23T09:40:53.183000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "And they correctly handle \"invalid\" blocks from the other chain",
        "created_at": "2022-03-23T09:41:28.983000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "I'll write a longer answer, am donating blood atm",
        "created_at": "2022-03-23T09:41:49.552000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Yes exactly new nodes will favor nodes with a higher td, however we will not evict nodes with a low td, otherwise these nodes could never sync up to the network",
        "created_at": "2022-03-23T10:31:38.566000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "That makes sense, so according to all the other goerli nodes the shadow nodes are still in the same fork and network. Even if the shadow fork nodes are propagating invalid blocks(according to the normal nodes) they are rejected by the normal nodes and the normal chain continues without issues.",
        "created_at": "2022-03-23T11:52:36.339000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "\u003e they are rejected by the normal nodes and the normal chain continues without issues.\n\nThis is what worries me a bit in shadow forking Mainnet. Ideally, our mainnet shadow network should be isolated but the complexity of isolating it might be too high",
        "created_at": "2022-03-23T13:01:12.029000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "There is no way we can impact mainnet with shadow forking. We would need to run a significant number of nodes for that.\nIf this were possible, we wouldve seen lots and lots of attacks on mainnet already",
        "created_at": "2022-03-23T13:20:09.629000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "Agreed, if we have a comparatively negligible number of nodes then it should be fine",
        "created_at": "2022-03-23T13:22:53.963000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "now we support websocket",
        "created_at": "2022-03-23T16:12:49.480000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "nice, that should make Nimbus/Erigon nodes much more stable, pending Nimbus fixing that bug",
        "created_at": "2022-03-23T16:13:30.306000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "you need the `--ws` flag in Erigon",
        "created_at": "2022-03-23T16:13:43.680000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "what ports does it use (JWT, non-JWT, etc)?",
        "created_at": "2022-03-23T16:14:12.278000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "non-jwt: 8550",
        "created_at": "2022-03-23T16:14:23.849000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "jwt: 8551",
        "created_at": "2022-03-23T16:14:36.271000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Testing",
        "parent": "",
        "content": "If this happens to cause an issue, geth for example supports ` --whitelist` (recently renamed to `--eth.requiredblocks` in master) that can be used to drop peers w/ a non-matching block hash.  So if for example the shadow fork blocks cause too much disruption on the real goerli chain node operators can add `--eth.requiredblocks XXXX=YYYYY` where XXXX is a block number after the divergence and YYYY is the canonical hash on the real chain.  Not sure if other ELs have a similar feature.  We use this feature on ropsten since there was an invalid chain still being mined (IIRC some old miners kept running after the London or Berlin fork, I forget which).",
        "created_at": "2022-03-23T16:22:54.361000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Since they use different fork choice rules and the rules of the respective other chains are not valid, we can not use `requiredblocks` for this.\n`requiredblocks` is only useful if you have two competing **valid** blocks under the same fork choice.\nThe shadow chain blocks are invalid on the real network and vice versa, so they get dropped super quickly.\nThe only issue that could arise is if our nodes would eclipse mainnet nodes, s.th. the mainnet nodes only have peers that drop the mainnet blocks, but this is very very unlikely",
        "created_at": "2022-03-23T16:27:25.252000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Testing",
        "parent": "",
        "content": "Ah ok I misunderstood that the two chains would be \"interoperable\" until some tx ordering or other difference caused them to diverge",
        "created_at": "2022-03-23T16:36:23.161000+00:00",
        "attachments": null
    },
    {
        "author": "diegolosada",
        "category": "Testing",
        "parent": "",
        "content": "Tested and it works great. Thks.",
        "created_at": "2022-03-23T16:51:23.552000+00:00",
        "attachments": null
    },
    {
        "author": "phi.go",
        "category": "Testing",
        "parent": "",
        "content": "motivated by \u003c@!291925846556540928\u003e and the latest FInalized... is there anything I can do, testing-wise, with a system that only has a 250 GB SSD in? It's the only solid state storage I have lying around right now outside of my actual validator rig. I haven't run a test net since Medalla and I don't remember how the size requirements compared to main net...",
        "created_at": "2022-03-23T19:48:36.936000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "Testing",
        "parent": "",
        "content": "Kiln is definitely much less than 250GB!",
        "created_at": "2022-03-23T19:49:27.712000+00:00",
        "attachments": null
    },
    {
        "author": "phi.go",
        "category": "Testing",
        "parent": "",
        "content": "ok thanks, i know what i'm doing tomorrow then üôÇ",
        "created_at": "2022-03-23T19:50:46.451000+00:00",
        "attachments": null
    },
    {
        "author": "timbeiko",
        "category": "Testing",
        "parent": "",
        "content": "Ethstaker has some tutorials, and there are high level instructions linked in the EF blog post about Kiln üòÑ",
        "created_at": "2022-03-23T19:51:27.168000+00:00",
        "attachments": null
    },
    {
        "author": "phi.go",
        "category": "Testing",
        "parent": "",
        "content": "yup, thanks, the \"how\" won't an issue, just the \"whether or not i could with the hardware i have at my fingertips\"",
        "created_at": "2022-03-23T19:52:57.123000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "üôå \n\nAnd like I've said in other places, put your open source contributor hat on when you run through it all. Is something broken? Report it. Is the tutorial dated with an old cli flag? Make a PR! Etc etc",
        "created_at": "2022-03-23T20:50:55.335000+00:00",
        "attachments": null
    },
    {
        "author": "galaxybloom.",
        "category": "Testing",
        "parent": "",
        "content": "My pre-merge version of Kiln actually got pretty close to 250GB ... maybe I had something in the setup wrong but it was a fresh VM with a completely fresh install.  üßê",
        "created_at": "2022-03-23T21:12:23.977000+00:00",
        "attachments": null
    },
    {
        "author": "galaxybloom.",
        "category": "Testing",
        "parent": "",
        "content": "do you have any suggestions for those of us who are not in the dev world to help with this? i followed the instructions and set up a working, deposited validator just before the merge on Kiln, and found some errors in the flow of the instruction pages (some to outdated golang, etc.) but I'm not quite there to know how to \"pull a PR\" and don't know where/how to best report what I know.",
        "created_at": "2022-03-23T21:13:51.393000+00:00",
        "attachments": null
    },
    {
        "author": "galaxybloom.",
        "category": "Testing",
        "parent": "",
        "content": "I know that I could be useful in translating my own tech nerd experience with setting up a node, not knowing much about the dev side, but I'm just not clear on where/how to jump in at the level I'm at.",
        "created_at": "2022-03-23T21:15:39.133000+00:00",
        "attachments": null
    },
    {
        "author": "galaxybloom.",
        "category": "Testing",
        "parent": "",
        "content": "I know enough CLI to get myself in trouble and to follow well-built instructions, and to troubleshoot errors in such instructions, but also have the perspective of someone who is somewhat flailing blindly in the dark ... which is how a lot of new validators might feel in getting things set up. but I want people to know it's completely doable even if you really don't know wtf you are doing. üòÖ",
        "created_at": "2022-03-23T21:19:03.254000+00:00",
        "attachments": null
    },
    {
        "author": "marioevz",
        "category": "Testing",
        "parent": "",
        "content": "Hey \u003c@!360491619402776577\u003e , geth is crashing on my kurtosis testnet (parithoshj/geth:merge-87d642d is the image) with this error:\n`panic: runtime error: index out of range [-1]\n\ngoroutine 20575 [running]:\ngithub.com/ethereum/go-ethereum/core.(*HeaderChain).ValidateHeaderChain(0xc000214510, {0xc00540a580, 0xf993bb3d522e840\n0, 0x4}, 0x1)\n        github.com/ethereum/go-ethereum/core/headerchain.go:340 +0xab2\ngithub.com/ethereum/go-ethereum/core.(*BlockChain).InsertHeaderChain(0xc0002ca400, {0xc00540a580, 0x0, 0x4}, 0xc00664$\nc60)\n        github.com/ethereum/go-ethereum/core/blockchain.go:2300 +0xb3                                                 \ngithub.com/ethereum/go-ethereum/eth/downloader.(*Downloader).processHeaders(0xc00003c180, 0x1, 0xc0004b7e40, 0xc000046780, 0x0)\n        github.com/ethereum/go-ethereum/eth/downloader/downloader.go:1377 +0x9df\ngithub.com/ethereum/go-ethereum/eth/downloader.(*Downloader).syncWithPeer.func7()\n        github.com/ethereum/go-ethereum/eth/downloader/downloader.go:584 +0x31\ngithub.com/ethereum/go-ethereum/eth/downloader.(*Downloader).spawnSync.func1()\n        github.com/ethereum/go-ethereum/eth/downloader/downloader.go:605 +0x70\ncreated by github.com/ethereum/go-ethereum/eth/downloader.(*Downloader).spawnSync\n        github.com/ethereum/go-ethereum/eth/downloader/downloader.go:605 +0x65`\n\nIs this the same error you saw a couple days ago ?",
        "created_at": "2022-03-23T21:54:38.209000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Yes, that should be fixed in the current master",
        "created_at": "2022-03-23T21:55:29.268000+00:00",
        "attachments": null
    },
    {
        "author": "marioevz",
        "category": "Testing",
        "parent": "",
        "content": "ok thanks! üòÑ",
        "created_at": "2022-03-23T21:57:22.586000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "I can build a new image and update the docs in the morning üôÇ",
        "created_at": "2022-03-23T22:09:03.610000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "It depends on the issue you run into on where to fix it. If it was a notes/hackmd doc, ping me or \u003c@!552133098075193354\u003e to find the right place to edit. If it's github, that's the place! you can open an \"issue\" or if you know how to fix it make a code change with a \"pull request\"",
        "created_at": "2022-03-23T23:19:04.469000+00:00",
        "attachments": null
    }
]