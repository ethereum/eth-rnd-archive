[
    {
        "author": "iannorden",
        "category": "general",
        "parent": "",
        "content": "Hi all, another question. While decoding individual storage node rlps, I very rarely run across a node\nthat fails to decode into [][]byte or []interface{}. \n\nWhen decoding into []byte these nodes will immediately throw an “rlp: expected input string or byte for []uint8, decoding into ([][]uint8)[14]”.\n\nWhen decoding into []interface{} the initial decoding works, but then when I iterate over the elements and type assert them to []byte (as is done here https://github.com/ipfs/go-ipld-eth/blob/master/trie_node.go#L127) I get a panic: \"panic: interface conversion: interface {} is []interface {}, not []uint8\"\n\nUpon closer inspection I can see that this is because one of the elements of the branch node does not decode into a single byte array, but instead an array of byte arrays.\n\nSpecifically, for example, at block 10041344 the storage branch node at path 0b000f060b0f0700 for the state account at leafkey 0x0f27a427a06c148ea9a08f515db9ba0cdcfc7260580a2e512385db59487acd14 I am unable to decode the branch node element at position 14 into []byte, the actual value is a byte array: [[54 67 156 56 255 153 112 176 185 21 62 239 27 79 212 212 90 175 240 252 0 192 203 46 180 91 154 233] [1]]\n\n\u003c@!211091239112671234\u003e any insight into the above two questions would be much appreciated!",
        "created_at": "2020-05-12T14:42:31.065000+00:00",
        "attachments": null
    },
    {
        "author": "s1na",
        "category": "general",
        "parent": "",
        "content": "\u003e Upon closer inspection I can see that this is because one of the elements of the branch node does not decode into a single byte array, but instead an array of byte arrays.\n\nif a child's bytelength is smaller than 32, instead of the hash the node itself is embedded in the parent",
        "created_at": "2020-05-12T14:45:25.242000+00:00",
        "attachments": null
    },
    {
        "author": "iannorden",
        "category": "general",
        "parent": "",
        "content": "Thank you \u003c@!259648573401071617\u003e !",
        "created_at": "2020-05-12T14:46:24.475000+00:00",
        "attachments": null
    },
    {
        "author": "iannorden",
        "category": "general",
        "parent": "",
        "content": "Is there a way you would recommend handling this when attempting to \"generically\" decode all nodes?",
        "created_at": "2020-05-12T14:46:47.544000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "general",
        "parent": "",
        "content": "'genericaly' this is needed.. however, if you write a trie for only the main account trie, then you don't need to bother with it. For storage tries, it's required, though",
        "created_at": "2020-05-12T14:49:50.577000+00:00",
        "attachments": null
    },
    {
        "author": "s1na",
        "category": "general",
        "parent": "",
        "content": "Martin can correct me, but i think this is the relevant part in geth:\nhttps://github.com/ethereum/go-ethereum/blob/master/trie/node.go#L186",
        "created_at": "2020-05-12T14:54:33.043000+00:00",
        "attachments": null
    },
    {
        "author": "iannorden",
        "category": "general",
        "parent": "",
        "content": "Thank you both! While I have your attention could I get some help with my above EIP-158 question- when an account is removed, if its leaf node was previously referenced in a branch node element-  I assume that reference reverts to an empty []byte not crypto.Keccak256(rlp.EncodeToBytes([]byte{}))?",
        "created_at": "2020-05-12T14:59:22.670000+00:00",
        "attachments": null
    },
    {
        "author": "s1na",
        "category": "general",
        "parent": "",
        "content": "afaik eip-158 doesn't change trie logic, so removing an empty account is equivalent to removing an item from the trie. So the branch child should become empty []byte",
        "created_at": "2020-05-12T15:07:01.428000+00:00",
        "attachments": null
    },
    {
        "author": "iannorden",
        "category": "general",
        "parent": "",
        "content": "Great, thank you \u003c@!259648573401071617\u003e , that makes sense!",
        "created_at": "2020-05-12T15:09:32.661000+00:00",
        "attachments": null
    }
]