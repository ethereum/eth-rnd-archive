[
    {
        "author": "tbenr",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Hey, one question. When we do the state upgrade (applies to Capella as well as Eip4844) we should set in the new Capella latest ExecutionPayloadHeader. So it needs to be upgraded too. We should set new fields with ZERO values, right?",
        "created_at": "2022-11-16T10:16:46.075000+00:00",
        "attachments": []
    },
    {
        "author": "tbenr",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "ah yes, i see it in the spec https://github.com/ethereum/consensus-specs/blob/dev/specs/capella/fork.md",
        "created_at": "2022-11-16T10:20:53.826000+00:00",
        "attachments": []
    },
    {
        "author": "tbenr",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "never mind",
        "created_at": "2022-11-16T10:21:09.215000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Okay now this is an entirely different discussion\n\nBut I'm wondering why the execution API is designed so that you can call the new `V2` methods before the fork?",
        "created_at": "2022-11-16T16:22:53.224000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "As currently written, the definition of `ExecutionPayloadV2`:\nhttps://github.com/ethereum/execution-apis/blob/main/src/engine/specification.md#executionpayloadv2\ncontradicts the specification of `engine_newPayloadV2`:\nhttps://github.com/ethereum/execution-apis/blob/main/src/engine/specification.md#specification-1\n\nThe specification of `engine_newPayloadV2` implies that the `withdrawals` field is not an `Array of WithdrawalV1` but an `Option\u003cArray of WithdrawalV1\u003e` because the field can be `null`. It heavily implies that a `ExecutionPayload::Merge` serializes to an `ExecutionPayloadV2` by setting `withdrawals` to `null` while an `ExecutionPayload::Capella` serializes to an `ExecutionPayloadV2` by setting `withdrawals` to `non-null`\n\nI say heavily implies because it doesn't explicitly say that, instead saying to you `null` or `non-null` depending on \"if withdrawals are activated\" which I assume is a statement about what fork the payload belongs to and not a statement about whether we've enabled withdrawals functionality on that testnet (because some 4844 testnets will disable withdrawals)",
        "created_at": "2022-11-16T16:33:17.335000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "While the specification of `engine_newPayloadV2` seems to give strict requirements for how an `ExecutionPayload::Merge` and an `ExecutionPayload::Capella` should serialize into an `ExecutionPayloadV2`, the same requirements are NOT included in the specification of the response from `engine_getPayloadV2`, which returns an `ExecutionPayloadV2`.\n\nSo exactly how the consensus client is supposed to know which fork to deserialize the `ExecutionPayloadV2` into is not defined",
        "created_at": "2022-11-16T16:50:18.449000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "the idea is that users can upgrade w/o worrying about the fork timing",
        "created_at": "2022-11-16T16:51:05.497000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "devs cut release, users upgrade and have the new logic but if it is called before there are any withdrawals, the API needs to represent that somehow",
        "created_at": "2022-11-16T16:51:42.898000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "hmm i don't follow about your point for the `newPayloadV2` spec vs `getPayloadV2` spec",
        "created_at": "2022-11-16T16:53:40.166000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "we can add a note about handling the empty vs null withdrawals?",
        "created_at": "2022-11-16T16:54:24.548000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "by `Merge` I mean the `Bellatrix` fork, and by `Capella` I mean the the fork where withdrawals are activated, even if we've disabled them for `4844` testing by making `get_expected_withdrawals` always return `[]`\nokay a couple direct questions:\n1) by \"if withdrawals are activated\" does the API mean \"if this is an `ExecutionPayload::Capella` and not an `ExecutionPayload::Merge`\"",
        "created_at": "2022-11-16T16:56:47.159000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "i'd say so",
        "created_at": "2022-11-16T16:59:31.945000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "this was my second direct question:\n\nThere appears to be an implied requirement on the execution side that the `ExecutionPayloadV2` returned by `engine_getPayloadV2` set `withdrawals` to `null` if this is a `ExecutionPayload::Merge` and set `withdrawals` to `non-null` if this is an `ExecutionPayload::Capella`",
        "created_at": "2022-11-16T16:59:43.596000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "The answer to this question has implications for how the consensus side deserializes the payload so I'd say this requirement should be made explicit if it's real. And perhaps both specifications should speak in terms of forks instead of in terms of \"if withdrawals are enabled\"",
        "created_at": "2022-11-16T17:00:35.299000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "sure, you are interpreting the current spec correctly",
        "created_at": "2022-11-16T17:05:08.760000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "i can make a PR to make that part clearer on `getPayload`",
        "created_at": "2022-11-16T17:05:20.011000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Okay then this also has implications for future forks. Lets suppose `4844` is not included into `Capella` and is instead its own fork. In that case there will be an `ExecutionPayloadV3` with new fields that are nullable. There will be corresponding `engine_newPayloadV3` and `engine_getPayloadV3` requests.\n\nThe question is, will the new `V3` objects and methods (`newPayloadV3`,`getPayloadV3`,`ExecutionPayloadV3`) be designed so that:\n\n1) it can handle all 3 forks, `ExecutionPayload::Merge`, `ExecutionPayload::Capella` and `ExecutionPayload::4844` \n2) it will only handle `ExecutionPayload::Capella` and `ExecutionPayload::4844`.",
        "created_at": "2022-11-16T17:13:05.940000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "the difference between `1` and `2` is whether or not `withdrawals` will be a nullable field in `ExecutionPayloadV3`",
        "created_at": "2022-11-16T17:13:45.464000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "The answer to this question again has implications for how the consensus side will serialize and deserialize the objects",
        "created_at": "2022-11-16T17:14:34.899000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "i'd say v3 assumes withdrawals are always there",
        "created_at": "2022-11-16T17:18:56.358000+00:00",
        "attachments": []
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "you think a PR to clarify `getPayloadV2` is helpful \u003c@554799849288105986\u003e ?",
        "created_at": "2022-11-16T17:22:06.334000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yeah I think that would be good.",
        "created_at": "2022-11-16T18:12:55.004000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I'd have said that V3 should be designed to work with all hard forks. Otherwise you can't ever drop support for earlier versions and we wind up carrying a heap of legacy APIs around forever.\n\nie the reason you can call V2 prior to Capella activating isn't really about ease of deployment, it's so that post-Capella we can remove V1 entirely.",
        "created_at": "2022-11-16T21:02:51.128000+00:00",
        "attachments": []
    }
]