[
    {
        "author": "agemanning",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Oh yeah, we've not implemented this yet. But when we do, I imagine there will be no difference in structure to the other rpc req/resp",
        "created_at": "2022-10-28T00:06:19.865000+00:00",
        "attachments": []
    },
    {
        "author": "mikeneuder",
        "category": "Consensus Layer",
        "parent": "",
        "content": "https://github.com/ledgerwatch/erigon/issues/5884 has a bit more context.",
        "created_at": "2022-10-28T00:08:02.105000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "i mean it is just weird that it takes six bytes to repressent ~25000 length",
        "created_at": "2022-10-28T00:10:46.498000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "but maybe it has new weird prefix for lightclient stuff?",
        "created_at": "2022-10-28T00:11:14.016000+00:00",
        "attachments": []
    },
    {
        "author": "agemanning",
        "category": "Consensus Layer",
        "parent": "",
        "content": "So for all req-resp the encoding-header is just a protobuf varint representing the length of the payload. Its size is dynamic.",
        "created_at": "2022-10-28T00:22:45.298000+00:00",
        "attachments": []
    },
    {
        "author": "agemanning",
        "category": "Consensus Layer",
        "parent": "",
        "content": "https://developers.google.com/protocol-buffers/docs/encoding#varints",
        "created_at": "2022-10-28T00:22:54.010000+00:00",
        "attachments": []
    },
    {
        "author": "agemanning",
        "category": "Consensus Layer",
        "parent": "",
        "content": "It should really only take up as many bytes as needed to represent the payload length",
        "created_at": "2022-10-28T00:23:31.885000+00:00",
        "attachments": []
    },
    {
        "author": "mikeneuder",
        "category": "Consensus Layer",
        "parent": "",
        "content": "huh that is pretty weird. the test message we are looking at has a first byte of `0x4a = 0100 1010`. dropping the MSB and interpretting it as an int just gives 74. whereas the size should be `size = 24896`",
        "created_at": "2022-10-28T01:12:16.592000+00:00",
        "attachments": []
    },
    {
        "author": "nishant0",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Are you interpreting the varint correctly ? It seems like there might be a bug in parsing the header.",
        "created_at": "2022-10-28T05:21:05.716000+00:00",
        "attachments": []
    },
    {
        "author": "nishant0",
        "category": "Consensus Layer",
        "parent": "",
        "content": "This is what we use in Prysm:\nhttps://github.com/prysmaticlabs/prysm/blob/develop/beacon-chain/p2p/encoder/varint.go#L16",
        "created_at": "2022-10-28T05:21:53.360000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "since Altair (for the v2 APIs), there is an additional `ForkDigest`-context. See https://github.com/ethereum/consensus-specs/blob/dev/specs/altair/p2p-interface.md#forkdigest-context",
        "created_at": "2022-10-28T12:05:22.678000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "LC uses the `ForkDigest` prefix as well (I guess it's a varint len + 4 bytes digest)",
        "created_at": "2022-10-28T12:06:01.194000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "it is used to determine what SSZ object is being transmitted",
        "created_at": "2022-10-28T12:06:35.971000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "eg if you request v2 block, the prefix tells you whether it is an altair or bellatrix block",
        "created_at": "2022-10-28T12:07:03.748000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "How is it different?",
        "created_at": "2022-10-28T12:07:05.151000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Like, why do you need that?",
        "created_at": "2022-10-28T12:07:13.035000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "If the others works why not the same here?",
        "created_at": "2022-10-28T12:07:25.212000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "the v1 one only supports phase0 blocks",
        "created_at": "2022-10-28T12:07:33.483000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "light client data uses the altair format with the future-proofing (and yes, right now, there is only a single SSZ format for LC data, but it will change in the future0",
        "created_at": "2022-10-28T12:08:05.485000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "if you perform a v2 block request (for post-phase0), you will also see the same prefix being added",
        "created_at": "2022-10-28T12:09:44.664000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "on gossip, the forkdigest is part of the individual topic so the prefix doesn't exist",
        "created_at": "2022-10-28T12:09:53.089000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "but lightclient topics are all v1",
        "created_at": "2022-10-28T12:58:31.835000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "so they support only phase0 blocks?",
        "created_at": "2022-10-28T12:58:47.978000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "but still support post-altair sync committee?",
        "created_at": "2022-10-28T12:58:59.283000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I see that it is what is happening, thank you!",
        "created_at": "2022-10-28T12:59:33.508000+00:00",
        "attachments": []
    },
    {
        "author": "funnygiulio",
        "category": "Consensus Layer",
        "parent": "",
        "content": "but really confusing nonetheless lol.",
        "created_at": "2022-10-28T12:59:41.755000+00:00",
        "attachments": []
    },
    {
        "author": "nishant0",
        "category": "Consensus Layer",
        "parent": "",
        "content": "v1 doesn't denote phase0/altair or bellatrix support. Its just the protocol version for the particular request",
        "created_at": "2022-10-28T13:12:27.298000+00:00",
        "attachments": []
    },
    {
        "author": "mikeneuder",
        "category": "Consensus Layer",
        "parent": "",
        "content": "ok nice. we are getting the correct result for the finality update topic! our first six bytes are 74, 38, 197, 139, 200, 4. the fork digest is 74, 38, 197, 139 so the varint is 200, 4. following the varint procedure, we get a binary number of  `1001001000` in base 10 thats `584`, which is the SSZ size of the finality update object",
        "created_at": "2022-10-28T14:06:31.411000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "each topic is independently versioned",
        "created_at": "2022-10-28T16:54:14.603000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "yes. `ForkDigest` context, then varint size (of uncompressed data), then compressed data. Same as for altair/v2 blocks requests",
        "created_at": "2022-10-28T16:55:58.900000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus Layer",
        "parent": "",
        "content": "the varint size allows you to pre-allocate the buffer that will hold the decompressed data",
        "created_at": "2022-10-28T16:56:19.213000+00:00",
        "attachments": []
    },
    {
        "author": "mikeneuder",
        "category": "Consensus Layer",
        "parent": "",
        "content": "right. cmd/lightclient/sentinel/communication/ssz_snappy/stream.go that is what we are doing now. https://github.com/ledgerwatch/erigon/pull/5886/files. thanks \u003c@881905303011086387\u003e!!",
        "created_at": "2022-10-28T17:16:45.145000+00:00",
        "attachments": []
    }
]