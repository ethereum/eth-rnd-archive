[
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Myweah it makes things a bit different, becauae then this header field becomes something that \"validates\" the body, but does not define the header chain",
        "created_at": "2023-05-24T04:38:09.548000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Workable I guess, it's all semantics, but it's one less field that can be verified header-only",
        "created_at": "2023-05-24T04:38:25.752000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Hey all, I found a missing validation in the 4844 spec which could lead to either a consensus fault or an infinite blob-capacity issue ðŸ˜…",
        "created_at": "2023-05-24T08:29:58.043000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The blocks are targeting 2 blobs are are capped to 4",
        "created_at": "2023-05-24T08:30:10.065000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The cap is not validated anywhere according to the spec",
        "created_at": "2023-05-24T08:30:18.378000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "```\ndef validate_block(block: Block) -\u003e None:\n    ...\n\n    num_blobs = 0\n    for tx in block.transactions:\n        ...\n\n        # the signer must be able to afford the transaction\n        assert signer(tx).balance \u003e= tx.gas * tx.max_fee_per_gas + get_total_data_gas(tx) * tx.max_fee_per_data_gas\n\n        # ensure that the user was willing to at least pay the current data gasprice\n        assert tx.max_fee_per_data_gas \u003e= get_data_gasprice(parent(block).header)\n\n        num_blobs += len(tx.blob_versioned_hashes)\n\n    # check that the excess data gas is correct\n    expected_edg = calc_excess_data_gas(parent(block).header, num_blobs)\n    assert expected_edg == block.excess_data_gas\n```",
        "created_at": "2023-05-24T08:30:33.088000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Note, `num_blobs` is permitted to be arbitrary, so whilst a single tx might at max contain 4 blobs, there's nothing stopping every single tx in a block to contain 4 blobs each",
        "created_at": "2023-05-24T08:31:13.314000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The Go code from Optimism/Coinbase actually conforms to the above spec and will allow arbitrarily many blobs https://github.com/ethereum/go-ethereum/pull/26283/files#diff-066287ece438b27f896b9c7e86fc3283328e35d0cc07f83a259bcbfc3a773b26R82",
        "created_at": "2023-05-24T08:32:10.574000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So at best, it's a consensus fault if other clients implemented it correctly - and not conforming to the spec",
        "created_at": "2023-05-24T08:32:27.110000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Or at worse a DoS vector if all clients implemented the spec to the letter",
        "created_at": "2023-05-24T08:32:55.053000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "We need a check of num_blobs against MAX_DATA_GAS_PER_BLOCK",
        "created_at": "2023-05-24T08:34:55.085000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Proposal:",
        "created_at": "2023-05-24T08:35:00.906000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "```\ndef validate_block(block: Block) -\u003e None:\n    ...\n\n    num_blobs = 0\n    for tx in block.transactions:\n        ...\n\n        # the signer must be able to afford the transaction\n        assert signer(tx).balance \u003e= tx.gas * tx.max_fee_per_gas + get_total_data_gas(tx) * tx.max_fee_per_data_gas\n\n        # ensure that the user was willing to at least pay the current data gasprice\n        assert tx.max_fee_per_data_gas \u003e= get_data_gasprice(parent(block).header)\n\n        num_blobs += len(tx.blob_versioned_hashes)\n\n    # check that the excess data gas is correct\n    asset num_blobs \u003c= MAX_DATA_GAS_PER_BLOCK / DATA_GAS_PER_BLOB // \u003c----------------------- ADDED\n    expected_edg = calc_excess_data_gas(parent(block).header, num_blobs)\n    assert expected_edg == block.excess_data_gas\n```",
        "created_at": "2023-05-24T08:36:16.956000+00:00",
        "attachments": null
    },
    {
        "author": "__flcl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Or \nasset num_blocks * DATA_GAS_PER_BLOB  \u003c= MAX_DATA_GAS_PER_BLOCK",
        "created_at": "2023-05-24T08:36:54.764000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "for sure",
        "created_at": "2023-05-24T08:37:01.281000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003cdankrad\u003e @peter this is currently verified by the CL spec: https://github.com/ethereum/consensus-specs/blob/dev/specs/deneb/beacon-chain.md#execution-payload",
        "created_at": "2023-05-24T11:46:09.817000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I don't really see a reason to not have the check in el tho (or rather in el too)",
        "created_at": "2023-05-24T12:16:02.131000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Also there's no mention of this is the spec, would be nice to add it there too",
        "created_at": "2023-05-24T12:19:12.264000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003cdankrad\u003e this is the spec",
        "created_at": "2023-05-24T12:19:25.157000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003cdankrad\u003e the full 4844 spec is the EL (part of the EIP) and CL (which is what I sent)",
        "created_at": "2023-05-24T12:19:45.391000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "still at least a note should be added to the el then why it's not necessary, as it stands, the el spec is ambiguous in itself",
        "created_at": "2023-05-24T12:23:44.130000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "another thing to keep in mind is that you might want to validate a block outside of newPayload",
        "created_at": "2023-05-24T12:24:16.438000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "e.g. snap sync",
        "created_at": "2023-05-24T12:24:19.381000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "in that case should you or should you not detect these errors?",
        "created_at": "2023-05-24T12:24:33.610000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "these are kind of the reasons it feels strange that we so storngly not want to check something that we could check",
        "created_at": "2023-05-24T12:25:08.781000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "e.g. the spec says I should verify that excessDataGas is correct?",
        "created_at": "2023-05-24T12:26:13.555000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Why not have the CL verify that?",
        "created_at": "2023-05-24T12:26:17.857000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Seems arbitrary a bit",
        "created_at": "2023-05-24T12:26:38.310000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "My expectation is that we should veryfy everything as strongly as can",
        "created_at": "2023-05-24T12:26:48.688000+00:00",
        "attachments": null
    },
    {
        "author": "karalabe",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "and I'd rather check in 2 places than none by some strange accident",
        "created_at": "2023-05-24T12:27:00.399000+00:00",
        "attachments": null
    },
    {
        "author": "__flcl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I guess tx hash is `keccak256(BLOB_TX_TYPE || rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, to, value, data, access_list, max_fee_per_data_gas, blob_versioned_hashes, y_parity, r, s]))`. Found no mention of it in the spec",
        "created_at": "2023-05-24T14:42:16.660000+00:00",
        "attachments": null
    },
    {
        "author": "kevaundray",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "go-kzg-4844 has just released new version 0.3.0 -- The main change being the endian switch in consensus-specs PR 3354 : \u003chttps://github.com/ethereum/consensus-specs/pull/3354\u003e\n\nThe doc comments in go-kzg-4844 have been updated to note that it now conforms to the consensus-specs at commit `017a8495f7671f5fff2075a9bfc9238c1a0982f8`",
        "created_at": "2023-05-24T22:08:03.032000+00:00",
        "attachments": null
    },
    {
        "author": "robocopsgonemad",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "greetings other 4844 friends, I wanna introduce \u003c@680245613258211336\u003e who is going to be working with me getting 4844 implemented on Besu.",
        "created_at": "2023-05-24T23:39:26.362000+00:00",
        "attachments": null
    }
]