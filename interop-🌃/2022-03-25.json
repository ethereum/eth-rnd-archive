[
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Hey all, we're debugging issues on the goerli shadowfork. Looks like most nodes experienced some kind of issues. Some Nethermind have trouble syncing, Marek is already on that. All Besu nodes are down. We have one teku-geth node that is fine and one that broke (probably due to resource exhaustion).",
        "created_at": "2022-03-25T07:28:25.662000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Regarding the teku-geth node, I noticed that teku seems to spam us with a lot of `eth_getBlockByNumber` (hunderts per second) during sync",
        "created_at": "2022-03-25T07:32:47.927000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "We'll likely do that as part of loading deposits/eth1 chain voting (ie the existing pre-merge interactions).  It is probably a bigger deal on a goerli shadow net because we don't have the block number the contract was deployed at so wind up scanning the entire chain.  For Prater we can start from the block the deposit contract was deployed which saves a lot of scanning but I don't think we have a CLI option to specify that for custom networks at the moment.\nAnd we can send up to 5 concurrent requests at a time so there's a limit to how much we'll hammer geth but it's a relatively high limit.",
        "created_at": "2022-03-25T07:43:53.999000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "hmm, but I have set up a fresh deposit contract at a recent block to prevent this exact thing..\nthe block number is present in a file called `deploy_block.txt` with the value `6582955`, similarly another file with block hash",
        "created_at": "2022-03-25T07:53:33.080000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "ahh, won't matter on teku since `--network=\"/custom_config_data/config.yaml\"` is just pointing to a file and not a dir",
        "created_at": "2022-03-25T07:54:10.184000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "How would i be able to provide teku info about deposit contract block height?",
        "created_at": "2022-03-25T07:54:35.148000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "An update on the goerli shadow fork, we seem to found a bug that we need some help explaining. \n\nPrysm is currently failing to  verify the sig of blocks 13774,13775 and 13776 and that's triggering some other issues. This block does show up as missing on quite a lot of nodes and seems like the proposer was `proposer_index: 46855`. That's a `nimbus-geth` node. \n\nNimbus geth itself also shows a sig verification error:\n```\nINF 2022-03-25 06:59:48.548+00:00 Block signature verification failed        signature=9374ddc3 blockRoot=15f0fefe blck=\"(slot: 13774, proposer_index: 46855, parent_root: \\\"251559bb\\\", state_root: \\\"12ef5848\\\", eth1data: (deposit_root: d70a234731285c6804c2a4f56711ddb8c82c99740f207854891028af34e27e5e, deposit_count: 0, block_hash: 64912ca90534520fa062e1262b5eb0212367d7e0609b7d432fefdd422c3a899c), graffiti: \\\"nimbus-geth\\\", proposer_slashings_len: 0, attester_slashings_len: 0, attestations_len: 89, deposits_len: 0, voluntary_exits_len: 0, sync_committee_participants: 129)\"\nWRN 2022-03-25 06:59:48.548+00:00 Unable to add proposed block to block pool topics=\"beacval\" blockRoot=15f0fefe blck=\"(slot: 13774, proposer_index: 46855, parent_root: \\\"251559bb\\\", state_root: \\\"12ef5848\\\", eth1data: (deposit_root: d70a234731285c6804c2a4f56711ddb8c82c99740f207854891028af34e27e5e, deposit_count: 0, block_hash: 64912ca90534520fa062e1262b5eb0212367d7e0609b7d432fefdd422c3a899c), graffiti: \\\"nimbus-geth\\\", proposer_slashings_len: 0, attester_slashings_len: 0, attestations_len: 89, deposits_len: 0, voluntary_exits_len: 0, sync_committee_participants: 129)\" signature=9374ddc3 validator=904a658f\n```\n\nHow would we be able to get our hands on this block to see why its messing up things? \u003c@!654267572107083777\u003e perhaps?",
        "created_at": "2022-03-25T08:24:38.454000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "Nimbus dumps/saves invalid blocks by default yeah",
        "created_at": "2022-03-25T08:25:24.437000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "its happening on `nimbus-geth-1` btw",
        "created_at": "2022-03-25T08:26:13.431000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "haven't looked at the shadow fork hosts/setup yet though so can't say exactly where they'd be, but typically in data directory",
        "created_at": "2022-03-25T08:26:19.845000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "okay, will look",
        "created_at": "2022-03-25T08:26:33.495000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "thanks!",
        "created_at": "2022-03-25T08:27:59.715000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "the nimbus commandlines say `--data-dir=/beacondata` but I don't see any `/beacondata` directory ?",
        "created_at": "2022-03-25T08:39:32.607000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "that's where those blocks would be dumped",
        "created_at": "2022-03-25T08:39:48.298000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "ah its a docker volume map",
        "created_at": "2022-03-25T08:39:56.420000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "`/home/devops/beacon`",
        "created_at": "2022-03-25T08:40:08.305000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "in which case, they're not there -- not sure exactly what commandline options are needed to enable them offhand, but it's not enabled thus far",
        "created_at": "2022-03-25T08:41:02.436000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "also though it's not just that one block that at least nimbus-geth-1 flags as having an invalid signature",
        "created_at": "2022-03-25T08:44:55.194000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "```\ntail -n15M nimbus.log| grep \"ignature verification failed\" | jq '[.blck.slot, .signature, .blockRoot, .blck.proposer_index, .blck.graffiti]|@tsv' -r\n13774   9374ddc3        15f0fefe        46855   nimbus-geth\n13776   b699f6dc        ff064a5d        19987   prysm-geth\n13784   87b12f6a        83ecc249        24416   prysm-geth\n13785   906e8320        ed4c356f        27706   prysm-geth\n13787   af497269        f8abff5d        32345   prysm-geth\n13788   af4c8f40        2cf3fd74        38487   prysm-geth\n13789   966ce8d1        6449d2e9        32082   prysm-geth\n13794   a48404f4        3e0561b9        35058   prysm-geth\n13795   8273c6f9        d0aeaa06        17387   prysm-geth\n13797   b05b105a        5b3c6495        48792   prysm-nethermind\n13798   8093defe        3d9db629        36055   prysm-geth\n13799   977b89af        c467d8be        35278   prysm-geth\n13801   9872b41e        1aa45386        20586   prysm-geth\n13803   b3520a7a        3931b897        38207   prysm-geth\n13804   aa37f98c        fac88540        21849   prysm-geth\n13806   84063de2        b22dc449        13026   prysm-geth\n13808   b0c7ce78        f7944cc3        33913   prysm-geth\n13809   929ae9db        01489619        30589   prysm-geth\n13811   a411c09c        0c69a543        36794   prysm-geth\n13812   8b561ffe        a6cce79e        31929   prysm-geth\n13814   acadc94b        dd6e8839        20546   prysm-geth\n13817   85fb7467        100a2008        21320   prysm-geth\n13819   86c2e603        51b2af6c        24555   prysm-geth\n13820   ad5a79c9        590102e4        19338   prysm-geth\n13821   adbe3c5c        fb7f9c3d        19171   prysm-geth\n13823   b4642cf1        30809b2f        20700   prysm-geth\n13827   b0c09675        39f6a85c        48870   prysm-nethermind\n13828   8a4711b9        99fc5557        20161   prysm-geth\n13832   986112af        5e121430        31583   prysm-geth\n13861   96d78808        f8f2a7a7        46513   nimbus-geth\n13867   923d0e17        19a67b6f        46179   nimbus-geth\n```",
        "created_at": "2022-03-25T08:48:21.324000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "I doubt that one block was uniquely flawed",
        "created_at": "2022-03-25T08:49:03.936000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "That is interesting",
        "created_at": "2022-03-25T08:49:51.660000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "it could definitely be a Nimbus signature verification problem, to be clear",
        "created_at": "2022-03-25T08:50:06.229000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "For 1 of the prysm nodes we got invalid blocks in 2 of these slots\n```\n13774,13775,13776\n```\n\nGuessing this was produced both by nimbus and prysm ? which makes it even stranger",
        "created_at": "2022-03-25T08:50:48.525000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "according to above, 13774 was Nimbus and 13776 was Prysm",
        "created_at": "2022-03-25T08:51:42.241000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "you also saw an invalid block on 13775?",
        "created_at": "2022-03-25T08:51:52.295000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "sorry no, let me rephrase we saw 2 invalid blocks, which were in 3 possible slots:\n13774,13775,13776\n\nBut from your data, it seems to have been the slots of `13774` `13776` , which would match up with what we saw too",
        "created_at": "2022-03-25T08:53:43.317000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "the debug logs were not enabled which meant we couldnt see more identifiable data on the bad blocks",
        "created_at": "2022-03-25T08:54:15.825000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "ah, that I do have",
        "created_at": "2022-03-25T08:54:29.628000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "not everything, and not the SSZs, but debug logs",
        "created_at": "2022-03-25T08:54:46.966000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "Also odd: nimbus-nethermind-1 shows no signature verification failed messages, but that's because it has some other issues that I'm not sure about currently.",
        "created_at": "2022-03-25T08:56:52.460000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "ah that is unfortunate, would be valuable if we had ssz data on these bad blocks. I will enable the bad block flag on prysm so future ones are captured",
        "created_at": "2022-03-25T08:57:09.473000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "but \u003c@!199561711278227457\u003e already pasted here the most important set of data that Nimbus logs",
        "created_at": "2022-03-25T08:58:02.453000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "it could be that one of the other clients stored the block but hasn't logged that its been rejected. Unsure how to check this for lh,teku,lodestar :\\ (not available via `/eth/v2/beacon/blocks/13776` since it would have been rejected)",
        "created_at": "2022-03-25T08:58:32.424000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "oh, for Nimbus, it's `--dump:on`",
        "created_at": "2022-03-25T08:59:52.074000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "`Write SSZ dumps of blocks, attestations and states to data dir`",
        "created_at": "2022-03-25T09:00:02.071000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "should i enable that now, so it dumps future blocks?",
        "created_at": "2022-03-25T09:01:07.351000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "yeah",
        "created_at": "2022-03-25T09:01:11.245000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "applied on `goerli-shadow-fork-nimbus-geth-1`",
        "created_at": "2022-03-25T09:01:42.998000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "it's on, and I now see a `dump` directory",
        "created_at": "2022-03-25T09:02:34.830000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "Testing",
        "parent": "",
        "content": "Some nodes may provide it if you use the root instead of the slot number.",
        "created_at": "2022-03-25T09:04:19.766000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "LH doesn't dump by default either, it would log it if you were running with trace logs though",
        "created_at": "2022-03-25T09:05:58.127000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "ah damn :\\\nUnfortunately since its been rejected everywhere I can't find the root to check if its present either. I can enable trace logs in lighthouse for atleast one node, might help later on.",
        "created_at": "2022-03-25T09:07:08.734000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "the invalid block root will be logged even in debug for LH",
        "created_at": "2022-03-25T09:08:13.101000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "switched lighthouse-geth-2 to trace logs",
        "created_at": "2022-03-25T09:09:54.597000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "If teku is running with `--Xlog-include-p2p-warnings-enabled` and it rejected the block then it likely logged the whole block contents.  If it didn't reject it then the `/eth/v1/beacon/headers?slot=XXX` API will return the header of all blocks (including non-canonical) in a slot so you can get the block root.  But by default it would prune non-canonical blocks once that epoch finalizes.  (`--data-storage-non-canonical-blocks-enabled` will tell it to keep all non-canonical blocks).",
        "created_at": "2022-03-25T09:11:17.796000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "unfortunately no data for `13774` or ...",
        "created_at": "2022-03-25T09:14:55.305000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "ah interesting, according to \u003c@!654267572107083777\u003e 's list `13867` is also affected.\n\nA teku geth node does contain info on this block",
        "created_at": "2022-03-25T09:16:04.810000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "```\n{\n  \"execution_optimistic\": true,\n  \"data\": [\n    {\n      \"root\": \"0x5ed8c80f6b03f3408618e2146cbca23a28528c793fa1a1c3fbdf810d1b3287f4\",\n      \"canonical\": false,\n      \"header\": {\n        \"message\": {\n          \"slot\": \"13867\",\n          \"proposer_index\": \"14613\",\n          \"parent_root\": \"0x9405de2c3eb3bc43de013a190eeac12b7ef6f540c3299446c496c21d89537924\",\n          \"state_root\": \"0x555b747fc0e33448f631b93338dfbe8f71d19914aebba59b9ab0dbb2fd9af7ed\",\n          \"body_root\": \"0x6a49873dcb7ff5160f30a1eed35cb5c6b0d9da6152f6571d49d8f9e3430a1772\"\n        },\n        \"signature\": \"0x805c2d770bd5abf5bfe1726829300e9557e2c1182c3ee534d5d72fffdacd442a2cbd6465af6813ce60a59ccc4713ebfc0ce2eda69bd1ea12f351ba4db317c009df215a145ef93a28825f56653b5b2dede8de18db9ab4a0e659aae7d33ed69dcd\"\n      }\n    }\n  ]\n}\n```",
        "created_at": "2022-03-25T09:16:11.564000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "is there another client which as similar-granularity logs to cross-check the data I pasted above, see (however the blocks were produced) the invalid signature determination was the same across CLs?",
        "created_at": "2022-03-25T09:16:22.950000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "aaaand exactly as you said, querying by root does return a value",
        "created_at": "2022-03-25T09:16:46.744000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "`curl -H 'Accept: application/octet-stream' \u003chost\u003e/eth/v2/beacon/blocks/0x5ed8c80f6b03f3408618e2146cbca23a28528c793fa1a1c3fbdf810d1b3287f4` will give you the block as SSZ if that's useful.",
        "created_at": "2022-03-25T09:16:46.950000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "lemme dump it",
        "created_at": "2022-03-25T09:16:48.599000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "(in the specific configurations used -- I'm sure it's possible generically)",
        "created_at": "2022-03-25T09:16:59.989000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "there's some evidence that at least Prysm and Nimbus matched up across 3 of the slots",
        "created_at": "2022-03-25T09:17:24.031000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "",
        "created_at": "2022-03-25T09:18:27.905000+00:00",
        "attachments": [
            {
                "type": "application/json; charset=utf-8",
                "origin_name": "13867.json",
                "content": "fa1a4e94278631770ab74fc4b28f29028f599232d97d494c9cb2b45133af650c"
            }
        ]
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "",
        "created_at": "2022-03-25T09:18:32.508000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "13867.ssz",
                "content": "2825c42ba65701e6dea603f57f0180563dd20aa45684d5786a752828b129bff8"
            }
        ]
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "data from `goerli-shadow-fork-teku-geth-1` for those with access",
        "created_at": "2022-03-25T09:19:02.482000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "going there. goerli-shadow-fork-teku-geth-2 seems not in a good shape",
        "created_at": "2022-03-25T09:20:12.429000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "yeah, resource limits are being hit causing some extra chaos",
        "created_at": "2022-03-25T09:20:30.617000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Yes, geth used 4GB of ram, teku 4GB, thus geth gets shut down and restarts its sync cycle",
        "created_at": "2022-03-25T09:21:06.143000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Why does teku use that much ram?",
        "created_at": "2022-03-25T09:21:17.441000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "probably cause i set that as the limit `-XX:SoftMaxHeapSize=2g -Xmx4g`, and non finality is making it use up as many resources as it can get",
        "created_at": "2022-03-25T09:23:38.119000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "the same, 4g",
        "created_at": "2022-03-25T09:29:24.145000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "this is when trying to manually transition state 13866 with the above block\n```\nFailed to run lcli: Failed to transition blocks: State transition failed: HeaderInvalid { reason: ProposerIndexMismatch { block_proposer_index: 14613, state_proposer_index: 46179 } }\n```",
        "created_at": "2022-03-25T09:34:12.525000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "interesting, not a signature error",
        "created_at": "2022-03-25T09:37:13.266000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "14613 is a validator on  goerli-shadow-fork-prysm-geth-2",
        "created_at": "2022-03-25T09:37:17.611000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "wierd, how it isnt a signature error",
        "created_at": "2022-03-25T09:38:32.345000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "hmm that doesnt match up to this",
        "created_at": "2022-03-25T09:45:19.248000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "This mentions 13867 is nimbus-geth",
        "created_at": "2022-03-25T09:45:40.763000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "yes, not prysm-geth",
        "created_at": "2022-03-25T09:46:13.317000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "so different forks maybe",
        "created_at": "2022-03-25T09:46:23.879000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "very possible",
        "created_at": "2022-03-25T09:46:30.018000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "did you retrieve the prestate by slot or by root ?",
        "created_at": "2022-03-25T09:46:55.294000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "that's one reason I included the blockroots and signatures",
        "created_at": "2022-03-25T09:47:03.412000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "mine also saw proposer index of 46179, which matches \u003c@!491624610215886849\u003e 's `state_proposer_index` (but not the `block_proposer_index`)",
        "created_at": "2022-03-25T09:48:05.052000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "interesting",
        "created_at": "2022-03-25T09:48:21.899000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@!199561711278227457\u003e do you mind dumping the prestate if its possible too ?",
        "created_at": "2022-03-25T09:48:35.118000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Basically state by this root:\n```\n0x9405de2c3eb3bc43de013a190eeac12b7ef6f540c3299446c496c21d89537924\n```",
        "created_at": "2022-03-25T09:49:04.854000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "sorry I retrieved by slot",
        "created_at": "2022-03-25T09:50:43.966000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "No prob, i am guessing you wouldn't have the above state stored in LH by anychance then ?",
        "created_at": "2022-03-25T09:51:38.541000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "yeah don't have it",
        "created_at": "2022-03-25T09:52:03.190000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "",
        "created_at": "2022-03-25T09:52:17.886000+00:00",
        "attachments": [
            {
                "type": "application/json; charset=utf-8",
                "origin_name": "0x9405de2c3eb3bc43de013a190eeac12b7ef6f540c3299446c496c21d89537924.json",
                "content": "7b00aab07d1de502874e19561fed4e6f99d6a74881520160e340351316daa9e9"
            },
            {
                "type": "",
                "origin_name": "0x9405de2c3eb3bc43de013a190eeac12b7ef6f540c3299446c496c21d89537924.ssz",
                "content": "8a597f13da2fe19736bd4a59a6f7468d3e459cbe0ef07cb7b0c1e0313799ae93"
            }
        ]
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "from teku",
        "created_at": "2022-03-25T09:52:25.433000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "is that the block or state ?",
        "created_at": "2022-03-25T09:52:49.552000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "ah got it from /eth/v2/beacon/blocks so block",
        "created_at": "2022-03-25T09:53:13.216000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "how do i get the state from the api?",
        "created_at": "2022-03-25T09:53:17.605000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "let me get the url, give me a sec",
        "created_at": "2022-03-25T09:53:33.321000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "`/eth/v2/debug/beacon/states/{root}`",
        "created_at": "2022-03-25T09:54:27.940000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "+ 1 ^",
        "created_at": "2022-03-25T09:54:36.302000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "hmm, not found now :\\\n`{\"code\":404,\"message\":\"Not found\"}%`",
        "created_at": "2022-03-25T09:56:55.957000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "so it has the block but no state?",
        "created_at": "2022-03-25T09:57:01.931000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "I think you need to enable the debug endpoints on the node",
        "created_at": "2022-03-25T09:58:23.608000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "teku might not expose them by default",
        "created_at": "2022-03-25T09:58:31.947000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "For prysm you need a flag to access the debug methods",
        "created_at": "2022-03-25T09:58:46.247000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "so guessing its the same thing here",
        "created_at": "2022-03-25T09:58:54.140000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@!504202741933932544\u003e is that the case?",
        "created_at": "2022-03-25T10:01:22.238000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "nope",
        "created_at": "2022-03-25T10:05:53.089000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "No all routes are enabled by default. You need to use the state root not the block root.",
        "created_at": "2022-03-25T10:05:55.746000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "And this is for a non finalised slot right?",
        "created_at": "2022-03-25T10:06:04.402000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "ahh that was it. \n\nJust to be explicit, I called `.../blocks/0x9405de2c3e...` and took the `state_root: 0xbb6462ae2a2d83398cbe17fa6b3152baf52eb9292414a48ac76950eeeee62c6c`.\n\nThen ran `/eth/v2/debug/beacon/states/0xbb6462...` and the result has been attached here",
        "created_at": "2022-03-25T10:08:51.093000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "",
        "created_at": "2022-03-25T10:09:03.207000+00:00",
        "attachments": [
            {
                "type": "application/json; charset=utf-8",
                "origin_name": "0xbb62-state.json",
                "content": "4eed33805e20b7b3a703e5162a061bd17c66f4a346a081dcb05146db4bb11159"
            }
        ]
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "can you dump the ssz too? can just add this header `\"accept: application/octet-stream\"`",
        "created_at": "2022-03-25T10:12:26.998000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "",
        "created_at": "2022-03-25T10:14:00.569000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "0xbb62-state.ssz",
                "content": "7e29453d86a237c791360346964913ef41f87673ad7cf6ddad00594f022a9987"
            }
        ]
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "lcli transition didn't give any errors with this state and block 13867 that pari attached above",
        "created_at": "2022-03-25T10:16:56.319000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Oh that is pretty wierd, I am away from my machine now but wilk try performing prysm's transition when i am back online.",
        "created_at": "2022-03-25T10:18:51.569000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "So sounds like some kind of shuffling cache issue then? Tried to validate it against the wrong fork?",
        "created_at": "2022-03-25T10:21:03.758000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Could be but if it was a shuffling issue, the check would have failed much earlier when we validated the block's proposer index",
        "created_at": "2022-03-25T10:22:10.827000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "```\n$ build/ncli transition --preState=$HOME/Downloads/0xbb62-state.ssz --blck=$HOME/Downloads/13867.ssz --postState=post.ssz\n```",
        "created_at": "2022-03-25T10:23:58.434000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "no error",
        "created_at": "2022-03-25T10:24:03.374000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "But it's also not the block nimbus-geth-1 saw:\n```\n13867   923d0e17        19a67b6f        46179   nimbus-geth\n```\ni.e. slot 13,867, proposer 46,179 (vs 14,613)",
        "created_at": "2022-03-25T10:27:59.662000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "so the chain forked off earlier and we ended up with different proposers on different forks?",
        "created_at": "2022-03-25T10:30:59.656000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "that's what it looks like",
        "created_at": "2022-03-25T10:32:05.674000+00:00",
        "attachments": null
    },
    {
        "author": "parithosh",
        "category": "Testing",
        "parent": "",
        "content": "hmm, are there any other debug steps to try then?",
        "created_at": "2022-03-25T10:39:05.775000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "Looking at nimbus-nethermind-1, it hits lots of chain reorgs starting at\n```\n{\"lvl\":\"NOT\",\"ts\":\"2022-03-25 04:07:12.759+00:00\",\"msg\":\"Updated head block with chain reorg\",\"topics\":\"chaindag\",\"lastHead\":\"3ad10cc7:12910\",\"headParent\":\"2849446c:12904\",\"stateRoot\":\"056007b4\",\"headBlock\":\"d363e46a:12911\",\"stateSlot\":12911,\"justified\":\"402:542d0f53\",\"finalized\":\"401:a3306118\",\"newHead\":\"d363e46a:12911\"}\n```",
        "created_at": "2022-03-25T10:45:51.050000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "nimbus-geth-1 and nimbus-nethermind-1 seem to agree on which fork consistently through\n```\n{\"lvl\":\"DBG\",\"ts\":\"2022-03-25 04:05:48.179+00:00\",\"msg\":\"Updated head block\",\"topics\":\"chaindag\",\"head\":\"2849446c:12904\",\"stateRoot\":\"d566e115\",\"justified\":\"402:542d0f53\",\"finalized\":\"401:a3306118\",\"newHead\":\"2849446c:12904\"}\n```",
        "created_at": "2022-03-25T10:46:46.138000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@!654267572107083777\u003e what's the post state root you got for the above transition btw?",
        "created_at": "2022-03-25T10:47:06.718000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "just checking, LH got `0x555b747fc0e33448f631b93338dfbe8f71d19914aebba59b9ab0dbb2fd9af7ed`",
        "created_at": "2022-03-25T10:48:00.783000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "",
        "created_at": "2022-03-25T10:48:12.591000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "post.ssz",
                "content": "ecddb27b48230851a83e3475062939722a3f71e25688c01a50472c19c4798f59"
            }
        ]
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "yeah same",
        "created_at": "2022-03-25T10:49:03.417000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "```\n$ build/ncli hashTreeRoot --htrKind=bellatrix_state --htrFile=post.ssz\n555b747fc0e33448f631b93338dfbe8f71d19914aebba59b9ab0dbb2fd9af7ed\n```",
        "created_at": "2022-03-25T10:49:03.832000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "just to clarify, the 13867 block was created by `nimbus-geth` and rejected by prysm nodes?",
        "created_at": "2022-03-25T10:51:58.591000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "Well, the 13867 block that `nimbus-geth-1` saw was, it seems.",
        "created_at": "2022-03-25T10:53:44.319000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "13867.ssz is prysm-geth",
        "created_at": "2022-03-25T11:02:31.088000+00:00",
        "attachments": null
    },
    {
        "author": "pawandhananjay",
        "category": "Testing",
        "parent": "",
        "content": "Received some invalid blocks over gossip on my local node. 15112, 15139. Both had pre-state as 15094. \nCan anyone check?",
        "created_at": "2022-03-25T12:30:38.452000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "15139_block.ssz",
                "content": "833f7b3193a25868753155ecc6fa84e771f01c698b301ad7e5ca4c212313f87f"
            },
            {
                "type": "",
                "origin_name": "15094_state.ssz",
                "content": "6238b94f18a12448c9bb9f79852f3bdeeac4a2e074f8361ae66451d74549f348"
            },
            {
                "type": "",
                "origin_name": "15112_block.ssz",
                "content": "9429c91ab7b30f916e7f2fa40ee4d3eb21b38f43c10887e84844e45f9bb3ceaa"
            }
        ]
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "sig verification failure on 15112 and 15139",
        "created_at": "2022-03-25T12:48:06.206000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "```\n$ ncli transition --preState=15094_state.ssz --blck=15112_block.ssz --postState=post_block_15112.ssz\nERR State transition failed                    tid=1202213 file=ncli.nim:102 error=\"indexed attestation: signature verification failure\"\n$ ncli transition --preState=15094_state.ssz --blck=15112_block.ssz --postState=post_block_15139.ssz\nERR State transition failed                    tid=1202328 file=ncli.nim:102 error=\"indexed attestation: signature verification failure\"\n```",
        "created_at": "2022-03-25T12:48:57.175000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "for teku Invalid attestation: Signature is invalid. (i got the wrong state before)",
        "created_at": "2022-03-25T12:50:19.405000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "15112 and 15139 have prysm-geth graffiti",
        "created_at": "2022-03-25T12:51:58.383000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "same for 15112: Signature is invalid.",
        "created_at": "2022-03-25T12:54:22.872000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Why are all those signatures invalid? Are you signing some chain specific data? Chainid/networkid/...?",
        "created_at": "2022-03-25T12:56:50.940000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "this is the state from goerli-shadow-fork-teku-geth-1",
        "created_at": "2022-03-25T12:57:04.996000+00:00",
        "attachments": [
            {
                "type": "",
                "origin_name": "state_at_15094.ssz",
                "content": "06cab0cd3b73aea5de83062fc9c59850ed925057324ae6be3f3decff2fe3e657"
            }
        ]
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "kind of -- not chainid/networkid, but forkdigest-related things get included in the hash. this tends to be both a function of which hardfork (phase0, altair, bellatrix) and which specific network (mainnet, prater, this testnet, etc)",
        "created_at": "2022-03-25T12:58:33.309000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "That would be the first place I'd look. Have you checked the configs? Maybe Pari made a mistake?",
        "created_at": "2022-03-25T13:00:35.590000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "The `Domain` is mixed into what is signed\nhttps://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/beacon-chain.md#compute_signing_root",
        "created_at": "2022-03-25T13:00:36.155000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "which includes info about the type being signed and the fork\nhttps://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/beacon-chain.md#get_domain",
        "created_at": "2022-03-25T13:01:01.611000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "(just for your understanding)",
        "created_at": "2022-03-25T13:01:07.988000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "so if signatures were correct leading up to that point (even post transition), it seems unlikely that the `fork_version` being mixed in would change unexpectedly (not impossible but not a likely bug code path)",
        "created_at": "2022-03-25T13:11:56.618000+00:00",
        "attachments": null
    },
    {
        "author": "tersec",
        "category": "Testing",
        "parent": "",
        "content": "So usually when I've seen that it's exactly around the transitions -- phase0 to altair or altair to bellatrix -- where the boundary condition interpretations differ slightly",
        "created_at": "2022-03-25T13:12:53.894000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "right, because the epoch param that can dictate a modified `fork_version`",
        "created_at": "2022-03-25T13:13:24.100000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Hi, just want to confirm something: the reply with `LastValidHash` when receiving an `INVALID` answer from the EL, is it guaranteed that this last valid hash is an ancestor of the requested block hash?",
        "created_at": "2022-03-25T18:47:24.616000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "We’ve assumed that it might not be, and it might even just be junk. There seems to be three options if it’s not an ancestor:\n\n1.  Invalidate nothing\n2. Invalidate all ancestors\n3. Invalidate only the immediate block, ignoring the LVH.\n\nLighthouse has gone with (3). IIRC Teku is doing the same thing.",
        "created_at": "2022-03-25T19:42:18.800000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Ohh crap.. Thanks a lot for this, probably this would save me a refactor. What would worry me is if the EL returns the last valid hash in a separate fork that has a higher slot. So just to make sure, what you are doing is first traverse the parent chain to figure out if it's an ancestor and then make decision for 3 if it's not. I think I will go with removing the immediate block and any descendant of it",
        "created_at": "2022-03-25T19:45:01.997000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "Teku mark the protonode as VALID if is found",
        "created_at": "2022-03-25T19:50:33.970000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "We first check to see if the LVH is in fork choice. If it is, we walk backwards from the “head” (not real head, head of this particular operation) and ensure it’s an ancestor. It’s a little onerous, but it’s all in memory so I think it’s fine, especially given this is supposed to be a rare failure case.\n\nThis means that we won’t actually invalidate any ancestors if the LVH is earlier than the finalised block! This is a little.. quirky but seems to be a reasonable trade-off (once again, IIRC Teku is doing the same). It means we might struggle to detect that the finalized checkpoint is invalid and all is lost, but on the other hand we also won’t follow an invalid chain since we invalidate the “head” block.",
        "created_at": "2022-03-25T19:50:52.064000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "Just thinking now, if the timestamp was also retuned with the LVH we could do an O(1) slot-based lookup to find it in our chain 🤔",
        "created_at": "2022-03-25T19:53:15.740000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "The spec states:\n\u003e where validHash is the block hash of the most recent valid ancestor of the invalid payload. That is, the valid ancestor of the payload with the highest blockNumber\nSo, LVH must be of an ancestor block of the payload. It might be the case though that LVH does correspond to a block that isn't in the fork choice state",
        "created_at": "2022-03-25T19:53:41.446000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Thanks this is more or less what I'm doing, I just that I have some larger loops to make: I mark the LVH as valid if it exists in forkchoice. But also I find every root that's a decendant of the first invalid block (if it is in forkchoice). And remove those blocks from DB (otherwise it's hard to do later). This is absolutely trivial to do in the linked tree implementation, but in the protoarray, to find all descendants is O(n^2)",
        "created_at": "2022-03-25T19:54:54.112000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "In protoarray you have a guarantee that all children have a higher index than their parent, so if you start with the LVH and iterate forwards whilst keeping a set of all the blocks you invalidate then you can do it in O(n).",
        "created_at": "2022-03-25T19:56:43.109000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "That doesn't work with our protoarray implementation, we do not keep a status field for each node.",
        "created_at": "2022-03-25T19:57:43.145000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "We just keep the map of the last valid block in each branch",
        "created_at": "2022-03-25T19:58:00.173000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "checking how we search. We actually search going back from the requested block",
        "created_at": "2022-03-25T19:59:49.238000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "and then we mark all descendants as invalid",
        "created_at": "2022-03-25T20:02:49.263000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Yeah so what I am planning to do is \n1) receive LVH  and INVALID for hash `root`. \n2) Request if `LVH` is in Forkchoice.  \n2a). If NO:  if we want to rely on the EL following the spec as Misha points out, then we can simply panic, otherwise it's probably safer to just remove the one block. \n2b). If YES: go up from LVH index by index removing the roots whose parent are in the invalid list.  \n3) readjust the list of last valid blocks in each branch. \nThanks, actually \u003c@!361447803194441738\u003e I take it back, if I assume that forkchoice is in a healthy status and our implementation doesn't have a bug, then going up does work and it's O(n).",
        "created_at": "2022-03-25T20:07:27.584000+00:00",
        "attachments": null
    },
    {
        "author": "tbenr",
        "category": "Testing",
        "parent": "",
        "content": "this is what we do",
        "created_at": "2022-03-25T20:07:29.802000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "The panic in 2a sounds like it would be a bug when LVH is an ancestor of the finalised block. I assume the oldest block in your fork choice is the finalised block.",
        "created_at": "2022-03-25T20:09:11.346000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "I guess you want to panic and crash if it’s finalised, anyway",
        "created_at": "2022-03-25T20:09:46.289000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "yeah that's what I mean, if we don't find LVH in forkchoice and we assume the EL is not buggy, then we can safely panic cause the finalized block has to be invalid.",
        "created_at": "2022-03-25T20:10:23.377000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "Indeed, we originally did this too. It was easier to implement as well. However I think I heard Teku we’re not crashing and that seemed more appealing so I followed that.",
        "created_at": "2022-03-25T20:12:16.888000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "I can certainly see both sides.. it’s a tricky call",
        "created_at": "2022-03-25T20:12:28.192000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "yeah, it's scary to have all nodes of one client panic if suddenly there's an otherwise innocuous bug in another client",
        "created_at": "2022-03-25T20:13:05.731000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Say geth returns an invalid LVH for some weird reason, we would all panic when probably we could invalidate the block and continue...",
        "created_at": "2022-03-25T20:13:41.004000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "if anyway we all crash later, we were screwed before with an invalid final block",
        "created_at": "2022-03-25T20:13:58.061000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "We don't do that, we return our canonical latest block",
        "created_at": "2022-03-25T20:14:39.888000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "haha, this is getting interesting 🙂",
        "created_at": "2022-03-25T20:14:52.894000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "I have to think about whether we can even do that, on monday",
        "created_at": "2022-03-25T20:16:05.064000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "So I was originally assuming the spec behaviour when I came asking here: I think the EL is supposed to switch head or try to perform the fork, start validating the chain and return when it finds an invalid payload",
        "created_at": "2022-03-25T20:16:26.865000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "if the EL does guarantee that it's an ancestor, then it avoids a loop for the CL",
        "created_at": "2022-03-25T20:17:04.047000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "I can also see how it might be hard for an EL to return information about invalid chains.",
        "created_at": "2022-03-25T20:18:24.282000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "In this case it works correctly only if `INVALID` payload is a part of canonical chain. I can also see the complexity on EL side, let us both think on that on Monday 🤔",
        "created_at": "2022-03-25T20:26:05.638000+00:00",
        "attachments": null
    },
    {
        "author": "robocopsgonemad",
        "category": "Testing",
        "parent": "",
        "content": "besu is down this rabbit hole right now too, and I don't know what to do if payload isn't on canonical chain",
        "created_at": "2022-03-25T20:26:40.895000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "I have no clue about the El side to judge anything but I'd be tempted to say that if there's any complication there, it's absolutely fine to keep it as Marius says. This is a rare occurrence in theory and it's no complication in our side. It's a loop in memory in the worst of implementations",
        "created_at": "2022-03-25T20:35:25.174000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Yeah the most important place for latestValidHash is when it's on the canonical chain.  For non-canonical chains invalidating just the head block is enough anyway as that stops us following the rest of the chain.  For canonical chains we want to get back to valid as soon as possible so we can resume syncing what is hopefully the correct chain.",
        "created_at": "2022-03-25T21:35:26.644000+00:00",
        "attachments": null
    },
    {
        "author": "lukaszrozmej",
        "category": "Testing",
        "parent": "",
        "content": "Isn't requirement for EL to return last valid block hash from this branch a potential exploit? (It needs to keep invalid block data, it may be forced to traverse a lot of this data)",
        "created_at": "2022-03-25T21:57:32.388000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "I think this is right if the EL is for some reason SYNCING while the CL is following this bad branch optimistically. At some point the EL recognizes that it's following a bad branch by executing a bad block, but it would be forced to continue tracking bad blocks just to know what are it's descendants to reply correctly when requested. It doesn't make much sense",
        "created_at": "2022-03-25T22:04:02.969000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "How do you know the block is invalid if you haven't got a chain of blocks that lead to it? You couldn't execute it.",
        "created_at": "2022-03-25T22:06:27.942000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "The point is after that block, if the CL is a 1000 blocks down from that bad block it will request it and the EL is forced to know that it's a descendant of it's bad block",
        "created_at": "2022-03-25T22:07:35.328000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "But that's the same as today in PoW where they could receive a block from p2p that's 1000 blocks down.  They either don't bother executing it because it's a fork (ACCEPTED response now) or they have to follow the chain back until they reach a block that they know is invalid and then can say that whole chain is invalid.",
        "created_at": "2022-03-25T22:08:45.338000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "The issue is for a client like Erigon that is forward syncing block by block, it reaches a bad block and it doesn't know what it's children are",
        "created_at": "2022-03-25T22:10:04.067000+00:00",
        "attachments": null
    },
    {
        "author": "lukaszrozmej",
        "category": "Testing",
        "parent": "",
        "content": "same in Nethermind",
        "created_at": "2022-03-25T22:10:22.728000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "But say you're in sync, and you get a bad block from p2p.  You reject it.  Then you receive that bad block again - do you execute it again or did you keep track of the fact it was invalid?",
        "created_at": "2022-03-25T22:10:58.401000+00:00",
        "attachments": null
    },
    {
        "author": "lukaszrozmej",
        "category": "Testing",
        "parent": "",
        "content": "we have some small in-memory cache of  recent invalid block hashes",
        "created_at": "2022-03-25T22:12:20.082000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "FWIW, from this discussion I gather that there is *some* difficulty in returning the last valid ancestor on the EL side, while there's a possible optimization on the CL side. It would be still be useful for us to get the latest valid block on the EL canonical chain, since we may not have it as valid and we can turn that optimistic status in our forkchoice tree, so I say we should specify this behavior in the spec as opposed to have to treat this LVH as \"possible junk\" as Paul put it.",
        "created_at": "2022-03-25T22:13:58.724000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "So I get that you might not always want to follow the chain back from a block to discover where it connects to your valid chain because that could mean requesting a lot of blocks, but that also means you can't say the block is invalid because you haven't executed it and can't connect it to an invalid chain.  So the response would be ACCEPTED or SYNCING.  To know the block is invalid you would have to know that it does descend from some invalid block.\n\nRight now the tracking of invalid blocks is probably basically just a set of block hashes so it wouldn't tell you what the latest valid block is.  It could be come a set of block hash and latest valid block though so you could provide the info.  It's quite possibly not worth making this change but something seems wrong to me that an EL could say a block is INVALID and not know what chain it connects to.",
        "created_at": "2022-03-25T22:16:33.115000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Personally I think I'd rather get either the latest valid block on the specific chain the block is from or no latest valid hash.  I can't do anything with the latest valid block from a different chain because I'd run into all kinds of race conditions if I tried to invalidate everything after that block.",
        "created_at": "2022-03-25T22:18:26.369000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Actually I suppose it could be invalid because the block hash doesn't match the actual payload data or things like that.  That would definitely make sense to not return a latestValidHash for in my mind.",
        "created_at": "2022-03-25T22:21:18.107000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "\u003e I can't do anything with the latest valid block from a different chain because I'd run into all kinds of race conditions if I tried to invalidate everything after that block.\nYou can simply put that hash as valid, it's better than no information at all",
        "created_at": "2022-03-25T22:25:02.836000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "I'd have found out that block was valid from the next fork choice update anyway - and if the next fcu returned syncing I'd be in optimistic sync mode anyway so it doesn't really matter where along the chain things switch from optimistic to valid.  latestValidHash is useful for removing a bunch of invalid nodes at the same time without having to work your way back up the chain one block at a time, sending an fcu for each until you finally reach the valid one.",
        "created_at": "2022-03-25T22:31:42.219000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "I mean ultimately it doesn't really matter, if teku gets a block that's from a different fork we will wind up ignoring the latestValidHash but it wastes a bit of our time going searching for it.  Given it's not a common case I'm not too worried about that though.",
        "created_at": "2022-03-25T22:32:37.137000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Ok so I suppose you are arguing that if we get INVALID with no LVH it means that the invalid block is not in the canonical chain of the EL and we don't even need to bother looking for it. I will concede that this does save a couple of cycles.",
        "created_at": "2022-03-25T22:47:36.900000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Yeah basically - but more so just that the EL can tell me that *this* block is invalid and it doesn't know where the latest valid hash is in that chain.",
        "created_at": "2022-03-25T22:55:42.329000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "For a newPayload that seems very reasonable.  For a fcu I would tend to expect the EL to be able to tell me the latest valid hash because it would then be in the canonical chain (or at least the chain I'm trying to make canonical).  But even there it isn't a big deal, just that EL is going to get a fcu with the parent block pretty quickly if it only tells me the head block is invalid. 🙂",
        "created_at": "2022-03-25T22:57:20.713000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "I agree, this is fine, perhaps it makes the logic in some cases a little awkward to check for no lvh or a special value meaning that. I'm fine either way is LVH means last canonical or \"nothing if not canonical, last canonical otherwise\"  but I'd like it if we specify this instead of the current one and then just assume that LVH may mean anything cause EC can't comply",
        "created_at": "2022-03-25T23:20:35.408000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Teku already considers it optional because it isn’t there for success or syncing responses anyway.",
        "created_at": "2022-03-25T23:39:19.715000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "LH is strict about LVH being included when the spec says it should be. I did a refactor to ensure this 😅\n\nI don’t mind any of the options on the table. I don’t have strong feelings about LVH.",
        "created_at": "2022-03-25T23:42:53.762000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Our current develop ignores completely this reply  since we're only removing the one block and it's children (that should be none) so this would be fairly easy here :)",
        "created_at": "2022-03-25T23:53:46.986000+00:00",
        "attachments": null
    }
]