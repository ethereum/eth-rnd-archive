[
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "It would depend on EL implementation. If EL client supports SYNCING on a side branch which is not the case AFAIK for any of existing clients, then SYNCING will be in the response. Otherwise, ACCEPTED with possible SYNCING in the case that \u003c@!360491619402776577\u003e have outlined",
        "created_at": "2022-02-03T05:59:19.437000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "Hey Guys! ðŸ‘‹ Was discussing the issue with \u003c@!758579010027782144\u003e  of how currently prepare payload and get payload calls are being done in same flow (apparently by every CL from their call timings) leaving from none to 30-40ms in the best case time for ELs to build a payload.",
        "created_at": "2022-02-03T11:10:40.580000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "anyway the conclusion was , prepare would need to be called like in the last \"interval\" of the previous slot, earlier the better, independently from the produceBlock calls that the validator initiate",
        "created_at": "2022-02-03T11:12:47.441000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "coming to the main question: is the payload id received in the two consecutive calls to EL (with the same params) result into same payload id",
        "created_at": "2022-02-03T11:13:54.589000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "if that is the case, then timing prepare call would be much easier as it could just be independently run in the last interval of previous slot and the usual produceBlock call flow would work seamlessly",
        "created_at": "2022-02-03T11:15:17.860000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "else CL will need to cache the payload id somehow",
        "created_at": "2022-02-03T11:15:42.428000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e Yeah, one reason at least Nimbus does this is that there's a wholly asynchronous flow, and that kind of caching is nontrivial to validate",
        "created_at": "2022-02-03T11:16:26.694000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e As is, there's a reliable linear sequence between where it gets a payload ID and uses a payload ID",
        "created_at": "2022-02-03T11:16:57.577000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "If the two consecutive prepare payload calls  to EL with same params result in same payload id (i.e. idempotent operation even if the EL is done building the payload), things will be very simple for CL, as it would be just to time the prepare call.",
        "created_at": "2022-02-03T11:20:03.247000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e the advantage from the CL side for changing this is that it makes timing more predictable, too",
        "created_at": "2022-02-03T11:22:29.055000+00:00",
        "attachments": null
    },
    {
        "author": "yperbasis",
        "category": "Testing",
        "parent": "",
        "content": "Fine from my point of view, but has to be in the Engine API spec.",
        "created_at": "2022-02-03T11:22:44.098000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e The goal is to propose at a very specific moment, and adding in this round-trip to the EL necessarily adds schedule risk",
        "created_at": "2022-02-03T11:23:09.990000+00:00",
        "attachments": null
    },
    {
        "author": "marekm3498",
        "category": "Testing",
        "parent": "",
        "content": "Yeah it is not a problem for Nethermind too, but I also think we should add this to the spec",
        "created_at": "2022-02-03T11:25:44.887000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e (oh, \"schedule risk\" during a slot time specifically. Not commenting on testnet preparation)",
        "created_at": "2022-02-03T11:27:45.130000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "ummm you mean, nimbus's produceBlock would start early, signal EL to prepare, sleep for few secs, and then continue and fetch in same call flow?",
        "created_at": "2022-02-03T11:29:52.207000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "I guess that could work, unless there is a duties reorg (which could be easily checked and flow abandoned if that happened)",
        "created_at": "2022-02-03T11:30:48.868000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e right now, it doesn't, because it doesn't know for sure what the head will be, because attestations affecting that could come in until quite late",
        "created_at": "2022-02-03T11:31:29.634000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "with proposer boost, that mightnot be a problem",
        "created_at": "2022-02-03T11:32:18.014000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "but in anycase, if we can have consecutive prepare payload calls to be idempotent op for payload id (blocks could still be improved in the background if still not fetched)",
        "created_at": "2022-02-03T11:34:50.707000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e I get the intuition regarding proposer boost, but unless it ends up nearly-guaranteed, it's a bit risky/tight coupling between two parts of the (meta-)spec which aren't otherwise tightly coupled",
        "created_at": "2022-02-03T11:35:49.962000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "right, so a produce block call flow makes sense to have its own call to prepare before doing a fetch (with whatever timing strategy a client can choose to deploy), but if there is a gurratee that payload id won't change for same params, then one could easily devise strategies to call EL to prepare (lets say from as soon as the last slot's block is imported to having a scheduling plan, or as soon as reorg of head happens)",
        "created_at": "2022-02-03T11:40:54.752000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "and if the params change between two consecutive prepare calls, it should imply that ELs abandon previous prepare and start building a new one",
        "created_at": "2022-02-03T11:43:46.552000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003ctersec\u003e Seems broadly reasonable",
        "created_at": "2022-02-03T11:46:54.218000+00:00",
        "attachments": null
    }
]