[
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@!543900561460822016\u003e \u003c@!203220829473996800\u003e excellent work guys! `preparePayload` and `consensusValidated` in the readme section are just leftovers, right?",
        "created_at": "2021-11-10T04:00:24.228000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cprotolambda\u003e Oh yes, need to update readme, that's outdated indeed",
        "created_at": "2021-11-10T04:02:39.477000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@!360491619402776577\u003e I am curious what timestamp checks geth does today",
        "created_at": "2021-11-10T06:05:47.732000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "You mean in pow? We check that the timestamp is bigger than the parent timestamp and (I believe) less than 4 minutes in the future from the parent",
        "created_at": "2021-11-10T06:58:08.215000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "yeah, I meant PoW. I am recalling a timeout on a block creation as well, something like 5s; or it was a delay of block creation process for this amount of time",
        "created_at": "2021-11-10T07:07:28.596000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "is preventing nodes to build 4 minutes after the parent done for security purpose?",
        "created_at": "2021-11-10T07:31:02.476000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "yes",
        "created_at": "2021-11-10T07:31:19.996000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Testing",
        "parent": "",
        "content": "I believe the timestamp can only be 15 seconds in the future? https://github.com/ethereum/go-ethereum/blob/0efed7f58baed63dab5351667e677a688458a3d7/consensus/ethash/consensus.go#L46",
        "created_at": "2021-11-10T13:54:21.510000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "Note that CL doesn't process any blocks from the future *and* won't build blocks for the future (more than ~1 slot)\n\nSo any checks in the engine API for EL would be sanity checks on input validations from the trusted CL. At best this would prevent EL from doing unnecessary work if there are errors on CL. At worst, it could brick the communication if CL has a good clock and EL has a bad one",
        "created_at": "2021-11-10T13:59:03.241000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "I'm okay with a sanity bound on time input validations but I would definitely not make them tighter than ~1 minute or something. Such that normal clock skew would not brick the comms",
        "created_at": "2021-11-10T13:59:37.148000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "(relevant PR under discussion https://github.com/ethereum/execution-apis/pull/121)",
        "created_at": "2021-11-10T14:01:02.240000+00:00",
        "attachments": null
    },
    {
        "author": "marekm3498",
        "category": "Testing",
        "parent": "",
        "content": "It seems ok in Nethermind too üôÇ",
        "created_at": "2021-11-10T15:14:54.426000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "hi \u003c@!360491619402776577\u003e, there is a doubt regarding `checkTerminalTotalDifficulty`, in the scenario when td is set, the function seems to be checking td for the parent of HeadBlockHash (called via `ForkchoiceUpdatedV1`), while in the consensus specs, HeadBlockHash is where its parent \u003c ttd and HeadBlockHash \u003e=ttd, so parent's ttd is always turning up to be low",
        "created_at": "2021-11-10T19:57:44.431000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "in the kintsugi-spec branch",
        "created_at": "2021-11-10T19:58:02.129000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "this is happening in from pre merge to post merge transition scenario, where ttd \u003e0 is being provided via genesis",
        "created_at": "2021-11-10T20:03:43.290000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "resulting error: `Error: JSON RPC error: total difficulty not reached yet, engine_forkchoiceUpdatedV1 `",
        "created_at": "2021-11-10T20:06:00.358000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Ah I think I see my problem. So the headblockhash refers to the pow chain that we want to build on",
        "created_at": "2021-11-10T20:13:01.574000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "yes!",
        "created_at": "2021-11-10T20:13:21.742000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "thats what my understanding is",
        "created_at": "2021-11-10T20:13:46.377000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "```python\ndef prepare_execution_payload(state: BeaconState,\n                              pow_chain: Dict[Hash32, PowBlock],\n                              finalized_block_hash: Hash32,\n                              fee_recipient: ExecutionAddress,\n                              execution_engine: ExecutionEngine) -\u003e Optional[PayloadId]:\n    if not is_merge_complete(state):\n        is_terminal_block_hash_set = TERMINAL_BLOCK_HASH != Hash32()\n        is_activation_epoch_reached = get_current_epoch(state.slot) \u003e= TERMINAL_BLOCK_HASH_ACTIVATION_EPOCH\n        if is_terminal_block_hash_set and not is_activation_epoch_reached:\n            # Terminal block hash is set but activation epoch is not yet reached, no prepare payload call is needed\n            return None\n\n        terminal_pow_block = get_terminal_pow_block(pow_chain)\n        if terminal_pow_block is None:\n            # Pre-merge, no prepare payload call is needed\n            return None\n        # Signify merge via producing on top of the terminal PoW block\n        parent_hash = terminal_pow_block.block_hash\n    else:\n        # Post-merge, normal payload\n        parent_hash = state.latest_execution_payload_header.block_hash\n\n    # Set the forkchoice head and initiate the payload build process\n    payload_attributes = PayloadAttributes(\n        timestamp=compute_timestamp_at_slot(state, state.slot),\n        random=get_randao_mix(state, get_current_epoch(state)),\n        fee_recipient=fee_recipient,\n    )\n    return execution_engine.notify_forkchoice_updated(parent_hash, finalized_block_hash, payload_attributes)\n```",
        "created_at": "2021-11-10T20:21:45.744000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "as per the reference code, first argument to `notify_forkchoice_updated` will be set to `terminal_pow_block.block_hash` at the merge block",
        "created_at": "2021-11-10T20:22:53.173000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "spec version 1.1.5",
        "created_at": "2021-11-10T20:23:44.428000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "Yes, so it's \"hey this is the head and I want to build on it\"\n\nfor the first PoS block, that head refrenced to build on will be a pow block",
        "created_at": "2021-11-10T20:32:53.095000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "üëç , so the `checkTerminalTotalDifficulty` should just check ttd on this head and not on its parent",
        "created_at": "2021-11-10T20:36:08.613000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "that will fix the issue here i think",
        "created_at": "2021-11-10T20:36:36.773000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "where is `checkTerminalTotalDifficulty` defined?",
        "created_at": "2021-11-10T20:40:52.595000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "in a test vector somewhere?",
        "created_at": "2021-11-10T20:41:34.075000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "given recent updates in 3675, EL shouldn't do the TTD check and just rely on CL when CL says to build pos on a pow block",
        "created_at": "2021-11-10T20:42:27.849000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "See here -- https://eips.ethereum.org/EIPS/eip-3675#fork-choice-rule",
        "created_at": "2021-11-10T20:43:29.181000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "essentially any call to `POS_FORKCHOICE_UPDATED` should win over PoW and assume CL knows the correct terminal conditions",
        "created_at": "2021-11-10T20:44:12.459000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "https://github.com/MariusVanDerWijden/go-ethereum/blob/kintsugi-spec/eth/catalyst/api.go#L466-L489",
        "created_at": "2021-11-10T20:44:22.972000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "I see\n\nI have to step AFK, but due to TTD override existing in CL (and not in EL), the plan is to *not* have EL do the TTD checks\n\n(but to still halt importing of blocks beyond TTD from the gossip ntwork)",
        "created_at": "2021-11-10T20:45:12.313000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Testing",
        "parent": "",
        "content": "will followup later",
        "created_at": "2021-11-10T20:45:15.748000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "üëç",
        "created_at": "2021-11-10T20:45:54.283000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "this fn gets called from here https://github.com/MariusVanDerWijden/go-ethereum/blob/kintsugi-spec/eth/catalyst/api.go#L187-L191",
        "created_at": "2021-11-10T20:47:10.903000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "our issue related to this: https://github.com/ChainSafe/lodestar/issues/3427",
        "created_at": "2021-11-10T20:48:28.492000+00:00",
        "attachments": null
    }
]