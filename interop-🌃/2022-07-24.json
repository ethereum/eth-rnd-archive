[
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "hmmm, came back home and looking to do it,  it's a rather non-trivial change, we only look for terminal difficulties after we get a VALID response from the EL. Changing this is not so easy. The alternative of doing it even if the EL returns ACCEPTED is also not nice because of what I mentioned above that it would break the symmetry of SYNCING/ACCEPTED in our code. At this point I think I'd rather wait to see if Erigon would execute the TTD block here, given that from what Marek said, it's possible that Nethermind can do it.",
        "created_at": "2022-07-24T00:40:06.430000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Yeah I think sending fcu for something that isn‚Äôt the head is a bad idea. Fcu is supposed to be for communicating what the chain head is, not a hacky way to get the EL to execute something.",
        "created_at": "2022-07-24T02:27:03.303000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "My suggestion would be that the EL should be required to actually execute blocks they receive via newPayload if they have the data required and haven‚Äôt yet received a fcu with a finalized block.",
        "created_at": "2022-07-24T02:28:37.034000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "That‚Äôs essentially the same as sending an fcu in this case which is just to force the EL to execute a non canonical block. It‚Äôs time bounded so the optimisation to not execute comes back in once the chain is finalising, avoids the risk of the CL being unable to reorg correctly around the merge and doesn‚Äôt require any protocol changes.",
        "created_at": "2022-07-24T02:30:02.889000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Or at least doesn‚Äôt require any changes to the on the wire engine api protocol - it is obviously changing the requirements on EL for newPayload.",
        "created_at": "2022-07-24T02:30:49.807000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Given they have to execute for the canonical chain and have to be able to reorg and execute for fcu it shouldn‚Äôt be too big a deal.",
        "created_at": "2022-07-24T02:31:22.174000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e But you do use FCU to execute side chains that are not yet resolved if/when forkchoice takes over. So if it's ACCEPTED (and this means semantically that all blocks are there) and has the weight to be head, running FCU at that point is normal behaviour and wouldn't fc poison because accepted means blocks are there (if that's the actual semantics people are using)",
        "created_at": "2022-07-24T02:33:01.697000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e I'm not suggesting pre-empting a FCU on non-canonical weight branches but if attestations say so, it should be safe to do to an ACCEPTED (rather than SYNCING) branch during this merge window",
        "created_at": "2022-07-24T02:33:50.998000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "If it becomes head yes. But it can‚Äôt become head because it can‚Äôt be imported. And we can‚Äôt even tell it would have become head because we can‚Äôt process any attestations for it until it‚Äôs imported.",
        "created_at": "2022-07-24T02:34:12.965000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "We‚Äôd have to optimistically import and then we‚Äôre subject to fork choice poisoning unless there‚Äôs some way to differentiate ‚ÄúEL has the data but chooses not to execute‚Äù from ‚ÄúEL is missing the required data to execute this‚Äù",
        "created_at": "2022-07-24T02:35:13.004000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e ACCEPTED and SYNCING are supposed to be semantically different for this precise level of precision",
        "created_at": "2022-07-24T02:35:39.229000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e But not all clients respect the intended semantics",
        "created_at": "2022-07-24T02:35:50.359000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "I didn‚Äôt think syncing was a valid response from newPayload at all but maybe I missed something.",
        "created_at": "2022-07-24T02:36:07.446000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e It is",
        "created_at": "2022-07-24T02:36:53.997000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e https://github.com/ethereum/execution-apis/blob/main/src/engine/specification.md#specification",
        "created_at": "2022-07-24T02:37:09.261000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e ACCEPTED was added specifically for clients to be able to say \"this is a  well formed chain but it's not cryptoeconomically valuable enough for me to execute. Say FCU if you really want me to\"",
        "created_at": "2022-07-24T02:37:53.514000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Ah I completely missed that detail. In which case yes we could allow optimistic import for ACCEPTED in teku. It‚Äôs a bit of work but shouldn‚Äôt be too bad. But we‚Äôd have to be absolutely certain the EL always gets the distinction right.",
        "created_at": "2022-07-24T02:38:00.770000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e I can't remember the status anymore. It was being incorrectly used in different ways but then there was a bit more conformance, I believe \n\nIn most cases, the distinction between the two terms don't actually cause CL to do something different so I stopped pushing too hard for the semantic distinction. That said, I believe it made it into hive",
        "created_at": "2022-07-24T02:39:38.143000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "I‚Äôd still say it‚Äôs simpler not to have the distinction and just disable the optimisation in the EL until finality.",
        "created_at": "2022-07-24T02:39:40.284000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e Geth is fine to execute such branches. It's more expensive  in erigon but certainly possible. I think nethermind as well",
        "created_at": "2022-07-24T02:40:37.842000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e It'd be essentially, insert and (internal simulation of) FCU for status, then a revert to prior head",
        "created_at": "2022-07-24T02:41:00.702000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Yeah that‚Äôs my thinking basically. And it means we could remove the distinction from the protocol and simplify things so this transition complexity doesn‚Äôt have to live on forever.",
        "created_at": "2022-07-24T02:41:57.885000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e \u003e \u003cdannyryan\u003e  (and geth does \"shallow fork\" execution.for within 128 blocks from head) (re @dannyryan: Geth is fine to execute such branches. It's more expensive  in erigon but certainly possible. I think nethermind as well)",
        "created_at": "2022-07-24T02:42:05.516000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Although I guess we could remove the distinction post merge as well which is where we‚Äôd land either way since we don‚Äôt want to change things if we don‚Äôt have to now.",
        "created_at": "2022-07-24T02:42:53.997000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e ACCEPTED isn't just for transition. It's to make clear the difference between what EL is actually doing\n\n(Waiting for valuable enough to execute vs doesn't have the data locally)\n\nI guess I figure this is valuable info and strange to drop",
        "created_at": "2022-07-24T02:43:05.761000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "As far as I know no CL makes use of the distinction and this is the first case I‚Äôve come across where there was even a vague use case for it.",
        "created_at": "2022-07-24T02:44:39.790000+00:00",
        "attachments": null
    },
    {
        "author": "bridge-bot",
        "category": "Testing",
        "parent": "",
        "content": "\u003cdannyryan\u003e Id say it's much less than vague here\n\nBut I agree that my assumption that it was valuable to know has been so far incorrect",
        "created_at": "2022-07-24T02:45:21.259000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Oh yeah I can see how it would affect CL behaviour here but we only just discovered this corner case. üôÇ",
        "created_at": "2022-07-24T02:46:07.416000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "So to pull this together to something actionable.  Are EL clients able to execute non-canonical blocks received via `engine_newPayload` if they have the data available to do so up until the first FCU with a finalized block? By the specs this would mean you can return `SYNCING` to say you're still downloading ancestor blocks or world state, but can't just choose not to execute because its non-canonical and return `ACCEPTED`.  \u003c@\u0026688101493978562687\u003e \u003c@\u0026836981603216654336\u003e  ?  My understanding is that Geth already does this and Nethermind are planning to.",
        "created_at": "2022-07-24T03:08:36.928000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Yes we already do that",
        "created_at": "2022-07-24T07:17:54.346000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "We dont return VALID though as we dont know how much the process takes but we are executing them, and mark them valid",
        "created_at": "2022-07-24T07:18:42.993000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "So if the beacon node retries would it get a VALID on the second attempt (assuming processing had completed)?",
        "created_at": "2022-07-24T07:20:42.872000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Yes it would",
        "created_at": "2022-07-24T07:20:59.886000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Given that full execution is done",
        "created_at": "2022-07-24T07:21:13.469000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Ok that‚Äôs a good start. The node would get stuck until it retried but not for the full safe slots period",
        "created_at": "2022-07-24T07:21:40.267000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Would it be possible to make it wait and return valid or invalid if the merge hasn‚Äôt finalised yet or is that hard to do?",
        "created_at": "2022-07-24T07:22:07.892000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Side note: We skip validation of downloaded side forks only up to a distance from the head of 32, but thats the length of an epoch",
        "created_at": "2022-07-24T07:22:28.863000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Probably we could make it wait in all scenarios(not just the merge) and return VALID on first attempt but things have to be right",
        "created_at": "2022-07-24T07:24:10.135000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "First of all, few blocks to download, secondly, does not take much to execute and P2P networking needs to be fully performant without any fluctuation",
        "created_at": "2022-07-24T07:24:51.484000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "It may be tedious to do something like that",
        "created_at": "2022-07-24T07:25:28.500000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "If you need to download blocks SYNCING is always the right response. But if you already have the required blocks it would be good to get valid straight away if it can be done in a reasonable time (in particular if it‚Äôs on a non canonical fork that‚Äôs only a couple of blocks long)",
        "created_at": "2022-07-24T07:27:23.032000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Ah if we have the ancestor and all that comes before, then yes we return VALID",
        "created_at": "2022-07-24T07:27:56.762000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Even for non canonical blocks? That‚Äôs quite different to what everyone seems to think Erigon will do.",
        "created_at": "2022-07-24T07:28:39.784000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Yes also for side forks",
        "created_at": "2022-07-24T07:28:50.928000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "We use in-memory execution",
        "created_at": "2022-07-24T07:29:09.200000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "It is going to be in the next alpha release",
        "created_at": "2022-07-24T07:29:18.690000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Erigon by design was not meant for concurrent forks, but I was able to hack a clean way to do it without risking major database corruptions",
        "created_at": "2022-07-24T07:30:44.804000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Right makes sense. I think that will make Erigon a much better client post merge as it will make reorgs cheaper , including for the CL as it shouldn‚Äôt have to go into optimistic mode or wait for the fcu response.",
        "created_at": "2022-07-24T07:38:17.141000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "I can actually try to make it return VALID on the first fcu in  case the above conditions are met with relative ease, would that help?",
        "created_at": "2022-07-24T09:43:42.852000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "There won‚Äôt be a fcu in the case we‚Äôre worried about because the CL can‚Äôt optimistically import the block. We‚Äôd need to get VALID on the engine_newPayload call to allow the CL to import the block.",
        "created_at": "2022-07-24T09:51:59.344000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Okay it can be done on the first newPayload as well, would that help?",
        "created_at": "2022-07-24T10:16:15.147000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Yeah I think it would help - especially right after the transition block.",
        "created_at": "2022-07-24T10:42:38.058000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "In our case this would be all that's needed, we will only send the first newPayload on the merge block",
        "created_at": "2022-07-24T11:24:21.132000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "https://github.com/ledgerwatch/erigon/pull/4812 the PR is ready, it will come out with the next release",
        "created_at": "2022-07-24T17:41:45.130000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "Can you check the bitwise arithmetic cause it's dangerous? I think your test is not really covering the function\nhttps://go.dev/play/p/JoBQvXyk1qf",
        "created_at": "2022-07-24T18:51:00.863000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "The function is right though",
        "created_at": "2022-07-24T18:51:28.203000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "By the way, I'm convinced the compiled assembly will be faster with something like\n```go\nif x \u003e y {\n    return x - y\n}\nreturn y - x\n```\nAt the very least I'm absolutely certain that in C++ `(x \u003e= y) ? x - y : y - x`  will be the fastest compiled assembly. And your fellow reviewers will probably thank you for something easier to read than fancy xors üôÇ",
        "created_at": "2022-07-24T18:58:56.375000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "Sometimes i just like to have my fun :)",
        "created_at": "2022-07-24T19:01:24.305000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "you just caught me today disassembling stuff on a boring Sunday that my family is sleeping üôÇ I was disassembling an if-else statement in Go casually to find out that the compiler is rather silly https://discord.com/channels/476244492043812875/483691416158208001/1000826392801460275",
        "created_at": "2022-07-24T19:03:07.884000+00:00",
        "attachments": null
    },
    {
        "author": "funnygiulio",
        "category": "Testing",
        "parent": "",
        "content": "I think sometimes you need to enjoy life and just do silly stuff like that just for the sake of doing silly stuff. Always being serious is harmful. But you are right readability is better, lol.",
        "created_at": "2022-07-24T19:05:13.462000+00:00",
        "attachments": null
    }
]