[
    {
        "author": "sproul",
        "category": "Testing",
        "parent": "",
        "content": "After kicking Lighthouse to sync its cache (our follow distance was holding us back), we do see Prysm's block, but with 190 deposits:\n\n```json\n    {\n      \"hash\": \"0x6e9c6d576ef4556e6decbbac127711823f58e38c5495b4d5cd05e5d52e2cd594\",\n      \"timestamp\": 1653992405,\n      \"number\": 12319896,\n      \"deposit_root\": \"0x2e9243f15c082b84071f66336b072321ae954ff0f07b37d1d171ed0eeba6e985\",\n      \"deposit_count\": 190\n    }\n```\n\nFull cache here: https://gist.github.com/michaelsproul/6138aea6660caa1bc832577f6c8e4b12",
        "created_at": "2022-06-01T00:19:33.622000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "ty",
        "created_at": "2022-06-01T00:23:24.922000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "I will investigate the split deposit count issues in a bit",
        "created_at": "2022-06-01T00:23:51.780000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@360491619402776577\u003e did you guys see this bad block already?",
        "created_at": "2022-06-01T00:42:49.173000+00:00",
        "attachments": [
            {
                "type": "text/plain; charset=utf-8",
                "origin_name": "message.txt",
                "content": "8d9744c10fa65362bf7ba79fa4b5ecb3bd975948216b36b8a84e78b5615e1574"
            }
        ]
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "the user gets to a sync loop after this as the CL keeps sending the same payloads over and over since it can't remove the finalized block (I'm guessing geth sent an older LVH)",
        "created_at": "2022-06-01T00:44:25.240000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "The block is valid on the explorer\nhttps://explorer.kiln.themerge.dev/block/68954/transactions",
        "created_at": "2022-06-01T00:50:55.745000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "FWIW GETH_VERSION=1.10.17\n```\nexec geth \\\n  --syncmode \"snap\" \\\n  --gcmode \"full\" \\\n  --port 29888 \\\n  --http \\\n  --http.addr 0.0.0.0 \\\n  --http.corsdomain \"*\" \\\n  --http.api eth,web3,net,engine \\\n  --http.port \"8545\" \\\n  --http.vhosts '*' \\\n  --maxpeers \"50\" \\\n  --ws \\\n  --ws.addr 0.0.0.0 \\\n  --ws.origins \"*\" \\\n  --ws.port \"8545\" \\\n  --ws.api eth,web3,net,engine \\\n  --rpc.evmtimeout \"15s\" \\\n  --metrics \\\n  --pprof \\\n  --pprof.addr 0.0.0.0 \\\n  --pprof.port \"6060\" \\\n  --datadir /ethereum/ \\\n  --cache \"4096\" \\\n  --networkid 1337802 \\\n  --kiln \\\n  --override.terminaltotaldifficulty 20000000000000 \\\n  --authrpc.jwtsecret=/usr/local/genesis/kiln/jwtsecret \\\n  --bootnodes enode://c354db99124f0faf677ff0e75c3cbbd568b2febc186af664e0c51ac435609badedc67a18a63adb64dacc1780a28dcefebfc29b83fd1a3f4aa3c0eb161364cf94@164.92.130.5:30303 \\\n  --verbosity \"3\"\n```",
        "created_at": "2022-06-01T00:59:36.768000+00:00",
        "attachments": null
    },
    {
        "author": "potuz",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@211091239112671234\u003e  This looks very much like the situation here https://discord.com/channels/595666850260713488/910910348922589184/973476599053828127 will the same tool decide if the db is corrupt? is there a reason to get a few reports like these ones now?",
        "created_at": "2022-06-01T01:08:13.344000+00:00",
        "attachments": null
    },
    {
        "author": "sproul",
        "category": "Testing",
        "parent": "",
        "content": "New Ropsten voting period looks bad too, started off with a string of votes for the incumbent, then a Prysm vote for a block with an invalid deposit count (https://beaconchain.ropsten.ethdevops.io/block/10250) then a Nethermind vote for an older block , presumably due to running Lighthouse (https://beaconchain.ropsten.ethdevops.io/block/10255)\n\nThe Nethermind/Lighthouse block is leading, but won't get quorum\n\n```\n0xeefb1f70bf7bed6394ed7d6f812f422aa37bf7680e1b75fa551d40e849f10a87[0]: 39 (incumbent)\n0xabddbfd7f3a9983f6b362f4355f838d7333dee1ec13b21add96e4b4346e98498[200]: 38\n0x9e2e711ac58d4164aa06ff32d3ded3893883bd44cdd252fed9959dad811b6606[181]: 12\ntotal votes in period: 89, slots remaining: 1955\nparticipation: 96.74%\n```\n\nLighthouse thinks the correct deposit count for Prysm's block is 204",
        "created_at": "2022-06-01T01:27:33.548000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Is `0xeefb1f70bf7bed6394ed7d6f812f422aa37bf7680e1b75fa551d40e849f10a87` accurate ? \nhttps://ropsten.etherscan.io/block/0xeefb1f70bf7bed6394ed7d6f812f422aa37bf7680e1b75fa551d40e849f10a87 Shows it being 15 days ago",
        "created_at": "2022-06-01T01:35:49.686000+00:00",
        "attachments": null
    },
    {
        "author": "sproul",
        "category": "Testing",
        "parent": "",
        "content": "that's the state's current eth1 block, so I think all the nodes that aren't synced properly are voting for it",
        "created_at": "2022-06-01T01:37:09.147000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "ah ok",
        "created_at": "2022-06-01T01:37:17.210000+00:00",
        "attachments": null
    },
    {
        "author": "sproul",
        "category": "Testing",
        "parent": "",
        "content": "currently that seems to be Lodestar + Nimbus mainly",
        "created_at": "2022-06-01T01:37:24.327000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "So I have a good idea on why prysm's voting is off. We don't process deposits for blocks that are in the follow distance. However this block \nhttps://ropsten.etherscan.io/block/0xabddbfd7f3a9983f6b362f4355f838d7333dee1ec13b21add96e4b4346e98498\n\nis within the follow distance. This is a recent block so it would be:\n\u003e 12321609 - 12320010 \nwhich is 1599 which would be within the follow distance.  However our voting period assumes block times are 12 seconds, while ropsten is highly irregular. Most blocks seem to be varying from 30 to 60 seconds.",
        "created_at": "2022-06-01T01:47:01.084000+00:00",
        "attachments": null
    },
    {
        "author": "sproul",
        "category": "Testing",
        "parent": "",
        "content": "sounds similar to our issue, except we were just not importing blocks at all due to the long block times https://github.com/sigp/lighthouse/pull/3234",
        "created_at": "2022-06-01T02:00:10.857000+00:00",
        "attachments": null
    },
    {
        "author": "sproul",
        "category": "Testing",
        "parent": "",
        "content": "damn you PoW miners \\**shakes fist*\\*",
        "created_at": "2022-06-01T02:00:26.290000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "In Teku we go through and find the first block that's more recent than the follow distance. Then wait until that block is in the follow distance, add it into our eth1 block cache and get the next block to repeat the process.  That way we have a very cheap way of ensuring we have every block within the follow distance that's not affected by block times. The initial search just may make a lot more calls if block times are off what we expect as we have to search forwards or backwards from our first guess to find the right block.",
        "created_at": "2022-06-01T02:14:06.225000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Yeah it is an issue, not sure on what is a good solution. Should we be reducing the follow distance ? Or alternatively increasing the block time in the config. As i understand it ropsten doesnt usually have 12 seconds blocks, it seems that the average block time is 30 seconds.",
        "created_at": "2022-06-01T02:17:44.252000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Alternatively we can just wait till the merge where it will be down to 12 seconds again",
        "created_at": "2022-06-01T02:18:36.148000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "In a PoW chain you just can't depend on block times being predictable. I think it was probably a mistake to make the follow distance time based and definitely a mistake to put `SECONDS_PER_ETH1_BLOCK` into the spec as if it had any actual meaning.",
        "created_at": "2022-06-01T02:20:16.620000+00:00",
        "attachments": null
    },
    {
        "author": "nishant0",
        "category": "Testing",
        "parent": "",
        "content": "Yeah it does seem like a mistake, adding a timing based component seems to have been wrong",
        "created_at": "2022-06-01T02:21:18.760000+00:00",
        "attachments": null
    },
    {
        "author": "ajsutton",
        "category": "Testing",
        "parent": "",
        "content": "Fun fact: Teku still has a block based head tracker which always follows 1024 blocks behind regardless of time.  We were incorrectly using that for a fair while and I was very surprised to find it was wrong.  Guess I get to delete some code. ðŸ™‚",
        "created_at": "2022-06-01T02:22:28.953000+00:00",
        "attachments": null
    },
    {
        "author": "dapplion",
        "category": "Testing",
        "parent": "",
        "content": "We found an issue in the logic conputing the root, will roll out of fix soon. I expect to resolve the wrong votes",
        "created_at": "2022-06-01T02:59:28.585000+00:00",
        "attachments": null
    },
    {
        "author": "holiman",
        "category": "Testing",
        "parent": "",
        "content": "We now have the tooling on master, `geth snapshot check-dangling-storage`. That's probably a good start",
        "created_at": "2022-06-01T05:15:44.596000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "Testing",
        "parent": "",
        "content": "Added it as an `ethdo` command:\n```\n$ ethdo chain eth1votes --verbose\nSlot: 13530\nVoting period: 6\nIncumbent: block 0xeefb1f70bf7bed6394ed7d6f812f422aa37bf7680e1b75fa551d40e849f10a87, deposit count 0\nSlots through period: 1242\nVotes this period: 1189\n  block 0x0ae5716ac1906592dbfb243ccadf90191f706d6f8c925b4f2712d2e24687553a, deposit count 204: 444 votes\n  block 0xeefb1f70bf7bed6394ed7d6f812f422aa37bf7680e1b75fa551d40e849f10a87, deposit count 0: 366 votes\n  block 0xd705e30761294ba8e313f613f6dec5939a49b663aeac74a830fb49e776f2cad3, deposit count 204: 193 votes\n  block 0x5a9559167c4690f9061b15263dd60edd2eaefd2694cad6e25247ba5136115fab, deposit count 204: 132 votes\n  block 0xd705e30761294ba8e313f613f6dec5939a49b663aeac74a830fb49e776f2cad3, deposit count 203: 46 votes\n  block 0x54878dc4634ff267ea924b0ab5ffb37b2e9b41e0d333439ca1f5533e1743b47e, deposit count 0: 1 vote\n  block 0x356c8d2f935c1b311f66c8e8d2980039bc781907a429f3a85a3d2d885797ef7b, deposit count 0: 1 vote\n  block 0xb0f352dd77ae8d5e6d2d3d974ad6bb38d919dd9dfe3bcb295c331874ce66c677, deposit count 0: 1 vote\n  block 0xfd11fec0b37daa19f01005f5b080dc21f371d2f7eedc12f8e8c1f3ac78e49930, deposit count 0: 1 vote\n  block 0xb6bfc40e092157ecf464ffe7174744f97180793f40119a0a11f120c8b4b6fd6d, deposit count 0: 1 vote\n  block 0x111fab228111455c0dac3cae9e0f0f4a6bee1d7247dcc6abb0cc08706183127d, deposit count 0: 1 vote\n  block 0xc84be0a72a844868fa58e3794a72cf530a6a630e62230e513108f0427e687881, deposit count 0: 1 vote\n  block 0xb0af359e8cfe3aa3e3b2242d202ba13093aad1913dc591cc66b1d8a0d94129af, deposit count 0: 1 vote\n```",
        "created_at": "2022-06-01T12:07:09.306000+00:00",
        "attachments": null
    },
    {
        "author": "jgm",
        "category": "Testing",
        "parent": "",
        "content": "(You'll need `ethdo` v1.23.1)",
        "created_at": "2022-06-01T12:07:18.126000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@425572898787426305\u003e \u003c@892053833121923094\u003e \nCross posting from some internal call here:\nThis new test `Invalid Transition Payload (go-ethereum)` is bugging me a bit. I believe we should change the spec a bit\nIt expects the LVH of an invalid payload to be set to 0x00 if the invalid payload is built upon the TTD block\nIt's super hard for us to check that, and just saying that clients can do either, return 0x00 or return the pow blockhash would be way nicer.",
        "created_at": "2022-06-01T15:33:33.926000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "CL has nothing to do with a pow block hash and wouldn't be able to use this information properly. It is implementation specific by CL client might not invalidate any block if LVH wouldn't be presented in their block tree. I believe 0x00 isn't an issue by itself but handling a transition block (the first PoS block) in a specific way is an issue.\n\nIs this complicated to query for parent and set LVH to 0x00 `if parent.difficulty \u003e 0`? Note that once the first PoS block gets finalized this check becomes unnecessary.",
        "created_at": "2022-06-01T18:03:27.910000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "It's just really ugly, but if you think thats better, then I will change it",
        "created_at": "2022-06-01T18:04:57.923000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "do I understand correctly that any other than responding with pow block hash way would be ugly?",
        "created_at": "2022-06-01T18:06:36.411000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Nah its fine I think, just implemented it in geth",
        "created_at": "2022-06-01T18:11:25.719000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "I can also understand that having this kind of special cases that are handling only one block does make the code even uglier. But this is in the nature of the transition process which is supposed to happen only once",
        "created_at": "2022-06-01T18:15:43.377000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "https://github.com/ethereum/go-ethereum/pull/25006",
        "created_at": "2022-06-01T18:16:44.757000+00:00",
        "attachments": null
    },
    {
        "author": "mariusvanderwijden",
        "category": "Testing",
        "parent": "",
        "content": "Yeah, I think the logic wrt. LVH is just way to complicated for what its worth, but doesn't really matter",
        "created_at": "2022-06-01T18:17:25.083000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "isn't ropsten follow distance `2048` ?",
        "created_at": "2022-06-01T18:22:02.989000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "I do agree and I hope we can get rid of it at some point in time. But as long as we have optimistic sync and two separate databases that must maintain eventual consistency, we seem to have to support LVH or similar logic",
        "created_at": "2022-06-01T18:22:43.470000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "our latest blocks seem to have deposits processed till the follow distance",
        "created_at": "2022-06-01T18:22:50.698000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "It is. It seems the problem on Ropsten is that there is a big discrepancy between a block at the follow distance by timestamp as per the spec and a block at the follow distance by block height",
        "created_at": "2022-06-01T18:33:42.471000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "we seem to be going by number i think",
        "created_at": "2022-06-01T18:34:35.912000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "As I understand Lighthouse was caching blocks by number but picking them for a vote by timestamp, maybe Prysm did the same. But for Ropsten it didn't work out because the difference between the two is too big.\n\nIf you're using block number to pick up `Eth1Data` for a vote then your votes may be incorrect",
        "created_at": "2022-06-01T18:39:10.074000+00:00",
        "attachments": null
    },
    {
        "author": "m.kalinin",
        "category": "Testing",
        "parent": "",
        "content": "There is `is_candidate_block` function in the spec that uses `block.timestamp`: https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/validator.md#get_eth1_data",
        "created_at": "2022-06-01T18:42:40.384000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "yea looks like we filter by timestampRange",
        "created_at": "2022-06-01T18:45:04.510000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "though will dig into what exactly is happening at our end to verify",
        "created_at": "2022-06-01T18:45:59.096000+00:00",
        "attachments": null
    },
    {
        "author": "g11tech",
        "category": "Testing",
        "parent": "",
        "content": "I think our cache also suffers from the same implementation issue cc \u003c@688748669268132001\u003e \u003c@534934855113506836\u003e",
        "created_at": "2022-06-01T19:06:57.861000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "The fundamental reason that it's time-based is because we need a validator who's voting at the end of the voting period to be able to vote on the same block as one who votes at the start, even if that validator was offline at the start of the period. Given that the beacon chain is time-based and is/was a completely separate system, we can't achieve this without making *some* assumptions about the block time on the PoW network. \n\nOriginally the voting system used a combination of both block-number-based follow distances and timestamp-based follow queries. This blend of concerns also caused issues, there's some history here: https://github.com/ethereum/consensus-specs/issues/1537. I can't recall the entire argument and I'm not necessarily saying we did the right thing, but I think the sentiment back then was \"we *must* make assumptions about timestamps so let's *only* make assumptions about timestamps\".\n\nI'm not saying that the eth1 voting mechanism is anything other than ugly and painful, but I think a lot of that is inherited from the fundamental problem of trying to track blockchain A with a completely separate and functionally distinct blockchain B. Once again, not trying to defend my honour or spark a debate, just giving some history.",
        "created_at": "2022-06-01T23:57:50.420000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Testing",
        "parent": "",
        "content": "It would have actually been much easier if \"eth1 nodes\" (I speak in the tongue of the ancients) provided timestamp based queries from the API. I don't think we have any chance of such a change now, so we *certainly* didn't have a shot back then ðŸ˜…",
        "created_at": "2022-06-01T23:59:38.428000+00:00",
        "attachments": null
    }
]