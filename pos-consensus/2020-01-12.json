[
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "We are working on optimizing latest `get_filter_block_tree` for fork choice. Wondering if anyone has already started optimizing it. We are seeing it to be unsustainable under mainnet config especially calling  `get_head` for every  attestation.  A call would be great to discuss how to optimize here. \u003c@!203220829473996800\u003e \u003c@!361447803194441738\u003e     https://github.com/prysmaticlabs/prysm/issues/4509",
        "created_at": "2020-01-12T17:36:23.472000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes, happy to plan a call and get clients set for fast fork choice. \u003c@!361447803194441738\u003e has been experimenting with fork-choice, and picked up my array based variant from the old optimized fork-choice repo (https://github.com/protolambda/lmd-ghost/, \"proto array\"). The spec fork-choice is focused on correctness, but is rather naive/slow because of that.\nThe optimized versions need some updates; you would want to adjust weights based on justified-state changes, and then there are several adjustments (like the explicit tree filter).",
        "created_at": "2020-01-12T17:42:47.234000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Problem with a call is that we're quite far from each other (US/EU/AU). I can adjust though if I'm the only EU. Who else would like to join a call?",
        "created_at": "2020-01-12T17:44:49.685000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I'm in pacific time zone and can adjust as well. Whenever is the most convenient for everyone",
        "created_at": "2020-01-12T17:45:58.027000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "\u003c@!363800010518822915\u003e what exact fork choice optimizations/algorithms is prysm running currently?",
        "created_at": "2020-01-12T17:49:19.952000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Not much tbh.  1.) cache ancestor data   2.) fast-pathing",
        "created_at": "2020-01-12T17:54:59.675000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "We started working towards stateful dag but havenâ€™t finished. Keen to hear with the latest v0.9.3 changes, what is everyone using and what the recommendation is",
        "created_at": "2020-01-12T17:55:05.314000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "We're presently using reduced-tree (devised at IC3 last year, not really documented anywhere), but I'm not a fan of it at the moment. It's nice on paper (it has a smaller memory footprint, is `O(validator_count)` not `O(blocks_in_tree)`) however it is rather complex to maintain the tree and it involves a lot of ancestor root lookups. Those ancestor roots are either costly state reads or can be optimized by storing a full tree of all non-finalized block roots in memory, which goes against the original principle of the tree being reduced.",
        "created_at": "2020-01-12T18:51:19.320000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I'm in the process of adapting \u003c@203220829473996800\u003e's `proto_array` to suit eth2/lighthouse. I've had to make changes for the following:\n\n- start from the justified state instead of the finalized state (trivial)\n- allow for changing of validator weights as the justified state changes\n- allow for filtering of the block tree based on justified/finalized epochs\n\nI _think_ I have a decent solution with all of these included as of yesterday, however I'm yet to test it and learn what terrible assumptions I may have made.",
        "created_at": "2020-01-12T18:56:24.303000+00:00",
        "attachments": null
    },
    {
        "author": "paulhauner",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "At the moment I have conceptually the same memory layout as `proto_array`, but i've significantly devated from the procedural logic to account for the changes mentioned above.",
        "created_at": "2020-01-12T18:57:41.821000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "as for `get_filtered_block_tree`, this should be maintained rather than continually re-calculated on the fly. It is a sub-tree of the block-tree relative to current justified and the post-state of the leaf blocks. You can easily store the current justified and update blocks into this subtree based on that when they come in. Then when new justified, can re-calculate the filtered subtree\n\nEven this is pretty naive, but that will hugely reduce your costs",
        "created_at": "2020-01-12T18:58:04.721000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yeah I agree. I think I'll start with caching the result of `get_filtered_block_tree`, that will greatly improve testnet health and buy us  more time to optimize fork choice as a whole",
        "created_at": "2020-01-12T19:00:04.446000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Do you guys see any issues doing the following? \u003c@!291925846556540928\u003e \u003c@!203220829473996800\u003e",
        "created_at": "2020-01-12T21:10:42.023000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Cache `Dict[JustifiedCheckpoint.Root, Dict[Root, BeaconBlock]`, Update cache when post state of new block is added to the store during `on_block`.  And `get_head` uses the cache instead of `get_filtered_block_tree`",
        "created_at": "2020-01-12T21:10:45.724000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Personally just not a fan of using dictionaries for everything. One root -\u003e array index dict, and then flattening things out for easy pruning, is my preference. But I guess that would work well enough, especially with not that many blocks in the dict (normal case)",
        "created_at": "2020-01-12T21:50:48.700000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I do like `one root -\u003e array index dict` better, it's easier for pruning. Thanks!",
        "created_at": "2020-01-12T21:52:26.878000+00:00",
        "attachments": null
    },
    {
        "author": "protolambda",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "It's particularly fitting for the array fork-choice version, where a simple prune is just removing a slice from each of the state arrays (all blocks processed before the finalized block). Lot's of dicts is readable and easy, and perfromance different may not be that significant, but you'll have to maintain them during pruning item by item.",
        "created_at": "2020-01-12T22:18:15.079000+00:00",
        "attachments": null
    }
]