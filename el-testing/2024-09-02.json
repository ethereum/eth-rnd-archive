[
    {
        "author": "gurukamath",
        "category": "Testing",
        "parent": "",
        "content": "Had a question about the following test in Pectra v1.0.4\n\n```\n{'test_file': 'blockchain_tests/prague/eip7702_set_code_tx/set_code_txs/set_code_to_precompile.json', 'test_key': 'tests/prague/eip7702_set_code_tx/test_set_code_txs.py::test_set_code_to_precompile[fork_Prague-precompile_0x000000000000000000000000000000000000000b-call_opcode_CALL-evm_code_type_LEGACY-blockchain_test]'}\n```\n\nThis makes a call to the BLS12_381_ADD precompile with empty input, which as per the 2537 specs should result in an error. Not sure if the test reflects that.",
        "created_at": "2024-09-02T15:22:24.013000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Ah, good point, this is an edge case which should be clarified in the EIP ðŸ™‚\n\nIf you delegate an account using a 7702 tx to a precompile (which has no code), it should **NOT** run the precompile, it should rather exit early (as if the account has no code, which technically is the case)",
        "created_at": "2024-09-02T15:24:19.675000+00:00",
        "attachments": null
    },
    {
        "author": "gurukamath",
        "category": "Testing",
        "parent": "",
        "content": "Would you have any reference to discussions around this? I wonder if it would just be easier to not allow delegating to a pre-compile",
        "created_at": "2024-09-02T15:39:24.046000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Yes, I will find it",
        "created_at": "2024-09-02T15:39:38.452000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "It's here https://discord.com/channels/595666850260713488/718596092828057631/1276906558915219496",
        "created_at": "2024-09-02T15:40:35.891000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "And here https://discord.com/channels/595666850260713488/718596092828057631/1276588678050877592",
        "created_at": "2024-09-02T15:41:14.494000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "\u003c@508125616940515329\u003e Does ethereumjs warms up target `address` during delegation setting, and not only `authority`?\n\nI'm debugging a tests and it seems so",
        "created_at": "2024-09-02T15:50:41.171000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Yes. This should also be clarified in the EIP",
        "created_at": "2024-09-02T15:51:08.390000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "What test is it? Can TAL",
        "created_at": "2024-09-02T15:51:14.399000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "I will also find the discussion on this point",
        "created_at": "2024-09-02T15:51:23.722000+00:00",
        "attachments": null
    },
    {
        "author": "marioevz",
        "category": "Testing",
        "parent": "",
        "content": "During authorization list parsing? It should not, right?",
        "created_at": "2024-09-02T15:51:45.122000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Oh wait, I misread",
        "created_at": "2024-09-02T15:51:55.635000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "What test is this? Then I can take a look",
        "created_at": "2024-09-02T15:52:01.030000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "I thought this was about txs calling a delegated account ðŸ˜…",
        "created_at": "2024-09-02T15:52:25.180000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "`prague/eip7702_set_code_tx/test_set_code_txs.py::test_ext_code_on_self_set_code[fork_Prague-state_test-balance_0]`",
        "created_at": "2024-09-02T15:52:52.769000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "it should not according to EIP",
        "created_at": "2024-09-02T15:53:16.723000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Yeah this is the situation I thought this was about. Let me spin up our test runner",
        "created_at": "2024-09-02T15:53:32.100000+00:00",
        "attachments": null
    },
    {
        "author": "marioevz",
        "category": "Testing",
        "parent": "",
        "content": "I think in this specific case `authority == address`",
        "created_at": "2024-09-02T15:53:43.253000+00:00",
        "attachments": null
    },
    {
        "author": "marioevz",
        "category": "Testing",
        "parent": "",
        "content": "but let me double check",
        "created_at": "2024-09-02T15:53:48.994000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "no, I see in debugger they are different",
        "created_at": "2024-09-02T15:54:01.058000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "This is likely the case: your tx calls into an account B, which is delegated to C. Now C calls EXTCODESIZE on either itself, or on the delegated account. However, a **tx-level call to a 7702-delegated account (B) should also add the delegated account (C) to warm**",
        "created_at": "2024-09-02T15:54:58.097000+00:00",
        "attachments": null
    },
    {
        "author": "marioevz",
        "category": "Testing",
        "parent": "",
        "content": "Yep, this is the explanation",
        "created_at": "2024-09-02T15:56:09.455000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Here is the ref for this discussion https://discord.com/channels/595666850260713488/718596092828057631/1272569089268912229",
        "created_at": "2024-09-02T15:56:50.581000+00:00",
        "attachments": null
    },
    {
        "author": "marioevz",
        "category": "Testing",
        "parent": "",
        "content": "Actually, tx enters directly into authority, so by entering here, we need to retrieve the code from address, hence the warmup",
        "created_at": "2024-09-02T15:56:52.475000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "For clarifications in the EIP, I currently have this list:\n\n1. This case (add tx-level delegated account to warm)\n2. Precompiles will not be run once delegated to (treated as empty accounts)\n3. EXTCODEHASH puts 0 on stack if the 7702-delegated account it is delegates to does not exist in trie (as opposed to empty hash keccak256(\"\") of accounts which exists in trie, but have no code, i.e. EOAs (non-delegated to))",
        "created_at": "2024-09-02T15:58:25.067000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "I would also add\n4. delegations are not reverted in case transaction fails\n5. if delegation target account does not exist, nonce is checked to be 0",
        "created_at": "2024-09-02T16:02:03.134000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "yeah I think this is the explanation for the difference, we didn't warm up the delegation target for tx sender\n\nPerhaps separate explict warming up test for this case would be nice",
        "created_at": "2024-09-02T16:03:03.737000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Oh right, 4. is a good point, we had this bug rolling back all delegations. For 5. I don't understand, if target account does not exist then that nonce should be zero anyways? And in the auth list if the nonce is nonzero, that authorization is invalid, so skip that one?",
        "created_at": "2024-09-02T16:04:41.446000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "yeah, it's a minor complaint, I mean the point `4. Verify the nonce of authority is equal to nonce.`  technically cannot be checked if `authority` does not exist (and so has no nonce), instead authorization nonce is checked to be 0",
        "created_at": "2024-09-02T16:06:29.907000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "maybe I'm overthinking",
        "created_at": "2024-09-02T16:06:36.364000+00:00",
        "attachments": null
    },
    {
        "author": "gumb00",
        "category": "Testing",
        "parent": "",
        "content": "but one could forget to check nonce if there's no authority nonce",
        "created_at": "2024-09-02T16:07:02.508000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Hmm we internally cast nonces to 0 if the account does not exist, but I could imagine other implementations cast this to `null`",
        "created_at": "2024-09-02T16:08:24.406000+00:00",
        "attachments": null
    },
    {
        "author": "ak4222",
        "category": "Testing",
        "parent": "",
        "content": "Has there been a discussion regarding 7702 refunds when txs fails?",
        "created_at": "2024-09-02T20:48:15.852000+00:00",
        "attachments": null
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "In what context? The delegations are still put even if the evm exectution fails. So if evm execution fails, account delegations are still done (not reverted), thus the gas refund it should get when putting code on existing accounts should still be applied",
        "created_at": "2024-09-02T21:34:25.820000+00:00",
        "attachments": null
    }
]