[
    {
        "author": "deme1744",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yes, that is what I was pointing out yesterday in the call. That it currently contradicts the discovery v5 spec (clearly as \"must\" is used there). Also invalidly using the request/response mechanism (well just the request part) for setting up a stream is what confused me in the first place, so spec implementers might not understand this immediately. So on the long term we should have a better packet \"stream\" packet type for that.",
        "created_at": "2021-05-19T07:17:47.331000+00:00",
        "attachments": null
    },
    {
        "author": "deme1744",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Additionally in our implementation we use the (lack of) responses for all request/response types to decide whether (eventually) we want to drop a peer from the routing table. Yes, packets on UDP can/will get dropped, but still, you can use this as information to rate your peers and drop them when too many responses don't arrive (well, rather replace them with other peers).",
        "created_at": "2021-05-19T07:22:02.828000+00:00",
        "attachments": null
    },
    {
        "author": "deme1744",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "But for now we could get away with just empty responses (as sort of ack), yes. Or just use it without the response (nobody else is using talkreq/talkresp afaik).",
        "created_at": "2021-05-19T07:23:58.302000+00:00",
        "attachments": null
    },
    {
        "author": "jason.carver",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yup! I heard, I was agreeing with you. :) Just adding the specifics from the spec.",
        "created_at": "2021-05-19T16:10:35.938000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "\u003c@!194432762315407360\u003e any chance you want to weigh in on this.  Could we simply modify the spec to relax the \"must\" to a \"should\" or even \"may\" or \"optionally\"...",
        "created_at": "2021-05-19T16:12:27.979000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Not sure where you're at in here",
        "created_at": "2021-05-19T16:14:35.637000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Can you give some additional context what you are discussing?",
        "created_at": "2021-05-19T16:15:21.399000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Basically, TALKREQ is for requests which have a single, small response",
        "created_at": "2021-05-19T16:16:34.989000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "When you get the answer, and it is empty, you know the other side doesn't support the request",
        "created_at": "2021-05-19T16:17:02.464000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "TALKREQ is not ideal for things where you want multiple responses, or no response",
        "created_at": "2021-05-19T16:17:39.855000+00:00",
        "attachments": null
    },
    {
        "author": "jason.carver",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yeah, we'd ideally like a TALK message that has no response",
        "created_at": "2021-05-19T16:17:52.820000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Why?",
        "created_at": "2021-05-19T16:18:04.365000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Getting a response is always good, even if it's empty, because it's a confirmation that the other side got the request",
        "created_at": "2021-05-19T16:18:41.664000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "At worst you could probably cram part of a TLS handshake in there üòâ",
        "created_at": "2021-05-19T16:18:56.171000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "When you don't get any response, you can assume the other side didn't get the request",
        "created_at": "2021-05-19T16:19:11.410000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I've said it before, if we want to transfer larger amount of data using the discovery connection, we should use TALKREQ to bootstrap a transfer protocol like uTP",
        "created_at": "2021-05-19T16:20:26.699000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "i.e. use TALKREQ to say: I want to transfer item X now, with this 'transfer id' or whatever",
        "created_at": "2021-05-19T16:21:09.187000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Then do the actual transfer using another protocol on the same port",
        "created_at": "2021-05-19T16:21:29.170000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Something like an HTTP connection upgrade?",
        "created_at": "2021-05-19T16:21:43.498000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yes",
        "created_at": "2021-05-19T16:21:47.190000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "That's what TALKREQ is for, really",
        "created_at": "2021-05-19T16:21:57.027000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So the TALKRESP would contain the first bytes of whatever the \"transfer protocol\" would want to send?",
        "created_at": "2021-05-19T16:22:32.241000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I guess in this case it would contain the acknowledgement of the transfer",
        "created_at": "2021-05-19T16:23:00.527000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Would you send it at the start or end of the transfer?",
        "created_at": "2021-05-19T16:23:22.335000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I would assume the start, because timeouts.",
        "created_at": "2021-05-19T16:23:30.992000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "(I'm also in this discussion three-quarters blind, so feel free to completely ignore me)",
        "created_at": "2021-05-19T16:24:09.017000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If you are talking about the TALKRESP, then it should be sent before the data transfer starts",
        "created_at": "2021-05-19T16:24:20.280000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If a transfer id of some kind is negotiated, it's really simple to multiplex the transfers on the port, just prefix all data traffic with the id. You can also negotiate symmetric encryption keys using the same TALKREQ/TALKRESP exchange.",
        "created_at": "2021-05-19T16:25:52.573000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Since the discv5 session is already encrypted, it's OK to literally just say 'this is the AES key I will use'",
        "created_at": "2021-05-19T16:26:33.278000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Since we already have a negotiated encrypted channel between the two nodes that want to stream data, what is your motivation for not just using DiscV5 packets for a uTP-like stream?",
        "created_at": "2021-05-19T16:27:31.472000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "right now, we can do that without modifying the base DiscV5 protocol with both sides just sending a stream of TALKREQ messages at each other, and using the `payload` part the same way that uTP uses the full UDP packet.  None of this has  any need for TALKRESP.",
        "created_at": "2021-05-19T16:28:45.888000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I get it, but it's kind of inefficient this way",
        "created_at": "2021-05-19T16:29:13.044000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "what is the inefficiency?",
        "created_at": "2021-05-19T16:29:27.123000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Basically, the discv5 wire protocol is specifically optimized for talking to many different nodes, where you only send a couple packets to each distinct one",
        "created_at": "2021-05-19T16:30:19.375000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If you want to transfer some kind of large data item, it will require many packets, and you'll pay with a lot of overhead",
        "created_at": "2021-05-19T16:31:03.548000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "It's much simpler to just send the data with a known prefix",
        "created_at": "2021-05-19T16:31:23.180000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "The overhead being...?  the packet headers themselves?  the encryption?",
        "created_at": "2021-05-19T16:31:32.306000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'm talking about the packet header, yeah",
        "created_at": "2021-05-19T16:32:11.122000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If I'm understanding this correctly, doesn't this strip out some of the nice parts of discv5 (encryption and resistance to packet inspection/filtering)?",
        "created_at": "2021-05-19T16:32:41.561000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "You can encrypt the transfer of course, and you can also negotiate keys over the encrypted discv5 session",
        "created_at": "2021-05-19T16:33:29.808000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "(I recognize that you could still add encryption back into the mix... but since we already have the keys in discv5 sessions... there seems to be a nice convenience factor here)",
        "created_at": "2021-05-19T16:33:47.816000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "We are really talking about the same thing here, it's just a matter of perspective.",
        "created_at": "2021-05-19T16:34:17.291000+00:00",
        "attachments": null
    },
    {
        "author": "jason.carver",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Is this right: the traffic multiplexer concept would require a server sitting \"in front\" of the discv5 one, dispatching to either discovery or a utp session.",
        "created_at": "2021-05-19T16:36:14.277000+00:00",
        "attachments": null
    },
    {
        "author": "jason.carver",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Versus having a TALK message means being able to use a standard discv5 implementation, to wrap around our subprotocol",
        "created_at": "2021-05-19T16:37:19.222000+00:00",
        "attachments": null
    },
    {
        "author": "jason.carver",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I suspect a lot of discv5 libraries are not ergonomically optimized for that dispatch use case right now, ie~ they are designed to bind to the port themselves, rather than to be handed a stream of packets from some upstream server",
        "created_at": "2021-05-19T16:38:17.664000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "how strongly do you feel about pushing something like uTP out of DiscV5?  Are you a strong üëé ?  Are you willing to consider inclusion of a uTP style protocol into the DiscV5 spec?\n\nWe still intend to implement uTP over TALK for what we are building, but we'd like to contribute it down into the core protocol at some point.",
        "created_at": "2021-05-19T16:38:29.063000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I think where we differ in opinion here is: \"convenience/ergonomics of having it be part of DiscV5 vs overhead/sub-optimal use of discv5 packets\".  For me the convenience/ergonomics wins, but I do see that using DiscV5 packets will incur an overhead penalty to the efficiency of the data transfer.",
        "created_at": "2021-05-19T16:40:43.793000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'm not really seeing how you could differentiate packets on the same UDP port without either putting something in front of the discv5 protocol, or trying to parse every packet as discv5 and if that fails, falling back to another protocol.",
        "created_at": "2021-05-19T16:50:57.254000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Looked over the spec a minute ago and the best route seems to be a new message type (`flag=4`)",
        "created_at": "2021-05-19T16:51:29.523000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "If you use the talkreq/talkresp to send the `ST_SYN` and `ST_STATE` messages, then maybe used a different port for the uTP...",
        "created_at": "2021-05-19T16:51:58.690000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "or a new `protocol-id` but that value seems intrinsicly bound to the structure of the packet header, so I don't see how you could get around changing/omitting any of the rest of the header fields.",
        "created_at": "2021-05-19T16:52:25.290000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "That would still require the whole AES encrypted header, no?",
        "created_at": "2021-05-19T16:52:45.097000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "yes, I believe so",
        "created_at": "2021-05-19T16:53:00.763000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Either way, we aren't actually blocked in any way on this and can proceed using TALKREQ, it'd just be nice to have the base protocol support streams at some point but we can iterate towards that",
        "created_at": "2021-05-19T16:54:17.554000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "At least having a way to \"upgrade\" a discv5 \"connection\" to a different protocol",
        "created_at": "2021-05-19T16:54:51.786000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I think the main issue is that there isn't a \"connection\" like HTTP+TCP, where the upgrade is requested through HTTP, but the connection is maintained with TCP.",
        "created_at": "2021-05-19T17:01:49.193000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "discv5 would need some sort of connection identifier? Unless it has one.",
        "created_at": "2021-05-19T17:02:20.608000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Yes, this is what I mean. In fact we already use it like that to multiplex discv4 and discv5 in geth",
        "created_at": "2021-05-19T17:03:15.041000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Regarding this, I'm not strongly yes or no on this. My main motivation is avoiding lock-in. The discovery is the discovery. If apps using discovery require additional protocol to do their thing, they should be able to do it, preferably on the same UDP port.",
        "created_at": "2021-05-19T18:07:06.149000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Since we cannot anticipate the needs of all future apps, I added the minimum necessary support for negotiating app-specific extensions, in the form of TALKREQ. It was also an explicit design goal to allow multiplexing discv5 and any other protocol, which is why the protocol includes an identifier and version in every packet. This is explained in the rationale.",
        "created_at": "2021-05-19T18:09:54.001000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I really really want to have some kind of data transfer protocol that is friends with discv5, just think it doesn't need to be integrated in the discovery itself.",
        "created_at": "2021-05-19T18:11:02.257000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So the correct approach would be to set a different identifier/version once the TALKREQ/TALKRESP exchange is complete?",
        "created_at": "2021-05-19T18:11:03.736000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "There is really no correct approach, since you can literally multiplex it with any other other protocol, even with ones that aren't designed for it.",
        "created_at": "2021-05-19T18:12:01.758000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "But obviously it would be nice to make something that integrates in a nice and performant way.",
        "created_at": "2021-05-19T18:12:38.494000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "So just send the raw uTP packets to the same port, try to parse them as discv5, and if they don't parse correctly, try a different protocol?",
        "created_at": "2021-05-19T18:13:01.360000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "That would be one possibility, but I think we can do better.",
        "created_at": "2021-05-19T18:13:19.774000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "BTW, which spec are you guys looking at for uTP?",
        "created_at": "2021-05-19T18:15:02.129000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I hear the RFC is pretty out of date",
        "created_at": "2021-05-19T18:15:20.550000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "BTW, sorry, but I need to drop off for today.",
        "created_at": "2021-05-19T18:17:14.156000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "No worries! Thanks for the input ‚ù§Ô∏è",
        "created_at": "2021-05-19T18:17:24.967000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Let me know if you find the official-ish uTP spec, or just any spec really.",
        "created_at": "2021-05-19T18:18:00.153000+00:00",
        "attachments": null
    },
    {
        "author": ".fjl",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "I'll create a write-up for this stuff over on the devp2p repo, but not today",
        "created_at": "2021-05-19T18:18:30.107000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "Channel Graveyard",
        "parent": "",
        "content": "Not sure how helpful it'll be, but transmission uses https://github.com/transmission/libutp/tree/fda9f4b3db97ccb243fcbed2ce280eb4135d705b exactly as its uTP implementation.",
        "created_at": "2021-05-19T18:24:03.486000+00:00",
        "attachments": null
    }
]