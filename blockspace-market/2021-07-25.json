[
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "How to calculate an EIP-1559 transaction refund?",
        "created_at": "2021-07-25T17:08:12.006000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If there is any refund though ðŸ˜…",
        "created_at": "2021-07-25T17:08:44.568000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "EIP-1559 doesn't change gas refund code.  There is another EIP in London that does though (I don't remember the number).",
        "created_at": "2021-07-25T17:10:00.261000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah ok",
        "created_at": "2021-07-25T17:10:14.188000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Asking this because I've noticed that the following miner tip calculation formula does not work with EIP-1559 transactions, only with legacy ones:\n```go\neffectiveTip := st.gasPrice\nif st.evm.ChainConfig().IsLondon(st.evm.Context.BlockNumber) {\n  effectiveTip = cmath.BigMin(st.gasTipCap, new(big.Int).Sub(st.gasFeeCap, st.evm.Context.BaseFee))\n}\nst.state.AddBalance(st.evm.Context.Coinbase, new(big.Int).Mul(new(big.Int).SetUint64(st.gasUsed()), effectiveTip))\n```",
        "created_at": "2021-07-25T17:11:16.579000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That's from geth source code",
        "created_at": "2021-07-25T17:11:53.281000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e Why it is not working for EIP-1559 transactions?",
        "created_at": "2021-07-25T17:12:06.158000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Is there something else that affects the miner tip?",
        "created_at": "2021-07-25T17:12:16.389000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm not familiar with Geth's implementation.",
        "created_at": "2021-07-25T17:13:24.541000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Let me rewrite that with python pseudocode",
        "created_at": "2021-07-25T17:13:37.130000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The EIP has python actual code if you want to just check that out.",
        "created_at": "2021-07-25T17:13:55.779000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@!301186049323958275\u003e here\n```py\neffective_tip = tx.gas_price\nif is_london(block.number):\n  effective_tip = min(tx.gas_price, (tx.gas_price - block.base_fee_per_gas))\ntip = receipt.gas_used * effective_tip\n```",
        "created_at": "2021-07-25T17:15:11.181000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Did not find any mention on how the tip is distributed to the miner",
        "created_at": "2021-07-25T17:15:28.040000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So this formula works for legacy transactions only",
        "created_at": "2021-07-25T17:15:45.996000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "What is the formula for EIP-1559 transactions?",
        "created_at": "2021-07-25T17:15:59.335000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "See this line in the EIP: https://eips.ethereum.org/EIPS/eip-1559\n```py\nself.account(block.author).balance += gas_used * priority_fee_per_gas\n```",
        "created_at": "2021-07-25T17:23:12.863000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ah, `block.author` instead of `block.coinbase` ðŸ˜…",
        "created_at": "2021-07-25T17:23:30.129000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`coinbase` is what I was Ctrl+F'ing haha",
        "created_at": "2021-07-25T17:23:42.116000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I have no idea why people call it coinbase.",
        "created_at": "2021-07-25T17:23:59.595000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "in solidity it's `block.coinbase`",
        "created_at": "2021-07-25T17:27:21.079000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "This is how it is called in bitcoin ðŸ˜„",
        "created_at": "2021-07-25T17:27:22.010000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In Geth it is also block.Coinbase",
        "created_at": "2021-07-25T17:27:40.936000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "OE calls it `author`",
        "created_at": "2021-07-25T17:27:57.517000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I think it should be standardized ðŸ˜„",
        "created_at": "2021-07-25T17:28:29.313000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`block.validator`",
        "created_at": "2021-07-25T17:29:33.330000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That could also work",
        "created_at": "2021-07-25T17:29:47.940000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But it may confuse people",
        "created_at": "2021-07-25T17:30:05.085000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Since there are no \"validators\" on eth1 chain",
        "created_at": "2021-07-25T17:30:14.824000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I guess that `block.author` is indeed the best",
        "created_at": "2021-07-25T17:30:37.637000+00:00",
        "attachments": null
    },
    {
        "author": "Deleted User",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "agree.",
        "created_at": "2021-07-25T17:30:47.311000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Okay so using a \"managed\" `tx.EffectiveGasTip()` seems to fix that ðŸ˜…",
        "created_at": "2021-07-25T17:40:31.922000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The yellow paper describes it as \"beneficiary address\". The EVM opcode to retrieve it is called COINBASE. The new executable eth1.0specs call it \"coinbase\", but they are very alpha.",
        "created_at": "2021-07-25T17:51:49.389000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Question: How to get `gasTipCap` from `eth_getTransactionByHash` response?",
        "created_at": "2021-07-25T17:58:20.163000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Or wait, is it the same `priorityFeeCap`?",
        "created_at": "2021-07-25T17:59:46.259000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Get it from the receipt.",
        "created_at": "2021-07-25T18:00:30.838000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Can't find it. There is only `effectiveGasPrice`",
        "created_at": "2021-07-25T18:02:37.447000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "`premium = effectiveGasPrice - block.baseFee`",
        "created_at": "2021-07-25T18:03:02.716000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Ohhh makes sense",
        "created_at": "2021-07-25T18:03:51.799000+00:00",
        "attachments": null
    },
    {
        "author": "alexssd7fp",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thank you \u003c@!301186049323958275\u003e",
        "created_at": "2021-07-25T18:04:04.671000+00:00",
        "attachments": null
    }
]