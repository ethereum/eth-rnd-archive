[
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e That is, it would be good if you could write contracts that use arbitrary amounts of  stack and memory, to arbitrary depths of message calls - just give them enough gas.\n\nRight, this is why I like that approach",
        "created_at": "2022-07-19T07:08:45.404000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(that approach = the `max_memory = call gas` and `max_child_call_gas = parent_call_gas - parent_memory` thing)",
        "created_at": "2022-07-19T07:09:04.459000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Because it creates a nice invariant where theoretical max memory requirement = tx gas",
        "created_at": "2022-07-19T07:09:29.446000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "hmm I guess you could charge more for gas expansion of a particular callframe as well",
        "created_at": "2022-07-19T07:11:09.292000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "On a more meta level, there is a different tradeoff that we have to deal with",
        "created_at": "2022-07-19T07:11:23.232000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Which is, just how hard do we try to map the gas schedule to actual hardware",
        "created_at": "2022-07-19T07:11:37.270000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The benefit of doing that is clear, the risk is (i) code complexity, and (ii) risk that if hardware changes, you'll have a gas schedule that's even more misaligned than something much more basic",
        "created_at": "2022-07-19T07:12:12.268000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Like, I think we already need to start thinking *today* about how to adjust the gas schedule to make it map better to costs inside of SNARKs",
        "created_at": "2022-07-19T07:12:44.481000+00:00",
        "attachments": null
    },
    {
        "author": "jlokier",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'll throw in that zk-EVMs may have different \"hardware\" constraints.  I'm not sure what the impact of that ~300MB stack memory would be.",
        "created_at": "2022-07-19T07:13:30.987000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "right",
        "created_at": "2022-07-19T07:15:31.966000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That's a case for not trying to aim for right fit, and instead trying to aim for hard invariants",
        "created_at": "2022-07-19T07:15:49.957000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Like, a hard requirement that the total memory of all callframes that ever get initialized in a block cannot exceed the gas limit would make things clean for a lot of zk-EVM designs",
        "created_at": "2022-07-19T07:17:38.266000+00:00",
        "attachments": null
    },
    {
        "author": "jlokier",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That \"total memory\" of all callframes isn't accounted for explicitly. In regular, non-zk EVMs, there are host data structures etc. at each call frame. At the moment the depth of calls is limited by the cost of calls, and it's important that stay reasonably limited.  Conversely some zk-EVMs don't have to prove execution with deep call stack memory, because they switch to recursive proofs.",
        "created_at": "2022-07-19T07:23:53.760000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, adding a fixed cost per callframe is fair",
        "created_at": "2022-07-19T10:34:33.090000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Or keeping the 63/64 rule",
        "created_at": "2022-07-19T10:35:31.918000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yes, call frames themselves should have a fixed cost, \u003c@807285075736789062\u003e.  And total memory used by calls should be accounted for via \u003c@273808422753796097\u003e's formula or something like it.  If I understand.\n\n\u003e how hard do we try to map the gas schedule to actual hardware\n\nAs hard as needed to avoid DoS.\n\nWhether to limit memory (and also stack?) with hard or soft limits is a mostly separate question.  I'm still leaning to soft limits with a sharp enough knee in the cost function that it's close to (or even is) asymptotic.   Regardless, if we don't increase limits for resource use I don't see any harm beyond failure to make full use of available hardware.  I'm not sure how to deal with zk-EVM.",
        "created_at": "2022-07-19T13:09:09.599000+00:00",
        "attachments": null
    },
    {
        "author": "jlokier",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Old-school zk-EVMs need to set a limited number of cycles or other resource, but I think there is a trend to using recursive proofs (that is, proof of knowledge of running a verification program on another proof of knowledge) to expand the size of computations as needed in a more flexible way now.  It still takes more time to prove a longer execution, naturally.",
        "created_at": "2022-07-19T13:12:46.595000+00:00",
        "attachments": null
    },
    {
        "author": "jlokier",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(Correction to self: more time except when parallelism is an option.)",
        "created_at": "2022-07-19T13:13:58.888000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "On code complexity -- this might even be a chance to simplify the cost functions.\n\nOn zk-EVMs it seems they may need different gas schedules?  (And it's cool that zk-voodoo is moving so fast that there is already an \"old school.\")",
        "created_at": "2022-07-19T13:15:28.791000+00:00",
        "attachments": null
    },
    {
        "author": "jlokier",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Different gas schedules make sense for incompatible chains. But just as there's some value in \"full\" EVM cross-compatibility to link chains more closely despite different underlying mechanisms, sometimes there's value in gas cross-compatibility too.",
        "created_at": "2022-07-19T13:18:38.870000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Gas is already evil.",
        "created_at": "2022-07-19T13:19:14.492000+00:00",
        "attachments": null
    },
    {
        "author": "jlokier",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Do you have a different idea than gas to achieve a similar governing mechanism?",
        "created_at": "2022-07-19T13:20:09.877000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Only vauge ones, sadly.  Architectures that push computation off-chain?  Charging for maximum use, given inputs?",
        "created_at": "2022-07-19T13:22:48.706000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But as it is VMs get turned into gas-counting machines that do useful computation as a side effect. ðŸ˜‰",
        "created_at": "2022-07-19T13:24:02.164000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e  there's value in gas cross-compatibility too\nIf we are in a \"give it enough gas and it won't throw an exception\" regime that compatibility seems less important?",
        "created_at": "2022-07-19T13:28:35.055000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://notes.ethereum.org/@vbuterin/proposals_to_adjust_memory_gas_costs",
        "created_at": "2022-07-19T15:55:56.938000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Would love feedback from anyone",
        "created_at": "2022-07-19T15:56:01.861000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "One particular question is: how much does having a low call stack limit (~500 or 1024 instead of 30000) actually matter?",
        "created_at": "2022-07-19T15:56:55.826000+00:00",
        "attachments": null
    },
    {
        "author": "jlokier",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "In principle, implementations can share a single memory and single stack across all the call frames, similar to the way most programming languages use a single stack for different function calls.  When implemented like that, there isn't as much need to worry about the difference between many call frames with small memory/stack use, and few call frame with large memory/stack use, and the cost model could reflect that.",
        "created_at": "2022-07-19T16:04:05.606000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "yep, that's the direction I'm going",
        "created_at": "2022-07-19T16:14:56.399000+00:00",
        "attachments": null
    },
    {
        "author": "atoulme",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I like proposal 4 and then proposal 1.",
        "created_at": "2022-07-19T16:20:59.480000+00:00",
        "attachments": null
    },
    {
        "author": "atoulme",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I agree proposal 4 is complex to envision for a dev. Proposal 1 is easier to understand, and I think it makes sense.\nIf I may, maybe I'd venture to say that you could assign gas to memory explicitly rather than deriving it from the gas available in the call frame. This way, folks can commit resources to memory explicitly?",
        "created_at": "2022-07-19T16:22:40.209000+00:00",
        "attachments": null
    },
    {
        "author": "gcolvin",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm happiest with 1.  Empirically, I don't think most contracts use nearly as much memory as (1) provides.  However, I'm not sure what you mean by \"Attempts to fill greater than that amount of memory exit with an error.\"  Is filling the same as extending?  Or is it the first MSTORE on a byte?",
        "created_at": "2022-07-19T19:14:43.567000+00:00",
        "attachments": null
    }
]