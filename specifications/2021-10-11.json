[
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "how difficult would it be to also run the consensus tests with the optimized db?",
        "created_at": "2021-10-11T09:15:08.495000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "The entire test suite passes with the optimized db. The problem is that optimized state changes only get written to disk when `state_root()` is called, so all the bugs we are catching require sequences of multiple transactions that aren't in the test suite.",
        "created_at": "2021-10-11T09:43:19.544000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "oh i see",
        "created_at": "2021-10-11T09:45:16.985000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "hmm, wouldn't this catch an issue? https://github.com/ethereum/tests/blob/develop/BlockchainTests/ValidBlocks/bcStateTests/SuicidesMixingCoinbase.json",
        "created_at": "2021-10-11T09:46:54.124000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "This was a resurrection bug. A call is made to `kill()` on `0x506f4b138e30f4ed0b9511d4d676eaaeca466983` in 54316 and 54319. The first call made it SELFDESTRUCT, the second one resurrected it (setting it to `EMPTY_ACCOUNT`). But the storage keys were never deleted, so the new account had storage and that caused the state root to be wrong.",
        "created_at": "2021-10-11T10:44:18.622000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "If there are no tests in `ethereum/tests` that catch this issue we should be sure to log it so we can create the test at some point",
        "created_at": "2021-10-11T11:05:38.203000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "No client existed prior to 2018 that could have this bug (it needs Erigon style state storage). Perusing the tests repository, there really don't seem to be many tests for the interaction between CREATE2 and SELFDESTRUCT (which is really messy for clients internally).",
        "created_at": "2021-10-11T11:58:01.728000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "Why is create2+selfdestruct more messy than create+selfdestruct?",
        "created_at": "2021-10-11T12:28:17.906000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "oh i see, because you recreate at the same address and the storage may still be around",
        "created_at": "2021-10-11T12:33:19.588000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "https://medium.com/@jason.carver/defend-against-wild-magic-in-the-next-ethereum-upgrade-b008247839d2",
        "created_at": "2021-10-11T12:34:51.416000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "general",
        "parent": "",
        "content": "and you can redeploy *different* bytecode there..",
        "created_at": "2021-10-11T12:34:58.453000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "feature not a bug",
        "created_at": "2021-10-11T12:35:07.876000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "ðŸ˜„",
        "created_at": "2021-10-11T12:35:09.212000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "general",
        "parent": "",
        "content": "but the tx in question is pre-create2 anyways and we still have the issue of not deleting storage",
        "created_at": "2021-10-11T12:35:37.886000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "In a real client you can't actually delete all storage for an account during the block processing for performance reasons. Instead each account stores a reincarnation number and increments it each SELFDESTRUCT. You store one storage trie for each incarnation (old tries get pruned as appropriate).",
        "created_at": "2021-10-11T14:32:21.365000+00:00",
        "attachments": null
    },
    {
        "author": "vorot93",
        "category": "general",
        "parent": "",
        "content": "*s/trie/set of storage slots\n\nErigon has no trie ðŸ˜…",
        "created_at": "2021-10-11T18:02:49.143000+00:00",
        "attachments": null
    }
]