[
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "What `get_storage_root` are you referring to?",
        "created_at": "2021-09-23T03:50:04.783000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Oh, I think I figured it out",
        "created_at": "2021-09-23T03:50:17.600000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "But in the executions-specs trie implementation.",
        "created_at": "2021-09-23T03:50:25.245000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Link?",
        "created_at": "2021-09-23T03:50:39.082000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "https://github.com/ethereum/execution-specs/blob/b0da91e9d53d816d32500be0cca758fcef8b3d79/src/ethereum/frontier/trie.py#L353",
        "created_at": "2021-09-23T03:51:13.365000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Just working on tightening the bounds of the `Bytes` types so they line up with the specs.",
        "created_at": "2021-09-23T03:51:33.166000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "I _believe_ it should be a `Callable[[Address], Root]`",
        "created_at": "2021-09-23T03:52:04+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Excuse my Python, but why is it `[Address]` instead of `Address`?",
        "created_at": "2021-09-23T03:54:18.847000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Oh, is the first parameter to callable an array of input parameters to the function, and the second is the return type for the function?",
        "created_at": "2021-09-23T03:54:36.288000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Exactly!",
        "created_at": "2021-09-23T04:35:31.994000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "This is a side effect of the fact that having `storage_root` be part of the account object in the accounts trie is really unwieldy. The problem is that it makes `Account` objects arbitrarily large (e.g. the `WETH` account on mainnet is huge).\nWe decided to make `Account` and other objects immutable, which means we can't feasibly put storage tries in the account object. This means it isn't possible to RLP encode an account without providing the storage root. So to calculate the state root of the accounts trie, you have to provide a function `get_storage_root` which takes an `Address` and returns the relevant storage root.",
        "created_at": "2021-09-23T10:58:36.185000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Yep, I eventually figured that out ðŸ¤£",
        "created_at": "2021-09-23T14:53:44.773000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Hm, does `get_storage_root` always take an address?",
        "created_at": "2021-09-23T15:42:22.312000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "It doesn't make sense to take anything else.",
        "created_at": "2021-09-23T15:44:17.891000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Hm, alright. It's getting called with a `Bytes4` sometimes ðŸ˜‰",
        "created_at": "2021-09-23T15:56:28.782000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Wat?",
        "created_at": "2021-09-23T15:57:05.540000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "If you find the answer to why that is please @mention me!",
        "created_at": "2021-09-23T15:57:18.827000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "I _suspect_ it's because we reuse the same code for both trie types",
        "created_at": "2021-09-23T15:57:46.027000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "I'll let you know what I find lol",
        "created_at": "2021-09-23T15:57:58.444000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Oh, is this just a bug in your code, not an expected behavior from a consensus compatible client?",
        "created_at": "2021-09-23T16:02:49.294000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "no bug in a real client",
        "created_at": "2021-09-23T16:02:54.944000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Just our stuff",
        "created_at": "2021-09-23T16:02:58.011000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "general",
        "parent": "",
        "content": "Ah, nevermind on mentioning me then.  I don't care about your thing.  ðŸ˜†",
        "created_at": "2021-09-23T16:03:10.103000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "ðŸ’”",
        "created_at": "2021-09-23T16:03:18.569000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Would it make sense to replace `Callable[[Address], Root]` with `Optional[Callable[[Address], Root]]` instead of using the `no_storage` hack?",
        "created_at": "2021-09-23T16:05:28.037000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "The current code calls it for every node in every Trie, regardless of whether that node is an account or not, but the result is ignored if the node isn't an account.",
        "created_at": "2021-09-23T16:05:38.636000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "Yeah, just need to add a check to not call if the node isn't an `Account`.",
        "created_at": "2021-09-23T16:07:14.123000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Instead of, or in addition to making it optional?",
        "created_at": "2021-09-23T16:07:35.045000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "If you just make it optional, the current code will crash on a `None is not callable` error.",
        "created_at": "2021-09-23T16:08:53.173000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "lol, yes. I'd check for that too.",
        "created_at": "2021-09-23T16:09:07.236000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "But I don't think that solves the problem of getting called on intermediary nodes",
        "created_at": "2021-09-23T16:09:23.636000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "So check if the node `isinstance` account, and only call then?",
        "created_at": "2021-09-23T16:09:52.425000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "kk",
        "created_at": "2021-09-23T16:10:07.757000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Thanks!",
        "created_at": "2021-09-23T16:10:10.630000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Eventually I'll learn how the whole trie works.",
        "created_at": "2021-09-23T16:10:23.379000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Eventually.",
        "created_at": "2021-09-23T16:10:24.999000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "Honestly the trie code would just benefit from a bit of refactoring. It has a bunch of artifacts from the history of how it evolved.",
        "created_at": "2021-09-23T16:10:28.082000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Yeah :\\",
        "created_at": "2021-09-23T16:10:41.781000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Probably should do a bit of cleanup before (or as part of) the homestead fork",
        "created_at": "2021-09-23T16:11:00.058000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "My new state code spends ~100% of its time in `rlp.encode` and `rlp.decode`, btw. So that will need optimizing as well.",
        "created_at": "2021-09-23T16:11:38.260000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "cpython, pypy, or both?",
        "created_at": "2021-09-23T21:20:18.119000+00:00",
        "attachments": null
    },
    {
        "author": "peter.davies",
        "category": "general",
        "parent": "",
        "content": "cpython",
        "created_at": "2021-09-23T21:21:53.334000+00:00",
        "attachments": null
    },
    {
        "author": "samwilsn",
        "category": "general",
        "parent": "",
        "content": "Gotta test with the JIT ðŸ˜›",
        "created_at": "2021-09-23T21:22:33.707000+00:00",
        "attachments": null
    }
]