[
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "I'd like to work on adding EEST tests for EXT*CALL (state tests). Is anyone also working on this and would like to coordinate?",
        "created_at": "2024-07-23T10:06:00.526000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "New tests or porting stuff from ethereum/tests?",
        "created_at": "2024-07-23T13:18:27.594000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "there are no (comprehensive) tests for EXT*CALL in `ethereum/tests`. So it's going to be new tests and/or porting from evmone state_tests (ones we've published ~3 weeks ago). Actually, there is a test for EXT\\*CALL in ethereum/tests, I'll see what it tests exactly and how it composes with the rest.",
        "created_at": "2024-07-23T13:36:16.787000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "There are several tests for EXT*CALL here - https://github.com/ethereum/execution-spec-tests/tree/main/tests/prague/eip7692_eof_v1/eip7069_extcall - Before we blindly bring over tests from other clients or the legacy tests we should make sure it's not duplicating coverage.",
        "created_at": "2024-07-23T13:45:01.932000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "We also should consider how we want to approach gas testing, since the legacy way of using the GAS opcode is off-limits.  We do get aggregate gas level checking with the fixtures, but we don't have opcode level checks that a single test will highlight.",
        "created_at": "2024-07-23T13:45:58.383000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "One idea I have is \"differential\" testing.  Two short TXes that only differ in the presence/absence of one opcode.  Then diff the gas used.",
        "created_at": "2024-07-23T13:47:18.056000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "But to make it one tx we would have to use a legacy launcher to do two short contracts and use the legacy gas to get the diff.",
        "created_at": "2024-07-23T13:48:07.012000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Can't we do a structure like this? Have a legacy contract call into the target contract with exactly the amount of gas necessary for the whole operation (so with the opcode) and then exactly the same call, but now with the necessary gas minus 1. Store the call result of both calls into two different storage slots. Then the first will store 1, and the second will store 0?",
        "created_at": "2024-07-23T13:54:35.293000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "Yup, I'm aware. Re approach to gas testing, I am initially considering something like MCOPY memory expansion tests use, c.f. https://github.com/ethereum/execution-spec-tests/blob/main/tests/cancun/eip5656_mcopy/test_mcopy_memory_expansion.py . Not ideal, but simple",
        "created_at": "2024-07-23T13:54:50.496000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "so more or less this what Jochem describes here",
        "created_at": "2024-07-23T13:55:13.766000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "Using GAS [in an auxiliary caller contract] appears (at least theoretically) to go against the notion of at one point disallowing legacy code in one form or another.\n\nAlso the new EXT*CALL rules for gas allowance calculation make it hard in general to figure out the gas usage and test it.",
        "created_at": "2024-07-23T14:01:54.886000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "This would require explicit support, correct? I.e. a new fixture format extending `state_test`, where the result of the first tx (e.g. gas used) can be used as a variable in the expectations towards the other tx effect...",
        "created_at": "2024-07-23T14:06:18.631000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "Yea, it would require harness changes.  That's why the legacy contract calling the eof contract is a better path.",
        "created_at": "2024-07-23T14:10:14.009000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "One consideration is also for _trace_ based testing, where some elements of the EIP-3155 trace are part of the fixture.",
        "created_at": "2024-07-23T14:12:17.647000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "Was thinking about this exactly now",
        "created_at": "2024-07-23T14:12:36.028000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "trace based fuzzing has produced better results than end result based fuzzing.",
        "created_at": "2024-07-23T14:12:41.214000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "given the nature of the system under test, I think it is a justified testing via internals. The trace of program A (at least gas decrements it contains) can be seen as something external, because it dictates how A can be modified (or its inputs) and to what effect.\n\nIs it reasonable to think about implementing this though for eof?",
        "created_at": "2024-07-23T14:18:43.473000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "3155 traces are how at least Linea does it's ZK prooving, so it feels like it's fair game.  \n\nBut then we are only testing a sub-set of possible EOF implementations, and ignoring the ones that re-write static gas charges to only occur once per branch.  So the diff based approach seems better there.",
        "created_at": "2024-07-23T14:20:44.722000+00:00",
        "attachments": []
    },
    {
        "author": "pdobacz",
        "category": "Testing",
        "parent": "",
        "content": "\u003e But then we are only testing a sub-set of possible EOF implementations\nI see. Also the question would be how large a trace should go into a fixture and how to express expectations in test generators...",
        "created_at": "2024-07-23T14:55:43.921000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "I think a legacy harness is the way to go.  But it gets wonky with warm/cold too.  Perhaps run op/nop/op2?  cold = op-nop warm = op2-nop",
        "created_at": "2024-07-23T15:42:00.804000+00:00",
        "attachments": []
    },
    {
        "author": "_shemnon",
        "category": "Testing",
        "parent": "",
        "content": "(op2 is just op run again)",
        "created_at": "2024-07-23T15:42:21.041000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Testing",
        "parent": "",
        "content": "Oh right good point about warm/cold ðŸ˜…",
        "created_at": "2024-07-23T16:00:36.455000+00:00",
        "attachments": []
    }
]