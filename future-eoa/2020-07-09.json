[
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sanity check: [EIP-2718](https://eips.ethereum.org/EIPS/eip-2718) is not a consensus change and does not require a hard fork.  We could codify it into the protocol via an upgrade to the DevP2P ETH protocol via `eth/66` or whatever comes next and it could be rolled out as soon as the EIP is accepted.  We will want a separate EIP to specify the updated messages for the `ETH` and  `LES` protocols.",
        "created_at": "2020-07-09T17:17:35.035000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "After which there should still probably be updates to the JSON-RPC spec to support the new format in the places where transactions are found.",
        "created_at": "2020-07-09T17:19:28.141000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "currently, EIP-2718 specifies that the actual tx serialization in blocks will be converted to the new form and legacy txs will no longer be valid",
        "created_at": "2020-07-09T17:20:48.645000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That is 2711 that does that technically.",
        "created_at": "2020-07-09T17:21:33.106000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Maybe the core point is that we need to update the spec for the DevP2P protocol so that it is explicit what the new message formats are at that layer.  This could be bundled into EIP-2718 which might make the most sense, or it could be a separate EIP.",
        "created_at": "2020-07-09T17:22:03.361000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@364458974906548225\u003e I am not familiar with devp2p, is there more to that then just defining what the byte array looks like?",
        "created_at": "2020-07-09T17:22:53.145000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e That is 2711 that does that technically.\nyou're saying 2711 is when the change of serialization occurs in blocks?",
        "created_at": "2020-07-09T17:23:21.285000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The output of 2712 is a byte array (rlp encoded blah blah), does devp2p care about the contents beyond that?",
        "created_at": "2020-07-09T17:23:29.865000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Here's a version of the devp2p eth protocol spec: https://github.com/ethereum/devp2p/blob/master/caps/eth.md \n\nI'm not sure that is canonical or up-to-date, but you can see that there are messages which have the old format embedded.",
        "created_at": "2020-07-09T17:23:51.717000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@543900561460822016\u003e Yes, though thinking harder on it both 2711 and 2718 do that.",
        "created_at": "2020-07-09T17:24:20.494000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oops, I got my numbers backward!",
        "created_at": "2020-07-09T17:24:26.894000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Sorry, so 2718 defines part of how a transaction is encoded, and 2711 defines a bit more.",
        "created_at": "2020-07-09T17:25:04.458000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003c@364458974906548225\u003e I don't think any additional wording is necessary in the EIP for the devp2p spec?",
        "created_at": "2020-07-09T17:26:16.112000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Do you feel something in particular is missing?  It looks like devp2p just says, \"rlp encoded transaction goes here\" more or less.",
        "created_at": "2020-07-09T17:26:45.647000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "as written, i suppose 2718 could be implemented w/o a hard fork if the block hash is calculated with legacy txs and then transformed to 2718 txs to propagate over devp2p, correct?",
        "created_at": "2020-07-09T17:27:16.219000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I do think we should version devp2p for this, and update those docs, but that would be it.",
        "created_at": "2020-07-09T17:27:57.606000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e as written, i suppose 2718 could be implemented w/o a hard fork if the block hash is calculated with legacy txs and then transformed to 2718 txs to propagate over devp2p, correct?\nI'm not a fan of this.  One of the things I would like to achieve with 2718 is not having legacy code lying around forever afterwards if at all possible.",
        "created_at": "2020-07-09T17:28:36.133000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "also not a fan, seems much more complex",
        "created_at": "2020-07-09T17:28:52.479000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, agreed, as I was writing this I came to the same conclusion, I think we probably want both, FORK_BLOCK_NUMBER and explicit specs for a new DevP2P versions of the `ETH` and `LES` protocol messages that document their message formats.",
        "created_at": "2020-07-09T17:30:05.244000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Where can one learn about the LES protocol?",
        "created_at": "2020-07-09T17:32:00.800000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Thought I'm still puzzling over what FORK_BLOCK does for us.. we can't invalidate existing DevP2P protocol versions so the old format will still be used at the networking level for older clients.  I can't find a use for FORK_BLOCK.....",
        "created_at": "2020-07-09T17:32:11.951000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "https://github.com/ethereum/devp2p/blob/master/caps/les.md might be mostly up-to-date",
        "created_at": "2020-07-09T17:32:34.862000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Why can't old versions be deprecated?",
        "created_at": "2020-07-09T17:32:35.627000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "They can be deprecated, but we can't force them to stop existing,  each client can choose to stop supporting them",
        "created_at": "2020-07-09T17:33:03.710000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I would like to dig into what that means, but my time is limited so I'll drop it for now.  :)",
        "created_at": "2020-07-09T17:33:45.764000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Currently, the ETH devp2p protocol doesn't actually specify what a transaction is:\n\u003e The items in the list are transactions in the format described in the main Ethereum specification.",
        "created_at": "2020-07-09T17:34:07.845000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Oh, I know where `FORK_BLOCK` comes into play.  The `Header.transactions_root`",
        "created_at": "2020-07-09T17:34:10.511000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So by updating how a transaction is defined in the Ethereum specification, we get devp2p for free.",
        "created_at": "2020-07-09T17:34:27.969000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Well, technically not the transaction root, but the state root.",
        "created_at": "2020-07-09T17:34:52.998000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "That field is dependent on the RLP encoded transaction.  So after FORK_BLOCK_NUMBER that field would need to be computed using the new RLP format.",
        "created_at": "2020-07-09T17:34:53.901000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Eh, depending on implementation, you may be able to calculate transaction root without any client changes. It is the state root that you cannot calculate without a client update.",
        "created_at": "2020-07-09T17:35:41.202000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Since the transaction root only depends on the transaction hashes and encoded bytes I believe?",
        "created_at": "2020-07-09T17:36:09.714000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "And so a client may treat transactions received as opaque bytes (never rlp decoding them) to calculate the transaction root.",
        "created_at": "2020-07-09T17:36:37.717000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "However, to calculate the state root you have to decode and interpret every transaction, so you can execute them all.",
        "created_at": "2020-07-09T17:36:56.884000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(someone should verify my assumption about transaction root)",
        "created_at": "2020-07-09T17:37:48.075000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "It isn't the hashes.  It's the actual RLP encoded full transaction.",
        "created_at": "2020-07-09T17:38:54.773000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "So we do have to update the spec for how `Header.transactions_root` is computed.",
        "created_at": "2020-07-09T17:40:02.813000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(sorry I didn't grok this before, trying to play catchup now before ACD tomorrow)",
        "created_at": "2020-07-09T17:40:28.840000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I don't believe so.",
        "created_at": "2020-07-09T17:40:59.876000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "But we can roll out the DevP2P changes prior to the fork block, and anyone stuck on older versions of the devp2p protocol will just have to do the transformation to the new format locally.",
        "created_at": "2020-07-09T17:41:12.702000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Imagine you receive a transaction over devp2p (either as part of a block or as part of a transaction broadcast).  You don't decode it, you just treat it as an opaque byte array.  Without ever trying to decode the transaction, you can validate the transaction root.",
        "created_at": "2020-07-09T17:42:17.266000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The state root on the other hand *does* require you to decode and understand the transaction.",
        "created_at": "2020-07-09T17:42:49.374000+00:00",
        "attachments": null
    },
    {
        "author": "lightclient",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "```\ntransactionsRoot: The Keccak 256-bit hash of the\nroot node of the trie structure populated with each\ntransaction in the transactions list portion of the\nblock\n```\n(from yellow paper)",
        "created_at": "2020-07-09T17:42:49.584000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Since the state root requires decoding and understanding the transaction, the above debate is a bit pedantic/academic, I'm mainly engaging to ensure we are all on the same page/talking about the same thing.",
        "created_at": "2020-07-09T17:44:00.947000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "All I'm saying is that it would be good to be explicit in the spec about the places this change effects.  I agree that the current spec does implicitely specify this to some degree by declaring that the old RLP encoding is invalid.\n\nWe will also need some new tests for `ethereum/tests` to cover the  `Header.transactions_root` .",
        "created_at": "2020-07-09T17:44:31.933000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "(sorry for any confusion here, I'm figuring this out as I go)",
        "created_at": "2020-07-09T17:45:01.994000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Yeah, new tests will be necessary, and old tests will need to start failing after a particular block number (I don't know if existing infrastructure supports that kind of test logic or not).",
        "created_at": "2020-07-09T17:45:44.622000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I believe those two tests would effectively be the same, demonstrating that the header is computed using the new format should be sufficient.",
        "created_at": "2020-07-09T17:46:24.775000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "The fact that clients don't have to upgrade devp2p is news to me, but I think we can ignore it since devp2p doesn't actually define transactions at all.",
        "created_at": "2020-07-09T17:46:35.632000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "\u003e I believe those two tests would effectively be the same, demonstrating that the header is computed using the new format should be sufficient.\nI don't believe this is true.  Definitely not for transaction root (again, pedantic) but even for state root I think it is important to show that you cannot compute a new state root given a legacy style transaction.",
        "created_at": "2020-07-09T17:47:45.885000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Meaning, if someone tries to include `rlp([nonce, ...])` in a block after fork, block production should fail rather than produce a block.",
        "created_at": "2020-07-09T17:48:38.561000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Similarly, if someone sends a block with a transaction root that points at a transaction in legacy format, block validation should fail.",
        "created_at": "2020-07-09T17:49:33.067000+00:00",
        "attachments": null
    },
    {
        "author": "pipermerriam",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I'm going to concede that we are saying close-enough to the same things here.  I'll review the spec and collect nodes on what specifically I think needs to be clarified, changed, (if anything).",
        "created_at": "2020-07-09T17:50:40.509000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "If you do think we need to make changes to the EIP for clarity and whatnot definitely let me know!  After this conversation I don't *think* changes are necessary (I need to look at LES still though), other than adding tests.",
        "created_at": "2020-07-09T17:53:00.986000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "I was mostly waiting on tests until there was some _very basic_ buy in from core devs that this is an avenue we want to pursue.",
        "created_at": "2020-07-09T17:53:24.839000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution R\u0026D",
        "parent": "",
        "content": "Looking at LES I don't think any changes are necessary there either, though the docs are a tad less clear than devp2p and I may be making some incorrect assumptions.",
        "created_at": "2020-07-09T17:55:41.866000+00:00",
        "attachments": null
    }
]