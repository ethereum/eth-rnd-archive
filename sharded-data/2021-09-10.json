[
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "Regarding DAS fork choice: I have an impression that ForkChoice should verify DAS for headers earlier: when they just appear in blocks. I.e. a block is only eligible for consideration in the fork choice when all shard headers in it are DAS available \n\nWhen DAS check is performed later (e.g. when header is confirmed) a bunch of iffy cases arises (including the one above)",
        "created_at": "2021-09-10T12:47:00.916000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003e - suppose the shard header gets confirmed on epoch transition (say at slot N) due to majority of votes",
        "created_at": "2021-09-10T12:47:26.299000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "The key thing is that an individual node should not accept a block as confirmed if it sees a majority of votes",
        "created_at": "2021-09-10T12:47:45.312000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "A node should only accept a block as confirmed if (i) it seems a majority of commits, and (ii) it personally has made a successful DAS check of the block",
        "created_at": "2021-09-10T12:48:06.723000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "I suppose under 'block' you mean 'shard blob' here?",
        "created_at": "2021-09-10T12:51:24.590000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Ah yes, though also transitively a block: a node should only \"see\" a block if it has successfully done DAS on all blobs that the block has declared confirmed",
        "created_at": "2021-09-10T12:51:55.729000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "Yes, confirming shard blob in isolation works well as you described, but it is not mapped well to beacon block fork choice 'confirmation'.",
        "created_at": "2021-09-10T12:55:14.045000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Why not?",
        "created_at": "2021-09-10T12:57:35.246000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "A shard blob is formally a dependency of a beacon block if that beacon block pushes that shard blob into the confirmed bucket",
        "created_at": "2021-09-10T12:58:03.260000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "In the same way that a beacon block's parent is formally a dependency of that block",
        "created_at": "2021-09-10T12:58:15.774000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "So the core principle is exactly the same as fork choice in hashgraph/DAG-style systems, where a block can have multiple dependencies that must be already accepted into the block tree for that block itself to be eligible for acceptance in the block tree",
        "created_at": "2021-09-10T12:59:52.670000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Except here it's easier because the shard blobs themselves don't have dependencies of their own ðŸ˜†",
        "created_at": "2021-09-10T13:00:22.510000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "At least the case I described above (the late pending blob header confirmation) has no explicit block 'guilty' for confirming a blob, thus ForkChoice just has no options to exclude anything from the block tree",
        "created_at": "2021-09-10T13:10:40.626000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "The block that's guilty is the first block where in the post-state of that block the blob is confirmed, and in the pre-state it's not confirmed",
        "created_at": "2021-09-10T13:11:07.622000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Ooooh you're saying the under 2/3 case",
        "created_at": "2021-09-10T13:11:26.359000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "ok I think I see what you mean now",
        "created_at": "2021-09-10T13:11:31.614000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "It's epoch transition guilt ðŸ™‚",
        "created_at": "2021-09-10T13:11:37+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "ok this is actually an important bug in the current spec at least wrt its ability to long-term execute ðŸ˜†",
        "created_at": "2021-09-10T13:12:09.797000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "One possible fix is to say \"if all slots in epoch N are inactive, then the end-of-epoch confirmations at the beginning of epoch N are skipped\"",
        "created_at": "2021-09-10T13:12:49.591000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "So the chain would get stuck for only one epoch, but then continue",
        "created_at": "2021-09-10T13:12:56.485000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "Even in optimistic case: when a block 'brings' just the last single attestation to confirm a blob with \u003e 2/3 (say other attestations were included in earlier blocks), then assuming this block as 'guilty' for confirming a DAS unavailable blob doesn't look 'fair'",
        "created_at": "2021-09-10T13:16:23.597000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "\u003e ForkChoice should verify DAS for headers earlier: when they just appear in blocks. I.e. a block is only eligible for consideration in the fork choice when all shard headers in it are DAS available \n\u003c@!273808422753796097\u003e what do you think on this option?",
        "created_at": "2021-09-10T13:17:17.205000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "I don't think of it as a moral judgement on the block, I think of it as just, that's the point of no return, so that's the point where the fork choice should get applied",
        "created_at": "2021-09-10T13:17:59.071000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "The problem I have with this approach is that it ends up putting a lot more pressure on the DAS mechanism",
        "created_at": "2021-09-10T13:18:27.644000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Like, a malicious block producer could publish a block in weird ways (eg. making only 90% of the data available and causing a temporary disagreement between DAS query results)",
        "created_at": "2021-09-10T13:19:01.057000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "And this would cause the network to disagree for a few extra seconds, and hurt the fork choice for 1-2 slots",
        "created_at": "2021-09-10T13:19:19.252000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Whereas with the current approach, the attestation gating ensures that you need an entire committee to be corrupted for such a thing to happen",
        "created_at": "2021-09-10T13:19:39.850000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "I think I see what you mean. Makes sense",
        "created_at": "2021-09-10T13:24:16.723000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Basically, because DAS has its own risks, we want to give nodes as much time as possible to do the sampling, to reduce the chance that a DAS sampling result disagreement persists long enough to cause a temporary chain split. And so we want to delay making a DAS check a fork choice dependency until the last possible moment. And the last possible moment is... the block right before the block which admits that shard blob into the confirmed set (at which point it's irreversible)",
        "created_at": "2021-09-10T13:25:50.842000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "Is it an option just to remove the possibility of late blob confirmation (\u003c2/3)? I.e. only \u003e2/3 or blob is just not confirmed",
        "created_at": "2021-09-10T13:26:04.405000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "The reason why late blob confirmation exists is so that the chain can still do something useful in the \u003e1/3 offline case",
        "created_at": "2021-09-10T13:26:28.123000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "It could just keep trying to survive in this case ðŸ˜€",
        "created_at": "2021-09-10T13:27:59.621000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "Right, though I think we have made an explicit design choice to be not just safe but also live in the \u003e1/3 offline case",
        "created_at": "2021-09-10T13:28:22.834000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "eg. it's a big part of the motivation for the whole hybrid Casper + LMD GHOST mess, instead of \"just using a BFT algo\"",
        "created_at": "2021-09-10T13:28:45.877000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "(not the whole motivation obviously, there's also the whole \"support 1m+ validators\" thing, but a big part)",
        "created_at": "2021-09-10T13:29:02.426000+00:00",
        "attachments": []
    },
    {
        "author": ".vbuterin",
        "category": "Cross-layer",
        "parent": "",
        "content": "And so for that design choice to be a reality, it needs to also apply to sharding",
        "created_at": "2021-09-10T13:29:19.631000+00:00",
        "attachments": []
    },
    {
        "author": "nashatyrev",
        "category": "Cross-layer",
        "parent": "",
        "content": "Got it. That makes things a bit more clear for me",
        "created_at": "2021-09-10T13:33:36.125000+00:00",
        "attachments": []
    }
]