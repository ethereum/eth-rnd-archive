[
    {
        "author": "barnabasbusa",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Based on the ACDC call today, maybe we can continue discussion here about what would be the best approach to use auth on the keymanager api endpoint on the validator clients. \n\nSimilarly, how the jwt authentication was specced out for the EL \u003c\u003e CL communication (https://github.com/ethereum/execution-apis/blob/main/src/engine/authentication.md)\nI think it would make sense to have a similar spec for keymanager api, Currently different client teams make assumptions about whether this endpoint should be http or https, and thus may require some certificate to be generated before the endpoint is exposed. \n\nPersonally I feel like this is a bit of an overkill, and https tunnel termination should be handled by the proxy layer instead of the application layer. \n\nI think it would make the most sense for all clients to use a basic authentication header, which could be generated by the client, or could be provided during runtime and possibly have a way to disable all authentication. \nBasic functionality: \n- allow to turn of auth (maybe?)\n- where to load token from\n- if from file, maybe a flag to configure file location\n\nCurious what you all think. cc \u003c@884836500037066862\u003e \u003c@504202741933932544\u003e \u003c@792822129019584562\u003e \u003c@654267572107083777\u003e \u003c@602753420033785856\u003e",
        "created_at": "2024-03-07T15:04:41.396000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I think we just need to agree on the header and maybe a flag to turn it off. extra could be overwriting with their own jwt provided. \n\nlike barnabas said i hope we don't pull tls/certs etc into this",
        "created_at": "2024-03-07T15:08:17.904000+00:00",
        "attachments": []
    },
    {
        "author": "tersec",
        "category": "Consensus Layer",
        "parent": "",
        "content": "As status quo, I think Nimbus doesn't support https here, but not certain. I guess, what is the overall goal here, to provide sufficient surface to allow Hive or Kurtosis testing, or to create a robust interoperability standard?",
        "created_at": "2024-03-07T15:09:07.477000+00:00",
        "attachments": []
    },
    {
        "author": "tersec",
        "category": "Consensus Layer",
        "parent": "",
        "content": "In particular, if former, then `allow to turn of auth` is all that's necessary",
        "created_at": "2024-03-07T15:11:58.553000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "interpretation is just an interoperability standard, it's on the validator client so hopefully it should be easier. we can just have some agreement to have something to turn it off to make testing easier?",
        "created_at": "2024-03-07T15:11:59.533000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "oh you just mentioned it below haha",
        "created_at": "2024-03-07T15:12:14.924000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "cc \u003c@586161934425128960\u003e",
        "created_at": "2024-03-07T15:12:21.175000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "yes i agree to all the points, ssl termination can happen at some middleware like nginx and its a pain to support with various security upgrades that might be needed over time",
        "created_at": "2024-03-07T15:14:11.452000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "regarding token path: lodestar for e.g. doesn't allow providing for the token path, which i think we should do",
        "created_at": "2024-03-07T15:15:13.016000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "and it has to be/should be a file (chmod 600)",
        "created_at": "2024-03-07T15:16:02.603000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "turning off auth imo is not really required to be standardized",
        "created_at": "2024-03-07T15:17:04.883000+00:00",
        "attachments": []
    },
    {
        "author": "nflaig",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Might even be something to test for, so disabling is definitly not ideal, the spec already defines that is should be a bearer token, in Lodestar we just use a opaque 32 bytes hex string. Just need to standarize how client actually generate / read the token and how validation works.",
        "created_at": "2024-03-07T15:19:54.960000+00:00",
        "attachments": []
    },
    {
        "author": "tersec",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Maybe I misunderstand? bearer token etc for JWT is between BN/EL?",
        "created_at": "2024-03-07T15:25:49.337000+00:00",
        "attachments": []
    },
    {
        "author": "tersec",
        "category": "Consensus Layer",
        "parent": "",
        "content": "keymanager API is something else",
        "created_at": "2024-03-07T15:26:24.545000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "yes this is to protect keymanager api endpoint with basic bearer token so nothing fancy of the jwt kind, but we can go there if need be ðŸ˜†",
        "created_at": "2024-03-07T15:27:20.891000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "this is talking about the keymanager api , some of us have jwts by default and some don't and the way of setting it is probably different. just trying to get alignment on it so testing is consistent ðŸ˜…",
        "created_at": "2024-03-07T15:28:29.319000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "idea being that keymanager api is probably a (more) public endpoint than bn\u003c\u003evc endpoints",
        "created_at": "2024-03-07T15:28:30.683000+00:00",
        "attachments": []
    },
    {
        "author": "nflaig",
        "category": "Consensus Layer",
        "parent": "",
        "content": "spec already defines it needs to be sent in `Authorization: Bearer ...` header, and alos noticed how the token is provided is documented as well [keymanager-oapi.yaml#L15-L17](https://github.com/ethereum/keymanager-APIs/blob/a71e126e369a4ca762906f1d0884edcad70ee0ed/keymanager-oapi.yaml#L15-L17)\n```yaml\n    All sensitive routes are to be authenticated with a token. This token should be provided by the user via a secure channel:\n      - Log the token to stdout when running the binary with the key manager API enabled\n      - Read the token from a file available to the binary\n```",
        "created_at": "2024-03-07T15:30:05.314000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "\u003e Log the token to stdout when running the binary with the key manager API enabled\ni don't think this is a good idea as logs are generally uploded for services like loki and are more accessible, we should log token path",
        "created_at": "2024-03-07T15:31:44.779000+00:00",
        "attachments": []
    },
    {
        "author": "nflaig",
        "category": "Consensus Layer",
        "parent": "",
        "content": "that's what it says in the spec, should probably say \"token file path\" though (what we log in Lodestar)",
        "created_at": "2024-03-07T15:32:13.072000+00:00",
        "attachments": []
    },
    {
        "author": "nflaig",
        "category": "Consensus Layer",
        "parent": "",
        "content": "as per spec you can use jwts https://github.com/ethereum/keymanager-APIs/pull/18, probably not ideal to have this optional, any reason not to just use a opaque token for this?",
        "created_at": "2024-03-07T15:33:37.320000+00:00",
        "attachments": []
    },
    {
        "author": "barnabasbusa",
        "category": "Consensus Layer",
        "parent": "",
        "content": "So ideally, the client should generate a token if one isn't provided, or accept a token as a runtime variable `--token /path`",
        "created_at": "2024-03-07T15:33:52.654000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "so for prysm it's by default, auto generated to a file ( auth-token) where the prysm wallet is located as long as you run --web flag , could do more to make ti more aligned with other clients",
        "created_at": "2024-03-07T15:35:15.138000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "first line is priv key for generating the jwt and second line for the jwt in the file",
        "created_at": "2024-03-07T15:35:48.778000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "jwt is more secure and eevryone in web world undestands it, so i say lets make jwt standard rather than optional",
        "created_at": "2024-03-07T15:36:23.492000+00:00",
        "attachments": []
    },
    {
        "author": "tersec",
        "category": "Consensus Layer",
        "parent": "",
        "content": "The EL JWT spec is careful to require only a specific subset of JWT. Hopefully this would be true for any such standardized keymanager JWT too. \"JWT\" as a whole is a somewhat nebulous, expansive scope, and introduces either (a) substantial attack surface if a server is required to support arbitrarily large parts of it or (b) doesn't provide useful interoperability if different servers choose to support smaller, but individually arbitrarily chosen subsets.\n\n(That said, while it's not really a consensus API, I'm not really convinced to this day JWT in the EL was a net benefit. It's a sort of opaque failure mode, etc etc.)",
        "created_at": "2024-03-07T15:43:52.061000+00:00",
        "attachments": []
    },
    {
        "author": "nflaig",
        "category": "Consensus Layer",
        "parent": "",
        "content": "The only advantage in that case I see using a JWT is that you don't send the secret over the wire but this is only benefitial if the JWT is generated on the fly with a short expiration as it is done for the execution api.",
        "created_at": "2024-03-07T15:47:50.959000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "\u003e I'm not really convinced to this day JWT in the EL was a net benefit\n\u003e \nyea, EL engine endpoint could be protected again by some middleware and not really be required to have jwt, and so could the keymanager one as well. \n\nalthough while EL engine endpoint (or eth as well) doesn't need to be public by default  so solo stakers don't need to worry about it, but may be keymanager does by its own functionality",
        "created_at": "2024-03-07T15:53:45.635000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus Layer",
        "parent": "",
        "content": "yes specially for the http requests, https wouldn't have this issue of reveal over the wire",
        "created_at": "2024-03-07T15:54:25.680000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I am ok with going with something more simple for the token doesn't have to be jwt if it's agreed by the group",
        "created_at": "2024-03-07T16:00:56.306000+00:00",
        "attachments": []
    },
    {
        "author": "nflaig",
        "category": "Consensus Layer",
        "parent": "",
        "content": "https://github.com/ethereum/keymanager-APIs/issues/9 has few more details, all clients seem to load the token from file already as well",
        "created_at": "2024-03-07T16:02:36.420000+00:00",
        "attachments": []
    },
    {
        "author": "jameshe5018",
        "category": "Consensus Layer",
        "parent": "",
        "content": "old issue totally forgot about it ðŸ’¦  yeah we load it from a file we just don't have a flag to specify where",
        "created_at": "2024-03-07T16:03:44.424000+00:00",
        "attachments": []
    },
    {
        "author": "tbenr",
        "category": "Consensus Layer",
        "parent": "",
        "content": "teku autogenerates a bearer in the data directory configured. No CLI argument to pass it. And we require a password protected keystore (standard PKCS12).\n\nWe want to keep the ssl required by default, would it be enough to allow non ssl binding to localhost? would it be enough for testing?",
        "created_at": "2024-03-07T21:37:21.377000+00:00",
        "attachments": []
    },
    {
        "author": "barnabasbusa",
        "category": "Consensus Layer",
        "parent": "",
        "content": "that wouldn't work for any sort of docker setups",
        "created_at": "2024-03-07T23:14:02.311000+00:00",
        "attachments": []
    },
    {
        "author": "barnabasbusa",
        "category": "Consensus Layer",
        "parent": "",
        "content": "maybe an assignable host interface with an additional flag to disable ssl binding?",
        "created_at": "2024-03-07T23:14:27.542000+00:00",
        "attachments": []
    }
]