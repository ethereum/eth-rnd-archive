[
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Wanted to put this question to the community. I'm deciding on the design for the structure of the `DepositTreeSnapshot`. This is part of the API so all clients will need to implement this the same way. There are two options:\n1. A flat design:\n```\nDepositTreeSnapshot:\n    finalized: List[Hash32],\n    deposits: uint64,\n    execution_block_height: u64,\n    execution_block_hash: Hash32\n```\n2. A more explicit/organized structure since 3 of the 4 fields are properties of the execution block who's deposits have been fully imported into the deposit tree and finalized:\n```\nFinalizedExecutionBlock:\n    hash: Hash256,\n    number: u64,\n    deposit_count: u64\nDepositTreeSnapshot:\n    finalized: List[Hash32],\n    execution_block: FinalizedExecutionBlock\n```\nNow obviously you can convert between these with minimal overhead. The main reason to use the second option is that everything in the `FinalizedExecutionBlock` must be retained as the tree is continuously finalized but the `finalized` list doesn't need to be calculated until someone actually requests a `DepositTreeSnapshot`. Of course it could simply be pre-calculated as well..\n\nWould really appreciate feedback ðŸ™‚",
        "created_at": "2022-07-19T19:15:57.028000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I'd keep it simple with the flat format. In Teku we don't hold the `FinalizedExecutionBlock` values as an SSZ object (because why would we?) so there's no benefit to the more complex structure and it's likely to wind up being more expensive to create the nested form than the flat one.",
        "created_at": "2022-07-19T21:01:23.201000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Has Teku implemented this? ðŸ˜²\nWe don't keep it around as an SSZ object either, but the data involved (block hash, number, deposit_count) IS kept around",
        "created_at": "2022-07-19T21:03:05.783000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Yeah we're using this deposit tree structure internally and have a (teku specific) API in latest develop that can return the snapshot.  Working on being able to start from a snapshot now.",
        "created_at": "2022-07-19T21:05:08.226000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I've left some comments on the EIP discussion thread. ðŸ™‚",
        "created_at": "2022-07-19T21:05:18.166000+00:00",
        "attachments": []
    },
    {
        "author": ".paulharris",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Generally speaking its been helpful if things are objects from the spec, to keep the same structure... I haven't chased down if this maps directly (or parts) to spec objects... but if that's any guidance... \nTimes where we've deviated have lead to a little chaos, so just putting it out there...",
        "created_at": "2022-07-19T21:05:57.666000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Note: both formats are still different than the format of the `DepositTreeSnapshot` as it exists now in the EIP - they add the block number of the finalized execution block (previously it was just the hash). This is for convenience. As it's very likely the newly syncing node will need to hit their execution engine to translate the block hash into block number. But for newly syncing nodes, especially after the merge, it's very likely the execution engine will not be synced yet, so rather than waiting for it to sync it's easier if the finalized execution block height is just included in the snapshot.",
        "created_at": "2022-07-19T21:07:10.872000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I saw that thank you! I've posted some responses ðŸ™‚",
        "created_at": "2022-07-19T21:07:47.669000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Ah \u003c@425907307621122049\u003e is likely to quite appreciate that block number...",
        "created_at": "2022-07-19T21:08:09.869000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "This doesn't map to anything directly in the spec. It's a subset fields from objects in the spec",
        "created_at": "2022-07-19T21:09:30.830000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "Either way, you would need to keep the `block_hash`, `block_number`, and `deposits` around (all are properties of the last imported \u0026 finalized eth1 block) in order to generate the snapshot though. Does that change how you view this or do you have the same opinion?",
        "created_at": "2022-07-19T21:12:49.107000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I'd still use the flat option - it's just so much simpler.",
        "created_at": "2022-07-19T21:13:13.425000+00:00",
        "attachments": []
    },
    {
        "author": ".paulharris",
        "category": "Consensus Layer",
        "parent": "",
        "content": "so the flat object looks like its got 1 list of bytes32, is that all that's needed? so the response would be \n```\n{ \"data\": {\n   \"finalized\": [\"0x...\", \"0x...\"],\n    \"deposits\": \"11111\",\n    \"execution_block_height\": \"222222\",\n    \"execution_block_hash\": \"0x....\"\n  }\n} \n```",
        "created_at": "2022-07-19T21:14:20.762000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "I think nesting in SSZ makes sense when you either are likely to save on hashing costs or may replace the object with it's hash (eg BeaconBlock vs BeaconBlockHeader). But I can't see either of those being the case here.",
        "created_at": "2022-07-19T21:14:28.302000+00:00",
        "attachments": []
    },
    {
        "author": ".paulharris",
        "category": "Consensus Layer",
        "parent": "",
        "content": "deposits would at least be a list?",
        "created_at": "2022-07-19T21:15:14.809000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "you've got one extra level of nesting to make it look like a generic RPC response, but otherwise yes",
        "created_at": "2022-07-19T21:15:30.881000+00:00",
        "attachments": []
    },
    {
        "author": ".paulharris",
        "category": "Consensus Layer",
        "parent": "",
        "content": "hrm ok this isnt the http api?",
        "created_at": "2022-07-19T21:15:43.569000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "No need for deposits - this is just the finalized portion of the deposit merkle tree.",
        "created_at": "2022-07-19T21:15:51.944000+00:00",
        "attachments": []
    },
    {
        "author": "ajsutton",
        "category": "Consensus Layer",
        "parent": "",
        "content": "This is the SSZ version of the object. In JSON form yes it would get the data wrapper as you have.",
        "created_at": "2022-07-19T21:16:11.162000+00:00",
        "attachments": []
    },
    {
        "author": ".paulharris",
        "category": "Consensus Layer",
        "parent": "",
        "content": "i might find the spec so i understand heh all good.",
        "created_at": "2022-07-19T21:16:37.948000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "the EIP is here:\nhttps://github.com/ethDreamer/EIPs/blob/snapshot_render/EIPS/eip-4881.md",
        "created_at": "2022-07-19T21:23:42.440000+00:00",
        "attachments": []
    },
    {
        "author": ".paulharris",
        "category": "Consensus Layer",
        "parent": "",
        "content": "oh yep i googled - ta ðŸ™‚",
        "created_at": "2022-07-19T21:24:01.418000+00:00",
        "attachments": []
    },
    {
        "author": "ethdreamer",
        "category": "Consensus Layer",
        "parent": "",
        "content": "the only difference is the `DepositTreeSnapshot` will also include a block number in addition to the block hash ðŸ™‚",
        "created_at": "2022-07-19T21:24:08.919000+00:00",
        "attachments": []
    },
    {
        "author": ".paulharris",
        "category": "Consensus Layer",
        "parent": "",
        "content": "yep i think that's a good idea",
        "created_at": "2022-07-19T21:24:25.257000+00:00",
        "attachments": []
    }
]