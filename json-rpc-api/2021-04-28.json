[
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "Hi guys, I just tried sending EIP1559 txs over TurboGeth/Besu/Nethermind but all of them failed. If I just try to serialize a tx such that it represents the bytes which we use for the transactions trie (so for EIP1559 these bytes start with `0x02`) then nodes do not accept it. However, if I re-RLP the byte sequence (so the one starting with `0x02`) then I get a valid RLP which can be directly decoded and nodes seem to accept this. This, however, breaks some stuff like in web3;\n\n```javascript\nvar Tx = require('ethereumjs-tx').Transaction;\nvar privateKey = Buffer.from('e331b6d69882b4cb4ea581d88e0b604039a3de5967688d3dcffdd2270c0fd109', 'hex');\n\nvar rawTx = {\n  nonce: '0x00',\n  gasPrice: '0x09184e72a000',\n  gasLimit: '0x2710',\n  to: '0x0000000000000000000000000000000000000000',\n  value: '0x00',\n  data: '0x7f7465737432000000000000000000000000000000000000000000000000000000600057'\n}\n\nvar tx = new Tx(rawTx, {'chain':'ropsten'});\ntx.sign(privateKey);\n\nvar serializedTx = tx.serialize();\n\n// console.log(serializedTx.toString('hex'));\n// 0xf889808609184e72a00082271094000000000000000000000000000000000000000080a47f74657374320000000000000000000000000000000000000000000000000000006000571ca08a8bbf888cfa37bbf0bb965423625641fc956967b81d12e23709cead01446075a01ce999b56a8a88504be365442ea61239198e23d1fce7d00fcfc5cd3b44b7215f\n\nweb3.eth.sendSignedTransaction('0x' + serializedTx.toString('hex'))\n.on('receipt', console.log);\n```\n\nIf I try to `sendSignedTransaction` for a EIP1559Transaction, then I need to `rlp.encode(serializedTx)` and then send that byte sequence. This is not the case for LegacyTxs. If we want to do this (not really have any opinion yet) then this should be documented. I also find it somewhat weird that we don't \"doubly\" RLP these txs for the transactions trie, but we do \"doubly RLP\" then if we want to send them over RPC, I find this inconsistent.\n\n(From \u003c#749160974506000444\u003e but this place is more appropriate for this discussion)",
        "created_at": "2021-04-28T13:11:59.704000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "CC \u003c@456226577798135808\u003e",
        "created_at": "2021-04-28T13:53:34.533000+00:00",
        "attachments": []
    },
    {
        "author": "Deleted User",
        "category": "Execution Layer",
        "parent": "",
        "content": "Over the wire, in devp2p message, the version with first byte being TxType for non-legacy txs is used",
        "created_at": "2021-04-28T13:56:00.046000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "Where does this sentence come from? Cause I can't find it in 2718",
        "created_at": "2021-04-28T14:03:00.053000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "If we don't \"double-RLP\" EIP2930, then we also should not \"double-RLP\" 1559",
        "created_at": "2021-04-28T14:03:23.646000+00:00",
        "attachments": []
    },
    {
        "author": "marekm3498",
        "category": "Execution Layer",
        "parent": "",
        "content": "\u003c@!508125616940515329\u003e Are you sure that we don't wrap EIP2930 transactions?",
        "created_at": "2021-04-28T14:09:26.674000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "Uhh sorry I should have verified this, repeating \u003c@!552133098075193354\u003e here. I'll check and try to see what happens if I send a non-doubly-RLPd EIP2930 to Nethermind",
        "created_at": "2021-04-28T14:10:07.729000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "At least for TransactionTrie and stuff like that I am 100% sure",
        "created_at": "2021-04-28T14:10:37.958000+00:00",
        "attachments": []
    },
    {
        "author": "marekm3498",
        "category": "Execution Layer",
        "parent": "",
        "content": "yes, but we don't need to wrap 1559 tx for TransactionTrie too",
        "created_at": "2021-04-28T14:11:41.474000+00:00",
        "attachments": []
    },
    {
        "author": "marekm3498",
        "category": "Execution Layer",
        "parent": "",
        "content": "In Nethermind if we want to use sendRawTransaction we need additional wrapping for 1559 and 2930",
        "created_at": "2021-04-28T14:14:38.705000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "Ok just checked, Nethermind does not accept 2930 txs in the form of `0x01 || TxData`, it only accepts `RLP(0x01 || TxData)`",
        "created_at": "2021-04-28T16:34:33.690000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "We should standardize this though, but I'm not sure why on devp2p layer / TransactionTrie we do not extra-RLP them, but for RPC we RLP them again. Don't think we can really revert this change either",
        "created_at": "2021-04-28T16:35:20.292000+00:00",
        "attachments": []
    },
    {
        "author": "timbeiko",
        "category": "Execution Layer",
        "parent": "",
        "content": "IIRC we had a discussion about this when planning Berlin and \u003c@!301186049323958275\u003e created a doc with the various options for encoding.",
        "created_at": "2021-04-28T17:07:26.785000+00:00",
        "attachments": []
    },
    {
        "author": "timbeiko",
        "category": "Execution Layer",
        "parent": "",
        "content": "https://discord.com/channels/595666850260713488/779922457631916064/781908060520185896",
        "created_at": "2021-04-28T17:09:11.161000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Ugh, this issue is a recurring point of confusion.",
        "created_at": "2021-04-28T17:10:12.406000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Devp2p is RLPx, which means the protocol messages are RLP encoded.",
        "created_at": "2021-04-28T17:10:27.365000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Transactions are always sent over RLPx as a list of `Transaction | LegacyTransaction`.\n`LegacyTransaction` is a list of byte arrays (`[nonce, gasPrice, gasLimit, ...]`).\n`Transaction` is a byte array (`new Uint8Array([TransactionType, ...TransactionPayload])` in JS notation).",
        "created_at": "2021-04-28T17:11:43.902000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "\u003c@508125616940515329\u003e",
        "created_at": "2021-04-28T17:11:46.495000+00:00",
        "attachments": []
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Though, reading more maybe you are talking about sending transactions via RPC... since this is the json-rpc channel...",
        "created_at": "2021-04-28T17:16:55.078000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "This is indeed about the RPC; if you send legacy TX over RPC you serialize the txn and then dump these bytes into RPC. But, for non legacy TX you have to RLP the serialized data and then send that over RPC. So this is a difference. Especially in web3 this makes a difference, please see:",
        "created_at": "2021-04-28T19:18:25.472000+00:00",
        "attachments": []
    },
    {
        "author": "jochembrouwer",
        "category": "Execution Layer",
        "parent": "",
        "content": "the example here (in web3 js)",
        "created_at": "2021-04-28T19:18:32.125000+00:00",
        "attachments": []
    }
]