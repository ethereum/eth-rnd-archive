[
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "Hi. Question about `eth_getBlockByNumber` post-merge: what should the `mixHash` value be when the `pending` tag is used?\n\nI tested it on Goerli with both Infura and Alchemy and in both cases it returns `0x000...000`. It seems like a sensible thing to do to me, but I would like to be sure before implementing that in Hardhat.",
        "created_at": "2022-08-15T16:42:24.616000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "Also, Alchemy returns non-zero values for both `difficulty` and `nonce`, so I don't trust these tests a lot ðŸ˜›",
        "created_at": "2022-08-15T16:44:19.842000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "semi-related: Have we considered deprecating `pending` as a block tag post-merge?  I feel like it makes less and less sense as things like non-mempool txs (e.g. mev-boost or private txs flows) become more and more common.",
        "created_at": "2022-08-15T19:58:42.585000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "Worth keeping in mind that if there's no `pending` block tag, then there's no way to obtain the next `baseFeePerGas` value",
        "created_at": "2022-08-15T20:21:44.723000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "hmm, ya, good to know.  I'd be in favor of adding a `eth_nextBaseFeePerGas` or what have you if that's the case.  Though is the number actually universally correct or is the value returned dependent on how the node is configured?  I forget if the fee change is 100% deterministic or if there's wiggle room left up to the miner.",
        "created_at": "2022-08-15T20:25:20.113000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "You can trivially calculate it locally from latest block.",
        "created_at": "2022-08-15T20:28:07.474000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Deterministic from latest block (needs body for gas used).",
        "created_at": "2022-08-15T20:28:36.402000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Ya looks like at least for geth the logic is all in one spot: https://github.com/ethereum/go-ethereum/blob/master/consensus/misc/eip1559.go#L55\n\nSo would be \"easy\" to make a `eth_nextBaseFee` type RPC to return this number.",
        "created_at": "2022-08-15T20:30:44.389000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "I know, but IIRC the logic is complex enough to make sense for it to be provided by the node. I know it's not advanced math, but it wasn't precisely adding 2 and 2, was it?",
        "created_at": "2022-08-15T20:31:59.870000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Would also be possible to implement the logic client-side in web3.js or ethers or where ever as well based off of data from `eth_getBlockByNumber(\"latest\", false)`",
        "created_at": "2022-08-15T20:32:21.085000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "I believe they already have the logic?",
        "created_at": "2022-08-15T20:32:34.489000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "The other problem with calculating it from the user-side is that there are some configuration parameters that could change",
        "created_at": "2022-08-15T20:33:00.146000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "I think the logic is in one function in almost every language now, can just copy it.  Maybe 10 lines of code?",
        "created_at": "2022-08-15T20:33:05.596000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "It is possible to change with a hard fork, yes.",
        "created_at": "2022-08-15T20:33:27.717000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "To be clear, if we added a new RPC it would still be done by the node, we're just pointing out that it's _also_ possible to do 100% client-side if necessary.",
        "created_at": "2022-08-15T20:34:04.402000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "My main point is if that's the only real value `eth_getBlockByNumber(\"pending\", false)` is providing then we can implement that RPC and deprecate pending.",
        "created_at": "2022-08-15T20:34:42.783000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "Agree",
        "created_at": "2022-08-15T20:34:50.907000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "I believe you need `true`, since you need the gas used which I don't believe is part of the header?",
        "created_at": "2022-08-15T20:35:10.861000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Oh, but maybe it is included in the jsonrpc response?",
        "created_at": "2022-08-15T20:35:24.816000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "I see `Header.GasUsed` in the geth code, not sure if that's calculated or an actual consensus field.",
        "created_at": "2022-08-15T20:35:48.491000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "It should also simplify the spec of the JSON-RPC, because the `pending` tag has some annoyingly different fields (at least in PoW, I'm not sure post-merge)",
        "created_at": "2022-08-15T20:35:54.719000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Pretty sure it isn't part of the consensus header.",
        "created_at": "2022-08-15T20:36:10.693000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Looks to be in the yellow paper: `gasUsed: A scalar value equal to the total gas used in transactions in this block; formally Hg.`",
        "created_at": "2022-08-15T20:37:05.961000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "Oh. I was wrong.  You are right.",
        "created_at": "2022-08-15T20:38:33.719000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "I do remember there was some other related field not part of consensus though that did sneak into the `eth_getTransactionReceipt` response but don't recall exactly what it was.",
        "created_at": "2022-08-15T20:40:07.748000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Ya that's the `gasUsed` that you were probably thinking of: it's not a consensus field but is returned by the tx apis.",
        "created_at": "2022-08-15T20:41:31.288000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "There are a bunch of fields in Jason RPC responses that don't exist in their respective consensus data structures IIRC.",
        "created_at": "2022-08-15T20:41:47.049000+00:00",
        "attachments": null
    },
    {
        "author": "sky.cactus",
        "category": "Execution Layer",
        "parent": "",
        "content": "It is why I always just assume redundant data (like gas used) is one of those.",
        "created_at": "2022-08-15T20:42:05.363000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "Btw, I would still love to get an answer about this. I'm pretty sure we'll just return the zero value in that case, but having extra confirmation would be appreciated.",
        "created_at": "2022-08-15T20:47:39.682000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "while not explicitly called out I think it's reasonable to expect that EIP-3675's requirements apply to the `pending` block post-merge as well, so I would expect mixHash, difficulty, nonce etc to all be zeros. https://github.com/mkalinin/EIPs/blob/7bf827255510b95ffc0b2c8f02ce53e51d6cec2f/EIPS/eip-3675.md#block-structure\n\nNo idea if most clients have a TTD-aware implementation of `pending` or not though, so there might be a corner case where a client still returns say a non-zero mixHash for `pending` even once they've reached TTD (but before the first PoS block).",
        "created_at": "2022-08-15T21:30:46.239000+00:00",
        "attachments": null
    },
    {
        "author": "fvictorio",
        "category": "Execution Layer",
        "parent": "",
        "content": "Wait, but I thought `mixHash` should have the RANDAO value, shouldn't it?",
        "created_at": "2022-08-15T21:33:03.183000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Oops I pointed to a draft of the EIP not the final one: https://github.com/ethereum/EIPs/blob/master/EIPS/eip-3675.md",
        "created_at": "2022-08-15T21:37:28.609000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "hmm but the final spec doesn't mention that either, perhaps it's in another EIP",
        "created_at": "2022-08-15T21:39:02.369000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Ok ya that's confusing: https://github.com/ethereum/EIPs/blob/master/EIPS/eip-4399.md",
        "created_at": "2022-08-15T21:42:24.260000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Hmm, so ya IMO this is another reason for removing `pending`, 4399 doesn't mention how pending blocks should be built at all.  An correct me if I'm wrong but I assume only the next actual validator knows the \"correct\" RANDAO value to add.  If that's the case 0x0...0 seems like a sane value for the JSONRPC to plug in but this area is definitely under-specified.",
        "created_at": "2022-08-15T21:47:00.620000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Then again, I'm not sure how to interpret: `Beginning with TRANSITION_BLOCK, client software MUST set the value of the mixHash, i.e. the field with the number 13 (0-indexed) in a block header, to the latest RANDAO mix of the post beacon state of the previous block.` in the context of the `pending` block to be honest.",
        "created_at": "2022-08-15T21:48:12.497000+00:00",
        "attachments": null
    },
    {
        "author": "ryanleeschneider",
        "category": "Execution Layer",
        "parent": "",
        "content": "Probably someone who's actually read and understood https://eth2book.info/altair/part2/building_blocks/randomness should chime in and not me ðŸ™‚",
        "created_at": "2022-08-15T21:49:56.569000+00:00",
        "attachments": null
    }
]