[
    {
        "author": "radekkapka",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Hey guys, I am currently reading the HF1 spec and there are a few things I don't understand. I hope it's OK if I dump some questions here. Today I would like to enquire about `process_attestation`.\n\n1. It doesn't make sense to have both `assert is_matching_source` and `if is_matching_source`, although I am not sure which one can be removed.\n2. Why do we check `if is_matching_head and is_matching_target` and not just `if is_matching_head`?\n3. Why do we have `+ integer_squareroot(SLOTS_PER_EPOCH)` when verifying timely source and `+ SLOTS_PER_EPOCH` when verifying timely target? Why not have the same value for both?",
        "created_at": "2021-02-16T08:00:00.365000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I'm curious, why do we need a separate shuffling for sync committees, and would it be feasible to create a correlated shuffling, for example by running one extra round on the other committees? shuffling indices is currently the major bottleneck in the eth2 state transition - adding one more adds to the burden - the problem also grows worse with the validator set size, because more memory needs to be touched",
        "created_at": "2021-02-16T14:38:25.321000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "\u003e 1. It doesn't make sense to have both assert is_matching_source and if is_matching_source, although I am not sure which one can be removed.",
        "created_at": "2021-02-16T18:23:43.370000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "the `assert` ensures that attestations are consistent w/ the current view of the chain, namely the current justified checkpoint",
        "created_at": "2021-02-16T18:24:12.658000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "actually seems like we can drop the conditional",
        "created_at": "2021-02-16T18:24:55.992000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "looking...",
        "created_at": "2021-02-16T18:24:58.380000+00:00",
        "attachments": null
    },
    {
        "author": "radekkapka",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "in that case the `if is_matching_source` check later on can be removed",
        "created_at": "2021-02-16T18:25:00.999000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "right",
        "created_at": "2021-02-16T18:25:05.509000+00:00",
        "attachments": null
    },
    {
        "author": "radekkapka",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "because it will always be `true`",
        "created_at": "2021-02-16T18:25:07.382000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "care to make a PR? ðŸ™‚",
        "created_at": "2021-02-16T18:25:52.010000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "` if is_matching_source and state.s...` was included for symmetry with the other conditionals there",
        "created_at": "2021-02-16T18:26:10.392000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "even though it was pre-validated in an above assert",
        "created_at": "2021-02-16T18:26:24.486000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I don't feel terribly strongly about it, but Justin might ðŸ˜…",
        "created_at": "2021-02-16T18:26:45.939000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "(2) because we don't want a scenario where you can get reward for head but no contribute to FFG finality (getting target correct)",
        "created_at": "2021-02-16T18:27:36.236000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "yes, the head implies the target, but we don't check consistency for inclusion on chain",
        "created_at": "2021-02-16T18:28:06.903000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Note, this condition for reward is in phase 0 because `get_matching_head_attestations` calls `get_matching_target_attestations`",
        "created_at": "2021-02-16T18:28:43.004000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "we could define `is_matching_head` as `data.beacon_block_root == get_block_root_at_slot(state, data.slot) and is_matching_target`",
        "created_at": "2021-02-16T18:29:41.516000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "maybe that is a bit clearer?",
        "created_at": "2021-02-16T18:29:47.438000+00:00",
        "attachments": null
    },
    {
        "author": "djrtwo",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "all of them have an implicit `is_matching_source` because of the assertion...",
        "created_at": "2021-02-16T18:29:59.860000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "\u003e 3. Why do we have + integer_squareroot(SLOTS_PER_EPOCH) when verifying timely source and + SLOTS_PER_EPOCH when verifying timely target? Why not have the same value for both?\nthis is basically an extra incentive to get the attestation on-chain quickly",
        "created_at": "2021-02-16T18:34:04.721000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "in sqrt(SLOTS_PER_EPOCH), rather than just w/in SLOTS_PER_EPOCH",
        "created_at": "2021-02-16T18:34:21.753000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "the high-level answer is security -- this shuffling is \"firewalled\"from the other shuffling(s) which keeps it semantically clean, a big concrete difference is that this shuffling only changes once per day, rather than every epoch",
        "created_at": "2021-02-16T18:37:59.066000+00:00",
        "attachments": null
    },
    {
        "author": "ralexstokes",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "trying to think what happens if we did the \"correlated shuffling\" like you suggest",
        "created_at": "2021-02-16T18:38:11.953000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Like, just using the first 1024 validators in the beacon shuffling as the sync committee?",
        "created_at": "2021-02-16T18:38:36.703000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "hmm",
        "created_at": "2021-02-16T18:38:38.355000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I know I did not think about it explicitly; I just have a cryptographer's \"domain-separate everything by default\" instinct",
        "created_at": "2021-02-16T18:39:09.670000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I suppose it could be done that way",
        "created_at": "2021-02-16T18:39:33.381000+00:00",
        "attachments": null
    },
    {
        "author": "terence0083",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Currently sync committee allows for duplicate indices though. It's very unlikely we'll reach that case but still",
        "created_at": "2021-02-16T18:48:10.332000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Well, the issue came up when optimising the proposer vs committee shuffling really in the state transition - this adds one more, and there are more to come - it's something worth considering",
        "created_at": "2021-02-16T18:49:16.373000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "that's also doable with the beacon shuffling approach",
        "created_at": "2021-02-16T18:49:23.127000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Just so `get_shuffled_index(i % committee_length)`",
        "created_at": "2021-02-16T18:49:38.798000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Sure, I mean \"security\" is fine, but also.. Imprecise ðŸ˜€",
        "created_at": "2021-02-16T18:51:52.663000+00:00",
        "attachments": null
    },
    {
        "author": "arnetheduck",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "And I agree, once per day isn't that bad except.. Its a cumulative effect, and at some point its good to ask the question at least",
        "created_at": "2021-02-16T18:53:06.948000+00:00",
        "attachments": null
    },
    {
        "author": ".vbuterin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Ah right, the fact that the shuffling is once per day means that in 255 of 256 epochs it will be mismatched with any other shuffling anyway",
        "created_at": "2021-02-16T19:30:49.824000+00:00",
        "attachments": null
    }
]