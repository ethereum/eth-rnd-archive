[
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "There are two alternatives to making CL responsible for trie root hashes computation:\n- Request RLP hashes from EL network, more suitable for the case when LES doesn't need these hashes to track the chain but need them when it sees relevant block header (after checking a `logs_bloom` value). In this case LES may request a full header from the network and then read transactions from a block in a safe manner\n- Request hashes via Engine API, e.g. `engine_getFullExecutionPayloadHeader` returning full header as it is represented on EL side\n\nI don't know whether it is suboptimal or not for LES to query the network for full headers when demanded",
        "created_at": "2022-11-23T10:19:44.833000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "re (1), yes, that could work if the LES doesn't need them to track the chain (i.e., the \"not passing trie roots at all\" approach). It introduces additional logic for \"having an incomplete block header\" though. if it needs them to track the chain, rather avoid as it would just hit the server twice (once the CL, then the EL), increasing risk of feature getting disabled.\n\nre (2), that would actually also be required for split block storage designs, because in that case, the CL doesn't persist transactions data, so cannot form the trie roots. The RPC call exists as `eth_getBlockByRoot` (with `includeTransactions: false`). But doing an RPC just to compute a hash, that potentially competes / interferes with other newPayload/fcU calls / validation duties, seems suboptimal as well.",
        "created_at": "2022-11-23T10:47:11.728000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Regarding the \"Adding SSZ support to the EL\", do you know if there is already an EIP for that? Haven't found one myself but it is hard to assume that noone filed one yet. If one isn't filed yet, I'll create one, so that all approaches are tried.",
        "created_at": "2022-11-23T10:49:01.475000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I would aim for just the `transactions_root`, `withdrawals_root`, and `Withdrawal` objects for consistently being stored in SSZ format. Those are not exposed to smart contracts I think, and they have the same size as the current MPT roots (and in case of withdrawals, that one hasn't shipped yet anyway)",
        "created_at": "2022-11-23T10:50:05.461000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I don't know if there are any EIPs that require EL clients to support SSZ. Btw, good point on payload bodies deduplication",
        "created_at": "2022-11-23T10:50:13.703000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Split block storage credits go to \u003c@340345049063882753\u003e , had a discussion with him recently",
        "created_at": "2022-11-23T10:50:47.279000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I think that mixing RLP and SSZ is gonna be painful for EL client devs. My gut is that we should be slowly getting rid of old EL structures and getting rid of RLP alongside this process. There is an issue with old smart contracts support though (despite of other related issues which I believe there is a huge list of)",
        "created_at": "2022-11-23T10:52:22.719000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Ideally, we don't have an EL blockchain as it is redundant and used for sync purposes and to serve JSON-RPC requests. When we cut historical blocks tail until after bellatrix, we can start looking to removing EL blockchain and block structures entirely, and replacing them in JSON-RPC and sync. Or statelessness introduction may become a trigger for this cleanup. Until that time I don't think we can get rid of RLP completely. But I agree that we should try to add SSZ support to EL when it is valuable",
        "created_at": "2022-11-23T10:57:33.862000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Smart contracts only have the block hash though, not the transactions root",
        "created_at": "2022-11-23T10:57:34.048000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes, but some of them are proving receipt and transaction inclusion in particular block using BLOCKHASH opcode and RLP",
        "created_at": "2022-11-23T10:58:22.487000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "receipts I don't need to touch",
        "created_at": "2022-11-23T10:59:02.073000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "It's just the transactions root (not the actual transactions), and the withdrawals, for which there is the problem that the CL and EL both represent them differently",
        "created_at": "2022-11-23T10:59:27.207000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "My comment relates to removing EL block structures in general, not to the particular case we're discussing",
        "created_at": "2022-11-23T10:59:42.235000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Ah, true",
        "created_at": "2022-11-23T10:59:47.748000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I think we need an input from \u003c@202397237962211328\u003e on how heavy LES depends on `transactions_root`. And what are particular scenarios when this value is used by LES client",
        "created_at": "2022-11-23T11:01:52.351000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "re `transactions_root`, he told me \"`transactions_root` is needed sometimes when the client wants to find a certain canonical transactions\".\nBut also, the current LES design is based on connecting to a BN via REST, obtaining the light client data and the EL block hash (Lodestar has an endpoint that allows querying CL proofs), and then fetches the RLP header via devp2p. Ideally, following the chain should not require extra network requests / the LC data should include all the info necessary to just track the chain and determine relevance of a block.",
        "created_at": "2022-11-23T11:07:27.684000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "The LC data is also exchanged via libp2p gossip, btw. So req/resp are actually only needed when a block has been missed. If LES wants full execution block headers, we should include all the necessary bits in the LC data. (Likewise, it is pushed via HTTP sse endpoint, so it doesn't need round trips either)",
        "created_at": "2022-11-23T11:12:34.085000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Reading the above I can conclude that LES needs `transactions_root` to read transactions from relevant blocks. Block relevancy can be determined with data currently supplied by CL light client (without RLP hashes). I agree that ideally LES doesn't do any additional queries to the wire unless a block has been missed, but as a compromise solution it doesn't sound too bad to do network requests from time to time. Though, it depends on block relevancy criteria, maybe some clients consider every 2nd block as relevant",
        "created_at": "2022-11-23T11:22:23.216000+00:00",
        "attachments": []
    },
    {
        "author": "m.kalinin",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "\u003e But also, the current LES design is based on connecting to a BN via REST, obtaining the light client data and the EL block hash (Lodestar has an endpoint that allows querying CL proofs)\n\nI see, it is a bit weird as actually CL should drive LES, not LES requesting CL for information to track the head of the chain. I assume this is what is current work about, to make it work in a more natural way",
        "created_at": "2022-11-23T11:24:09.495000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yeah, the current CL light client protocol is still based on pre-merge (no execution payload), my goal is to extend it (and the engine API) so that it works more naturally",
        "created_at": "2022-11-23T11:25:09.825000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Hey everyone, sorry for not following this discussion, there are just too many channels... i see there is quite a lot of discussion here about LES. I am running some errands now but later today i will read back a bit and respond or clear things up if necessary.",
        "created_at": "2022-11-23T12:36:33.435000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "So the thing is that with the cl/el split many different constructions are possible that could be called a \"light client\" and many of them might make sense for certain use cases but I see some assumptions about LES here that I never said or suggested ðŸ™‚ so the thing is that LES certainly does not expect anything from the libp2p gossip messages as it does not use libp2p gossip at all. There is a devp2p protocol for the EL part that works just fine, with years of work invested into solutions to improve service availability, peer discovery and many little practical details. I'm fine with considering new transport layers over the long term (though in that case i'd probably try to converge with portal) but if i want to make the Geth light client work asap then it's certainly not a top priority to change what works already.\nUsing a different p2p stack for the CL part would be a worst of both worlds solution, the client would only work if it found peers on both networks. Therefore my current solution is to fetch CL stuff through the REST api into Geth, then serve it to the Geth clients over the same channel. It is already implemented, hopefully released soon. Then we can start thinking about where to go next and how to converge protocols and p2p layers ðŸ™‚ So right now what I really need is a standardized beacon node api to get beacon state multiproofs (currently afaik only Lodestar has that).\nWhat \u003c@881905303011086387\u003e does  sounds to make sense for libp2p based light client designs, it is true that the EL block header (with a proof from the beacon header) is needed in order to prove anything from the EL side. Whether you need transacions root depends on the intended application, whether you want to be able to prove canonical transactions. If you do, you can also design it so that you don't need to re-encode anything into rlp since we're talking about a new design. As far as LES is concerned, it does not need full EL header proofs or anything else from the libp2p gossip.",
        "created_at": "2022-11-23T15:16:48.499000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Btw here is what I need:\nhttps://github.com/ethereum/beacon-APIs/pull/267",
        "created_at": "2022-11-23T15:18:18.060000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "We discussed this in length with \u003c@534934855113506836\u003e and hopefully there is going to be a reference implementation in Lodestar so we can move it forward.",
        "created_at": "2022-11-23T15:19:50.559000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "`getStateProof` can be quite expensive, in its generic form. are there specific fields that you request? is it only covering latest state, or arbitrary states?",
        "created_at": "2022-11-23T15:20:11.893000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I only expect the head state to be available on demand, otherwise see the subscribe endpoint. I am using the historical roots structure to prove old canonical blocks so i need more or less general purpose, though we can restrict it to certain fields. For example i do not want to go beyond the historical data container root hashes for each period, i maintain the trees with the individual block/state roots of old periods locally.",
        "created_at": "2022-11-23T15:26:49.748000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I know that proving anything from non-head states is very expensive for CL clients other than Lodestar. So the api design ensures that most of the proofs can be generated when the state itself is generated.",
        "created_at": "2022-11-23T15:30:04.766000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "How does it work then if the CL is also a light client? It will not have access to full block or state data in that case",
        "created_at": "2022-11-23T15:30:23.544000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "It's fine if only full CL nodes support this",
        "created_at": "2022-11-23T15:30:52.221000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Since it's used by a full Geth node that serves its light clients through LES.",
        "created_at": "2022-11-23T15:31:32.831000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Which is typically connected to a full CL through the engine API.",
        "created_at": "2022-11-23T15:33:36.710000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "can also be a light CL, but yes",
        "created_at": "2022-11-23T15:33:51.132000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "so, LES clients are not driven by engine API at all? They are on their own network and obtain their data autonomously?",
        "created_at": "2022-11-23T15:36:53.394000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes, it is an integrated el/cl light client",
        "created_at": "2022-11-23T15:40:57.925000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I see. So, it works well with the current (Altair) `LightClientUpdate` structure.",
        "created_at": "2022-11-23T15:41:32.077000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes",
        "created_at": "2022-11-23T15:42:25.912000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "At DevCon, we were discussing to extend `LightClientUpdate` with additional fields from the `ExecutionPayloadHeader`, e.g., to support the CL light client \u003c--\u003e EL full node pairing. Are there certain fields that would allow LES to reduce the number of network requests it needs? I think you mentioned a `logs_bloom` example",
        "created_at": "2022-11-23T15:42:48.914000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "For the CL light client \u003c--\u003e EL full node use case, the additional fields would be `beacon_block.message.body.execution_payload.{block_hash, block_number, parent_hash}`",
        "created_at": "2022-11-23T15:44:40.860000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "les is broken post merge",
        "created_at": "2022-11-23T15:53:43.118000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "not sure if the EL clients have ported the integration",
        "created_at": "2022-11-23T15:54:24.212000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yeah, maybe we misunderstood each other a bit there. We discussed it in the context that you wanted to extend the update and asked what is the minimum useful info that should be included. We concluded that for some apps like gateways the el root hash would be useful but if you want to prove further stuff from the el then you need the el header fields too. LES was only mentioned in the context that my protocol sends the rlp encoded original el header together with the beacon state proof for the el block root. You could do the same in the libp2p gossip, or prove header fields directly, but LES is not helped by adding anything to the head updates because in LES the server processes the update and requests a state proof and adds the header abyway.",
        "created_at": "2022-11-23T15:54:24.492000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "you don't say ðŸ™‚ obviously I'm talking about the post merge version which i wrote that is not released yet.",
        "created_at": "2022-11-23T15:55:54.279000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "ofcourse i was talking of current scenario ðŸ˜†",
        "created_at": "2022-11-23T15:56:23.044000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "lodestar is currently working on also driving the EL engine api via fcU through light client",
        "created_at": "2022-11-23T15:57:43.923000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Ah, got it, and yes, there are other use cases, e.g., the validating proxies that were suggested for use with wallets etc, that benefit from having access to `state_root`, or `logs_bloom`. But for these use cases, regarding `transactions_root` and `withdrawals_root`, they could obtain proofs for these also in a world where these woud be propagated in SSZ format.",
        "created_at": "2022-11-23T15:57:47.830000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "currently, it doesn't work, becaue you need to call `newPayload`, hence the attempt to add a new engine API method that no longer needs the full block data. But, as it seems, that we could probably go with an approach that only passes `block_hash, block_number, parent_hash`, and none of the rest.",
        "created_at": "2022-11-23T15:59:00.473000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "but if EL wants LES, EL will need to port engine API to LES and that way they can always be SYNCING even when they are synced to head via light client",
        "created_at": "2022-11-23T15:59:43.745000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "yes, we are prototyping something where we fetch the payload from the beacon network and provide it to the new payload",
        "created_at": "2022-11-23T16:00:22.951000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "LES clients don't need the engina api at all, it's an integrated el/cl light client",
        "created_at": "2022-11-23T16:00:50.664000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "it works as such, but it would be better if these things are natively available in the updates",
        "created_at": "2022-11-23T16:00:52.752000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "understood, but ideally in decoupled scenario, notifyFcU can just be exposed in LES scenario for light client to announce head",
        "created_at": "2022-11-23T16:02:11.107000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "without requiring the newPayload, which i think is doable on the EL part",
        "created_at": "2022-11-23T16:02:39.583000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "rest the beacon sync of EL already backfills and a toned down version could just backfill header than blocks",
        "created_at": "2022-11-23T16:04:10.204000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "That's an alternate design though. LES apparently does its own thing, not based on engine API",
        "created_at": "2022-11-23T16:04:50.417000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "no LES is just similar to full ETH protcol, its just header based without no block execution",
        "created_at": "2022-11-23T16:05:21.515000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "(telling from ethereumjs prespective where i have done some work)",
        "created_at": "2022-11-23T16:05:38.277000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Zsolt created LES ^^",
        "created_at": "2022-11-23T16:06:12.633000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "post merge, LES chain building is also broken because pow/poa rules don't apply anymore",
        "created_at": "2022-11-23T16:06:19.906000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "so it also need head annoucements like how a normal full el node does",
        "created_at": "2022-11-23T16:06:52.402000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "to find the canonical chain",
        "created_at": "2022-11-23T16:07:38.936000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "let me know if my understanding is wrong",
        "created_at": "2022-11-23T16:07:47.774000+00:00",
        "attachments": []
    },
    {
        "author": "wemeetagain",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Seems the difference is more a matter of client implementation specifics. Seems like geth is wanting a more unified soln vs ethereumjs which might still use a cl light client and the engine api?",
        "created_at": "2022-11-23T16:10:55.042000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "ohh yes ofcourse there can be two ways to solution this ðŸ™‚",
        "created_at": "2022-11-23T16:12:04.945000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "With \"these things\", do you mean the EL block header, or the ExecutionPayloadHeader?",
        "created_at": "2022-11-23T16:12:18.018000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes, and light client protocol should not prohibit the engine API approach, and also support the validating proxies (which need the stateRoot, for example)",
        "created_at": "2022-11-23T16:12:44.648000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "for LES if LES has to do validation of the header hash, then EL block header has to be available",
        "created_at": "2022-11-23T16:13:07.349000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "payloadheader has transactions which are not required by LES",
        "created_at": "2022-11-23T16:13:28.278000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Geth-LES doesn't need more data.",
        "created_at": "2022-11-23T16:13:33.848000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "but that could also work",
        "created_at": "2022-11-23T16:13:35.600000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "it doesn't, the difference is whether `transactions_root` is an SSZ root, or a Patricia trie root hash",
        "created_at": "2022-11-23T16:13:52.750000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "ohh sorry executionpayloadheader won't have transactions",
        "created_at": "2022-11-23T16:14:37.675000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "so we would need the EL block header",
        "created_at": "2022-11-23T16:14:45.024000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "OK, and \"we\" meaning ethereumjs?",
        "created_at": "2022-11-23T16:15:03.446000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "yes, but i think in general all ELs will require the same",
        "created_at": "2022-11-23T16:15:24.430000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "LES protocol on EL side is the standard one i think so under the hoob basic mechanis should be same",
        "created_at": "2022-11-23T16:16:02.622000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I agree that being able to just follow the chain with _only_ the light client data, and no additional network requests, would be quite useful",
        "created_at": "2022-11-23T16:16:30.628000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "And reusing the existing EL block header for that purpose seems consistent as well, rather than having a special flavor for light client ELs",
        "created_at": "2022-11-23T16:17:03.789000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "and the need for EL block header announcement from the CL light client to identify canonical head",
        "created_at": "2022-11-23T16:17:49.275000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "as difficulty/signer ruleset can't be applied anymore to determine what chain is canonical",
        "created_at": "2022-11-23T16:18:17.756000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Well, that is just standard `engine_forkchoiceUpdated`, and as long as we bundle `block_hash` with the light client updates, that is solved",
        "created_at": "2022-11-23T16:18:18.984000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "yes exactly",
        "created_at": "2022-11-23T16:18:30.674000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "solutioning of light client for canonical head can be coupled or embedded (Geth LES)",
        "created_at": "2022-11-23T16:19:34.512000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "that is my understanding ðŸ™‚",
        "created_at": "2022-11-23T16:19:47.396000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I'll try to set up an experimental LES/5 server soon, so if you want to stay compatible you can experiment with implementing that protocol. In LES/5 the head announcement is a beacon header signed by a sync committee, and with a new request type you can request EL headers with beacon state proof.",
        "created_at": "2022-11-23T16:21:47.522000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "so beacon header signed by sync comittee + proof is what CL light client is as of now",
        "created_at": "2022-11-23T16:23:04.781000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "That \"EL header\", is the RLP EL block header, not the CL ExecutionPayloadHeader, correct?",
        "created_at": "2022-11-23T16:23:07.346000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes, and that is integrated into LES/5 for convenience.",
        "created_at": "2022-11-23T16:23:49.103000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Ooook ðŸ™‚ So we are still all on the same page, and ultimately, any EL sort of needs to obtain the EL block header at some point, including the patricia trie root hashes for `transactions_root` and `withdrawals_root`. It is just the way how to obtain those EL block headers that is different among implementations",
        "created_at": "2022-11-23T16:24:39.413000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "right, also EL beacon sync for LES would still be needed",
        "created_at": "2022-11-23T16:25:12.376000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "beacon sync just with headers to backfill to genesis",
        "created_at": "2022-11-23T16:25:36.039000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "unless all headers are fed sort of in normal forward sync sort of the way",
        "created_at": "2022-11-23T16:26:07.434000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "so may be there is how the diffrentiation between two approaches can come",
        "created_at": "2022-11-23T16:26:28.924000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "CL driven LES will require backfill, and LES/5 might not",
        "created_at": "2022-11-23T16:26:52.546000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "is there a spec document i can read to see the internals of LES/5",
        "created_at": "2022-11-23T16:27:08.282000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "LES/5 does not backfill, it proves old canonical blocks through the historical roots structure",
        "created_at": "2022-11-23T16:27:55.462000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "not yet but indeed it's about time to document it ðŸ™‚",
        "created_at": "2022-11-23T16:28:33.137000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "ohh that would be interesting",
        "created_at": "2022-11-23T16:28:43.512000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "fully synced LES clients create that structure?",
        "created_at": "2022-11-23T16:29:19.755000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "The servers create it and generate proofs on demand for clients, from latest beacon head through historical roots, then state roots of the old period, then the old beacon state, to the old el block root",
        "created_at": "2022-11-23T16:31:31.605000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "servers are again integrated geth LES nodes for e.g?",
        "created_at": "2022-11-23T16:41:09.950000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes, Geth full nodes with LES service enabled",
        "created_at": "2022-11-23T16:47:48.037000+00:00",
        "attachments": []
    },
    {
        "author": "wemeetagain",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "The servers generating the proofs are CLs serving proofs over beacon api",
        "created_at": "2022-11-23T17:39:15.698000+00:00",
        "attachments": []
    },
    {
        "author": "wemeetagain",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Currently only lodestar, but thats why we want to standardize some proof api endpoints",
        "created_at": "2022-11-23T17:39:48.069000+00:00",
        "attachments": []
    },
    {
        "author": "g11tech",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "understood, so this is the way to get canonical  execution header without doing backfill sync and establishing a chain till genesis",
        "created_at": "2022-11-23T18:10:16.659000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "I think the question here was specifically about my historic canonical block proof which is constructed by geth. But indeed it is based on the beacon state proofs of lodestar.",
        "created_at": "2022-11-23T18:46:23.663000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "To summarize, \u003c@425572898787426305\u003e \u003c@202397237962211328\u003e :\n\nHaving easier access to the full EL block header would be useful for certain light client designs, and can help reducing network requirements.\n\nSpecifically regarding the engine API, the three options that make sense are:\n1. Just `block_hash`, `block_number`, and `parent_hash`\n2. full EL block header (including hexary `transactions_root` and `withdrawals_root`)\n3. full EL block\n\n(1) would allow driving EL's without downloading full blocks\n(2) would allow use cases where a light client can follow the chain and monitor it for relevant events, without needing to perform any additional network requests, just by following the CL light client event stream (via HTTP SSE, or via libp2p, or other mechanisms)\n(3) is where we are today, where light clients can omit the database, but still have a large network requirement\n\nSpecifically to achieve (2), the main problem is that the CL `ExecutionPayloadHeader` is insufficient to reproduce the full EL block header. Namely, due to its `transaction_root` and `withdrawals_root` being SSZ tree roots and not hexary trie roots.\n\nI see four different ways to continue:\n(A) Including the hexary roots into the CL `ExecutionPayload`: https://github.com/ethereum/consensus-specs/pull/3078\n(B) CL implementation re-computing hexary roots on demand: https://github.com/ethereum/consensus-specs/pull/3078#issuecomment-1324265309\n(C) Switching the hexary roots in the EL to SSZ roots: https://ethereum-magicians.org/t/eip-4895-beacon-chain-withdrawals-as-system-level-operations/8568/28?u=etan-status\n(D) Drop option (2) and focus on (1) instead. This would require light clients to obtain EL block header information through separate requests",
        "created_at": "2022-11-23T18:55:54.007000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "(E) prove EL block root only from beacon state and distribute original rlp EL header with the proof? Or am I missing something?",
        "created_at": "2022-11-23T19:56:03.194000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "the original RLP EL header is not available to the CL (who serves the light client data); the hexary `transactions_root` / `withdrawals_root` are not currently part of the CL `ExecutionPayloadHeader`, so cannot be proven using SSZ merkle proof. Options (A) and (B) allow the CL to reconstruct the RLP EL header",
        "created_at": "2022-11-23T20:24:33.749000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Right... I spent my entire Ethereum career in a world where EL headers are available so I just assumed that automatically ðŸ™‚",
        "created_at": "2022-11-23T20:56:32.207000+00:00",
        "attachments": []
    },
    {
        "author": "zsfelfoldi",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Btw you can get them from the EL node through RPC API, though I'm not sure if you'd like to rely on that ðŸ™‚ (it should be available on the same URL as the engine API so it might be a workable solution)",
        "created_at": "2022-11-23T20:59:28.306000+00:00",
        "attachments": []
    },
    {
        "author": "tersec",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "The purpose as I understand it is, yeah, to be able to do this from CL-world",
        "created_at": "2022-11-23T21:08:36.870000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "yes, but that RPC call may compete with resources needed for ongoing validator duties or fork choice processing via newPayload / forkchoiceUpdated. so it is not optimal either. ultimately, we just want to obtain two trie roots ^^ but yes, in split block storage designs the CL may also have discarded the transactions, so it becomes a necessity to either cache those trie roots in advance, or to use the RPC. not that easy",
        "created_at": "2022-11-23T22:39:17.489000+00:00",
        "attachments": []
    },
    {
        "author": "uink45",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Regarding approach (A), is that change slated for Capella (as in when withdrawals are enabled)?",
        "created_at": "2022-11-23T22:54:07.839000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Yes, aiming to get either one of (A), (B), (C), or (D) ready for Capella. The two trie roots are the main blocker.\nOption (D) you can preview here (providing only the SSZ but not the hexary trie roots): https://github.com/etan-status/consensus-specs/commit/lc-eph",
        "created_at": "2022-11-23T22:55:52.003000+00:00",
        "attachments": []
    },
    {
        "author": "etan_status",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Slashing slated for later, it needs more time for proper test building, to define slashing protection and honest validator rules etc",
        "created_at": "2022-11-23T22:58:02.453000+00:00",
        "attachments": []
    },
    {
        "author": "uink45",
        "category": "Consensus R\u0026D",
        "parent": "",
        "content": "Also, since EL is using `hexary_trie_root([RLP.encode(Withdrawal), ...])` and not `hash_tree_root([SSZ.encode(Withdrawal), ...])`, light clients will not be verify the data because of different hashes right?",
        "created_at": "2022-11-23T23:57:30.472000+00:00",
        "attachments": []
    }
]